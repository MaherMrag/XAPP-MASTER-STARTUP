<style>
    input.series-color {
        width: 100px;
        text-align: center;
    }

    input.series-color::-webkit-color-swatch {
        border: none;
    }
</style>
<script type="text/javascript">
    RED.nodes.registerType('ui.spark', {
        category: 'dashboard',
        color: 'rgb(119, 198, 204)',
        autoedit: true,
        defaults: {
            name: { value: '_spark' },
            tag: { value: '' },
            parentid: {},
            z: {},
            x: { value: 0 },
            y: { value: 0 },
            width: { value: 5 },
            height: { value: 5 },
            class: { value: 'icon-ui-spark' },
            days: { value: 8 },
            sparktype: { value: 'bar' },
            barWidth: { value: '16' },
            barSpacing: { value: '4' },
            barColor: { value: '#59cfa8' },
            sparkwidth: { value: '100' },
            sparkheight: { value: '100' },
            lineColor: { value: '#26B99A' },
            fillColor: { value: '#ffffff' },
            lineWidth: { value: 2 },
            spotColor: { value: '#34495E' },
            minSpotColor: { value: '#34495E' },
            maxSpotColor: { value: '#6d93c4' },
            highlightSpotColor: { value: '#ef5179' },
            highlightLineColor: { value: '#8ba8bf' },
            spotRadius: { value: 2.5 },
        },
        inputs: 1,
        outputs: 1,
        oneditprepare: function () {
            var node = this;
            var setColour = function (id, value) {
                $(id).val(value);
                $(id).css("background-color", value);
                var rgb = tinycolor(value).toRgb();
                var level = ((rgb.r * 299) + (rgb.g * 587) + (rgb.b * 114)) / 1000;
                var textColor = (level >= 128) ? '#111111' : '#eeeeee';
                $(id).css("color", textColor);
            }

            $('#node-input-barColor').on("change", function () {
                setColour("#node-input-barColor", $(this).val());
            });;
            $('#node-input-lineColor').on("change", function () {
                setColour("#node-input-lineColor", $(this).val());
            });;
            $('#node-input-fillColor').on("change", function () {
                setColour("#node-input-fillColor", $(this).val());
            });;
            $('#node-input-spotColor').on("change", function () {
                setColour("#node-input-spotColor", $(this).val());
            });;
            $('#node-input-minSpotColor').on("change", function () {
                setColour("#node-input-minSpotColor", $(this).val());
            });;
            $('#node-input-maxSpotColor').on("change", function () {
                setColour("#node-input-maxSpotColor", $(this).val());
            });;
            $('#node-input-highlightSpotColor').on("change", function () {
                setColour("#node-input-highlightSpotColor", $(this).val());
            });;
            $('#node-input-highlightLineColor').on("change", function () {
                setColour("#node-input-highlightLineColor", $(this).val());
            });;

            var defaultColors = ['#1F77B4', '#AEC7E8', '#FF7F0E', '#2CA02C', '#98DF8A', '#D62728', '#FF9896', '#9467BD', '#C5B0D5'];
            node.barColor = node.barColor ? node.barColor : defaultColors[0];
            node.lineColor = node.lineColor ? node.lineColor : defaultColors[1];
            node.fillColor = node.fillColor ? node.fillColor : defaultColors[2];
            node.spotColor = node.spotColor ? node.spotColor : defaultColors[3];
            node.minSpotColor = node.minSpotColor ? node.minSpotColor : defaultColors[4];
            node.maxSpotColor = node.maxSpotColor ? node.maxSpotColor : defaultColors[5];
            node.highlightSpotColor = node.highlightSpotColor ? node.highlightSpotColor : defaultColors[6];
            node.highlightLineColor = node.highlightLineColor ? node.highlightLineColor : defaultColors[7];

            setColour("#node-input-barColor", node.barColor)
            setColour("#node-input-lineColor", node.lineColor)
            setColour("#node-input-fillColor", node.fillColor)
            setColour("#node-input-spotColor", node.spotColor)
            setColour("#node-input-minSpotColor", node.minSpotColor)
            setColour("#node-input-maxSpotColor", node.maxSpotColor)
            setColour("#node-input-highlightSpotColor", node.highlightSpotColor)
            setColour("#node-input-highlightLineColor", node.highlightLineColor)


            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                maxWidth: 12,
                maxHeight: 7,
                fixedHeight: false,
                fixedWidth: true,
            });
            //Tag
            var tag_settings = {
                view: {
                    dblClickExpand: false
                },
                data: {
                    simpleData: {
                        enable: true
                    }
                },
                callback: {
                    beforeClick: (treeId, treeNode) => {
                        var check = (treeNode && !treeNode.isParent);
                        if (!check) alert("Please select a...");
                        return check;
                    },
                    onClick: (e, treeId, treeNode) => {
                        var zTree = XAPP.trees.tree.getZTreeObj('tag-menu-item');
                        var node = zTree.getSelectedNodes()[0];
                        $("#node-input-tag").val(node.id);
                        $('#tag_menuBtn span').html(node.name);
                    }
                }
            };

            function tag_bodydown(event) {
                if (!(event.target.id == "tag_menuBtn" || event.target.id == "tag-menu-content" || $(event.target).parents("#tag-menu-content").length > 0)) {
                    tag_hideMenu();
                }
            }

            function tag_hideMenu() {
                $("#tag-menu-content").fadeOut("fast");
                $("body").unbind("mousedown", tag_bodydown);
            }

            function tag_showMenu() {
                $("#tag-menu-content").css({ 'display': 'Block' }).slideDown("fast");
                XAPP.trees.init($(`#tag-menu-item`), tag_settings, XAPP.treelist.tree().getNodesByParam('name', 'Configuration'));
                var Treemenu = XAPP.trees.tree.getZTreeObj('tag-menu-item');
                var nn = Treemenu.getNodesByParam('id', $("#node-input-tag").val())
                Treemenu.selectNode(nn[0])
                $("body").bind("mousedown", tag_bodydown);
            }
            $(`#tag_menuBtn`).on('click', tag_showMenu);

            var node_tag = RED.nodes.node(node.tag);
            if (node_tag) {
                $('#tag_menuBtn span').html(node_tag.name);
            } else {
                $('#tag_menuBtn span').html('');
            }

        },
        oneditsave: function () {
            var node = this;

            node.days = $('#node-input-days').val();
            node.name = $('#node-input-name').val();

            node._def.oncomponentload.call(node);

        },
        onwsprepare: function () {
        },
        oncomponentload: function () {
            var nn = this;
            var item_id = nn.id.replace(".", "-");

            var pNode = RED.nodes.node(nn.parentid)
            var startdate, enddate;

            if (pNode) {
                startdate = (pNode.startdate) ? moment(new Date(pNode.startdate)) : moment().startOf('day').toString();
                enddate = (pNode.enddate) ? moment(new Date(pNode.enddate)) : moment().endOf('day').toString();
            } else {
                startdate = moment().startOf('day').toString();
                enddate = moment().endOf('day').toString();
            }
            var unit = nn.Unit;

            var unit = 'Days';
            /* var xformat = 'HH:mm:ss'; */
            var days = nn.days || 7;
            startdate = moment().subtract(days, 'days');
            enddate = moment();






            var gridstack_item_content = $(`#${item_id}-item-content`);
            gridstack_item_content.empty();



            var box_item = $(`<div id='${item_id}-info-box'class="info-box">`).on("dblclick", function () {
                RED.editor.edit(nn);
                var n = XAPP.treelist.tree().getNodesByParam('id', nn.id)
                XAPP.treelist.tree().selectNode(n[0])
            }).appendTo(gridstack_item_content);
            var component_content = $(`<div class="info-box-content">`).appendTo(box_item);


            var spark_component = $(`
    



                        <div>
                            <div class="spark_tile">${nn.name}</div>

                                <span class="spark_description">Total :
                                    <span id ="${item_id}-total" class="spark_total">231,809</span>
                                </span>
                                <div class="spark" style="width:100%;text-align: center;" style="text-align: center;">
                                    <span id ="${item_id}-spark" class="graph"></span>
                                </div>
                                <span class="spark_footer">
                                    Evolution last ${nn.days} days
                                </span>
                                </span>
                        </div>
  `).appendTo(component_content)


            var spinner = $(`<div id ='${item_id}-spinner'  class='tp-spinner'>
														<span class='tb-spinner tb-spinner-is-centered'> </span>
                                                    </div>`).appendTo(component_content)

            var date = { startdate: startdate, enddate: enddate, tag: nn.tag }
            spark_component.hide();
            spinner.show();
            $.ajax({
                method: 'POST',
                contentType: 'application/json',
                url: "spark/" + nn.id,
                data: JSON.stringify(date),
                success: function (data) {
                    console.log('Spark Data :', data)
                    init(data)

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Unexpected error saving user settings:", jqXHR.status, textStatus);
                }
            });


            function formatNumber(num) {
                return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
            }
            function init(data) {
                spark_component.show();
                spinner.hide();

                var result = data.result;

                var arr = [];
                var total = 0.0;


                if ($(`#${item_id}-spark`).length) {


                    for (id in result) {
                        if (result.hasOwnProperty(id)) {
                            total += result[id].value;
                            arr.push(result[id].value);
                        }

                    }


                    $(`#${item_id}-total`).text(formatNumber(total));

                    $(`#${item_id}-spark`).sparkline(arr, {
                        type: nn.sparktype,
                        height: nn.sparkwidth,
                        width: nn.sparkheight,
                        barWidth: nn.barWidth,

                        barSpacing: nn.barSpacing,
                        barColor: nn.barColor,
                        lineColor: nn.lineColor,
                        fillColor: nn.fillColor,
                        lineWidth: nn.lineWidth,
                        spotColor: nn.spotColor,
                        minSpotColor: nn.minSpotColor,
                        maxSpotColor: nn.maxSpotColor,
                        spotRadius: nn.spotRadius,
                        highlightSpotColor: nn.highlightSpotColor,
                        highlightLineColor: nn.highlightLineColor,


                    });



                }


            }

        },

    });
</script>

<script type="text/html" data-template-name="ui.spark">

    <style>
        .red-ui-editor .stack  input[type="color"] {
             width: '50px';
             height: '20px' !important;
             border: none;
             margin: 0;
             padding: 0;
             float: right;
         }
        .red-ui-editor .stack  input[type="text"] {
             width: 100%;
             height: auto;
             border: none;
             margin: 0;
             padding: 0;
         }
 
         .red-ui-editor .stack  input[type="checkbox"] {
             height: auto;
             border: none;
             margin: 0;
             padding: 0;
         }
 
         .red-ui-editor .stack  select { 
             width: 100%;
             height: auto;
             border: 0;
             padding: 0;
             margin: 0;
         }
 
         .red-ui-editor .stack  table.red-ui-info-table tr:not(.blank) td:first-child {
     color: #444;
     vertical-align: top;
     width: 207px;
     padding: 3px 3px 3px 6px;
     background: #f7f7f7;
     border-right: 1px solid #ddd;
 }
 
         .red-ui-editor .stack table.red-ui-info-table tr:not(.blank) { border: 1px solid #ddd; }
 
     </style>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <!-- Element: Tag -->
    <div class="form-row">
        <label for="node-input-tag"><i class="fa fa-tag"></i> Tag </label>
        <div class="menu-container" style="display: inline-block;">
            <div id='tag_btncontainer' class="red-ui-typedInput-container"
                style="width: 268px; margin-right: 0px; margin-left: 0px;">
                <button id='tag_menuBtn' class="red-ui-typedInput-type-select red-ui-typedInput-full-width" tabindex="0">
                    <i class="red-ui-typedInput-icon fa fa-caret-down"></i>
                    <span class="red-ui-typedInput-type-label"></span>
                </button>
            </div>
            <div id="tag-menu-content" class="ztree-menucontent" style="display:none;width: 268px;">
                <ul id="tag-menu-item" class="ztree"></ul>
            </div>
            <input type="hidden" id="node-input-tag" style="width: 268px;" autocomplete="off" dir=""
                class="red-ui-typedInput" value="">
        </div>
        
       
    </div>

    <hr> 

   

   
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="stack">
        <table class="red-ui-info-table">
            <tbody>
                <tr class="red-ui-help-info-row">
                    <td colspan="2">Spark</td>

                </tr>
                <tr class="red-ui-help-info-row">
                   <td>Type</td>
                   <td>
                    <select id="node-input-sparktype">
                        <option value="bar">Bar</option>
                        <option value="line">Line</option>
                    </select>

                   </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>Days</td>
                    <td>
                        <input type="text" id="node-input-days"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td colspan="2">Bar</td>

                </tr>
                <tr class="red-ui-help-info-row">
                    <td>barColor</td>
                    <td>
                        <input type="color" id="node-input-barColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>barWidth</td>
                    <td>
                        <input type="text" id="node-input-barWidth"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>barSpacing</td>
                    <td>
                        <input type="text" id="node-input-barSpacing"/>
                    </td>
                </tr>

                <tr class="red-ui-help-info-row">
                    <td colspan="2">Line</td>
                </tr>

                <tr class="red-ui-help-info-row">
                    <td>sparkwidth</td>
                    <td>
                        <input type="text" id="node-input-sparkwidth"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>spotRadius</td>
                    <td>
                        <input type="text" id="node-input-spotRadius"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>sparkheight</td>
                    <td>
                        <input type="text" id="node-input-sparkheight"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>lineWidth</td>
                    <td>
                        <input type="text" id="node-input-lineWidth"/>
                    </td>
                </tr>

                <tr class="red-ui-help-info-row">
                    <td>lineColor</td>
                    <td>
                        <input type="color" id="node-input-lineColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>fillColor</td>
                    <td>
                        <input type="color" id="node-input-fillColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>spotColor</td>
                    <td>
                        <input type="color" id="node-input-spotColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>minSpotColor</td>
                    <td>
                        <input type="color" id="node-input-minSpotColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>maxSpotColor</td>
                    <td>
                        <input type="color" id="node-input-maxSpotColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>highlightSpotColor</td>
                    <td>
                        <input type="color" id="node-input-highlightSpotColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>
                <tr class="red-ui-help-info-row">
                    <td>highlightLineColor</td>
                    <td>
                        <input type="color" id="node-input-highlightLineColor" class="series-color" style="width: 50px;height: 20px;"/>
                    </td>
                </tr>


               
            </tbody>
        </table>
    </div>






</script>

<script type="text/x-red" data-help-name="ui.spark">

</script>
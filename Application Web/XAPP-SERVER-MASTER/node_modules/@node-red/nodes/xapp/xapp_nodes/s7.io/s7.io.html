<!--******************************************************************-->
<!--  			    		 Read Node			     				  -->
<!--******************************************************************-->
<script type="text/html" data-template-name="s7.io">
	<!-- Element: name -->

<div class="form-row">
	<label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
	<input type="text" id="node-config-signal-name" placeholder="Name">
</div>



<!-- Element: Topic -->
<div class="form-row">
	<label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
	<input type="text" id="node-input-topic" placeholder="Topic">
</div>
<div class="divider"></div>

<!-- Element: maxvalue -->
<div class="form-row">
	<label for="node-input-maxvalue"><i class="fa fa-crosshairs"></i> Max Value </label>
	<input type="text" id="node-config-maxvalue" placeholder="maxvalue">
</div>
<div class="form-row">
	<label for="node-input-unit"><i class="fa fa-atom"></i> Unit </label>
	<input type="text" id="node-config-unit" placeholder="Unit">
</div>


<div class="form-row">
	<!-- Element: Color -->
	<label for="node-input-widgettype"><i class="fa fa-asterisk"></i> Type </label>

	<select style="width: 200px;margin-bottom: 0px;" id="node-input-widgettype">
		<option value="temperature-high"> Temperature</option>
		<option value="sun">Energy</option>
		<option value="industry">Production</option>
		<option value="burn">Water</option>
	</select>


	<input type="color" id="node-input-color" class="series-color"
		style="margin-left: 5px; margin-right: 5px; width: 100px; background-color: rgb(255, 127, 14); color: rgb(17, 17, 17);">

</div>




<div class="divider"></div>


<!-- Element: S7 Data Type -->
<div class="form-row">
	<label for="node-input-signal"><i class="fa fa-envelope"></i> Data Type</label>
	<select id="node-input-s7Type" style="width: 100px"></select>
	<input type="text" id="node-input-DBnum" style="width:50px;    text-align: center;">
	<select id="node-input-s7DataType" style="width: 100px"></select>
</div>
<div id="id-form-offset" class="form-row">
	<!-- Element: Offset -->
	<label for="node-input-signal"><i class="fa fa-sort-numeric-asc"></i> Offset </label>
	<input type="text" id="node-input-offset" style="width:50px;    text-align: center; margin-bottom: 0px">
	<label id="node-input-dot" style="width:10px;    font-size: 40px;">.</label>
	<input type="text" id="node-input-bit-offset" style="width:50px;    text-align: center;" disabled>
	<!-- Element: Quantity -->
	<label id="id-form-quantity" style="margin-left: 10px; width: 70px;margin-bottom: 0px; "><i
			class="fa fa-crosshairs"></i> Quantity </label>
	<input type="text" id="node-config-input-quantity" style="width:100px;margin-bottom: 0px;">
</div>
<!-- Element: Intervall -->
<div class="form-row">
	<!-- <label for=""><i class="fa fa-repeat"></i> <span data-i18n="inject.label.repeat"></span></label> -->
	<label for=""><i class="fa fa-repeat"></i> <span>Repeat</span></label>
	<select id="inject-time-type-select" style="width: 100px;margin-bottom: 0px;">
		<option value="none">none</option>
		<option value="interval">interval</option>
	</select>

	<label id="inject-time-label" style="margin-left: 10px; width: 50px; "><i
			class="fa fa-clock-o"></i><span>Every</span></label>
	<input type="text" id="inject-time-interval-count" style="width: 50px;" placeholder="0">
	<select style="width: 100px;margin-bottom: 0px;" id="inject-time-interval-units">
		<option value="s"> seconds</option>
		<option value="m"> minutes</option>
		<option value="h"> hours</option>
	</select>
</div>

<!-- Element: Inject once at start -->
<div class="form-row" id="node-once">
	<label>&nbsp;</label>
	<input type="checkbox" id="node-input-once" style="display: inline-block; width: auto; vertical-align: top;">
	<label for="node-input-once" style="width: 70%;" l>Inject once at start?</label>
</div>

<div class="divider"></div>

<!-- Element: Data Base -->

<div class="form-row">
	<label for="node-input-operation"><i class="fa fa-database"></i> Data Base </label>
	<div class="menu-container" style="display: inline-block;">
		<div id='database_btncontainer' class="red-ui-typedInput-container"
			style="width: 268px; margin-right: 0px; margin-left: 0px;">
			<button id='database_menuBtn' class="red-ui-typedInput-type-select red-ui-typedInput-full-width"
				tabindex="0">
				<i class="red-ui-typedInput-icon fa fa-caret-down"></i>
				<span class="red-ui-typedInput-type-label"></span>
			</button>
		</div>
		<div id="database-menu-content" class="ztree-menucontent" style="display:none;width: 268px;">
			<ul id="database-menu-item" class="ztree"></ul>
		</div>
		<input type="hidden" id="node-input-operation" style="width: 268px;" autocomplete="off" dir=""
			class="red-ui-typedInput" value="">
	</div>
</div>

<div class="form-row">
	<label for=""><i class="fa fa-repeat"></i> <span>Repeat</span></label>
	<select id="db-inject-time-type-select" style="width: 100px;margin-bottom: 0px;">
		<option value="none">none</option>
		<option value="interval">interval</option>
	</select>

	<label id="db-inject-time-label" style="margin-left: 10px; width: 50px; "><i
			class="fa fa-clock-o"></i><span>Every</span></label>
	<input type="text" id="db-inject-time-interval-count" style="width: 50px;" placeholder="0">
	<select style="width: 100px;margin-bottom: 0px;" id="db-inject-time-interval-units">
		<option value="s"> seconds</option>
		<option value="m"> minutes</option>
		<option value="h"> hours</option>
	</select>
</div>
</script>

<script type="text/x-red" data-help-name="s7.io">
<p>The node reads data from Siemens devices such as S7-300/400/1200/1500.</p>
<p>The signals to be read are setup in the node's connection selector. The repeat function allows sending 
requests either periodically or if disabled triggered by any node's input message.
</br>
</br>
The node outputs a msg.payload in the following format:</p>
<p style="padding-left: 10px;"><b>payload.signal :</b> Symbolic name of the signal as configured,</p>
<p style="padding-left: 10px;"><b>payload.path :</b> Signal path of the signal,</p>
<p style="padding-left: 10px;"><b>payload.error :</b> Error value: 0 = no error, -1 = reading failed ,</p>
<p style="padding-left: 10px;"><b>payload.value :</b> Read data as array. The returned data can be either:</p>
<p style="padding-left: 30px;"><em>null</em>: in case of an error;</p>
<p style="padding-left: 30px;"><em>single value</em>: if the quantity equals to one;</p>
<p style="padding-left: 30px;"><em>array of values</em>: if the quantity is larger than one;</p>
</br>
Node status:</p>
<p style="padding-left: 10px;"><b>connected :</b> The node is connected with a PLC.</p>
<p style="padding-left: 10px;"><b>disconnected :</b> The node is disconnected.</p>
<p style="padding-left: 10px;"><b>error :</b> Some Error occured.</p>
<p style="padding-left: 10px;">Note: The node status connected and disconnected corresponds to the internal state of nodes7 (isoConnectionState). The node status error corresponds to the return value of a read request.
</br>
</br>
Example payload of output msg:</br>
1) Reading Q0.1, return value is true and valid:</br>
<div style="padding-left: 17px;"> {topic:"Input_hall#1", payload:{signal: "machine#1", path:"Q0.1",error:0, value:[true] }, _msgid: "92e3f0cc.6d1c1"} </div></br>
2) Reading QB1, return value is 100 and valid:</br>
<div style="padding-left: 17px;"> {topic:"Input_hall#1", payload:{signal: "machine#1", path:"QB1",error:0, value:[100] }, _msgid: "92e3f0cc.6d1c1"} </div></br>
3) Reading QB0-QB3, return value is [1,2,3,4] and valid:</br>
<div style="padding-left: 17px;"> {topic:"Input_hall#1", payload:{signal: "machine#1", path:"QB0..3",error:0, value:[1,2,3,4] }, _msgid: "92e3f0cc.6d1c1"} </div></br>
4) Reading DB11.DBB0 - DB11.DBB3, return value is [null,null,null,null] and invalid because DB11 does not exist:</br>
<div style="padding-left: 17px;"> {topic:"Input_hall#1", payload:{signal: "machine#1", path:"DB10,BYTE0..3",error:-1, value:[null,null,null,null] }, _msgid: "92e3f0cc.6d1c1"} </div></br>
5) In any case of Error:  </br> 
<div style="padding-left: 17px;"> error=-1, value=[null] </div></br>
</script>

<style>
	input.series-color {
		width: 100px;
		text-align: center;
	}

	input.series-color::-webkit-color-swatch {
		border: none;
	}
</style>
<script type="text/javascript">
	var subWindow = null;
	RED.nodes.registerType('s7.io', {
		category: 'common',
		color: "#009999",
		autoedit: true,
		defaults: {
			connection: {},
			group: {},
			name: { value: "_tag" },
			payload: { value: { S7_Type: "I", S7_DBnum: "0", S7_Datatype: "X", S7_Offset: "0", S7_BitOffset: "0", S7_Quantity: "1", S7_Name: "" } },
			topic: { value: "topic" },
			signalSetted: { value: false },
			none: { value: false },
			repeat: { value: "" },
			operation: { value: '' },
			dbnone: { value: false },
			dbrepeat: { value: "" },
			once: { value: false },
			maxvalue: { value: '100' },
			color: { value: '#1F77B4' },
			unit: { value: 'Â°C' },
			widgettype: { value: '' },
		},
		inputs: 1,
		outputs: 1,
		icon: "fieldbus.png",
		paletteLabel: "s7.config",
		oneditprepare: function () {
			var node = this;

						//data base
						var database_settings = {
				view: {
					dblClickExpand: false
				},
				data: {
					simpleData: {
						enable: true
					}
				},
				callback: {
					beforeClick: (treeId, treeNode) => {
						var check = (treeNode && !treeNode.isParent);
						if (!check) alert("Please select a...");
						return check;
					},
					onClick: (e, treeId, treeNode) => {
						var zTree = XAPP.trees.tree.getZTreeObj('database-menu-item');
						var node = zTree.getSelectedNodes()[0];
						$("#node-input-operation").val(node.id);
						$('#database_menuBtn span').html(node.name);
					}
				}
			};

			function database_bodydown(event) {
				if (!(event.target.id == "database_menuBtn" || event.target.id == "database-menu-content" || $(event.target).parents("#database-menu-content").length > 0)) {
					database_hideMenu();
				}
			}

			function database_hideMenu() {
				$("#database-menu-content").fadeOut("fast");
				$("body").unbind("mousedown", database_bodydown);
			}

			function database_showMenu() {
				$("#database-menu-content").css({ 'display': 'Block' }).slideDown("fast");
				XAPP.trees.init($(`#database-menu-item`), database_settings, XAPP.treelist.tree().getNodesByParam('name', 'Data Base'));
				var Treemenu = XAPP.trees.tree.getZTreeObj('database-menu-item');
				var nn = Treemenu.getNodesByParam('id', $("#node-input-operation").val())
				Treemenu.selectNode(nn[0])
				$("body").bind("mousedown", database_bodydown);
			}


			$(`#database_menuBtn`).on('click', database_showMenu);

			var node_db = RED.nodes.node(node.operation);
			if (node_db) {
				$('#database_menuBtn span').html(RED.nodes.node(node.operation).name);
			} else {
				$('#database_menuBtn span').html('');
			}


		var operators1 = [
				{ v: "I", t: "Input" }
				, { v: "Q", t: "Output" }
				, { v: "M", t: "Marker" }
				, { v: "DB", t: "Datablock" }
				, { v: "T", t: "Timer" }
				, { v: "C", t: "Counter" }
				//,{v:"PI",t:"Peripheral Input"}
				//,{v:"PQ",t:"Peripheral Output"}
			];
			var operators2 = [
				{ v: "X", t: "Bit" }
				, { v: "B", t: "Byte" }
				, { v: "W", t: "Word" }
				, { v: "D", t: "DWord" }
				, { v: "I", t: "Int" }
				, { v: "DI", t: "DInt" }
				, { v: "uint8", t: "uint8" }
				, { v: "uint16", t: "uint16" }
				, { v: "uint32", t: "uint32" }
				, { v: "int16", t: "int16" }
				, { v: "int32", t: "int32" }
				, { v: "R", t: "Real" }
				, { v: "CHAR", t: "Char" }
				, { v: "STRING", t: "S7-String" }
			];

			$("#node-input-bit-offset").spinner({
				min: 0,
				max: 7
			});

			var S7_Name = $('#node-config-signal-name');
			var S7_BitOffset = $('#node-input-bit-offset');
			var S7_Quantity = $('#node-config-input-quantity');
			var S7_DBnum = $('#node-input-DBnum');
			var S7_Offset = $('#node-input-offset');
			var S7_Type = $("#node-input-s7Type");
			var S7_Datatype = $("#node-input-s7DataType");
			var s7_Topic = $('#node-input-topic');
			var s7_Once = $('#node-input-once');

			//S7_Type	
			for (var d in operators1) { S7_Type.append($("<option></option>").val(operators1[d].v).text(operators1[d].t)); }

			//S7_Datatype			
			for (var d in operators2) { S7_Datatype.append($("<option></option>").val(operators2[d].v).text(operators2[d].t)); }



			node.payload = node.payload || { S7_Type: "I", S7_DBnum: "0", S7_Datatype: "X", S7_Offset: "0", S7_BitOffset: "0", S7_Quantity: "1", S7_Name: "" };

			$('#node-config-signal-name').val(node.name)
			$('#node-input-bit-offset').val(node.payload.S7_BitOffset)
			$('#node-config-input-quantity').val(node.payload.S7_Quantity)
			$('#node-input-DBnum').val(node.payload.S7_DBnum)
			$('#node-input-offset').val(node.payload.S7_Offset)
			$("#node-input-s7Type").val(node.payload.S7_Type)
			$("#node-input-s7DataType").val(node.payload.S7_Datatype)
			$('#node-input-topic').val(node.topic)
			$('#node-input-once').val(node.once)

			$('#node-config-maxvalue').val(node.maxvalue);
			$('#node-config-unit').val(node.unit)



			var setColour = function (id, value) {
				console.log("id :", id);
				$(id).val(value);
				$(id).css("background-color", value);
				var rgb = tinycolor(value).toRgb();
				var level = ((rgb.r * 299) + (rgb.g * 587) + (rgb.b * 114)) / 1000;
				var textColor = (level >= 128) ? '#111111' : '#eeeeee';
				$(id).css("color", textColor);
			}
			setColour("#node-input-color", node.color);

			$(".series-color").on("change", function () {
				setColour("#" + $(this).attr("id"), $(this).val());
			});

			$("#node-input-widgettype option").filter(function () { return $(this).val() == node.widgettype; }).attr('selected', true);

			var Lb_Quantity = $('#id-form-quantity')
			var offset_container = $('#id-form-offset')
			var dot = $('#node-input-dot')



			function writedata(id, value) {
				var msg = {
					action: 'recieve',
					payload: {
						signal: '',
						path: '',
						error: 0,
						value: [value]
					}
				}


				$.ajax({
					method: 'POST',
					contentType: 'application/json',
					url: "tags/" + id,
					data: JSON.stringify(msg),
					success: function (resp) {
						RED.notify(RED._("inject tags.success"));
					},
					error: function (jqXHR, textStatus, errorThrown) {

					}
				});
			}


			//dynamic change of S7-Type selectbox (S7_Type) and Datatype selectbox (S7_Datatype) 
			S7_Type.change(function () {
				var f1 = S7_Type.children("option:selected").val();
				var f3 = S7_Datatype.children("option:selected").val();

				dot.hide();
				S7_BitOffset.parent().hide();
				Lb_Quantity.show();
				S7_Quantity.show()
				switch (f1) {
					case "E":
					case "I":
					case "A":
					case "Q":
					case "M":
					case "PI":
					case "PQ": {
						S7_DBnum.hide();
						S7_Datatype.show();
						offset_container.show();
						if (f3 === "X") {
							dot.show();
							S7_BitOffset.parent().show();
							Lb_Quantity.hide();
							S7_Quantity.hide();
						} else if (f3 === "CHAR") {
							dot.hide();
							S7_BitOffset.parent().hide();
							Lb_Quantity.hide();
							S7_Quantity.hide();
						}
						break;
					}
					case "DB": {
						S7_DBnum.show();
						S7_Datatype.show();
						offset_container.show();
						if (f3 === "X") {
							dot.show();
							S7_BitOffset.parent().show();
							Lb_Quantity.hide();
							S7_Quantity.hide();
						} else if (f3 === "CHAR") {
							dot.hide();
							S7_BitOffset.parent().hide();
							Lb_Quantity.hide();
							S7_Quantity.hide();
						}
						break;
					}
					case "T":
					case "C": {
						S7_DBnum.hide();
						S7_Datatype.hide();
						offset_container.show();
						dot.hide();
						S7_BitOffset.parent().hide();
						Lb_Quantity.hide();
						S7_Quantity.hide();
						break;
					}
					default: { }
				}
			});
			S7_Datatype.change(function () {
				var f3 = S7_Datatype.children("option:selected").val();

				switch (f3) {
					case "X":
						dot.show();
						S7_BitOffset.parent().show();
						Lb_Quantity.hide();
						S7_Quantity.hide();
						break;
					case "B":
					case "W":
					case "D":
					case "I":
					case "DI":
					case "uint8":
					case "uint16":
					case "uint32":
					case "int16":
					case "int32":
					case "STRING":
					case "R":
						dot.hide();
						S7_BitOffset.parent().hide();
						Lb_Quantity.show();
						S7_Quantity.show();
						break;
					case "CHAR":
						dot.hide();
						S7_BitOffset.parent().hide();
						Lb_Quantity.hide();
						S7_Quantity.hide();
						break;
					default:
						dot.hide();
						S7_BitOffset.parent().hide();
						Lb_Quantity.hide();
						S7_Quantity.hide();
				}
				var f1 = S7_Type.children("option:selected").val();
				if (f1 === "T" || f1 === "C") {
					dot.hide();
					S7_BitOffset.hide();
					Lb_Quantity.show();
					S7_Quantity.show()
				}

			});

			S7_Type.change();
			S7_Datatype.change();


			/************ Intervall-functionality ********** */
			$("#inject-time-type-select").change(function () {
				var id = $("#inject-time-type-select option:selected").val();
				$(".inject-time-row").hide();
				$("#inject-time-row-" + id).show();
				if ((id == "interval")) {
					$("#node-once").show();
					$("#inject-time-label").show();
					$("#inject-time-interval-count").parent().show();
					$("#inject-time-interval-units").show();
				} else {
					$("#inject-time-label").hide();
					$("#inject-time-interval-count").parent().hide();
					$("#inject-time-interval-units").hide();
					$("#node-once").hide();
					$("#node-input-once").prop('checked', false);
				}
			});
			$("#inject-time-interval-count").spinner({ min: 1 });
			$("#inject-time-interval-units").change(function () {
				var units = $("#inject-time-interval-units option:selected").val();
			});

			var repeattype = "none";
			if (node.repeat != "" && node.repeat != 0) {
				repeattype = "interval";
				var r = "s";
				var c = node.repeat;
				if (node.repeat % 60 === 0) { r = "m"; c = c / 60; }
				if (node.repeat % 1440 === 0) { r = "h"; c = c / 60; }
				$("#inject-time-interval-count").val(c);
				$("#inject-time-interval-units").val(r);
			}
			$("#inject-time-type-select option").filter(function () { return $(this).val() == repeattype; }).attr('selected', true);
			$("#inject-time-type-select").change();



			/************ DataBase-functionality ********** */

			$("#node-input-operation").change(function () {
				var id = $("#node-input-operation option:selected").val();
				var coll_list = [];
				RED.nodes.eachNode((nn) => {
					if (nn.type === 's7.db.in') {
						if (id === nn.configNode) {
							coll_list.push({ id: nn.id, name: nn.name });
						}
					}
				})

				$("#node-input-operation").empty();
				$.each(coll_list, function (i, nn) {
					$("#node-input-operation").append($('<option/>', {
						selected: nn.id === node.operation ? true : false,
						value: nn.id,
						text: nn.name
					}));
				});
			});


			var db_list = [];
			RED.nodes.eachConfig((nn) => {
				if (nn.type === 's7.db') {
					db_list.push({ id: nn.id, name: nn.name });
				}
			})


			var listdatabase = $("#node-input-operation");
			$.each(db_list, function (i, nn) {
				listdatabase.append($('<option/>', {
					selected: nn.id === node.db ? true : false,
					value: nn.id,
					text: nn.name
				}));
			});
			listdatabase.change();










			$("#db-inject-time-type-select").change(function () {
				var id = $("#db-inject-time-type-select option:selected").val();
				$(".inject-time-row").hide();
				$("#inject-time-row-" + id).show();
				if ((id == "interval")) {
					$("#db-inject-time-label").show();
					$("#db-inject-time-interval-count").parent().show();
					$("#db-inject-time-interval-units").show();
				} else {
					$("#db-inject-time-label").hide();
					$("#db-inject-time-interval-count").parent().hide();
					$("#db-inject-time-interval-units").hide();
				}
			});
			$("#db-inject-time-interval-count").spinner({ min: 1 });
			$("#db-inject-time-interval-units").change(function () {
				var units = $("#db-inject-time-interval-units option:selected").val();
			});

			var repeattype = "none";
			if (node.dbrepeat != "" && node.dbrepeat != 0) {
				repeattype = "interval";
				var r = "s";
				var c = node.dbrepeat;
				if (node.dbrepeat % 60 === 0) { r = "m"; c = c / 60; }
				if (node.dbrepeat % 1440 === 0) { r = "h"; c = c / 60; }
				$("#db-inject-time-interval-count").val(c);
				$("#db-inject-time-interval-units").val(r);
			}
			$("#db-inject-time-type-select option").filter(function () { return $(this).val() == repeattype; }).attr('selected', true);
			$("#db-inject-time-type-select").change();
		},
		oneditsave: function () {
			var node = this;
			var S7_Name = $('#node-config-signal-name');
			var S7_BitOffset = $('#node-input-bit-offset');
			var S7_Quantity = $('#node-config-input-quantity');
			var S7_DBnum = $('#node-input-DBnum');
			var S7_Offset = $('#node-input-offset');
			var S7_Type = $('#node-input-s7Type');
			var S7_Datatype = $('#node-input-s7DataType');
			var s7_Topic = $('#node-input-topic');
			var s7_Once = $('#node-input-once');

			//Intervall-functionality
			var none = false;
			var repeat = "";
			var type = $("#inject-time-type-select option:selected").val();

			if (type == "none") {
				none = true;
			} else if (type == "interval") {
				var count = $("#inject-time-interval-count").val();
				var units = $("#inject-time-interval-units option:selected").val();
				if (units == "s") {
					repeat = count;
				} else if (units == "m") {
					repeat = count * 60;
				} else if (units == "h") {
					repeat = count * 60 * 60;
				}
			}



			node.name = S7_Name.val()
			node.payload = { S7_Type: S7_Type.val(), S7_DBnum: S7_DBnum.val(), S7_Datatype: S7_Datatype.val(), S7_Offset: S7_Offset.val(), S7_BitOffset: S7_BitOffset.val(), S7_Quantity: S7_Quantity.val(), S7_Name: S7_Name.val() };
			node.topic = s7_Topic.val();
			node.repeat = repeat;
			node.none = none;
			node.once = s7_Once.val();


			node.maxvalue = $('#node-config-maxvalue').val();
			node.unit = $('#node-config-unit').val();

			node.color = $('#node-input-color').val();

			node.widgettype = $('#node-input-widgettype option:selected').val();




			none = false;
			repeat = "";
			type = $("#db-inject-time-type-select option:selected").val();

			if (type == "none") {
				none = true;
			} else if (type == "interval") {
				var count = $("#db-inject-time-interval-count").val();
				var units = $("#db-inject-time-interval-units option:selected").val();
				if (units == "s") {
					repeat = count;
				} else if (units == "m") {
					repeat = count * 60;
				} else if (units == "h") {
					repeat = count * 60 * 60;
				}
			}


			node.db = $("#node-input-operation").val();
			node.operation = $("#node-input-operation").val();

			node.dbrepeat = repeat;
			node.dbnone = none;

			//var nodeConfig = RED.nodes.node(node.connection)
			//nodeConfig.payload[node.id] = node.payload
		},

		oneditcancel: function () {

		},
		onwsprepare: function () {
			var node = this;
			var nn = this;
			var item_id = node.id.replace(".", "-");
			var unit = 'Seconds';
			var xformat = 'HH:mm:ss';

			startdate = moment().subtract(5, 'minute');
			enddate = moment();
			console.log('startdate :', startdate)
			console.log('enddate :', enddate)
			var container = $('#system-main-container');
			container.empty()
			var msg_container = $('<div id="system-message-container"></div>').appendTo(container)

			var card_item = $(`<div class="card">`).appendTo(container)
			var card_header = $(`<div class="card-header">
                                    <h3 class="card-title"><i class="fa fa-tag"></i><strong>  ${node.name}</strong></h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="card-refresh" data-source="widgets.html" data-source-selector="#card-refresh-content" data-load-on-init="false"><i class="fas fa-sync-alt"></i></button>
                                        <button type="button" class="btn btn-tool" data-card-widget="maximize"><i class="fas fa-expand"></i></button>
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>`).on("dblclick", function () { RED.editor.edit(node); }).appendTo(card_item);





			var component_content = $(`<div class="card-body">`).appendTo(card_item);
			var card_footer = $(`<div class="card-footer">`).appendTo(card_item);

			var chart_component = `<div id='${item_id}-chart' style='height: 100%;width: 100%; '></div>`


			function show_spinner() {
				component_content.empty();
				var spinner = $(`<div id ='${item_id}-spinner'  class='tp-spinner'>
														<span class='tb-spinner tb-spinner-is-centered'> </span>
                                                    </div>`).appendTo(component_content)
			}



			function load_data() {
				var date = { startdate: startdate, enddate: enddate }
				var data = { date: date, unit: unit }
				show_spinner();
				$.ajax({
					method: 'POST',
					contentType: 'application/json',
					url: "io/" + nn.id,
					data: JSON.stringify(data),
					success: function (data) {
						console.log('Dataaa IO :', data)
						init_chart(data)

						//  init_table(data)


					},
					error: function (jqXHR, textStatus, errorThrown) {
						console.log("Unexpected error saving user settings:", jqXHR.status, textStatus);
					}
				});
			}

			function init_chart(data) {
				var theme = {
					color: [
						'#26B99A', '#34495E', '#BDC3C7', '#3498DB',
						'#9B59B6', '#8abb6f', '#759c6a', '#bfd3b7'
					],

					title: {
						itemGap: 8,
						textStyle: {
							fontWeight: 'normal',
							color: '#408829'
						}
					},

					dataRange: {
						color: ['#1f610a', '#97b58d']
					},

					toolbox: {
						color: ['#408829', '#408829', '#408829', '#408829']
					},

					tooltip: {
						backgroundColor: 'rgba(0,0,0,0.5)',
						axisPointer: {
							type: 'line',
							lineStyle: {
								color: '#408829',
								type: 'dashed'
							},
							crossStyle: {
								color: '#408829'
							},
							shadowStyle: {
								color: 'rgba(200,200,200,0.3)'
							}
						}
					},

					dataZoom: {
						dataBackgroundColor: '#eee',
						fillerColor: 'rgba(64,136,41,0.2)',
						handleColor: '#408829'
					},
					grid: {
						borderWidth: 0
					},

					categoryAxis: {
						axisLine: {
							lineStyle: {
								color: '#408829'
							}
						},
						splitLine: {
							lineStyle: {
								color: ['#eee']
							}
						}
					},

					valueAxis: {
						axisLine: {
							lineStyle: {
								color: '#408829'
							}
						},
						splitArea: {
							show: true,
							areaStyle: {
								color: ['rgba(250,250,250,0.1)', 'rgba(200,200,200,0.1)']
							}
						},
						splitLine: {
							lineStyle: {
								color: ['#eee']
							}
						}
					},
					timeline: {
						lineStyle: {
							color: '#408829'
						},
						controlStyle: {
							normal: { color: '#408829' },
							emphasis: { color: '#408829' }
						}
					},

					k: {
						itemStyle: {
							normal: {
								color: '#68a54a',
								color0: '#a9cba2',
								lineStyle: {
									width: 1,
									color: '#408829',
									color0: '#86b379'
								}
							}
						}
					},
					map: {
						itemStyle: {
							normal: {
								areaStyle: {
									color: '#ddd'
								},
								label: {
									textStyle: {
										color: '#c12e34'
									}
								}
							},
							emphasis: {
								areaStyle: {
									color: '#99d2dd'
								},
								label: {
									textStyle: {
										color: '#c12e34'
									}
								}
							}
						}
					},
					force: {
						itemStyle: {
							normal: {
								linkStyle: {
									strokeColor: '#408829'
								}
							}
						}
					},
					chord: {
						padding: 4,
						itemStyle: {
							normal: {
								lineStyle: {
									width: 1,
									color: 'rgba(128, 128, 128, 0.5)'
								},
								chordStyle: {
									lineStyle: {
										width: 1,
										color: 'rgba(128, 128, 128, 0.5)'
									}
								}
							},
							emphasis: {
								lineStyle: {
									width: 1,
									color: 'rgba(128, 128, 128, 0.5)'
								},
								chordStyle: {
									lineStyle: {
										width: 1,
										color: 'rgba(128, 128, 128, 0.5)'
									}
								}
							}
						}
					},
					gauge: {
						startAngle: 225,
						endAngle: -45,
						axisLine: {
							show: true,
							lineStyle: {
								color: [[0.2, '#86b379'], [0.8, '#68a54a'], [1, '#408829']],
								width: 8
							}
						},
						axisTick: {
							splitNumber: 10,
							length: 12,
							lineStyle: {
								color: 'auto'
							}
						},
						axisLabel: {
							textStyle: {
								color: 'auto'
							}
						},
						splitLine: {
							length: 18,
							lineStyle: {
								color: 'auto'
							}
						},
						pointer: {
							length: '90%',
							color: 'auto'
						},
						title: {
							textStyle: {
								color: '#333'
							}
						},
						detail: {
							textStyle: {
								color: 'auto'
							}
						}
					},
					textStyle: {
						fontFamily: 'Arial, Verdana, sans-serif'
					}
				};



				component_content.empty();
				component_content.append(chart_component);

				if (chart_component.length) {

					node.ioechartBar = echarts.init(document.getElementById(`${item_id}-chart`), 'infographic');




					var title = {
						show: true,
						text: node.name,
						subtext: 'In real time',
						left: 'left',
						top: 'top',
					};

					var toolbox = {
						show: true,
						orient: 'horizontal',
						left: 'right',
						top: 'top',
						feature: {
							magicType: {
								show: true,
								title: {
									line: 'Line',
									bar: 'Bar',
									stack: 'Stack',
									tiled: 'Tiled'
								},
								type: ['line', 'bar', 'stack', 'tiled']
							},
							restore: {
								show: true,
								title: "Restore"
							},
							saveAsImage: {
								show: true,
								title: "Save Image"
							},
							dataZoom: {
								yAxisIndex: 'none',
								title: 'Zoom'
							},
							myfeature: {
								show: true,
								title: 'Maximize',
								icon: 'path://M432.45,595.444c0,2.177-4.661,6.82-11.305,6.82c-6.475,0-11.306-4.567-11.306-6.82s4.852-6.812,11.306-6.812C427.841,588.632,432.452,593.191,432.45,595.444L432.45,595.444z M421.155,589.876c-3.009,0-5.448,2.495-5.448,5.572s2.439,5.572,5.448,5.572c3.01,0,5.449-2.495,5.449-5.572C426.604,592.371,424.165,589.876,421.155,589.876L421.155,589.876z M421.146,591.891c-1.916,0-3.47,1.589-3.47,3.549c0,1.959,1.554,3.548,3.47,3.548s3.469-1.589,3.469-3.548C424.614,593.479,423.062,591.891,421.146,591.891L421.146,591.891zM421.146,591.891',
								onclick: function () {
									const element = document.getElementById(`${item_id}`);

									element.webkitRequestFullScreen();
								}
							},
						}
					};

					var tooltip = {
						trigger: 'axis',
						axisPointer: {
							type: 'cross', // 'line' | 'shadow'
							animation: true,
						},
						/* formatter: function (params) {
							params = params[0];
							var date = new Date(params.name);
							return date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' : ' + params.value;
						},
						position: function (pt) {
							return [pt[0], '10%'];
						}, */
					};

					var legend = {
						show: true,
						orient: 'horizontal',
						left: 'center',
						top: 'top',
						data: [node.name]
					};


					var grid = {
						left: 10,
						right: 10,
						bottom: 60,
						top: 60,
						containLabel: true
					};

					var xAxis = {
						/* name: nn.xname, */
						/* 						axisLabel: {
													formatter: '{value}' + nn.xunit, textStyle: {
														color: '#999'
													}
												}, */
						type: 'category',
						boundaryGap: true,
						splitLine: { show: true },
						splitArea: { show: true },
						axisTick: { show: true },
						axisLine: { show: true },
						data: []
					};

					var yAxis = {
						/* 						name: nn.yname,
												axisLabel: {
													formatter: '{value} ' + nn.yunit, textStyle: {
														color: '#999'
													}
												}, */
						type: 'value',
						boundaryGap: false,
						splitLine: { show: true },
						splitArea: { show: true },
						axisTick: { show: true },
						axisLine: { show: true },

					};

					var dataZoom = [{ show: true, realtime: true, start: 0, end: 100 }, { type: 'inside' }/* , { type: 'slider' } */];





					var markPoint = { data: [] };
					if (true) { markPoint.data.push({ type: 'min', name: 'min' }); }
					if (true) { markPoint.data.push({ type: 'max', name: 'max' }); }
					if (true) { markPoint.data.push({ type: 'average', name: 'average' }); }

					/* 					var markLine = { silent: true, data: [] };
										if (nn.mark_line) { markLine.data.push({ yAxis: parseFloat(nn.mark_line) }) }
					
										if (nn.mark_average_line_show) { markLine.data.push({ type: 'average', name: 'average' }); } */




					//var markArea = { silent: true, data: [] }
					//if (nn.mark_Area_min && nn.mark_Area_max) {
					//	markArea.data.push({ yAxis: '9000000'/* parseFloat(nn.mark_Area_min) */ });
					//	markArea.data.push({ yAxis: '12000000'/* parseFloat(nn.mark_Area_max) } */ });
					//}
					var seriesData = [];
					var series = []
					var xAxisData = [];
					var serie = {};
					var result = data.data.result;

					for (id in result) {
						if (result.hasOwnProperty(id)) {
							xAxisData.push(moment(new Date(result[id].date)).format(xformat));
							seriesData.push(result[id].value)
						}
					}

					serie = { name: node.name, animation: true, smooth: true, type: 'line', data: seriesData, markPoint: markPoint/* , markLine: markLine *//*, markArea: markArea */ }
					series.push(serie)



					xAxis.data = xAxisData;
					options = {
						calculable: true,
						title: title,
						legend: legend,
						toolbox: toolbox,
						tooltip: tooltip,
						dataZoom: dataZoom,
						grid: grid,
						xAxis: xAxis,
						yAxis: yAxis,
						series: series
					}

					node.options = options;
					node.ioechartBar.setOption(options);
					component_content.on("resize", function () {
						node.ioechartBar.resize();

					})

				}


			}

			load_data()

		},
		onredrawnode: function () {
			var node = this;
			
			if (node.options) {
				console.log('node io options')
				/* if (node.options.series[0].data.length <= 60) { */
				node.options.series[0].data.shift();
				node.options.xAxis.data.shift();
				/* } */
				node.options.series[0].data.push(node.status.text.v);


				node.options.xAxis.data.push(moment(new Date()).format('HH:mm:ss'))


			}
			if (node.ioechartBar) {
				console.log('node io ioechartBar')
				var options = {
					xAxis: {
						data: node.options.xAxis.data,
					},


					series: [{
						data: node.options.series[0].data,
					}]

				}

				node.ioechartBar.setOption(options);
			}


		}

	});
</script>
!function(){if(!!window.MSInputMethodContext&&!!document.documentMode&&(window.DOMTokenList.prototype.toggle=function(e,t){1===arguments.length&&(t=!this.contains(e)),this[t?"add":"remove"](e)},"classList"in SVGElement.prototype||Object.defineProperty(SVGElement.prototype,"classList",Object.getOwnPropertyDescriptor(HTMLElement.prototype,"classList")),"children"in SVGElement.prototype||Object.defineProperty(SVGElement.prototype,"children",Object.getOwnPropertyDescriptor(HTMLElement.prototype,"children")),Array.from=function(){if(arguments.length>1)throw new Error("Node-RED's IE11 Array.from polyfill doesn't support multiple arguments");var e=arguments[0],t=[];if(e.forEach)e.forEach((function(e){t.push(e)}));else for(var i=0;i<e.length;i++)t.push(arrayList[i]);return t},0===new Set([0]).size)){var e=Set;Set=function(t){var i=new e;return t&&t.forEach(i.add,i),i},Set.prototype=e.prototype,Set.prototype.constructor=Set}}(),jQuery.propHooks.disabled={set:function(e,t){e.disabled!==t&&(e.disabled=t,t?$(e).trigger("disabled"):$(e).trigger("enabled"))}};var RED=function(){function e(e,t){t=t||function(){};var i,o=/<!-- --- \[red-module:(\S+)\] --- -->/.exec(e.trim());i=o?o[1]:"unknown";try{var n=!1,a=$("<div>"+e+"</div>"),r=a.find("script"),s=r.length;r.each((function(e,o){var r=$(o).attr("src");if(r&&!/^\s*(https?:|\/|\.)/.test(r)){$(o).remove();var d=document.createElement("script");d.onload=function(){0===--s&&($("#red-ui-editor-node-configs").append(a),t())},"module"===$(o).attr("type")&&(d.type="module"),$("#red-ui-editor-node-configs").append(d),d.src=RED.settings.apiRootUrl+r,n=!0}else(/\/ace.js$/.test(r)||/\/ext-language_tools.js$/.test(r))&&(console.warn("Blocked attempt to load",r,"by",i),$(o).remove()),s--})),n||($("#red-ui-editor-node-configs").append(a),t())}catch(e){RED.notify(RED._("notification.errors.failedToAppendNode",{module:i,error:e.toString()}),{type:"error",timeout:1e4}),console.log("["+i+"] "+e.toString()),t()}}function t(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"icons",success:function(t){RED.nodes.setIconSets(t),e&&e()}})}function i(){d.reportProgress(RED._("event.loadNodes",{count:""}),30);var t=localStorage.getItem("editor-language")||i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":t},cache:!1,url:"nodes",success:function(t){var i=t.trim().split(/(?=<!-- --- \[red-module:\S+\] --- -->)/),a=i.length,r=function(){(d.reportProgress(RED._("event.loadNodes",{count:a-i.length+"/"+a}),30+(a-i.length)/a*40),0===i.length)?($("#red-ui-editor").i18n(),$("#red-ui-palette > .red-ui-palette-spinner").hide(),$(".red-ui-palette-scroll").removeClass("hide"),$("#red-ui-palette-search").removeClass("hide"),RED.settings.theme("projects.enabled",!1)?RED.projects.refresh((function(e){o((function(){RED.sidebar.info.refresh(),e||(RED.menu.setDisabled("menu-item-projects-open",!0),RED.menu.setDisabled("menu-item-projects-settings",!0),!1===e||RED.projects.showStartup()),n()}))})):o((function(){RED.sidebar.info.refresh(),n()}))):e(i.shift(),r)};r()}})}function o(e){d.reportProgress(RED._("event.loadFlows"),80),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){if(t){var i=window.location.hash;RED.nodes.version(t.rev),d.reportProgress(RED._("event.importFlows"),90);try{RED.nodes.import(t.flows),RED.nodes.dirty(!1),RED.view.redraw(!0),/^#flow\/.+$/.test(i)&&RED.workspaces.show(i.substring(6))}catch(e){RED.notify(RED._("event.importError",{message:e.message}),{fixed:!0,type:"error"})}}e()}})}function n(){var i={};RED.comms.subscribe("notification/#",(function(e,t){var n=e.split("/")[1];if("runtime-deploy"!==n&&"node"!==n){if("project-update"===n)return d.start("Loading project",0),RED.nodes.clear(),RED.history.clear(),RED.view.redraw(!0),void RED.projects.refresh((function(){o((function(){var e=RED.projects.getActiveProject(),i={"change-branch":RED._("notification.project.change-branch",{project:e.git.branches.local}),"merge-abort":RED._("notification.project.merge-abort"),loaded:RED._("notification.project.loaded",{project:t.project}),updated:RED._("notification.project.updated",{project:t.project}),pull:RED._("notification.project.pull",{project:t.project}),revert:RED._("notification.project.revert",{project:t.project}),"merge-complete":RED._("notification.project.merge-complete")}[t.action];d.end(),RED.notify("<p>"+i+"</p>"),RED.sidebar.info.refresh()}))}));if(t.text){t.default=t.text;var a=RED._(t.text,t),r={type:t.type,fixed:void 0===t.timeout,timeout:t.timeout,id:n};"runtime-state"===n&&("safe-mode"===t.error?r.buttons=[{text:RED._("common.label.close"),click:function(){i[n].hideNotification()}}]:"missing-types"===t.error?(a+="<ul><li>"+t.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.projects.getActiveProject()?r.buttons=[{text:RED._("notification.label.manage-project-dep"),click:function(){i[n].hideNotification(),RED.projects.settings.show("deps")}}]:r.buttons=[{text:RED._("common.label.close"),click:function(){i[n].hideNotification()}}]):"credentials_load_failed"===t.error?RED.settings.theme("projects.enabled",!1)?RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.setupCredentials"),click:function(){i[n].hideNotification(),RED.projects.showCredentialsPrompt()}}]):r.buttons=[{text:RED._("common.label.close"),click:function(){i[n].hideNotification()}}]:"missing_flow_file"===t.error||"missing_package_file"===t.error?RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.setupProjectFiles"),click:function(){i[n].hideNotification(),RED.projects.showFilesPrompt()}}]):"project_empty"===t.error?RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.no"),click:function(){i[n].hideNotification()}},{text:RED._("notification.project.createDefault"),click:function(){i[n].hideNotification(),RED.projects.createDefaultFileSet()}}]):"git_merge_conflict"===t.error&&(RED.nodes.clear(),RED.sidebar.versionControl.refresh(!0),RED.user.hasPermission("projects.write")&&(r.buttons=[{text:RED._("notification.project.mergeConflict"),click:function(){i[n].hideNotification(),RED.sidebar.versionControl.showLocalChanges()}}]))),i.hasOwnProperty(n)?i[n].update(a,r):i[n]=RED.notify(a,r)}else i.hasOwnProperty(n)&&(i[n].close(),delete i[n])}})),RED.comms.subscribe("status/#",(function(e,t){var i=e.split("/"),o=RED.nodes.node(i[1]);o&&(t.hasOwnProperty("text")&&null!==t.text&&/^[a-zA-Z]/.test(t.text)&&(t.text=o._(t.text.toString(),{defaultValue:t.text.toString()})),o.status=t,o.dirtyStatus=!0,o.dirty=!0,XAPP.view.redrawStatus(o))})),RED.comms.subscribe("notification/node/#",(function(i,o){var n,a,r;if("notification/node/added"==i){var s=[];o.forEach((function(t){var i=t.id;RED.nodes.addNodeSet(t),s=s.concat(t.types),RED.i18n.loadNodeCatalog(i,(function(){$.get("nodes/"+i,(function(t){e(t)}))}))})),s.length&&(r="<ul><li>"+s.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:s.length})+r,"success")),t()}else if("notification/node/removed"==i){for(n=0;n<o.length;n++)a=o[n],RED.nodes.removeNodeSet(a.id).added&&(r="<ul><li>"+a.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:a.types.length})+r,"success"));t()}else"notification/node/enabled"==i?o.types&&(RED.nodes.getNodeSet(o.id).added?(RED.nodes.enableNodeSet(o.id),r="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:o.types.length})+r,"success")):$.get("nodes/"+o.id,(function(t){e(t),r="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:o.types.length})+r,"success")}))):"notification/node/disabled"==i?o.types&&(RED.nodes.disableNodeSet(o.id),r="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:o.types.length})+r,"success")):"notification/node/upgraded"==i&&(RED.notify(RED._("palette.event.nodeUpgraded",{module:o.module,version:o.version}),"success"),RED.nodes.registry.setModulePendingUpdated(o.module,o.version))})),RED.comms.subscribe("event-log/#",(function(e,t){var i=e.substring(9);RED.eventLog.log(i,t)})),$(".red-ui-header-toolbar").show(),setTimeout((function(){d.end()}),100)}function a(){$.get("red/about",(function(e){RED.sidebar.help.set('<div style="text-align:center;"><img width="50px" src="red/images/node-red-icon.svg" /></div>'+RED.utils.renderMarkdown(e))}))}function r(){var e;RED.workspaces.init(),RED.statusBar.init(),RED.userSettings.init(),RED.user.init(),RED.notifications.init(),RED.library.init(),RED.keyboard.init(),RED.palette.init(),RED.eventLog.init(),!1!==RED.settings.theme("palette.editable")?RED.palette.editor.init():console.log("Palette editor disabled"),RED.sidebar.init(),RED.settings.theme("projects.enabled",!1)?RED.projects.init():console.log("Projects disabled"),RED.subflow.init(),RED.group.init(),RED.clipboard.init(),RED.search.init(),RED.actionList.init(),RED.editor.init(),RED.diff.init(),e=[],RED.settings.theme("projects.enabled",!1)&&e.push({id:"menu-item-projects-menu",label:RED._("menu.label.projects"),options:[{id:"menu-item-projects-new",label:RED._("menu.label.projects-new"),disabled:!1,onselect:"core:new-project"},{id:"menu-item-projects-open",label:RED._("menu.label.projects-open"),disabled:!1,onselect:"core:open-project"},{id:"menu-item-projects-settings",label:RED._("menu.label.projects-settings"),disabled:!1,onselect:"core:show-project-settings"}]}),e.push({id:"menu-item-view-menu",label:RED._("menu.label.view.view"),options:[{id:"menu-item-palette",label:RED._("menu.label.palette.show"),toggle:!0,onselect:"core:toggle-palette",selected:!0},{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:"core:toggle-sidebar",selected:!0},{id:"menu-item-event-log",label:RED._("eventLog.title"),onselect:"core:show-event-log"},{id:"menu-item-action-list",label:RED._("keyboard.actionList"),onselect:"core:show-action-list"},null]}),e.push(null),RED.settings.theme("menu.menu-item-import-library",!0)&&e.push({id:"menu-item-import",label:RED._("menu.label.import"),onselect:"core:show-import-dialog"}),RED.settings.theme("menu.menu-item-export-library",!0)&&e.push({id:"menu-item-export",label:RED._("menu.label.export"),onselect:"core:show-export-dialog"}),e.push(null),e.push({id:"menu-item-search",label:RED._("menu.label.search"),onselect:"core:search"}),e.push(null),e.push({id:"menu-item-config-nodes",label:RED._("menu.label.displayConfig"),onselect:"core:show-config-tab"}),e.push({id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:"core:add-flow"},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:"core:edit-flow"},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:"core:remove-flow"}]}),e.push({id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:"core:create-subflow"},{id:"menu-item-subflow-convert",label:RED._("menu.label.selectionToSubflow"),disabled:!0,onselect:"core:convert-to-subflow"}]}),e.push({id:"menu-item-group",label:RED._("menu.label.groups"),options:[{id:"menu-item-group-group",label:RED._("menu.label.groupSelection"),disabled:!0,onselect:"core:group-selection"},{id:"menu-item-group-ungroup",label:RED._("menu.label.ungroupSelection"),disabled:!0,onselect:"core:ungroup-selection"},null,{id:"menu-item-group-merge",label:RED._("menu.label.groupMergeSelection"),disabled:!0,onselect:"core:merge-selection-to-group"},{id:"menu-item-group-remove",label:RED._("menu.label.groupRemoveSelection"),disabled:!0,onselect:"core:remove-selection-from-group"}]}),e.push(null),!1!==RED.settings.theme("palette.editable")&&(e.push({id:"menu-item-edit-palette",label:RED._("menu.label.editPalette"),onselect:"core:manage-palette"}),e.push(null)),e.push({id:"menu-item-user-settings",label:RED._("menu.label.settings"),onselect:"core:show-user-settings"}),e.push(null),RED.settings.theme("menu.menu-item-keyboard-shortcuts",!0)&&e.push({id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:"core:show-help"}),e.push({id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label",RED._("menu.label.help")),href:RED.settings.theme("menu.menu-item-help.url","http://nodered.org/docs")}),e.push({id:"menu-item-node-red-version",label:"v"+RED.settings.version,onselect:"core:show-about"}),$('<li><a id="red-ui-header-button-sidemenu" class="button" href="#"><i class="fa fa-bars"></i></a></li>').appendTo(".red-ui-header-toolbar"),RED.menu.init({id:"red-ui-header-button-sidemenu",options:e}),RED.nodes.init(),RED.comms.connect(),$("#red-ui-main-container").show(),RED.actions.add("core:show-about",a),d.reportProgress(RED._("event.loadPalette"),20),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(e){RED.nodes.setNodeList(e),d.reportProgress(RED._("event.loadNodeCatalogs"),25),RED.i18n.loadNodeCatalogs((function(){t(i)}))}}),XAPP.init({apiRootUrl:""})}var s=!1;var d={init:function(){var e=$('<div id="red-ui-loading-progress"></div>').hide(),t=$("<div>").appendTo(e),i=($("<div>",{class:"red-ui-loading-bar-label"}).appendTo(t),$("<div>",{class:"red-ui-loading-bar"}).appendTo(t));$("<span>").appendTo(i);return e},start:function(e,t){e&&d.reportProgress(e,t),$("#red-ui-loading-progress").show()},reportProgress:function(e,t){$(".red-ui-loading-bar-label").text(e),$(".red-ui-loading-bar span").width(t+"%")},end:function(){$("#red-ui-loading-progress").hide(),d.reportProgress("",0)}};return{init:function(e){if(s)throw new Error("RED already initialised");s=!0,ace.require("ace/ext/language_tools"),(e=e||{}).apiRootUrl=e.apiRootUrl||"",e.apiRootUrl&&!/\/$/.test(e.apiRootUrl)&&(e.apiRootUrl=e.apiRootUrl+"/"),e.target=$("#red-ui-editor"),e.target.addClass("red-ui-editor"),function(e){var t=$('<div id="red-ui-header" style="display:none"></div>').appendTo(e.target),i="";$('<ul class="red-ui-header-toolbar hide"></ul>').appendTo(t),$('<div id="red-ui-header-shade" class="hide"></div>').appendTo(t),$('<div id="red-ui-main-container" class="red-ui-sidebar-closed hide"><div id="red-ui-workspace"></div><div id="red-ui-editor-stack"></div><div id="red-ui-palette"></div><div id="red-ui-sidebar"></div><div id="red-ui-sidebar-separator"></div></div>').appendTo(e.target),$('<div id="red-ui-editor-node-configs"></div>').appendTo(e.target),$('<div id="red-ui-full-shade" class="hide"></div>').appendTo(e.target),d.init().appendTo("#red-ui-main-container"),d.start("...",0),$.getJSON(e.apiRootUrl+"theme",(function(e){e.header&&(e.header.url&&(i=$("<a>",{href:e.header.url}).appendTo(i)),e.header.image&&$("<img>",{src:e.header.image}).appendTo(i),e.header.title&&$("<span>").html(e.header.title).appendTo(i))}))}(e),RED.i18n.init(e,(function(){RED.settings.init(e,r)}))},loader:d}}();RED.events=function(){var e={};return{on:function(t,i){e[t]=e[t]||[],e[t].push(i)},off:function(t,i){var o=e[t];if(o)for(var n=0;n<o.length;n++)if(o[n]===i)return void o.splice(n,1)},emit:function(){var t=arguments[0],i=Array.prototype.slice.call(arguments,1);if(RED.events.DEBUG&&console.warn(t,i),e[t])for(var o=0;o<e[t].length;o++)try{e[t][o].apply(null,i)}catch(e){console.warn("RED.events.emit error: ["+t+"] "+e.toString()),console.warn(e)}}}}(),RED.i18n=function(){var e;return{init:function(t,i){e=t.apiRootUrl||"";var o=localStorage.getItem("editor-language"),n={resGetPath:e+"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1,returnObjectTrees:!0};o&&(n.lng=o),i18n.init(n,(function(){i()})),RED._=function(){var e=i18n.t.apply(null,arguments);return"string"==typeof e?e:arguments[0]}},lang:function(){for(var e=i18n.functions.toLanguages(localStorage.getItem("editor-language")||i18n.detectLanguage()),t=RED.settings.theme("languages")||["en-US"],i=0;i<e.length;i++)if(t.indexOf(e[i])>-1)return e[i];return"end-US"},loadNodeCatalog:function(t,i){var o=i18n.functions.toLanguages(localStorage.getItem("editor-language")||i18n.detectLanguage()),n=o.length;o.forEach((function(o){$.ajax({headers:{Accept:"application/json"},cache:!1,url:e+"nodes/"+t+"/messages?lng="+o,success:function(e){i18n.addResourceBundle(o,t,e),0===--n&&i()}})}))},loadNodeCatalogs:function(t){var i=i18n.functions.toLanguages(localStorage.getItem("editor-language")||i18n.detectLanguage()),o=i.length;i.forEach((function(i){$.ajax({headers:{Accept:"application/json"},cache:!1,url:e+"nodes/messages?lng="+i,success:function(e){Object.keys(e).forEach((function(t){i18n.addResourceBundle(i,t,e[t])})),0===--o&&t()}})}))}}}(),RED.settings=function(){var e,t={},i={},o=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},n=function(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(i){!function(e){for(var i in t)t.hasOwnProperty(i)&&RED.settings.hasOwnProperty(i)&&delete RED.settings[i];for(i in e)e.hasOwnProperty(i)&&(RED.settings[i]=e[i]);t=e}(i),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+i.version),console.groupCollapsed("Versions"),console.log("jQuery",$().jquery),console.log("jQuery UI",$.ui.version),console.log("ACE",ace.version),console.log("D3",d3.version),console.groupEnd(),a(e)},error:function(t,i,o){401===t.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login((function(){n(e)}))):console.log("Unexpected error loading settings:",t.status,i)}})};function a(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(t){!function(e){i=e}(t),e()},error:function(e,t,i){console.log("Unexpected error loading user settings:",e.status,t)}})}function r(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout((function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(i),success:function(e){},error:function(e,t,i){console.log("Unexpected error saving user settings:",e.status,t)}})}),300))}return{init:function(e,t){var i=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(i){var o=i[1];RED.settings.set("auth-tokens",{access_token:o}),window.location.search=""}RED.settings.apiRootUrl=e.apiRootUrl,$.ajaxSetup({beforeSend:function(t,i){if(!/^\s*(https?:|\/|\.)/.test(i.url)){e.apiRootUrl&&(i.url=e.apiRootUrl+i.url);var o=RED.settings.get("auth-tokens");o&&t.setRequestHeader("Authorization","Bearer "+o.access_token),t.setRequestHeader("Node-RED-API-Version","v2")}}}),n(t)},load:n,loadUserSettings:a,set:function(e,t){o()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(RED.utils.setMessageProperty(i,e,t),r()))},get:function(e,t){if(o()){if("auth-tokens"===e)return JSON.parse(localStorage.getItem(e));var n;try{void 0===(n=RED.utils.getMessageProperty(i,e))&&(n=t)}catch(e){n=t}return n}},remove:function(e){o()&&("auth-tokens"===e?localStorage.removeItem(e):(delete i[e],r()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var i=e.split("."),o=RED.settings.editorTheme;try{for(var n=0;n<i.length;n++)o=o[i[n]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function e(){$("#red-ui-header-button-user-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},(function(){RED.settings.load((function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),e(),RED.events.emit("login",RED.settings.user.username)}))}))}}):(RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var t=/^((.+)\.)?read$/,i=/^((.+)\.)?write$/;function o(e,n){if(""===n)return!0;var a;if(Array.isArray(n)){for(a=0;a<n.length;a++)if(!o(e,n[a]))return!1;return!0}if(Array.isArray(e)){if(0===e.length)return!1;for(a=0;a<e.length;a++)if(o(e[a],n))return!0;return!1}return"*"===e||e===n||("read"===e||"*.read"===e?t.test(n):("write"===e||"*.write"===e)&&i.test(n))}return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var t=$('<li><a id="red-ui-header-button-user" class="button hide" href="#"></a></li>').prependTo(".red-ui-header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(t.find("a")):$('<i class="fa fa-user"></i>').appendTo(t.find("a")),RED.menu.init({id:"red-ui-header-button-user",options:[]}),e()}},login:function(t,i){"function"==typeof t&&(i=t,t={});var o=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');o.dialog({autoOpen:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},modal:!0,closeOnEscape:!!t.cancelable,width:600,resizable:!1,draggable:!1,close:function(e,t){$("#node-dialog-login").dialog("destroy").remove(),RED.keyboard.enable()}}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(n){var a=0;if("credentials"==n.type){for(;a<n.prompts.length;a++){var r=n.prompts[a],s=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+r.id+'">'+RED._(r.label)+":</label><br/>").appendTo(s);var d=$('<input style="width: 100%" id="node-dialog-login-'+r.id+'" type="'+r.type+'" tabIndex="'+(a+1)+'"/>').appendTo(s);a<n.prompts.length-1&&d.keypress(function(){var e=s;return function(t){13==t.keyCode&&(e.next("div").find("input").trigger("focus"),t.preventDefault())}}()),s.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(t.cancelable?'<a href="#" id="node-dialog-login-cancel" class="red-ui-button" style="margin-right: 20px;" tabIndex="'+(a+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" class="red-ui-button" style="width: auto;" tabIndex="'+(a+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").on("submit",(function(o){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var a={client_id:"node-red-editor",grant_type:"password",scope:""},r=0;r<n.prompts.length;r++){var s=n.prompts[r];a[s.id]=$("#node-dialog-login-"+s.id).val()}$.ajax({url:"auth/token",type:"POST",data:a}).done((function(o,n,a){RED.settings.set("auth-tokens",o),t.updateMenu&&e(),$("#node-dialog-login").dialog("close"),i()})).fail((function(e,t,i){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()})).always((function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()})),o.preventDefault()}))}else if("strategy"==n.type)for(a=0;a<n.prompts.length;a++){r=n.prompts[a],s=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var l=$('<a href="#" class="red-ui-button"></a>',{style:"padding: 10px"}).appendTo(s).on("click",(function(){document.location=r.url}));if(r.image)$("<img>",{src:r.image}).appendTo(l);else if(r.label){var c=$("<span></span>").text(r.label);r.icon&&($("<i></i>",{class:"fa fa-2x "+r.icon,style:"vertical-align: middle"}).appendTo(l),c.css({verticalAlign:"middle",marginLeft:"8px"})),c.appendTo(l)}l.button()}t.cancelable&&$("#node-dialog-login-cancel").button().on("click",(function(e){$("#node-dialog-login").dialog("close")}));var p=n.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load((function(){o.dialog("open")})).attr("src",p),RED.keyboard.disable()}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done((function(e,t,i){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)})).fail((function(e,t,i){401===e.status?document.location.reload(!0):console.log(t)}))},hasPermission:function(e){return""===e||(!RED.settings.user||o(RED.settings.user.permissions||"",e))}}}(),RED.comms=function(){var e,t=null,i=null,o=null,n=10,a={},r=!1,s=0,d=!1;return{connect:function l(){var c;if(d=!0,RED.settings.apiRootUrl){var p=/^(https?):\/\/(.*)$/.exec(RED.settings.apiRootUrl);p&&(console.log(p),c="ws"+("https"===p[1]?"s":"")+"://"+p[2]+"comms")}else{var u=location.hostname,f=location.port;0!==f.length&&(u=u+":"+f),u=(u+=document.location.pathname)+("/"==u.slice(-1)?"":"/")+"comms",c="ws"+("https:"==document.location.protocol?"s":"")+"://"+u}var h=RED.settings.get("auth-tokens");function g(){for(var t in a)a.hasOwnProperty(t)&&e.send(JSON.stringify({subscribe:t}))}r=null!=h,(e=new WebSocket(c)).onopen=function(){s=0,t&&(i=setTimeout((function(){t.close(),t=null}),1e3)),r?e.send(JSON.stringify({auth:h.access_token})):g()},e.onmessage=function(e){var t=JSON.parse(e.data);if(t.auth)r&&"ok"===t.auth?(r=!1,g()):"fail"===t.auth&&(d=!1,RED.user.login({updateMenu:!0},(function(){l()})));else for(var i=0;i<t.length;i++){var o=t[i];if(o.topic)for(var n in a){if(a.hasOwnProperty(n))if(new RegExp("^"+n.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(o.topic)){var s=a[n];if(s)for(var c=0;c<s.length;c++)s[c](o.topic,o.data)}}}},e.onclose=function(){d&&(i&&(clearTimeout(i),i=null),++s<10?(setTimeout(l,1e3),s>5&&null==t&&(t=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):s<20?setTimeout(l,2e3):(n=60,o=setInterval((function(){if(0===--n)t.update(RED._("notification.errors.lostConnection")),clearInterval(o),l();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:n})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";t.update(e,{silent:!0}),$(t).find("a").on("click",(function(e){e.preventDefault(),t.update(RED._("notification.errors.lostConnection"),{silent:!0}),clearInterval(o),l()}))}}),1e3)))}},subscribe:function(t,i){null==a[t]&&(a[t]=[]),a[t].push(i),e&&1==e.readyState&&e.send(JSON.stringify({subscribe:t}))},unsubscribe:function(e,t){if(a[e]){for(var i=0;i<a[e].length;i++)if(a[e][i]===t){a[e].splice(i,1);break}0===a[e].length&&delete a[e]}}}}(),RED.text={},RED.text.bidi=function(){var e="";function t(e){return e>64&&e<91||e>96&&e<123}function i(i){return"auto"==e?function(e){for(var i,o=e.length,n=0;n<o;n++){if((i=e.charCodeAt(n))>=1488&&i<=1535||i>=1536&&i<=1631||i>=1642&&i<=1775||i>=1786&&i<=2047||i>=64285&&i<=65023||i>=65136&&i<=65276)return!0;if(t(e.charCodeAt(n)))return!1}return!1}(i)?"rtl":"ltr":e}function o(){$(this).attr("dir",i($(this).val()))}return{setTextDirection:function(t){e=t,RED.nodes.eachNode((function(e){e.dirty=!0})),RED.view.redraw(),RED.palette.refresh(),$("#red-ui-workspace").find("span.red-ui-text-bidi-aware").each((function(){$(this).attr("dir",i($(this).html()))})),$("#red-ui-sidebar").find("span.red-ui-text-bidi-aware").each((function(){$(this).attr("dir",i($(this).text()))}))},enforceTextDirectionWithUCC:function(e){if(e){var t=i(e);if("ltr"==t)return"‪"+e+"‬";if("rtl"==t)return"‫"+e+"‬"}return e},resolveBaseTextDir:i,prepareInput:function(e){e.on("keyup",o).on("paste",o).on("cut",o),o.call(e)}}}(),RED.text.format=function(){var e=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},t=function(){function t(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var i=parseInt(e.length,10);return isNaN(i)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function i(e,t){var i={};for(var o in t)t.hasOwnProperty(o)&&(i[o]=t[o]);var n=e.content,a=i.usePos&&i.startPos<n.length;a&&(i.start="",i.loops=!1),i.bStart=a?i.startPos:i.start.length>0?n.indexOf(i.start):0;var r=i.useLength&&i.length>0&&i.bStart+i.length<n.length;return r&&(i.end=""),i.bEnd=r?i.bStart+i.length:i.end.length>0?n.indexOf(i.end,i.bStart+i.start.length)+1:n.length,i.after||(i.start=""),i.before||(i.end=""),i}return{handleSubcontents:function(t,i,o,n,a){if(!o.content||"string"!=typeof o.content||0===o.content.length)return t;var r=!0;void 0!==o.loops&&(r=!!o.loops);for(var s=0;!(s>=t.length);s++)if(!(t[s].isParsed||t.keep||t[s].isSeparator)){var d=t[s].content,l=d.indexOf(o.content);if(!(l<0)){var c,p=0;if(o.continued)do{p++,c=d.indexOf(o.content,l+p*o.content.length)}while(0===c);else p=1;if(c=l+p*o.content.length,t.splice(s,1),l>0&&(t.splice(s,0,new e({content:d.substring(0,l),localGui:i.dir,keep:!0})),s++),t.splice(s,0,new e({content:d.substring(l,c),textDirection:o.subDir,localGui:i.dir})),c<d.length&&t.splice(s+1,0,new e({content:d.substring(c,d.length),localGui:i.dir,keep:!0})),!r)break}}},handleBounds:function(o,n,a,r,s){for(var d=0;d<a.length;d++)if(t(a[d]))for(var l=0;!(l>=o.length);l++)if(!(o[l].isParsed||o[l].inBounds||o.keep||o[l].isSeparator)){var c=i(o[l],a[d]),p=c.bStart,u=c.bEnd;if(!(p<0||u<0)){var f=o[l].content;if(o.splice(l,1),p>0&&(o.splice(l,0,new e({content:f.substring(0,p),localGui:n.dir,keep:!0})),l++),c.start&&(o.splice(l,0,new e({content:c.start,localGui:n.dir,isSeparator:!0})),l++),o.splice(l,0,new e({content:f.substring(p+c.start.length,u-c.end.length),textDirection:c.subDir,localGui:n.dir,inBounds:!0})),c.end&&(l++,o.splice(l,0,new e({content:c.end,localGui:n.dir,isSeparator:!0}))),u+c.end.length<f.length&&o.splice(l+1,0,new e({content:f.substring(u+c.end.length,f.length),localGui:n.dir,keep:!0})),!c.loops)break}}for(d=0;d<o.length;d++)o[d].inBounds=!1;return o},handleCases:function(e,t,i,o,n){if(0===i.length)return e;var a={};for(var r in t)t.hasOwnProperty(r)&&(a[r]=t[r]);for(var s=0;s<i.length;s++)i[s].handler&&"function"==typeof i[s].handler.handle||(i[s].handler=t.commonHandler),i[s].args?(a.cases=i[s].args.cases,a.points=i[s].args.points,a.bounds=i[s].args.bounds,a.subs=i[s].args.subs):(a.cases=[],a.points=[],a.bounds=[],a.subs={}),i[s].handler.handle(o,e,a,n);return e},handlePoints:function(t,i,o,n,a){for(var r=0;r<o.length;r++)for(var s=0;!(s>=t.length);s++)if(!(t[s].isParsed||t[s].keep||t[s].isSeparator)){var d=t[s].content,l=d.indexOf(o[r]);l>=0&&(t.splice(s,1),l>0&&(t.splice(s,0,new e({content:d.substring(0,l),textDirection:i.subDir,localGui:i.dir,inPoints:!0})),s++),t.splice(s,0,new e({content:o[r],localGui:i.dir,isSeparator:!0})),l+o[r].length+1<=d.length&&t.splice(s+1,0,new e({content:d.substring(l+o[r].length),textDirection:i.subDir,localGui:i.dir,inPoints:!0})))}for(r=0;r<t.length;r++)t[r].keep?t[r].keep=!1:t[r].inPoints&&(t[r].isParsed=!0,t[r].inPoints=!1);return t}}}(),i={handle:function(e,i,o,n){var a=[];Array.isArray(o.cases)&&(a=o.cases);var r=[];void 0!==o.points&&(Array.isArray(o.points)?r=o.points:"string"==typeof o.points&&(r=o.points.split("")));var s={};"object"==typeof o.subs&&(s=o.subs);var d=[];return Array.isArray(o.bounds)&&(d=o.bounds),t.handleBounds(i,o,d,e,n),t.handleSubcontents(i,o,s,e,n),t.handleCases(i,o,a,e,n),t.handlePoints(i,o,r,e,n),i}},o={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),function(e){var t=e?e.split("-")[0]:"";return!(!t||t.length<2)&&["iw","he","ar","fa","ur"].some((function(e){return e===t}))}(e=e.toLowerCase())){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,i,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;i=/^(rtl|ltr)$/i.test(i)?i:"ltr";var n=o?e.split("").reverse().join(""):e,a=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(n);return a?a[0]<="z"?"ltr":"rtl":i},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var i="",o=0;o<e.length;o++){var n=""+e.charAt(o);switch(n){case"‎":i+="<LRM>";break;case"‏":i+="<RLM>";break;case"‪":i+="<LRE>";break;case"‫":i+="<RLE>";break;case"‭":i+="<LRO>";break;case"‮":i+="<RLO>";break;case"‬":i+="<PDF>";break;default:i+=n}}var a=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return a+i+(""===a?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},n=function(){var t={};function n(e,t){var o=Array.isArray(e)?e[0]:e;return o.guiDir||(o.guiDir="ltr"),o.dir||(o.dir=o.guiDir),t?(void 0===o.points&&(o.points=[]),o.cases||(o.cases=[]),o.bounds||(o.bounds=[]),o.commonHandler=i,o):o}function a(t,o,a){if(!t||!o)return new e({content:""});var r=n(o,!0),s=[new e({content:t,actual:t,localGui:r.dir})],d=i.handle;return r.handler&&"function"==typeof r.handler&&(d=r.handler.handle),d(t,s,r,a),s}function r(e,t,i){var a=n(t,!1);return i?function(e,t,i){for(var n="",a="",r=0;r<e.length;r++)if(e[r].isVisible){var s=e[r].textDirection,d=e[r].localGui;if(""!==d&&""===a?n+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>":""===a||""!==d&&d===a&&!stop||(n+="</bdi>"+(r==e.length-1&&""!==d?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==d&&(n+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>")),"auto"===s&&(s=o.getDirection(e[r].content,s,t.guiDir)),/^(rtl|ltr)$/i.test(s)?(n+="<bdi dir='"+("rtl"===s?"rtl":"ltr")+"'>"+e[r].content+"</bdi>",s):(n+=e[r].content,o.getDirection(e[r].content,s,t.guiDir,!0)),r<e.length-1)n+="<span style='unicode-bidi: embed; direction: "+("rtl"===(d&&e[r+1].localGui?d:t.dir)?"rtl":"ltr")+";'></span>";else""!==a&&(n+="</bdi>");a=d,stop=!1}else stop=!0;var l="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;l!==t.guiDir&&(n="<bdi dir='"+("rtl"===l?"rtl":"ltr")+"'>"+n+"</bdi>");return n}(e,a):function(e,t,i){for(var n="",a="",r=!1,s=0;s<e.length;s++)if(e[s].isVisible){var d=e[s].textDirection,l=e[s].localGui;if(""!==l&&""===a?n+="rtl"===l?o.RLE:o.LRE:""===a||""!==l&&l===a&&!r||(n+=o.PDF+(s==e.length-1&&""!==l?"":"rtl"===t.dir?o.RLM:o.LRM),""!==l&&(n+="rtl"===l?o.RLE:o.LRE)),"auto"===d&&(d=o.getDirection(e[s].content,d,t.guiDir)),/^(rtl|ltr)$/i.test(d)?(n+=("rtl"===d?o.RLE:o.LRE)+e[s].content+o.PDF,d):(n+=e[s].content,o.getDirection(e[s].content,d,t.guiDir,!0)),s<e.length-1)n+="rtl"===(l&&e[s+1].localGui?l:t.dir)?o.RLM:o.LRM;else""!==a&&(n+=o.PDF);a=l,r=!1}else r=!0;var c="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(n=("rtl"===c?o.RLE:o.LRE)+n+o.PDF);return n}(e,a)}return t.parseAndDisplayStructure=function(e,t,i,o){return e&&t?r(a(e,t,o),t,i):e},t.parseStructure=a,t.displayStructure=r,t.restore=function(e,t){return e},t}(),a={format:function(e,t,i,o,a,r){var s={guiDir:i?"rtl":"ltr",dir:t.dir?t.dir:i?"rtl":"ltr",subs:{content:">",continued:!0,subDir:i?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:i?"ltr":"rtl"}}}]};return r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},r={format:function(e,t,i,o,a,r){var s={guiDir:i?"rtl":"ltr",dir:"ltr",points:","};return r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},s=function(){function e(e,t){if("ar"!==o.getLocaleDetails(t).lang)return"ltr";var i=e.indexOf("@");return i>0&&i<e.length-1&&o.hasArabicChar(e.substring(i+1))?"rtl":"ltr"}return{format:function(t,o,a,r,s,d){var l={guiDir:a?"rtl":"ltr",dir:e(t,s),points:"<>.:,;@",cases:[{handler:i,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return d?n.parseStructure(t,l,!!r,s):n.parseAndDisplayStructure(t,l,!!r,s)}}}(),d={format:function(e,t,i,o,a,r){var s={guiDir:i?"rtl":"ltr",dir:"ltr",points:"/\\:."};return r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},l={format:function(e,t,i,o,a,r){var s={guiDir:i?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},c={format:function(e,t,o,a,r,s){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:i,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:i,args:{subs:{content:" ",continued:!0}}},{handler:i,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return s?n.parseStructure(e,d,!!a,r):n.parseAndDisplayStructure(e,d,!!a,r)}},p={format:function(e,t,i,o,a,r){var s={guiDir:i?"rtl":"ltr",dir:"ltr",points:"_"};return r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},u={format:function(e,t,i,o,a,r){var s={guiDir:i?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},f={format:function(e,t,i,o,a,r){var s={guiDir:i?"rtl":"ltr",dir:t.dir?t.dir:i?"rtl":"ltr",points:" ,.!?;:"};return r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},h={format:function(e,t,o,a,r,s){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:i,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return s?n.parseStructure(e,d,!!a,r):n.parseAndDisplayStructure(e,d,!!a,r)}},g={format:function(e,t,i,o,a,r){var s={},d="",l=Array.isArray(t)?t[0]:t;for(d in l)l.hasOwnProperty(d)&&(s[d]=l[d]);return s.guiDir=i?"rtl":"ltr",s.dir=s.dir?s.dir:s.guiDir,r?n.parseStructure(e,s,!!o,a):n.parseAndDisplayStructure(e,s,!!o,a)}},v=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function i(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function o(e){0===e.msgDir.length&&(e.msgDir=i(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:i(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function b(e){switch(e){case"breadcrumb":return a;case"comma":return r;case"email":return s;case"filepath":return d;case"formula":return l;case"sql":return c;case"underscore":return p;case"url":return u;case"word":return f;case"xpath":return h;default:return g}}function m(e,t,i,n,a){if(!e||1!=e.nodeType)return!1;v||(v=document.createEvent("Event")).initEvent("TF",!0,!0),e.setAttribute("data-tf-type",t);var r="undefined"===i?"{}":JSON.stringify(Array.isArray(i)?i[0]:i);e.setAttribute("data-tf-args",r);var s="ltr";if("undefined"===n&&(e.dir?s=e.dir:e.style&&e.style.direction&&(s=e.style.direction),n="rtl"===s.toLowerCase()),e.setAttribute("data-tf-dir",n),e.setAttribute("data-tf-locale",o.getLocaleDetails(a).lang),function(e){var t=window.navigator.userAgent;if(t.indexOf("MSIE")>=0||t.indexOf("Trident")>=0||t.indexOf("Edge")>=0)return!1;var i=document.createElement(e.tagName);i.contentEditable=!0;var o="oninput"in i;return o||(i.setAttribute("oninput","return;"),o="function"==typeof i.oninput),i=null,o}(e)){e.oninput;e.oninput=function(e){y(e.target)}}else e.onkeyup=function(t){y(t.target),e.dispatchEvent(v)},e.onmouseup=function(t){y(t.target),e.dispatchEvent(v)};return y(e),!0}function y(e){var t=e.textContent||"",i=document.getSelection();if(0===t.length||!i||i.rangeCount<=0)e.dispatchEvent(v);else{var o,n,a=i.getRangeAt(0),r=a.cloneRange();o=a.startContainer,n=a.startOffset;var s=0;3===o.nodeType&&(s+=n),r.setStart(e,0),r.setEndBefore(o);var d=document.createElement("div");d.appendChild(r.cloneContents()),s+=d.textContent.length,e.innerHTML=b(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var l=e,c=e,p=0,u=!1;for(i.removeAllRanges(),a.setStart(e,0),a.setEnd(e,0);c;){if(3===c.nodeType){if(p+c.nodeValue.length>=s){a.setStart(c,s-p);break}p+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(l=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(l===e){u=!0;break}c=l.nextSibling,l=l.parentNode}if(u)break}i.addRange(a),e.dispatchEvent(v)}}return{
/*!
        * Returns the HTML representation of a given structured text
        * @param text - the structured text
        * @param type - could be one of filepath, url, email
        * @param args - pass additional arguments to the handler. generally null.
        * @param isRtl - indicates if the GUI is mirrored
        * @param locale - the browser locale
        */
getHtml:function(e,t,i,o,n){return b(t).format(e,i,o,!0,n)},
/*!
        * Handle Structured text correct display for a given HTML element.
        * @param element - the element  : should be of type div contenteditable=true
        * @param type - could be one of filepath, url, email
        * @param args - pass additional arguments to the handler. generally null.
        * @param isRtl - indicates if the GUI is mirrored
        * @param locale - the browser locale
        */
attach:function(e,t,i,o,n){return m(e,t,i,o,n)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9,PANNING:10,SELECTING_NODE:11,GROUP_DRAGGING:12,GROUP_RESIZE:13},RED.nodes=function(){var e,t,o={},a={},r={},s=[],d={},l=[],c={},p=null,u={},f={},h=!1;var g=function(){var e={},t=[],i={},o={},n={},a={};n.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}};var r={setModulePendingUpdated:function(t,i){e[t].pending_version=i,RED.events.emit("registry:module-updated",{module:t,version:i})},getModule:function(t){return e[t]},getNodeSetForType:function(e){return r.getNodeSet(o[e])},getModuleList:function(){return e},getNodeList:function(){return t},getNodeTypes:function(){return Object.keys(n)},setNodeList:function(e){t=[];for(var i=0;i<e.length;i++){var o=e[i];r.addNodeSet(o)}},addNodeSet:function(n){n.added=!1,i[n.id]=n;for(var a=0;a<n.types.length;a++)o[n.types[a]]=n.id;t.push(n),e[n.module]=e[n.module]||{name:n.module,version:n.version,local:n.local,sets:{}},n.pending_version&&(e[n.module].pending_version=n.pending_version),e[n.module].sets[n.name]=n,RED.events.emit("registry:node-set-added",n)},removeNodeSet:function(n){for(var a=i[n],r=0;r<a.types.length;r++)delete o[a.types[r]];delete i[n];for(var s=0;s<t.length;s++)if(t[s].id===n){t.splice(s,1);break}return delete e[a.module].sets[a.name],0===Object.keys(e[a.module].sets).length&&delete e[a.module],RED.events.emit("registry:node-set-removed",a),a},getNodeSet:function(e){return i[e]},enableNodeSet:function(e){var t=i[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=i[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var a;(n[e]=t,t.type=e,"subflow:"!=e.substring(0,8))&&(t.set=i[o[e]],i[o[e]].added=!0,i[o[e]].enabled=!0,a="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=a+":"+e[0]);var i=RED._.apply(null,e);return i===e[0]&&(i=t),i});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete n[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return n[e]},setIconSets:function(e){(a=e)["font-awesome"]=RED.nodes.fontAwesome.getIconList()},getIconSets:function(){return a}};return r}();function v(){return(1+4294967295*Math.random()).toString(16)}function b(e){if(0!==e.type.indexOf("subflow"))e._=e._def._;else{var t=e.type.substring(8),i=RED.nodes.subflow(t);i&&i.instances.push(i),e._=RED._}if("config"==e._def.category)r[e.id]=e;else{if(e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.dirty=!0,N(e),"subflows"==e._def.category&&void 0===e.i){var n=0;RED.nodes.eachNode((function(e){n=Math.max(n,e.i||0)})),e.i=n+1}o[e.id]=e,a[e.z]?a[e.z][e.id]=e:console.warn("Node added to unknown tab/subflow:",e)}RED.events.emit("nodes:add",e)}function m(e){s.push(e),RED.events.emit("links:add",e)}function y(e){return e in r?r[e]:e in o?o[e]:null}function w(e){var t,i=[],d=[];if(e in r)t=r[e],delete r[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(e in o){t=o[e],delete o[e],a[t.z]&&delete a[t.z][t.id],(i=s.filter((function(e){return e.source===t||e.target===t}))).forEach(E);var l=!1;for(var c in t._def.defaults)if(t._def.defaults.hasOwnProperty(c)){var p=t._def.defaults[c];if(p.type){var u=g.getNodeType(p.type);if(u&&"config"==u.category){var f=r[t[c]];if(f)if(l=!0,f._def.exclusive)w(t[c]),d.push(f);else{var h=f.users;h.splice(h.indexOf(t),1)}}}}if(0===t.type.indexOf("subflow:")){var v=t.type.substring(8),b=RED.nodes.subflow(v);b&&b.instances.splice(b.instances.indexOf(t),1)}l&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:i,nodes:d}}function E(e){var t=s.indexOf(e);-1!=t&&s.splice(t,1),RED.events.emit("links:remove",e)}function D(e,t){d[e.id]=e,a[e.id]={},e._def=RED.nodes.getType("tab"),void 0===t?l.push(e.id):l.splice(t,0,e.id),RED.events.emit("flows:add",e),void 0!==t&&RED.events.emit("flows:reorder",l)}function R(e,t){if(t){var i=Object.keys(c).map((function(e){return c[e].name}));i.sort();var o=1,n=e.name;i.forEach((function(t){n==t&&(o++,n=e.name+" ("+o+")")})),e.name=n}c[e.id]=e,a[e.id]={},RED.nodes.registerType("subflow:"+e.id,{defaults:{name:{value:""},env:{value:[]}},icon:function(){return e.icon||"subflow.svg"},category:e.category||"subflows",inputs:e.in.length,outputs:e.out.length,color:e.color||"#DDAA99",label:function(){return this.name||RED.nodes.subflow(e.id).name},labelStyle:function(){return this.name?"red-ui-flow-node-label-italic":""},paletteLabel:function(){return RED.nodes.subflow(e.id).name},inputLabels:function(t){return e.inputLabels?e.inputLabels[t]:null},outputLabels:function(t){return e.outputLabels?e.outputLabels[t]:null},oneditprepare:function(){RED.subflow.buildEditForm("subflow",this),RED.subflow.buildPropertiesForm(this)},oneditresize:function(e){var t=e.height;$("ol.red-ui-editor-subflow-env-list").editableList("height",t)},set:{module:"node-red"}}),e.instances=[],e._def=RED.nodes.getType("subflow:"+e.id),RED.events.emit("subflows:add",e)}function x(e){return c[e]}function _(e,t){for(var i in o)if(o.hasOwnProperty(i)){var n=o[i];if(n.z===e){var a=/^subflow:(.+)$/.exec(n.type);if(a){if(a[1]===t)return!0;if(_(a[1],t))return!0}}}return!1}function k(e){var t={};for(var i in t.id=e.id,t.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(i)&&(t[i]=e[i]);return t}function T(e,t){if("tab"===e.type)return k(e);t=t||!1;var i={};if(i.id=e.id,i.type=e.type,i.z=e.z,0!==i.z&&""!==i.z||delete i.z,!0===e.d&&(i.d=!0),e.g&&(i.g=e.g),"unknown"==i.type)for(var o in e._orig)e._orig.hasOwnProperty(o)&&(i[o]=e._orig[o]);else{for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(i[n]=e[n]);if(t){var a={};if(/^subflow:/.test(i.type)&&e.credentials)for(var r in e.credentials)e.credentials.hasOwnProperty(r)&&(!e.credentials._||e.credentials["has_"+r]!=e.credentials._["has_"+r]||e.credentials["has_"+r]&&e.credentials[r])&&(a[r]=e.credentials[r]);else if(e.credentials)for(var d in i.credentials={},e._def.credentials)e._def.credentials.hasOwnProperty(d)&&("password"==e._def.credentials[d].type?(!e.credentials._||e.credentials["has_"+d]!=e.credentials._["has_"+d]||e.credentials["has_"+d]&&e.credentials[d])&&(a[d]=e.credentials[d]):null==e.credentials[d]||e.credentials._&&e.credentials[d]==e.credentials._[d]||(a[d]=e.credentials[d]));Object.keys(a).length>0&&(i.credentials=a)}}if("group"===e.type&&(i.x=e.x,i.y=e.y,i.w=e.w,i.h=e.h,i.nodes=i.nodes.filter((function(e){return!!e})).map((function(e){return e.id}))),"config"!=e._def.category){i.x=e.x,i.y=e.y,i.wires=[];for(var l=0;l<e.outputs;l++)i.wires.push([]);for(var c=s.filter((function(t){return t.source===e})),p=0;p<c.length;p++){var u=c[p];"subflow"!=u.target.type&&u.sourcePort<i.wires.length&&i.wires[u.sourcePort].push(u.target.id)}if(e.inputs>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(i.inputLabels=e.inputLabels.slice()),e.outputs>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(i.outputLabels=e.outputLabels.slice()),(!e._def.defaults||!e._def.defaults.hasOwnProperty("icon"))&&e.icon){var f=RED.utils.getDefaultNodeIcon(e._def,e);e.icon!==f.module+"/"+f.file&&(i.icon=e.icon)}if((!e._def.defaults||!e._def.defaults.hasOwnProperty("l"))&&e.hasOwnProperty("l"))/^link (in|out)$/.test(i.type)==e.l&&(i.l=e.l)}return e.info&&(i.info=e.info),i}function C(e,t){var o={};if(o.id=e.id,o.type=e.type,o.name=e.name,o.info=e.info,o.category=e.category,o.in=[],o.out=[],o.env=e.env,t){var n={};for(var a in e.credentials)e.credentials.hasOwnProperty(a)&&(!e.credentials._||e.credentials["has_"+a]!=e.credentials._["has_"+a]||e.credentials["has_"+a]&&e.credentials[a])&&(n[a]=e.credentials[a]);Object.keys(n).length>0&&(o.credentials=n)}return o.color=e.color,e.in.forEach((function(e){for(var t={x:e.x,y:e.y,wires:[]},i=s.filter((function(t){return t.source===e})),n=0;n<i.length;n++){var a=i[n];"subflow"!=a.target.type&&t.wires.push({id:a.target.id})}o.in.push(t)})),e.out.forEach((function(t,n){var a={x:t.x,y:t.y,wires:[]},r=s.filter((function(e){return e.target===t}));for(i=0;i<r.length;i++)"subflow"!=r[i].source.type?a.wires.push({id:r[i].source.id,port:r[i].sourcePort}):a.wires.push({id:e.id,port:0});o.out.push(a)})),o.in.length>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(o.inputLabels=e.inputLabels.slice()),o.out.length>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(o.outputLabels=e.outputLabels.slice()),e.icon&&"node-red/subflow.svg"!==e.icon&&(o.icon=e.icon),e.status&&(o.status={x:e.status.x,y:e.status.y,wires:[]},s.forEach((function(t){t.target===e.status&&("subflow"!=t.source.type?o.status.wires.push({id:t.source.id,port:t.sourcePort}):o.status.wires.push({id:e.id,port:0}))}))),o}function j(e,t,i,o){var n=[];t=t||{},e=e.filter((function(e){return!t[e.id]&&(t[e.id]=!0,!0)})),o=o||{},i=i||{};for(var a=0;a<e.length;a++){var s=e[a];if("subflow:"==s.type.substring(0,8)){var d=s.type.substring(8);if(!i[d]){i[d]=!0;var l=[x(d)];RED.nodes.eachNode((function(e){e.z==d&&l.push(e)})),n=j(l,t,i,o).concat(n)}}if("subflow"!==s.type){var c=RED.nodes.convertNode(s);for(var p in s._def.defaults)if(s._def.defaults[p].type&&s[p]in r){var u=r[s[p]],f=g.getNodeType(s._def.defaults[p].type).exportable;null==f||f?s[p]in o||(o[s[p]]=!0,e.push(u)):c[p]=""}n.push(c),"group"===s.type&&(n=n.concat(j(s.nodes,t,i,o)))}else{var h=C(s);n.push(h)}}return n}function L(e,t){var i;t=t||[];var o=null;return RED.nodes.eachSubflow((function(n){if(n.name==e.name&&n.info==e.info&&n.in.length==e.in.length&&n.out.length==e.out.length){var a=RED.nodes.filterNodes({z:n.id});if(a.length==t.length){var r=[e].concat(t),s=[n].concat(a),d=JSON.stringify(r),l=JSON.stringify(j(s));for(i=0;i<a.length;i++)d=d.replace(new RegExp('"'+t[i].id+'"',"g"),'"'+a[i].id+'"');if((d=d.replace(new RegExp('"'+e.id+'"',"g"),'"'+n.id+'"'))===l)return o=n,!1}}})),o}function O(e,t,i){if(i&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var n in o.defaults)if(o.defaults.hasOwnProperty(n)){var a=e[n],r=t[n];if(typeof a!=typeof r)return!1;if(null===a||"string"==typeof a||"number"==typeof a){if(a!==r)return!1}else if(JSON.stringify(a)!==JSON.stringify(r))return!1}return!0}function S(e){var t={tabs:{},subflows:{},groups:{},configs:{},nodes:{},all:[],conflicted:{},zMap:{}};return e.forEach((function(e){t.all.push(e),"tab"===e.type?t.tabs[e.id]=e:"subflow"===e.type?t.subflows[e.id]=e:"group"===e.type?t.groups[e.id]=e:e.hasOwnProperty("x")&&e.hasOwnProperty("y")?t.nodes[e.id]=e:t.configs[e.id]=e;var i=e.z||"__global__";t.zMap[i]=t.zMap[i]||[],t.zMap[i].push(e),(o[e.id]||r[e.id]||d[e.id]||c[e.id]||u[e.id])&&(t.conflicted[e.id]=e)})),t}function I(e){var t={},i={},o={},n=[];e.forEach((function(e){"subflow"===e.type?i[e.id]=e:e.hasOwnProperty("x")||e.hasOwnProperty("y")||(o[e.id]=e),e.z&&(t[e.z]=t[e.z]||[],t[e.z].push(e))}));var r=Object.keys(o);r.forEach((function(e){var t=o[e];i[t.z]&&delete o[e]})),r=Object.keys(o);var s=Object.keys(i);return s.forEach((function(e){var o=i[e];n=n.concat(function(e){for(var t=x(e),i=[t],o=Object.keys(a[t.id]||{}),n=0,r=o.length;n<r;n++)i.push(a[t.id][o[n]]);return j(i)}(e));RED.subflow.removeSubflow(o.id,!0),P([o].concat(t[o.id]));i[e]=x(e)})),RED.nodes.eachNode((function(e){if(/^subflow:/.test(e.type)){var t=e.type.substring(8);i[t]&&(i[t].instances.push(e),e._def=RED.nodes.getType(e.type),e.dirty=!0,e.changed=!0,e._colorChanged=!0)}})),s.forEach((function(e){var t=i[e];RED.events.emit("subflows:change",t)})),RED.utils.clearNodeColorCache(),r.forEach((function(e){n=n.concat(T(y(e))),w(e),P([o[e]])})),{removedNodes:n}}function P(i,n){(n=n||{generateIds:!1,addFlow:!1}).importMap=n.importMap||{};var a,s,l,p=n.generateIds,f=n.addFlow,h={};if("string"==typeof i){if(""===i)return;try{s=JSON.parse(i)}catch(W){var y=new Error(RED._("clipboard.invalidFlow",{message:W.message}));throw y.code="NODE_RED",y}}else s=i;$.isArray(s)||(s=[s]);var w,E={},k=[],T=[];if(s=s.filter((function(e){var t=e.id;if(E[e.id])return!1;if(E[e.id]=!0,!n.generateIds)if(n.importMap[t]){if("replace"===n.importMap[t])return T.push(e),!1}else{var i=o[t]||r[t]||d[t]||c[t]||u[t];i&&k.push({existing:i,imported:e})}return!0})),k.length>0){for(var C=RED._("clipboard.importDuplicate",{count:k.length}),j=$("<ul>"),P=Math.min(5,k.length),N=0;N<P;N++){var z=k[N];$("<li>").text(z.existing.id+" [ "+z.existing.type+(z.imported.type!==z.existing.type?" | "+z.imported.type:"")+" ]").appendTo(j)}P!==k.length&&$("<li>").text(RED._("deploy.confirm.plusNMore",{count:k.length-P})).appendTo(j);var M=$("<p>").append(j),B=new Error(C+M.html());throw B.code="import_conflict",B.importConfig=S(s),B}T.length>0&&(w=I(T).removedNodes);var G=!1;t||(G=!0,t=JSON.parse(JSON.stringify(s)));var U=[];for(N=0;N<s.length;N++){(a=s[N]).id;"workspace"==a.type||"tab"==a.type||"subflow"==a.type||"group"==a.type||g.getNodeType(a.type)||"subflow:"==a.type.substring(0,8)||-1!=U.indexOf(a.type)||U.push(a.type),a.z?(h[a.z]=h[a.z]||[],h[a.z].push(a)):G&&a.hasOwnProperty("x")&&a.hasOwnProperty("y")&&!a.z&&(l||(D(l={id:RED.nodes.id(),type:"tab",disabled:!1,label:RED._("clipboard.recoveredNodes"),info:RED._("clipboard.recoveredNodesInfo")}),RED.workspaces.add(l),h[l.id]=[]),a.z=l.id,h[l.id].push(a))}if(!G&&U.length>0){var F=$("<ul>");U.forEach((function(e){$("<li>").text(e).appendTo(F)})),F=F[0].outerHTML,RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:U.length})+"</p>"+F,"error",!1,1e4)}var J=RED.workspaces.active(),q=x(J);for(N=0;N<s.length;N++){var V=/^subflow:(.+)$/.exec(s[N].type);if(V){var W,K=V[1],H=x(J);if(H)if(K===H.id&&(W=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),_(K,H.id)&&(W=new Error(RED._("notification.errors.cannotAddCircularReference"))),W)throw W.code="NODE_RED",W}}var Y,Q,X,Z,ee=[],te={},ie=[],oe={},ne={},ae={},re=[],se=[],de=[],le=new Set,ce=null;for(l&&ee.push(l),N=0;N<s.length;N++)if("workspace"===(a=s[N]).type||"tab"===a.type)"workspace"===a.type&&(a.type="tab"),null==e&&(e=a),0===J&&(J=a.id),(p||"copy"===n.importMap[a.id])&&(Y=v(),te[a.id]=Y,a.id=Y),D(a),RED.workspaces.add(a),ee.push(a);else if("subflow"===a.type){var pe;n.importMap[a.id]||(pe=L(a,h[a.id])),pe?ne[a.id]=pe:(oe[a.id]=a,(p||"copy"===n.importMap[a.id])&&(Y=v(),a.id=Y),a.in.forEach((function(e,t){e.type="subflow",e.direction="in",e.z=a.id,e.i=t,e.id=v()})),a.out.forEach((function(e,t){e.type="subflow",e.direction="out",e.z=a.id,e.i=t,e.id=v()})),a.status&&(a.status.type="subflow",a.status.direction="status",a.status.z=a.id,a.status.id=v()),ie.push(a),R(a,p||"copy"===n.importMap[a.id]))}for(null==e&&(D(e={type:"tab",id:v(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(e),ee.push(e),J=RED.workspaces.active()),N=0;N<s.length;N++)if(a=s[N],(Q=g.getNodeType(a.type))&&"config"==Q.category){var ue=null;if(p||"copy"===n.importMap[a.id]){if(a.z){if(ne[a.z])continue;oe[a.z]?a.z=oe[a.z].id:(a.z=te[a.z],d[a.z]||(f?(null===ce&&(ce=RED.workspaces.add(null,!0),ee.push(ce)),a.z=ce.id):a.z=J))}if("copy"!==n.importMap[a.id]&&(ue=RED.nodes.node(a.id))&&a.z&&ue.z!==a.z)for(var fe in ue=null,r)if(r.hasOwnProperty(fe)&&r[fe].z===a.z&&O(r[fe],a,!1)){ue=r[fe],ae[a.id]=r[fe];break}}else a.z&&!d[a.z]&&(a.z=J);if(!ue||ue._def.exclusive){for(Z in X={id:a.id,z:a.z,type:a.type,info:a.info,users:[],_config:{}},a.z||delete X.z,a.hasOwnProperty("d")&&(X.d=a.d),Q.defaults)Q.defaults.hasOwnProperty(Z)&&(X[Z]=a[Z],X._config[Z]=JSON.stringify(a[Z]));if(Q.hasOwnProperty("credentials")&&a.hasOwnProperty("credentials"))for(Z in X.credentials={},Q.credentials)Q.credentials.hasOwnProperty(Z)&&a.credentials.hasOwnProperty(Z)&&(X.credentials[Z]=a.credentials[Z]);X.label=Q.label,X._def=Q,(p||"copy"===n.importMap[a.id])&&(X.id=v()),ae[a.id]=X,re.push(X)}}for(N=0;N<s.length;N++)if("workspace"!==(a=s[N]).type&&"tab"!==a.type&&"subflow"!==a.type&&(!(Q=g.getNodeType(a.type))||"config"!=Q.category)){var he={x:parseFloat(a.x||0),y:parseFloat(a.y||0),z:a.z,type:0,info:a.info,changed:!1,_config:{}};if("group"!==a.type&&(he.wires=a.wires||[],he.inputLabels=a.inputLabels,he.outputLabels=a.outputLabels,he.icon=a.icon),a.hasOwnProperty("l")&&(he.l=a.l),a.hasOwnProperty("d")&&(he.d=a.d),a.hasOwnProperty("g")&&(he.g=a.g),p||"copy"===n.importMap[a.id]){if(ne[a.z])continue;oe[he.z]?he.z=oe[he.z].id:(he.z=te[he.z],d[he.z]||(f?(null===ce&&(ce=RED.workspaces.add(null,!0),ee.push(ce)),he.z=ce.id):he.z=J)),he.id=v()}else he.id=a.id,null!=he.z&&(d[he.z]||oe[he.z])||(f?(null===ce&&(ce=RED.workspaces.add(null,!0),ee.push(ce)),he.z=ce.id):he.z=J);if(he.type=a.type,he._def=Q,"group"===he.type){for(Z in he._def=RED.group.def,he._def.defaults)he._def.defaults.hasOwnProperty(Z)&&"inputs"!==Z&&"outputs"!==Z&&(he[Z]=a[Z],he._config[Z]=JSON.stringify(a[Z]));he._config.x=he.x,he._config.y=he.y}else if("subflow"===a.type.substring(0,7)){var ge=a.type.split(":")[1],ve=ne[ge]||oe[ge]||x(ge);(p||"copy"===n.importMap[a.id])&&(ge=ve.id,he.type="subflow:"+ge,he._def=g.getNodeType(he.type),delete he.i),he.name=a.name,he.outputs=ve.out.length,he.inputs=ve.in.length,he.env=a.env}else{if(!he._def){he.x&&he.y?he._def={color:"#fee",defaults:{},label:"unknown: "+a.type,labelStyle:"red-ui-flow-node-label-italic",outputs:a.outputs||a.wires&&a.wires.length||0,set:g.getNodeSet("node-red/unknown")}:(he._def={category:"config",set:g.getNodeSet("node-red/unknown")},he.users=[],delete he.x,delete he.y,delete he.wires,delete he.inputLabels,delete he.outputLabels,a.z||delete he.z);var be={};for(var me in a)a.hasOwnProperty(me)&&"x"!=me&&"y"!=me&&"z"!=me&&"id"!=me&&"wires"!=me&&(be[me]=a[me]);he._orig=be,he.name=a.type,he.type="unknown"}if("config"!=he._def.category){for(Z in a.hasOwnProperty("inputs")?(he.inputs=a.inputs,he._config.inputs=JSON.stringify(a.inputs)):he.inputs=he._def.inputs,a.hasOwnProperty("outputs")?(he.outputs=a.outputs,he._config.outputs=JSON.stringify(a.outputs)):he.outputs=he._def.outputs,he.hasOwnProperty("wires")&&he.wires.length>he.outputs&&(he._def.defaults.hasOwnProperty("outputs")&&isNaN(parseInt(a.outputs))?he.outputs=he.wires.length:(console.log("Warning: node.wires longer than node.outputs - trimming wires:",he.id," wires:",he.wires.length," outputs:",he.outputs),he.wires=he.wires.slice(0,he.outputs))),he._def.defaults)he._def.defaults.hasOwnProperty(Z)&&"inputs"!==Z&&"outputs"!==Z&&(he[Z]=a[Z],he._config[Z]=JSON.stringify(a[Z]));if(he._config.x=he.x,he._config.y=he.y,he._def.hasOwnProperty("credentials")&&a.hasOwnProperty("credentials"))for(Z in he.credentials={},he._def.credentials)he._def.credentials.hasOwnProperty(Z)&&a.credentials.hasOwnProperty(Z)&&(he.credentials[Z]=a.credentials[Z])}}ae[a.id]=he,"unknown"===he.type||"config"!==he._def.category?re.push(he):"group"===he.type&&(de.push(he),le.add(he.id))}var ye={catch:"scope",status:"scope",complete:"scope","link in":"links","link out":"links"};for(N=0;N<re.length;N++){if((a=re[N]).wires){for(var we=0;we<a.wires.length;we++)for(var Ee=a.wires[we]instanceof Array?a.wires[we]:[a.wires[we]],De=0;De<Ee.length;De++)if(ae.hasOwnProperty(Ee[De]))if(a.z===ae[Ee[De]].z){var Re={source:a,sourcePort:we,target:ae[Ee[De]]};m(Re),se.push(Re)}else console.log("Warning: dropping link that crosses tabs:",a.id,"->",ae[Ee[De]].id);delete a.wires}for(var $e in a.g&&ae[a.g]?a.g=ae[a.g].id:delete a.g,a._def.defaults)if(a._def.defaults.hasOwnProperty($e))if(a._def.defaults[$e].type&&ae[a[$e]])X=ae[a[$e]],a[$e]=X.id,-1===X.users.indexOf(a)&&X.users.push(a);else if(ye.hasOwnProperty(a.type)&&ye[a.type]===$e&&void 0!==a[$e]&&null!==a[$e])for(var xe=0;xe<a[$e].length;xe++)ae[a[$e][xe]]&&(a[$e][xe]=ae[a[$e][xe]].id);q&&/^link /.test(a.type)&&a.links&&(a.links=a.links.filter((function(e){var t=RED.nodes.node(e);return t&&t.z===J})))}for(N=0;N<ie.length;N++)(a=ie[N]).in.forEach((function(e){e.wires.forEach((function(t){var i={source:e,sourcePort:0,target:ae[t.id]};m(i),se.push(i)})),delete e.wires})),a.out.forEach((function(e){e.wires.forEach((function(t){var i;m(i=oe[t.id]&&oe[t.id].id==a.id?{source:a.in[t.port],sourcePort:t.port,target:e}:{source:ae[t.id]||oe[t.id],sourcePort:t.port,target:e}),se.push(i)})),delete e.wires})),a.status&&(a.status.wires.forEach((function(e){var t;m(t=oe[e.id]&&oe[e.id].id==a.id?{source:a.in[e.port],sourcePort:e.port,target:a.status}:{source:ae[e.id]||oe[e.id],sourcePort:e.port,target:a.status}),se.push(t)})),delete a.status.wires);var _e,ke={};for(N=0;N<de.length;N++)(a=de[N]).g&&!le.has(a.g)&&delete a.g,a.nodes=a.nodes.map((function(e){return ae[e]})),a.nodes=a.nodes.filter((function(e){return e&&e.g!==a.id&&(e.g=a.id),!!e})),a.g||(ke[a.id]=0);do{for(_e=!1,N=0;N<de.length;N++)(a=de[N]).g&&ke[a.id]!==ke[a.g]+1&&(ke[a.id]=ke[a.g]+1,_e=!0)}while(_e);for(de.sort((function(e,t){return ke[e.id]-ke[t.id]})),N=0;N<de.length;N++)A(a=de[N]);for(N=0;N<re.length;N++){b(he=re[N])}for(N=0;N<re.length;N++){he=re[N];RED.editor.validateNode(he)}if(RED.workspaces.refresh(),l)var Te=RED.notify(RED._("clipboard.recoveredNodesNotification",{flowName:RED._("clipboard.recoveredNodes")}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){Te.close()}}]});return{nodes:re,links:se,groups:de,workspaces:ee,subflows:ie,missingWorkspace:ce,removedNodes:w}}function N(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var i=e._def.defaults[t];if(i.type){var o=g.getNodeType(i.type);if(o&&"config"==o.category){var n=r[e[t]];n&&-1===n.users.indexOf(e)&&n.users.push(e)}}}}function A(e){f[e.z]=f[e.z]||[],f[e.z].push(e),u[e.id]=e,RED.events.emit("groups:add",e)}function z(e){var t=f[e.z].indexOf(e);if(f[e.z].splice(t,1),0===f[e.z].length&&delete f[e.z],e.g&&u[e.g]){var i=u[e.g].nodes.indexOf(e);u[e.g].nodes.splice(i,1)}RED.group.markDirty(e),delete u[e.id],RED.events.emit("groups:remove",e)}return{init:function(){RED.events.on("registry:node-type-added",(function(e){g.getNodeType(e);var t={};RED.nodes.eachNode((function(i){"unknown"===i.type&&i.name===e&&(t[i.id]=i)})),RED.nodes.eachConfig((function(i){"unknown"===i.type&&i.name===e&&(t[i.id]=i)}));var i=Object.keys(t);if(i.length>0){var n=[];i.forEach((function(e){var i=t[e];r.hasOwnProperty(i.id)?delete r[i.id]:(delete o[i.id],a[i.z]&&delete a[i.z][i.id]),n.push(T(i)),RED.events.emit("nodes:remove",i)}));var s=[];RED.nodes.eachLink((function(e){t.hasOwnProperty(e.source.id)&&t.hasOwnProperty(e.target.id)&&s.push(e)})),s.forEach(E),RED.view.redraw(!0,!0);var d=P(n,{generateIds:!1}),l={};d.nodes.forEach((function(e){l[e.id]=e})),RED.nodes.eachLink((function(e){l.hasOwnProperty(e.source.id)&&(e.source=l[e.source.id]),l.hasOwnProperty(e.target.id)&&(e.target=l[e.target.id])})),RED.view.redraw(!0)}}))},registry:g,setNodeList:g.setNodeList,getNodeSet:g.getNodeSet,addNodeSet:g.addNodeSet,removeNodeSet:g.removeNodeSet,enableNodeSet:g.enableNodeSet,disableNodeSet:g.disableNodeSet,setIconSets:g.setIconSets,getIconSets:g.getIconSets,registerType:g.registerNodeType,getType:g.getNodeType,convertNode:T,add:b,remove:w,clear:function(){o={},s=[],a={},r={},l=[],u={},f={},Object.keys(c).forEach((function(e){RED.subflow.removeSubflow(e)})),Object.keys(d).forEach((function(e){RED.workspaces.remove(d[e])})),e=null,t=null,d={},RED.nodes.dirty(!1),RED.view.redraw(!0,!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh(),RED.events.emit("workspace:clear")},moveNodeToTab:function(e,t){"group"!==e.type?(a[e.z]&&delete a[e.z][e.id],a[t]||(a[t]={}),a[t][e.id]=e,e.z=t,RED.events.emit("nodes:change",e)):function(e,t){var i=f[e.z].indexOf(e);f[e.z].splice(i,1),f[t]=f[t]||[],f[t].push(e),e.z=t,RED.events.emit("groups:change",e)}(e,t)},addLink:m,removeLink:E,addWorkspace:D,removeWorkspace:function(e){var t=d[e],i=[],n=[],s=[];if(t){var c,p;for(c in delete d[e],delete a[e],l.splice(l.indexOf(e),1),o)o.hasOwnProperty(c)&&(p=o[c]).z==e&&i.push(p);for(c in r)r.hasOwnProperty(c)&&(p=r[c]).z==e&&i.push(p);for(c=0;c<i.length;c++){var u=w(i[c].id);n=n.concat(u.links)}for(s=(f[e]||[]).filter((function(e){return!e.g})),c=0;c<s.length;c++)s[c].nodes.forEach((function(e){"group"===e.type&&s.push(e)}));for(c=s.length-1;c>=0;c--)z(s[c]);RED.events.emit("flows:remove",t)}return{nodes:i,links:n,groups:s}},getWorkspaceOrder:function(){return l},setWorkspaceOrder:function(e){l=e},workspace:function(e){return d[e]},defaultWorkspace:()=>e.id,addSubflow:R,removeSubflow:function(e){c[e.id]&&(delete c[e.id],delete a[e.id],g.removeNodeType("subflow:"+e.id),RED.events.emit("subflows:remove",e))},subflow:x,subflowContains:_,addGroup:A,removeGroup:z,group:function(e){return u[e]},groups:function(e){return f[e]||[]},eachNode:function(e){for(var t in o)if(o.hasOwnProperty(t)&&!1===e(o[t]))break},eachLink:function(e){for(var t=0;t<s.length&&!1!==e(s[t]);t++);},eachConfig:function(e){for(var t in r)if(r.hasOwnProperty(t)&&!1===e(r[t]))break},eachSubflow:function(e){for(var t in c)if(c.hasOwnProperty(t)&&!1===e(c[t]))break},eachWorkspace:function(e){for(var t=0;t<l.length&&!1!==e(d[l[t]]);t++);},node:y,version:function(e){if(void 0===e)return p;p=e},originalFlow:function(e){if(void 0===e)return t;t=e},filterNodes:function(e){var t=[],i=null,n=!1;e.hasOwnProperty("z")&&(a.hasOwnProperty(e.z)?i=Object.keys(a[e.z]):n=!0),null===i&&(i=Object.keys(o));for(var r=0;r<i.length;r++){var s=o[i[r]];e.hasOwnProperty("type")&&s.type!==e.type||(n&&s.z!==e.z||t.push(s))}return t},filterLinks:function(e){for(var t=[],i=0;i<s.length;i++){var o=s[i];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||t.push(o)}return t},import:P,identifyImportConflicts:S,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var i=[e],o=[e];0!==o.length;)for(var n=o.shift(),a=s.filter((function(e){return e.source===n||e.target===n})),r=0;r<a.length;r++){var d=a[r].source===n?a[r].target:a[r].source,l=d.id;l||(l=d.direction+":"+d.i),t[l]||(t[l]=!0,i.push(d),o.push(d))}return i},createExportableNodeSet:j,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,i=[];for(t=0;t<l.length;t++)"tab"==d[l[t]].type&&i.push(k(d[l[t]]));for(t in c)c.hasOwnProperty(t)&&i.push(C(c[t],e));for(t in u)u.hasOwnProperty(t)&&i.push(T(u[t]));for(t in r)r.hasOwnProperty(t)&&i.push(T(r[t],e));for(t in o)o.hasOwnProperty(t)&&i.push(T(o[t],e));return i},updateConfigNodeUsers:N,id:v,dirty:function(e){if(null==e)return h;!function(e){h=e,RED.events.emit("workspace:dirty",{dirty:h})}(e)}}}(),RED.nodes.fontAwesome=function(){var e={"fa-address-book-o":"","fa-address-book":"","fa-address-card-o":"","fa-address-card":"","fa-adjust":"","fa-align-center":"","fa-align-justify":"","fa-align-left":"","fa-align-right":"","fa-ambulance":"","fa-american-sign-language-interpreting":"","fa-anchor":"","fa-angle-double-down":"","fa-angle-double-left":"","fa-angle-double-right":"","fa-angle-double-up":"","fa-angle-down":"","fa-angle-left":"","fa-angle-right":"","fa-angle-up":"","fa-archive":"","fa-area-chart":"","fa-arrow-circle-down":"","fa-arrow-circle-left":"","fa-arrow-circle-o-down":"","fa-arrow-circle-o-left":"","fa-arrow-circle-o-right":"","fa-arrow-circle-o-up":"","fa-arrow-circle-right":"","fa-arrow-circle-up":"","fa-arrow-down":"","fa-arrow-left":"","fa-arrow-right":"","fa-arrow-up":"","fa-arrows-alt":"","fa-arrows-h":"","fa-arrows-v":"","fa-arrows":"","fa-asl-interpreting":"","fa-assistive-listening-systems":"","fa-asterisk":"","fa-at":"","fa-audio-description":"","fa-automobile":"","fa-backward":"","fa-balance-scale":"","fa-ban":"","fa-bank":"","fa-bar-chart-o":"","fa-bar-chart":"","fa-barcode":"","fa-bars":"","fa-bath":"","fa-bathtub":"","fa-battery-0":"","fa-battery-1":"","fa-battery-2":"","fa-battery-3":"","fa-battery-4":"","fa-battery-empty":"","fa-battery-full":"","fa-battery-half":"","fa-battery-quarter":"","fa-battery-three-quarters":"","fa-battery":"","fa-bed":"","fa-beer":"","fa-bell-o":"","fa-bell-slash-o":"","fa-bell-slash":"","fa-bell":"","fa-bicycle":"","fa-binoculars":"","fa-birthday-cake":"","fa-blind":"","fa-bold":"","fa-bolt":"","fa-bomb":"","fa-book":"","fa-bookmark-o":"","fa-bookmark":"","fa-braille":"","fa-briefcase":"","fa-bug":"","fa-building-o":"","fa-building":"","fa-bullhorn":"","fa-bullseye":"","fa-bus":"","fa-cab":"","fa-calculator":"","fa-calendar-check-o":"","fa-calendar-minus-o":"","fa-calendar-o":"","fa-calendar-plus-o":"","fa-calendar-times-o":"","fa-calendar":"","fa-camera-retro":"","fa-camera":"","fa-car":"","fa-caret-down":"","fa-caret-left":"","fa-caret-right":"","fa-caret-square-o-down":"","fa-caret-square-o-left":"","fa-caret-square-o-right":"","fa-caret-square-o-up":"","fa-caret-up":"","fa-cart-arrow-down":"","fa-cart-plus":"","fa-cc":"","fa-certificate":"","fa-chain-broken":"","fa-chain":"","fa-check-circle-o":"","fa-check-circle":"","fa-check-square-o":"","fa-check-square":"","fa-check":"","fa-chevron-circle-down":"","fa-chevron-circle-left":"","fa-chevron-circle-right":"","fa-chevron-circle-up":"","fa-chevron-down":"","fa-chevron-left":"","fa-chevron-right":"","fa-chevron-up":"","fa-child":"","fa-circle-o-notch":"","fa-circle-o":"","fa-circle-thin":"","fa-circle":"","fa-clipboard":"","fa-clock-o":"","fa-clone":"","fa-close":"","fa-cloud-download":"","fa-cloud-upload":"","fa-cloud":"","fa-cny":"","fa-code-fork":"","fa-code":"","fa-coffee":"","fa-cog":"","fa-cogs":"","fa-columns":"","fa-comment-o":"","fa-comment":"","fa-commenting-o":"","fa-commenting":"","fa-comments-o":"","fa-comments":"","fa-compass":"","fa-compress":"","fa-copy":"","fa-copyright":"","fa-creative-commons":"","fa-credit-card-alt":"","fa-credit-card":"","fa-crop":"","fa-crosshairs":"","fa-cube":"","fa-cubes":"","fa-cut":"","fa-cutlery":"","fa-dashboard":"","fa-database":"","fa-deaf":"","fa-deafness":"","fa-dedent":"","fa-desktop":"","fa-diamond":"","fa-dollar":"","fa-dot-circle-o":"","fa-download":"","fa-drivers-license-o":"","fa-drivers-license":"","fa-edit":"","fa-eject":"","fa-ellipsis-h":"","fa-ellipsis-v":"","fa-envelope-o":"","fa-envelope-open-o":"","fa-envelope-open":"","fa-envelope-square":"","fa-envelope":"","fa-eraser":"","fa-eur":"","fa-euro":"","fa-exchange":"","fa-exclamation-circle":"","fa-exclamation-triangle":"","fa-exclamation":"","fa-expand":"","fa-external-link-square":"","fa-external-link":"","fa-eye-slash":"","fa-eye":"","fa-eyedropper":"","fa-fast-backward":"","fa-fast-forward":"","fa-fax":"","fa-feed":"","fa-female":"","fa-fighter-jet":"","fa-file-archive-o":"","fa-file-audio-o":"","fa-file-code-o":"","fa-file-excel-o":"","fa-file-image-o":"","fa-file-movie-o":"","fa-file-o":"","fa-file-pdf-o":"","fa-file-photo-o":"","fa-file-picture-o":"","fa-file-powerpoint-o":"","fa-file-sound-o":"","fa-file-text-o":"","fa-file-text":"","fa-file-video-o":"","fa-file-word-o":"","fa-file-zip-o":"","fa-file":"","fa-files-o":"","fa-film":"","fa-filter":"","fa-fire-extinguisher":"","fa-fire":"","fa-flag-checkered":"","fa-flag-o":"","fa-flag":"","fa-flash":"","fa-flask":"","fa-floppy-o":"","fa-folder-o":"","fa-folder-open-o":"","fa-folder-open":"","fa-folder":"","fa-font":"","fa-forward":"","fa-frown-o":"","fa-futbol-o":"","fa-gamepad":"","fa-gavel":"","fa-gbp":"","fa-gear":"","fa-gears":"","fa-genderless":"","fa-gift":"","fa-glass":"","fa-globe":"","fa-graduation-cap":"","fa-group":"","fa-h-square":"","fa-hand-grab-o":"","fa-hand-lizard-o":"","fa-hand-o-down":"","fa-hand-o-left":"","fa-hand-o-right":"","fa-hand-o-up":"","fa-hand-paper-o":"","fa-hand-peace-o":"","fa-hand-pointer-o":"","fa-hand-rock-o":"","fa-hand-scissors-o":"","fa-hand-spock-o":"","fa-hand-stop-o":"","fa-handshake-o":"","fa-hard-of-hearing":"","fa-hashtag":"","fa-hdd-o":"","fa-header":"","fa-headphones":"","fa-heart-o":"","fa-heart":"","fa-heartbeat":"","fa-history":"","fa-home":"","fa-hospital-o":"","fa-hotel":"","fa-hourglass-1":"","fa-hourglass-2":"","fa-hourglass-3":"","fa-hourglass-end":"","fa-hourglass-half":"","fa-hourglass-o":"","fa-hourglass-start":"","fa-hourglass":"","fa-i-cursor":"","fa-id-badge":"","fa-id-card-o":"","fa-id-card":"","fa-ils":"","fa-image":"","fa-inbox":"","fa-indent":"","fa-industry":"","fa-info-circle":"","fa-info":"","fa-inr":"","fa-institution":"","fa-intersex":"","fa-italic":"","fa-jpy":"","fa-key":"","fa-keyboard-o":"","fa-krw":"","fa-language":"","fa-laptop":"","fa-leaf":"","fa-legal":"","fa-lemon-o":"","fa-level-down":"","fa-level-up":"","fa-life-bouy":"","fa-life-buoy":"","fa-life-ring":"","fa-life-saver":"","fa-lightbulb-o":"","fa-line-chart":"","fa-link":"","fa-list-alt":"","fa-list-ol":"","fa-list-ul":"","fa-list":"","fa-location-arrow":"","fa-lock":"","fa-long-arrow-down":"","fa-long-arrow-left":"","fa-long-arrow-right":"","fa-long-arrow-up":"","fa-low-vision":"","fa-magic":"","fa-magnet":"","fa-mail-forward":"","fa-mail-reply-all":"","fa-mail-reply":"","fa-male":"","fa-map-marker":"","fa-map-o":"","fa-map-pin":"","fa-map-signs":"","fa-map":"","fa-mars-double":"","fa-mars-stroke-h":"","fa-mars-stroke-v":"","fa-mars-stroke":"","fa-mars":"","fa-medkit":"","fa-meh-o":"","fa-mercury":"","fa-microchip":"","fa-microphone-slash":"","fa-microphone":"","fa-minus-circle":"","fa-minus-square-o":"","fa-minus-square":"","fa-minus":"","fa-mobile-phone":"","fa-mobile":"","fa-money":"","fa-moon-o":"","fa-mortar-board":"","fa-motorcycle":"","fa-mouse-pointer":"","fa-music":"","fa-navicon":"","fa-neuter":"","fa-newspaper-o":"","fa-object-group":"","fa-object-ungroup":"","fa-outdent":"","fa-paint-brush":"","fa-paper-plane-o":"","fa-paper-plane":"","fa-paperclip":"","fa-paragraph":"","fa-paste":"","fa-pause-circle-o":"","fa-pause-circle":"","fa-pause":"","fa-paw":"","fa-pencil-square-o":"","fa-pencil-square":"","fa-pencil":"","fa-percent":"","fa-phone-square":"","fa-phone":"","fa-photo":"","fa-picture-o":"","fa-pie-chart":"","fa-plane":"","fa-play-circle-o":"","fa-play-circle":"","fa-play":"","fa-plug":"","fa-plus-circle":"","fa-plus-square-o":"","fa-plus-square":"","fa-plus":"","fa-podcast":"","fa-power-off":"","fa-print":"","fa-puzzle-piece":"","fa-qrcode":"","fa-question-circle-o":"","fa-question-circle":"","fa-question":"","fa-quote-left":"","fa-quote-right":"","fa-random":"","fa-recycle":"","fa-refresh":"","fa-registered":"","fa-remove":"","fa-reorder":"","fa-repeat":"","fa-reply-all":"","fa-reply":"","fa-retweet":"","fa-rmb":"","fa-road":"","fa-rocket":"","fa-rotate-left":"","fa-rotate-right":"","fa-rouble":"","fa-rss-square":"","fa-rss":"","fa-rub":"","fa-ruble":"","fa-rupee":"","fa-s15":"","fa-save":"","fa-scissors":"","fa-search-minus":"","fa-search-plus":"","fa-search":"","fa-send-o":"","fa-send":"","fa-server":"","fa-share-square-o":"","fa-share-square":"","fa-share":"","fa-shekel":"","fa-sheqel":"","fa-shield":"","fa-ship":"","fa-shopping-bag":"","fa-shopping-basket":"","fa-shopping-cart":"","fa-shower":"","fa-sign-in":"","fa-sign-language":"","fa-sign-out":"","fa-signal":"","fa-signing":"","fa-sitemap":"","fa-sliders":"","fa-smile-o":"","fa-snowflake-o":"","fa-soccer-ball-o":"","fa-sort-alpha-asc":"","fa-sort-alpha-desc":"","fa-sort-amount-asc":"","fa-sort-amount-desc":"","fa-sort-asc":"","fa-sort-desc":"","fa-sort-down":"","fa-sort-numeric-asc":"","fa-sort-numeric-desc":"","fa-sort-up":"","fa-sort":"","fa-space-shuttle":"","fa-spinner":"","fa-spoon":"","fa-square-o":"","fa-square":"","fa-star-half-empty":"","fa-star-half-full":"","fa-star-half-o":"","fa-star-half":"","fa-star-o":"","fa-star":"","fa-step-backward":"","fa-step-forward":"","fa-stethoscope":"","fa-sticky-note-o":"","fa-sticky-note":"","fa-stop-circle-o":"","fa-stop-circle":"","fa-stop":"","fa-street-view":"","fa-strikethrough":"","fa-subscript":"","fa-subway":"","fa-suitcase":"","fa-sun-o":"","fa-superscript":"","fa-support":"","fa-table":"","fa-tablet":"","fa-tachometer":"","fa-tag":"","fa-tags":"","fa-tasks":"","fa-taxi":"","fa-television":"","fa-terminal":"","fa-text-height":"","fa-text-width":"","fa-th-large":"","fa-th-list":"","fa-th":"","fa-thermometer-0":"","fa-thermometer-1":"","fa-thermometer-2":"","fa-thermometer-3":"","fa-thermometer-4":"","fa-thermometer-empty":"","fa-thermometer-full":"","fa-thermometer-half":"","fa-thermometer-quarter":"","fa-thermometer-three-quarters":"","fa-thermometer":"","fa-thumb-tack":"","fa-thumbs-down":"","fa-thumbs-o-down":"","fa-thumbs-o-up":"","fa-thumbs-up":"","fa-ticket":"","fa-times-circle-o":"","fa-times-circle":"","fa-times-rectangle-o":"","fa-times-rectangle":"","fa-times":"","fa-tint":"","fa-toggle-down":"","fa-toggle-left":"","fa-toggle-off":"","fa-toggle-on":"","fa-toggle-right":"","fa-toggle-up":"","fa-trademark":"","fa-train":"","fa-transgender-alt":"","fa-transgender":"","fa-trash-o":"","fa-trash":"","fa-tree":"","fa-trophy":"","fa-truck":"","fa-try":"","fa-tty":"","fa-turkish-lira":"","fa-tv":"","fa-umbrella":"","fa-underline":"","fa-undo":"","fa-universal-access":"","fa-university":"","fa-unlink":"","fa-unlock-alt":"","fa-unlock":"","fa-unsorted":"","fa-upload":"","fa-usd":"","fa-user-circle-o":"","fa-user-circle":"","fa-user-md":"","fa-user-o":"","fa-user-plus":"","fa-user-secret":"","fa-user-times":"","fa-user":"","fa-users":"","fa-vcard-o":"","fa-vcard":"","fa-venus-double":"","fa-venus-mars":"","fa-venus":"","fa-video-camera":"","fa-volume-control-phone":"","fa-volume-down":"","fa-volume-off":"","fa-volume-up":"","fa-warning":"","fa-wheelchair-alt":"","fa-wheelchair":"","fa-wifi":"","fa-window-close-o":"","fa-window-close":"","fa-window-maximize":"","fa-window-minimize":"","fa-window-restore":"","fa-won":"","fa-wrench":"","fa-yen":""},t={"fa-500px":"","fa-adn":"","fa-amazon":"","fa-android":"","fa-angellist":"","fa-apple":"","fa-bandcamp":"","fa-behance-square":"","fa-behance":"","fa-bitbucket-square":"","fa-bitbucket":"","fa-bitcoin":"","fa-black-tie":"","fa-bluetooth-b":"","fa-bluetooth":"","fa-btc":"","fa-buysellads":"","fa-cc-amex":"","fa-cc-diners-club":"","fa-cc-discover":"","fa-cc-jcb":"","fa-cc-mastercard":"","fa-cc-paypal":"","fa-cc-stripe":"","fa-cc-visa":"","fa-chrome":"","fa-codepen":"","fa-codiepie":"","fa-connectdevelop":"","fa-contao":"","fa-css3":"","fa-dashcube":"","fa-delicious":"","fa-deviantart":"","fa-digg":"","fa-dribbble":"","fa-dropbox":"","fa-drupal":"","fa-edge":"","fa-eercast":"","fa-empire":"","fa-envira":"","fa-etsy":"","fa-expeditedssl":"","fa-fa":"","fa-facebook-f":"","fa-facebook-official":"","fa-facebook-square":"","fa-facebook":"","fa-firefox":"","fa-first-order":"","fa-flickr":"","fa-font-awesome":"","fa-fonticons":"","fa-fort-awesome":"","fa-forumbee":"","fa-foursquare":"","fa-free-code-camp":"","fa-ge":"","fa-get-pocket":"","fa-gg-circle":"","fa-gg":"","fa-git-square":"","fa-git":"","fa-github-alt":"","fa-github-square":"","fa-github":"","fa-gitlab":"","fa-gittip":"","fa-glide-g":"","fa-glide":"","fa-google-plus-circle":"","fa-google-plus-official":"","fa-google-plus-square":"","fa-google-plus":"","fa-google-wallet":"","fa-google":"","fa-gratipay":"","fa-grav":"","fa-hacker-news":"","fa-houzz":"","fa-html5":"","fa-imdb":"","fa-instagram":"","fa-internet-explorer":"","fa-ioxhost":"","fa-joomla":"","fa-jsfiddle":"","fa-lastfm-square":"","fa-lastfm":"","fa-leanpub":"","fa-linkedin-square":"","fa-linkedin":"","fa-linode":"","fa-linux":"","fa-maxcdn":"","fa-meanpath":"","fa-medium":"","fa-meetup":"","fa-mixcloud":"","fa-modx":"","fa-odnoklassniki-square":"","fa-odnoklassniki":"","fa-opencart":"","fa-openid":"","fa-opera":"","fa-optin-monster":"","fa-pagelines":"","fa-paypal":"","fa-pied-piper-alt":"","fa-pied-piper-pp":"","fa-pied-piper":"","fa-pinterest-p":"","fa-pinterest-square":"","fa-pinterest":"","fa-product-hunt":"","fa-qq":"","fa-quora":"","fa-ra":"","fa-ravelry":"","fa-rebel":"","fa-reddit-alien":"","fa-reddit-square":"","fa-reddit":"","fa-renren":"","fa-resistance":"","fa-safari":"","fa-scribd":"","fa-sellsy":"","fa-share-alt-square":"","fa-share-alt":"","fa-shirtsinbulk":"","fa-simplybuilt":"","fa-skyatlas":"","fa-skype":"","fa-slack":"","fa-slideshare":"","fa-snapchat-ghost":"","fa-snapchat-square":"","fa-snapchat":"","fa-soundcloud":"","fa-spotify":"","fa-stack-exchange":"","fa-stack-overflow":"","fa-steam-square":"","fa-steam":"","fa-stumbleupon-circle":"","fa-stumbleupon":"","fa-superpowers":"","fa-telegram":"","fa-tencent-weibo":"","fa-themeisle":"","fa-trello":"","fa-tripadvisor":"","fa-tumblr-square":"","fa-tumblr":"","fa-twitch":"","fa-twitter-square":"","fa-twitter":"","fa-usb":"","fa-viacoin":"","fa-viadeo-square":"","fa-viadeo":"","fa-vimeo-square":"","fa-vimeo":"","fa-vine":"","fa-vk":"","fa-wechat":"","fa-weibo":"","fa-weixin":"","fa-whatsapp":"","fa-wikipedia-w":"","fa-windows":"","fa-wordpress":"","fa-wpbeginner":"","fa-wpexplorer":"","fa-wpforms":"","fa-xing-square":"","fa-xing":"","fa-y-combinator-square":"","fa-y-combinator":"","fa-yahoo":"","fa-yc-square":"","fa-yc":"","fa-yelp":"","fa-yoast":"","fa-youtube-play":"","fa-youtube-square":"","fa-youtube":""},i=Object.keys(e);return{getIconUnicode:function(i){return e[i]||t[i]},getIconList:function(){return i}}}(),RED.history=function(){var e=[],t=[];function i(e){var t,o,n,a,r={};if(e){if("multi"==e.t)for(a={t:"multi",events:[]},t=e.events.length-1;t>=0;t--){var s=i(e.events[t]);a.events.push(s)}else if("replace"==e.t)if(e.complete){a={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:{},rev:RED.nodes.version()},RED.nodes.clear(),RED.nodes.import(e.config).nodes.forEach((function(t){e.changed[t.id]&&(t.changed=!0,a.changed[t.id]=!0)})),RED.nodes.version(e.rev)}else{var d={};e.config.forEach((function(e){d[e.id]="replace"}));var l=RED.nodes.import(e.config,{importMap:d});a={t:"replace",config:l.removedNodes}}else if("add"==e.t){if(a={t:"delete"},e.nodes)for(a.nodes=[],t=0;t<e.nodes.length;t++)if((o=RED.nodes.node(e.nodes[t])).z&&(r[o.z]=!0),a.nodes.push(o),RED.nodes.remove(e.nodes[t]),o.g){var c,p=(c=RED.nodes.group(o.g)).nodes.indexOf(o);-1!==p&&(c.nodes.splice(p,1),RED.group.markDirty(c))}if(e.links)for(a.links=[],t=0;t<e.links.length;t++)a.links.push(e.links[t]),RED.nodes.removeLink(e.links[t]);if(e.groups)for(a.groups=[],t=e.groups.length-1;t>=0;t--)r[(c=e.groups[t]).z]=!0,a.groups.unshift(c),RED.nodes.removeGroup(c);if(e.workspaces)for(a.workspaces=[],t=0;t<e.workspaces.length;t++){var u=RED.nodes.getWorkspaceOrder();e.workspaces[t]._index=u.indexOf(e.workspaces[t].id),a.workspaces.push(e.workspaces[t]),RED.nodes.removeWorkspace(e.workspaces[t].id),RED.workspaces.remove(e.workspaces[t])}if(e.subflows)for(a.subflows=[],t=0;t<e.subflows.length;t++)a.subflows.push(e.subflows[t]),RED.nodes.removeSubflow(e.subflows[t]),RED.workspaces.remove(e.subflows[t]);if(e.subflow&&(a.subflow={},e.subflow.instances&&(a.subflow.instances=[],e.subflow.instances.forEach((function(e){a.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}))),e.subflow.hasOwnProperty("changed")&&(n=RED.nodes.subflow(e.subflow.id))&&(n.changed=e.subflow.changed)),e.removedLinks)for(a.createdLinks=[],t=0;t<e.removedLinks.length;t++)a.createdLinks.push(e.removedLinks[t]),RED.nodes.addLink(e.removedLinks[t])}else if("delete"==e.t){if(a={t:"add"},e.workspaces)for(a.workspaces=[],t=0;t<e.workspaces.length;t++)a.workspaces.push(e.workspaces[t]),RED.nodes.addWorkspace(e.workspaces[t],e.workspaces[t]._index),RED.workspaces.add(e.workspaces[t],void 0,e.workspaces[t]._index),delete e.workspaces[t]._index;if(e.subflows)for(a.subflows=[],t=0;t<e.subflows.length;t++)a.subflows.push(e.subflows[t]),RED.nodes.addSubflow(e.subflows[t]);if(e.subflowInputs&&e.subflowInputs.length>0&&((n=RED.nodes.subflow(e.subflowInputs[0].z)).in.push(e.subflowInputs[0]),n.in[0].dirty=!0),e.subflowOutputs&&e.subflowOutputs.length>0)for(n=RED.nodes.subflow(e.subflowOutputs[0].z),e.subflowOutputs.sort((function(e,t){return e.i-t.i})),t=0;t<e.subflowOutputs.length;t++){var f=e.subflowOutputs[t];n.out.splice(f.i,0,f);for(var h=f.i+1;h<n.out.length;h++)n.out[h].i++,n.out[h].dirty=!0;RED.nodes.eachLink((function(e){e.source.type=="subflow:"+n.id&&e.sourcePort>=f.i&&e.sourcePort++}))}if(e.subflow&&(a.subflow={},e.subflow.hasOwnProperty("instances")&&(a.subflow.instances=[],e.subflow.instances.forEach((function(e){a.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}))),e.subflow.hasOwnProperty("status")&&((n=RED.nodes.subflow(e.subflow.id)).status=e.subflow.status)),n&&RED.nodes.filterNodes({type:"subflow:"+n.id}).forEach((function(e){e.inputs=n.in.length,e.outputs=n.out.length,e.resize=!0,e.dirty=!0})),e.groups){a.groups=[];var g={};for(e.groups.forEach((function(e){g[e.id]=e})),t=e.groups.length-1;t>=0;t--)RED.nodes.addGroup(e.groups[t]),r[e.groups[t].z]=!0,a.groups.unshift(e.groups[t]),e.groups[t].g&&(-1===(c=g[e.groups[t].g]?g[e.groups[t].g]:RED.nodes.group(e.groups[t].g)).nodes.indexOf(e.groups[t])&&c.nodes.push(e.groups[t]),RED.group.markDirty(e.groups[t]))}if(e.nodes)for(a.nodes=[],t=0;t<e.nodes.length;t++)RED.nodes.add(e.nodes[t]),r[e.nodes[t].z]=!0,a.nodes.push(e.nodes[t].id),e.nodes[t].g&&(-1===(c=RED.nodes.group(e.nodes[t].g)).nodes.indexOf(e.nodes[t])&&c.nodes.push(e.nodes[t]),RED.group.markDirty(c));if(e.links)for(a.links=[],t=0;t<e.links.length;t++)RED.nodes.addLink(e.links[t]),a.links.push(e.links[t]);if(e.createdLinks)for(a.removedLinks=[],t=0;t<e.createdLinks.length;t++)a.removedLinks.push(e.createdLinks[t]),RED.nodes.removeLink(e.createdLinks[t]);if(e.changes)for(t in e.changes)if(e.changes.hasOwnProperty(t)){if(o=RED.nodes.node(t)){for(var v in e.changes[t])e.changes[t].hasOwnProperty(v)&&(o[v]=e.changes[t][v]);o.dirty=!0}RED.events.emit("nodes:change",o)}n&&RED.events.emit("subflows:change",n)}else if("move"==e.t){for(a={t:"move",nodes:[]},t=0;t<e.nodes.length;t++){var b=e.nodes[t],m={n:b.n,ox:b.n.x,oy:b.n.y,dirty:!0,moved:b.moved};a.nodes.push(m),b.n.x=b.ox,b.n.y=b.oy,b.n.dirty=!0,b.n.moved=b.moved}if(e.links)for(a.removedLinks=[],t=0;t<e.links.length;t++)a.removedLinks.push(e.links[t]),RED.nodes.removeLink(e.links[t]);if(e.removedLinks)for(a.links=[],t=0;t<e.removedLinks.length;t++)a.links.push(e.removedLinks[t]),RED.nodes.addLink(e.removedLinks[t]);e.addToGroup?(RED.group.removeFromGroup(e.addToGroup,e.nodes.map((function(e){return e.n})),!1),a.removeFromGroup=e.addToGroup):e.removeFromGroup&&(RED.group.addToGroup(e.removeFromGroup,e.nodes.map((function(e){return e.n}))),a.addToGroup=e.removeFromGroup)}else if("edit"==e.t){for(t in(a={t:"edit",changes:{}}).node=e.node,e.changes)if(e.changes.hasOwnProperty(t)){if(a.changes[t]=e.node[t],e.node._def.defaults&&e.node._def.defaults[t]&&e.node._def.defaults[t].type){var y=RED.nodes.node(e.node[t]);y&&(y.users.splice(y.users.indexOf(e.node),1),RED.events.emit("nodes:change",y));var w=RED.nodes.node(e.changes[t]);w&&(w.users.push(e.node),RED.events.emit("nodes:change",w))}e.node[t]=e.changes[t]}var E;switch(e.node.type){case"tab":E="flows";break;case"group":E="groups";break;case"subflow":E="subflows";break;default:E="nodes"}if(E+=":change",RED.events.emit(E,e.node),"tab"===e.node.type&&e.changes.hasOwnProperty("disabled")&&($("#red-ui-tab-"+e.node.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!e.node.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!e.node.disabled)),e.subflow)a.subflow={},e.subflow.hasOwnProperty("inputCount")&&(a.subflow.inputCount=e.node.in.length,e.node.in.length>e.subflow.inputCount?(a.subflow.inputs=e.node.in.slice(e.subflow.inputCount),e.node.in.splice(e.subflow.inputCount)):e.subflow.inputs.length>0&&(e.node.in=e.node.in.concat(e.subflow.inputs))),e.subflow.hasOwnProperty("outputCount")&&(a.subflow.outputCount=e.node.out.length,e.node.out.length>e.subflow.outputCount?(a.subflow.outputs=e.node.out.slice(e.subflow.outputCount),e.node.out.splice(e.subflow.outputCount)):e.subflow.outputs.length>0&&(e.node.out=e.node.out.concat(e.subflow.outputs))),e.subflow.hasOwnProperty("instances")&&(a.subflow.instances=[],e.subflow.instances.forEach((function(e){a.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}))),e.subflow.hasOwnProperty("status")&&e.subflow.status&&delete e.node.status,RED.editor.validateNode(e.node),RED.nodes.filterNodes({type:"subflow:"+e.node.id}).forEach((function(t){t.inputs=e.node.in.length,t.outputs=e.node.out.length,RED.editor.updateNodeProperties(t),RED.editor.validateNode(t)}));else{var D;if(e.outputMap)for(var R in D={},a.outputMap={},e.outputMap)e.outputMap.hasOwnProperty(R)&&"-1"!==e.outputMap[R]&&(D[e.outputMap[R]]=R,a.outputMap[e.outputMap[R]]=R);e.node.__outputs=a.changes.outputs,RED.editor.updateNodeProperties(e.node,D),RED.editor.validateNode(e.node)}if(e.links)for(a.createdLinks=[],t=0;t<e.links.length;t++)RED.nodes.addLink(e.links[t]),a.createdLinks.push(e.links[t]);if(e.createdLinks)for(a.links=[],t=0;t<e.createdLinks.length;t++)RED.nodes.removeLink(e.createdLinks[t]),a.links.push(e.createdLinks[t]);e.node.dirty=!0,e.node.changed=e.changed}else if("createSubflow"==e.t){if(a={t:"deleteSubflow",activeWorkspace:e.activeWorkspace,dirty:RED.nodes.dirty()},e.nodes){a.movedNodes=[];var x=e.activeWorkspace,_=RED.nodes.filterNodes({z:e.subflow.subflow.id});for((_=_.concat(RED.nodes.groups(e.subflow.subflow.id))).forEach((function(t){t.x+=e.subflow.offsetX,t.y+=e.subflow.offsetY,t.dirty=!0,a.movedNodes.push(t.id),RED.nodes.moveNodeToTab(t,x)})),a.subflows=[],t=0;t<e.nodes.length;t++)a.subflows.push(RED.nodes.node(e.nodes[t])),RED.nodes.remove(e.nodes[t])}if(e.links)for(a.links=[],t=0;t<e.links.length;t++)a.links.push(e.links[t]),RED.nodes.removeLink(e.links[t]);if(a.subflow=e.subflow,RED.nodes.removeSubflow(e.subflow.subflow),RED.workspaces.remove(e.subflow.subflow),e.removedLinks)for(a.createdLinks=[],t=0;t<e.removedLinks.length;t++)a.createdLinks.push(e.removedLinks[t]),RED.nodes.addLink(e.removedLinks[t])}else if("deleteSubflow"==e.t){if(a={t:"createSubflow",activeWorkspace:e.activeWorkspace,dirty:RED.nodes.dirty()},e.subflow&&(RED.nodes.addSubflow(e.subflow.subflow),a.subflow=e.subflow,e.subflow.subflow.g&&RED.group.addToGroup(RED.nodes.group(e.subflow.subflow.g),e.subflow.subflow)),e.subflows)for(a.nodes=[],t=0;t<e.subflows.length;t++)RED.nodes.add(e.subflows[t]),a.nodes.push(e.subflows[t].id);if(e.movedNodes&&e.movedNodes.forEach((function(t){nn=RED.nodes.node(t),nn||(nn=RED.nodes.group(t)),nn.x-=e.subflow.offsetX,nn.y-=e.subflow.offsetY,nn.dirty=!0,RED.nodes.moveNodeToTab(nn,e.subflow.subflow.id)})),e.links)for(a.links=[],t=0;t<e.links.length;t++)a.links.push(e.links[t]),RED.nodes.addLink(e.links[t]);if(e.createdLinks)for(a.removedLinks=[],t=0;t<e.createdLinks.length;t++)a.removedLinks.push(e.createdLinks[t]),RED.nodes.removeLink(e.createdLinks[t])}else if("reorder"==e.t)a={t:"reorder",order:RED.nodes.getWorkspaceOrder()},e.order&&RED.workspaces.order(e.order);else if("createGroup"==e.t){if(a={t:"ungroup",dirty:RED.nodes.dirty(),groups:[]},e.groups)for(t=0;t<e.groups.length;t++)a.groups.push(e.groups[t]),RED.group.ungroup(e.groups[t])}else if("ungroup"==e.t){if(a={t:"createGroup",dirty:RED.nodes.dirty(),groups:[]},e.groups)for(t=0;t<e.groups.length;t++){a.groups.push(e.groups[t]);var k=e.groups[t].nodes.slice();e.groups[t].nodes=[],RED.nodes.addGroup(e.groups[t]),RED.group.addToGroup(e.groups[t],k)}}else"addToGroup"==e.t?(a={t:"removeFromGroup",dirty:RED.nodes.dirty(),group:e.group,nodes:e.nodes,reparent:e.reparent},e.nodes&&RED.group.removeFromGroup(e.group,e.nodes,!e.hasOwnProperty("reparent")||void 0===e.hasOwnProperty("reparent")||e.reparent)):"removeFromGroup"==e.t&&(a={t:"addToGroup",dirty:RED.nodes.dirty(),group:e.group,nodes:e.nodes,reparent:e.reparent},e.nodes&&RED.group.addToGroup(e.group,e.nodes));return e.callback&&"function"==typeof e.callback&&(a.callback=e.callback,e.callback(e)),Object.keys(r).forEach((function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)})),RED.nodes.dirty(e.dirty),RED.view.updateActive(),RED.view.select(null),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.subflow.refresh(),a}}return{markAllDirty:function(){for(var t=0;t<e.length;t++)e[t].dirty=!0},list:function(){return e},listRedo:function(){return t},depth:function(){return e.length},push:function(i){e.push(i),t=[]},pop:function(){var o=i(e.pop());o&&t.push(o)},peek:function(){return e[e.length-1]},clear:function(){e=[],t=[]},redo:function(){var o=t.pop();if(o){var n=i(o);n&&e.push(n)}}}}(),RED.validators={number:function(e){return function(t){return e&&(""===t||void 0===t)||""!==t&&!isNaN(t)}},regex:function(e){return function(t){return e.test(t)}},typedInput:function(e,t){return function(i){var o=$("#node-"+(t?"config-":"")+"input-"+e).val()||this[e];if("json"===o)try{return JSON.parse(i),!0}catch(e){return!1}else{if("msg"===o||"flow"===o||"global"===o)return RED.utils.validatePropertyExpression(i);if("num"===o)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(i)}return!0}}},RED.utils=function(){function e(e){var t=_marked(e);return DOMPurify.sanitize(t,{SAFE_FOR_JQUERY:!0})}function t(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function i(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function o(e){var o;if(Array.isArray(e))o=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]");else if(null===e)o=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-null">null</span>');else if("object"==typeof e)o=e.hasOwnProperty("type")&&"undefined"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-null">undefined</span>'):e.hasOwnProperty("type")&&"Buffer"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("buffer["+e.length+"]"):e.hasOwnProperty("type")&&"array"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]"):e.hasOwnProperty("type")&&"function"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("function"):!e.hasOwnProperty("type")||"number"!==e.type&&"bigint"!==e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta">object</span>'):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>').text(e.data);else if("string"==typeof e){var n;n=e.length>30?i(e.substring(0,30))+"&hellip;":i(e),o=$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-string"></span>').html('"'+t(n)+'"')}else o="number"==typeof e?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>').text(""+e):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-other"></span>').text(""+e);return o}function n(e,t,i,o){e.addClass("red-ui-debug-msg-expandable"),e.prop("toggle",(function(){return function(i){var o=e.parent();if(o.hasClass("collapsed")){if(i)return t&&!o.hasClass("built")&&(t(),o.addClass("built")),o.removeClass("collapsed"),!0}else if(!i)return o.addClass("collapsed"),!0;return!1}})),e.on("click",(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&i&&i(!t),e.preventDefault()})),o&&e.trigger("click")}window._marked=window.marked,window.marked=function(t){return console.warn("Use of 'marked()' is deprecated. Use RED.utils.renderMarkdown() instead"),e(t)},_marked.setOptions({renderer:new _marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,smartLists:!0,smartypants:!1});var a={},r={};function s(e,t,i,o){if(t&&t.length>0){if(""===e&&void 0===i)return!0;for(var n=0;n<t.length;n++){var a=t[n];if(0===a.indexOf(e)&&("."===a[e.length]||"["===a[e.length])){if(void 0===i||"["!==a[e.length])return!0;var r=a.substring(e.length),s=/\[(\d+)\]/.exec(r);if(s){var d=parseInt(s[1]);return i<=d&&d<=o}}}}return!1}function d(e,t,i,o,n,a){var s=r[i]&&r[i][o]&&r[i][o].number||a||"dec";if(n?(s="dec"===s?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===s||"dateS"==s?13===t.toString().length&&t<=2147483647e3?"dateML":10===t.toString().length&&t<=2147483647?"dateL":"hex":"dateML"===s||"dateL"==s?"hex":"dec",r[i]=r[i]||{},r[i][o]=r[i][o]||{},r[i][o].number=s):void 0!==a&&(r[i]=r[i]||{},r[i][o]=r[i][o]||{},r[i][o].number=s),"dec"===s)e.text(""+t);else if("dateMS"===s)e.text(new Date(t).toISOString());else if("dateS"===s)e.text(new Date(1e3*t).toISOString());else if("dateML"===s){var d=new Date(t);e.text(d.toLocaleString()+"  [UTC"+(d.getTimezoneOffset()/-60<=0?"":"+")+d.getTimezoneOffset()/-60+"]")}else if("dateL"===s){var l=new Date(1e3*t);e.text(l.toLocaleString()+"  [UTC"+(l.getTimezoneOffset()/-60<=0?"":"+")+l.getTimezoneOffset()/-60+"]")}else"hex"===s&&e.text("0x"+t.toString(16))}function l(e,t,i,o,n){var a=r[i]&&r[i][o]&&r[i][o].buffer||"raw";n&&(a="raw"===a?"string":"raw",r[i]=r[i]||{},r[i][o]=r[i][o]||{},r[i][o].buffer=a),"raw"===a?(t.text("raw"),e.removeClass("red-ui-debug-msg-buffer-string").addClass("red-ui-debug-msg-buffer-raw")):"string"===a&&(t.text("string"),e.addClass("red-ui-debug-msg-buffer-string").removeClass("red-ui-debug-msg-buffer-raw"))}function c(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var i,o,n=[],a=0,r=!1,s=!1,d=0;d<t;d++){var l=e[d];if(r){if(l===i){if(d-a==0)throw new Error("Invalid property expression: zero-length string at position "+a);if(n.push(e.substring(a,d)),s&&!/\]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected array expression at position "+a);if(!s&&d+1!==t&&!/[\[\.]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" expression at position "+(d+1));a=d+1,r=!1}}else if("'"===l||'"'===l){if(d!=a)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);r=!0,i=l,a=d+1}else if("."===l){if(0===d)throw new Error("Invalid property expression: unexpected . at position 0");if(a!=d&&(o=e.substring(a,d),/^\d+$/.test(o)?n.push(parseInt(o)):n.push(o)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1}else if("["===l){if(0===d)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d&&n.push(e.substring(a,d)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1,s=!0}else if("]"===l){if(!s)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d){if(o=e.substring(a,d),!/^\d+$/.test(o))throw new Error("Invalid property expression: unexpected array expression at position "+a);n.push(parseInt(o))}a=d+1,s=!1}else if(" "===l)throw new Error("Invalid property expression: unexpected ' ' at position "+d)}if(s||r)throw new Error("Invalid property expression: unterminated expression");return a<t&&n.push(e.substring(a)),n}function p(e,t){var i,o=null;return"string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),i=c(t)):i=t,i.reduce((function(e,t){return void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(o=void 0!==e.data[t]?e.data[t]:void 0),o}),e),o}function u(e){var t={module:"",file:""};if(e){var i=e.indexOf(RED.settings.apiRootUrl+"icons/");0===i&&(e=e.substring((RED.settings.apiRootUrl+"icons/").length)),-1!==(i=e.indexOf("/"))?(t.module=e.slice(0,i),t.file=e.slice(i+1)):t.file=e}return t}function f(e,t){var i;if(t&&"subflow"===t.type)i="node-red/subflow.svg";else if("function"==typeof e.icon)try{i=e.icon.call(t)}catch(t){console.log("Definition error: "+e.type+".icon",t),i="arrow-in.svg"}else i=e.icon;var o=u(i);return o.module||(e.set?o.module=e.set.module:o.module="node-red"),o}function h(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}var g={};function v(e){var t,i,o;if(/^#[a-f0-9]{6}$/i.test(e))t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),o=parseInt(e.substring(5,7),16);else{if(!/^#[a-f0-9]{3}$/i.test(e))return e;t=parseInt(e.substring(1,2)+e.substring(1,2),16),i=parseInt(e.substring(2,3)+e.substring(2,3),16),o=parseInt(e.substring(3,4)+e.substring(3,4),16)}var n=(((t=Math.max(0,t-50))<<16)+((i=Math.max(0,i-50))<<8)+(o=Math.max(0,o-50))).toString(16);return"#"+"000000".slice(0,6-n.length)+n}return{createObjectElement:function e(r,u){var f,h,g,v,b,m,y=(u=u||{}).key,w=u.typeHint,E=u.hideKey,D=u.path,R=u.sourceId,x=u.rootPath,_=u.expandPaths,k=u.ontoggle,T=u.exposeApi,C=u.tools,j={};void 0!==D&&void 0!==x&&(m=D.substring(x.length+("."===D[x.length]?1:0)));var L=$('<span class="red-ui-debug-msg-element"></span>');if(L.collapse=function(){L.find(".red-ui-debug-msg-expandable").parent().addClass("collapsed")},v=$('<span class="red-ui-debug-msg-row"></span>').appendTo(L),R&&function(e,t,i,o,n,r,s){a.hasOwnProperty(t)||(a[t]={});var d=$('<span class="red-ui-debug-msg-tools"></span>').appendTo(e),l=$('<span class="red-ui-debug-msg-tools-copy button-group"></span>').appendTo(d);if(i){var p=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-terminal"></i></button>').appendTo(l).on("click",(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(i,p,"clipboard.copyMessagePath")}));RED.popover.tooltip(p,RED._("node-red:debug.sidebar.copyPath"))}var u=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(l).on("click",(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(o,u,"clipboard.copyMessageValue")}));if(RED.popover.tooltip(u,RED._("node-red:debug.sidebar.copyPayload")),void 0!==r&&""!==r){var f=a[t].hasOwnProperty(r),h=$('<button class="red-ui-button red-ui-button-small red-ui-debug-msg-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(d).on("click",(function(i){if(i.preventDefault(),i.stopPropagation(),a[t].hasOwnProperty(r))delete a[t][r],$(this).removeClass("selected"),e.removeClass("red-ui-debug-msg-row-pinned");else{var o="$"+("["===r[0]?"":".")+r;a[t][r]=c(o),$(this).addClass("selected"),e.addClass("red-ui-debug-msg-row-pinned")}})).toggleClass("selected",f);e.toggleClass("red-ui-debug-msg-row-pinned",f),RED.popover.tooltip(h,RED._("node-red:debug.sidebar.pinPath"))}s&&(s.addClass("red-ui-debug-msg-tools-other"),s.appendTo(d))}(v,R,D,r,0,m,C),y)E||($('<span class="red-ui-debug-msg-object-key"></span>').text(y).appendTo(v),$("<span>: </span>").appendTo(v));else if(L.addClass("red-ui-debug-msg-top-level"),R){var O=a[R];if(_=[],O){for(var S in O)if(O.hasOwnProperty(S))try{void 0!==p({$:r},O[S])&&_.push(S)}catch(e){}_.sort()}L.clearPinned=function(){L.find(".red-ui-debug-msg-row-pinned").removeClass("red-ui-debug-msg-row-pinned"),a[R]={}}}g=$('<span class="red-ui-debug-msg-object-value"></span>').appendTo(v);var I=Array.isArray(r),P=!1;if(r&&"object"==typeof r&&r.hasOwnProperty("type")&&r.hasOwnProperty("data")&&(r.__enc__&&"array"===r.type||"Buffer"===r.type)&&(I=!0,P=!0),null==r)$('<span class="red-ui-debug-msg-type-null">'+r+"</span>").appendTo(g);else if(r.__enc__&&"undefined"===r.type)$('<span class="red-ui-debug-msg-type-null">undefined</span>').appendTo(g);else if(!r.__enc__||"number"!==r.type&&"bigint"!==r.type)if("function"===w||r.__enc__&&"function"===r.type)h=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("function").appendTo(g);else if("internal"===w||r.__enc__&&"internal"===r.type)h=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("[internal]").appendTo(g);else if("string"==typeof r)/[\t\n\r]/.test(r)&&(L.addClass("collapsed"),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(v),n(v,(function(){$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(w||"string").appendTo(v);var e=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(L);$('<pre class="red-ui-debug-msg-type-string"></pre>').text(r).appendTo(e)}),(function(e){k&&k(D,e)}),s(m,_))),h=$('<span class="red-ui-debug-msg-type-string red-ui-debug-msg-object-header"></span>').html('"'+t(i(r))+'"').appendTo(g),/^#[0-9a-f]{6}$/i.test(r)&&$('<span class="red-ui-debug-msg-type-string-swatch"></span>').css("backgroundColor",r).appendTo(h);else if("number"==typeof r)h=$('<span class="red-ui-debug-msg-type-number"></span>').appendTo(g),Number.isInteger(r)&&r>=0&&(h.addClass("red-ui-debug-msg-type-number-toggle"),h.on("click",(function(e){e.preventDefault(),d($(this),r,R,D,!0)}))),d(h,r,R,D,!1,"hex"===w?"hex":void 0);else if(I){L.addClass("collapsed");var N=r.length;if(w){var A=/\[(\d+)\]/.exec(w);A&&(N=parseInt(A[1]))}var z=r,M="array";P?(z=r.data,void 0===N&&(N=z.length),z.__enc__&&(z=z.data),M=r.type.toLowerCase()):/buffer/.test(w)&&(M="buffer");var B=z.length;if(N>0){$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(v);var G=$('<div class="red-ui-debug-msg-array-rows"></div>').appendTo(L);L.addClass("red-ui-debug-msg-buffer-raw")}if(y)b=$('<span class="red-ui-debug-msg-type-meta"></span>').text(w||M+"["+N+"]").appendTo(g);else{b=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(g),$("<span>[ </span>").appendTo(b);var U=Math.min(N,10);for(f=0;f<U;f++)o(z[f]).appendTo(b),f<U-1&&$("<span>, </span>").appendTo(b);N>U&&$("<span> &hellip;</span>").appendTo(b),0===U&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(b),$("<span> ]</span>").appendTo(b)}N>0&&n(v,(function(){if(y||(b=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(w||M+"["+N+"]").appendTo(v)),"buffer"===M){var t=$('<div class="red-ui-debug-msg-string-rows"></div>').appendTo(L),i=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(t),o="";try{o=String.fromCharCode.apply(null,new Uint16Array(z))}catch(e){console.log(e)}$('<pre class="red-ui-debug-msg-type-string"></pre>').text(o).appendTo(i);var a=$('<span class="red-ui-debug-msg-buffer-opts"></span>').appendTo(b),r=$('<a class="red-ui-button red-ui-button-small" href="#"></a>').text("raw").appendTo(a).on("click",(function(e){e.preventDefault(),e.stopPropagation(),l(L,$(this),R,D,!0)}));l(L,r,R,D,!1)}var d;if(B<=10)for(f=0;f<B;f++)d=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(G),j[D+"["+f+"]"]=e(z[f],{key:""+f,typeHint:"buffer"===M&&"hex",hideKey:!1,path:D+"["+f+"]",sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(d);else{for(f=0;f<B;f+=10){var c=f;d=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(G),v=$("<span></span>").appendTo(d),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').appendTo(v),n(v,function(){var t=c,i=Math.min(B-1,c+9),o=d;return function(){for(var n=t;n<=i;n++){var a=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(o);j[D+"["+n+"]"]=e(z[n],{key:""+n,typeHint:"buffer"===M&&"hex",hideKey:!1,path:D+"["+n+"]",sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(a)}}}(),function(){var e=e+"["+f+"]";return function(t){k&&k(e,t)}}(),s(m,_,c,Math.min(B-1,c+9))),$('<span class="red-ui-debug-msg-object-key"></span>').html("["+c+" &hellip; "+Math.min(B-1,c+9)+"]").appendTo(v)}B<N&&$('<div class="red-ui-debug-msg-object-entry collapsed"><span class="red-ui-debug-msg-object-key">['+B+" &hellip; "+N+"]</span></div>").appendTo(G)}}),(function(e){k&&k(D,e)}),s(m,_))}else if("object"==typeof r){L.addClass("collapsed");var F=Object.keys(r);if((y||F.length>0)&&($('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(v),n(v,(function(){for(y||$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text("object").appendTo(v),f=0;f<F.length;f++){var t=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(L),i=D;void 0!==i&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(F[f])?i+=(i.length>0?".":"")+F[f]:i+='["'+F[f].replace(/"/,'\\"')+'"]'),j[i]=e(r[F[f]],{key:F[f],typeHint:!1,hideKey:!1,path:i,sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(t)}0===F.length&&$('<div class="red-ui-debug-msg-object-entry red-ui-debug-msg-type-meta collapsed"></div>').text("empty").appendTo(L)}),(function(e){k&&k(D,e)}),s(m,_))),y)$('<span class="red-ui-debug-msg-type-meta"></span>').text("object").appendTo(g);else{b=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(g),$("<span>{ </span>").appendTo(b);var J=Math.min(F.length,5);for(f=0;f<J;f++)$('<span class="red-ui-debug-msg-object-key"></span>').text(F[f]).appendTo(b),$("<span>: </span>").appendTo(b),o(r[F[f]]).appendTo(b),f<J-1&&$("<span>, </span>").appendTo(b);F.length>J&&$("<span> &hellip;</span>").appendTo(b),0===J&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(b),$("<span> }</span>").appendTo(b)}}else $('<span class="red-ui-debug-msg-type-other"></span>').text(""+r).appendTo(g);else h=$('<span class="red-ui-debug-msg-type-number red-ui-debug-msg-object-header"></span>').text(r.data).appendTo(g);return T&&L.prop("expand",(function(){return function(e,t){if(D===e)v.prop("toggle")&&v.prop("toggle")(t);else if(j[e]&&j[e].prop("expand"))j[e].prop("expand")(e,t);else for(var i in j)if(j.hasOwnProperty(i)&&0===e.indexOf(i)){j[i].prop("expand")&&j[i].prop("expand")(e,t);break}}})),L},getMessageProperty:p,setMessageProperty:function(e,t,i,o){void 0===o&&(o=void 0!==i),0===t.indexOf("msg.")&&(t=t.substring(4));for(var n,a=c(t),r=a.length,s=e,d=0;d<r-1;d++)if("string"==typeof(n=a[d])||"number"==typeof n&&!Array.isArray(s))if(s.hasOwnProperty(n))s=s[n];else{if(!o)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else if("number"==typeof n)if(void 0===s[n]){if(!o)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else s=s[n];n=a[r-1],void 0===i?"number"==typeof n&&Array.isArray(s)?s.splice(n,1):delete s[n]:s[n]=i},normalisePropertyExpression:c,validatePropertyExpression:function(e){try{c(e);return!0}catch(e){return!1}},separateIconPath:u,getDefaultNodeIcon:f,getNodeIcon:function(e,t){if(t&&"_selection_"===t.type)return"font-awesome/fa-object-ungroup";if(t&&"group"===t.type)return"font-awesome/fa-object-group";if("config"===e.category)return RED.settings.apiRootUrl+"icons/node-red/cog.svg";if(t&&"tab"===t.type)return"red-ui-icons/red-ui-icons-flow";if(t&&"unknown"===t.type)return RED.settings.apiRootUrl+"icons/node-red/alert.svg";if(t&&t.icon){if(h(i=u(t.icon)))return"font-awesome"===i.module?t.icon:RED.settings.apiRootUrl+"icons/"+t.icon;if("font-awesome"!==i.module&&/.png$/i.test(i.file)&&(i.file=i.file.replace(/.png$/,".svg"),h(i)))return RED.settings.apiRootUrl+"icons/"+t.icon.replace(/.png$/,".svg")}var i;if(h(i=f(e,t)))return"font-awesome"===i.module?i.module+"/"+i.file:RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file;if(/.png$/i.test(i.file)){var o=i.file;if(i.file=i.file.replace(/.png$/,".svg"),h(i))return RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file;i.file=o}return i.module="node-red",h(i)||/.png$/i.test(i.file)&&(i.file=i.file.replace(/.png$/,".svg"),h(i))?RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file:"subflows"===e.category?RED.settings.apiRootUrl+"icons/node-red/subflow.svg":RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"},getNodeLabel:function(e,t){var i;if(t=t||"","tab"===e.type)i=e.label||t;else if("group"===e.type)i=e.name||t;else{i=e._def.label;try{i=("function"==typeof i?i.call(e):i)||t}catch(o){console.log("Definition error: "+e.type+".label",o),i=t}}return RED.text.bidi.enforceTextDirectionWithUCC(i)},getNodeColor:function(e,t){var i=t.color,o=RED.settings.theme("palette.theme")||[];if(o.length>0){if(!g.hasOwnProperty(e)){g[e]=t.color;for(var n=o.length,a=0;a<n;a++){var r=o[a];if((!r.hasOwnProperty("category")||(r.hasOwnProperty("_category")||(r._category=new RegExp(r.category)),r._category.test(t.category)))&&(!r.hasOwnProperty("type")||(r.hasOwnProperty("_type")||(r._type=new RegExp(r.type)),r._type.test(e)))){g[e]=r.color||t.color;break}}}i=g[e]}return i||"#ddd"},clearNodeColorCache:function(){g={}},addSpinnerOverlay:function(e,t){var i=$('<div class="red-ui-component-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&i.addClass("red-ui-component-spinner-contain"),i},decodeObject:function(e,t){if("number"===t&&"NaN"===e)e=Number.NaN;else if("number"===t&&"Infinity"===e)e=1/0;else if("number"===t&&"-Infinity"===e)e=-1/0;else if("Object"===t||/^array/.test(t)||"boolean"===t||"number"===t)e=JSON.parse(e);else if(/error/i.test(t))e=((e=JSON.parse(e)).name?e.name+": ":"")+e.message;else if("null"===t)e=null;else if("undefined"===t)e=void 0;else if(/^buffer/.test(t)){var i=e;e=[];for(var o=0;o<i.length;o+=2)e.push(parseInt(i.substr(o,2),16))}return e},parseContextKey:function(e){var t={},i=/^#:\((\S+?)\)::(.*)$/.exec(e);return i?(t.store=i[1],t.key=i[2]):(t.key=e,RED.settings.context&&(t.store=RED.settings.context.default)),t},createIconElement:function(e,t,i){var o=t.find(".red-ui-palette-icon");0!==o.length&&o.remove(),0!==(a=t.find("i")).length&&a.remove();var n=u(e);if("font-awesome"===n.module){if(RED.nodes.fontAwesome.getIconUnicode(n.file)){var a,r=i?"fa-lg ":"";return void(a=$("<i/>").appendTo(t)).addClass("red-ui-palette-icon-fa fa fa-fw "+r+n.file)}e=RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"}else if("red-ui-icons"===n.module){return void $("<i/>").appendTo(t).addClass("red-ui-palette-icon red-ui-icons "+n.file)}$("<div/>",{class:"red-ui-palette-icon"}).appendTo(t).css("backgroundImage","url("+e+")")},sanitize:i,renderMarkdown:e,createNodeIcon:function(e){var t=e._def,i=$("<div>",{class:"red-ui-search-result-node"});if("_selection_"===e.type)i.addClass("red-ui-palette-icon-selection");else if("group"===e.type)i.addClass("red-ui-palette-icon-group");else if("tab"===e.type)i.addClass("red-ui-palette-icon-flow");else{var o=RED.utils.getNodeColor(e.type,t);i.css("backgroundColor",o);var n=v(o);n!==o&&i.css("border-color",n)}var a=RED.utils.getNodeIcon(t,e),r=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(i);return RED.utils.createIconElement(a,r,!0),i},getDarkerColor:v}}(),function(e){e.widget("nodered.editableList",{_create:function(){var t,i=this;(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton)&&(t="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",e('<a href="#" class="red-ui-button red-ui-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+t+"</a>").appendTo(this.topContainer).on("click",(function(e){e.preventDefault(),i.addItem({})})));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach((function(e){var t=i.element.css(e);"auto"!==t&&""!==t&&(i.topContainer.css(e,t),i.uiContainer.css(e,"0"),"top"===e&&i.options.header&&i.uiContainer.css(e,"20px"),i.element.css(e,"auto"))})),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var o=this.element.css("minHeight");"0px"!==o&&(this.uiContainer.css("minHeight",o),this.element.css("minHeight",0));var n=this.element.css("maxHeight");"0px"!==n&&(this.uiContainer.css("maxHeight",n),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var a,r=this.element.attr("style");if(null!==(a=/width\s*:\s*(\d+%)/i.exec(r))&&(this.element.width("100%"),this.uiContainer.width(a[1])),this.options.sortable){var s={axis:"y",update:function(e,t){i.options.sortItems&&i.options.sortItems(i.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(s.connectWith=this.options.connectWith),this.element.sortable(s)}this._resize()},_resize:function(){var t=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-t),this.options.resize&&this.options.resize(),this.options.resizeItem){var i=this;this.element.children().each((function(t){i.options.resizeItem(e(this).children(".red-ui-editableList-item-content"),t)}))}},_destroy:function(){if(this.topContainer){var e=this.topContainer;delete this.topContainer,e.remove()}},_refreshFilter:function(){var e=this,t=0;return this.activeFilter?(this.items().each((function(i,o){var n=o.data("data");try{e.activeFilter(n)?(o.parent().show(),t++):o.parent().hide()}catch(e){console.log(e),o.parent().show(),t++}})),t):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var t=this.element.children(),i=this;t.sort((function(t,o){return i.activeSort(e(t).children(".red-ui-editableList-item-content").data("data"),e(o).children(".red-ui-editableList-item-content").data("data"))})),e.each(t,(function(e,t){i.element.append(t)}))}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},getItemAt:function(t){var i=this.items();return t>=0&&t<i.length?e(i[t]).data("data"):void 0},indexOf:function(t){for(var i=this.items(),o=0;o<i.length;o++)if(e(i[o]).data("data")===t)return o;return-1},insertItemAt:function(t,i){var o=this;t=t||{};var n=e("<li>"),a=e("<div/>").addClass("red-ui-editableList-item-content").appendTo(n);if(a.data("data",t),!0===this.options.sortable&&(e('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(n),n.addClass("red-ui-editableList-item-sortable")),this.options.removable){var r=e("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(n);e("<i/>",{class:"fa fa-remove"}).appendTo(r),n.addClass("red-ui-editableList-item-removable"),r.on("click",(function(t){t.preventDefault();var i=a.data("data");n.addClass("red-ui-editableList-item-deleting"),n.fadeOut(300,(function(){e(this).remove(),o.options.removeItem&&o.options.removeItem(i)}))}))}var s=!1;if(this.activeSort){this.items().each((function(e,i){if(!s){var a=i.data("data");o.activeSort(t,a)<0&&(n.insertBefore(i.closest("li")),s=!0)}}))}if(s||(i<=0?n.prependTo(this.element):i>o.element.children().length-1?n.appendTo(this.element):n.insertBefore(this.element.children().eq(i))),this.options.addItem){i=o.element.children().length-1;if(o.options.addItem(a,i,t),o.activeFilter)try{o.activeFilter(t)||n.hide()}catch(e){}!o.activeSort&&o.scrollOnAdd&&setTimeout((function(){o.uiContainer.scrollTop(o.element.height())}),0)}},addItem:function(e){this.insertItemAt(e,this.element.children().length)},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t,i){var o=this.element.children().filter((function(i){return t===e(this).children(".red-ui-editableList-item-content").data("data")}));i?o.detach():o.remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map((function(t){return e(this).children(".red-ui-editableList-item-content")}))},empty:function(){this.element.empty(),this.uiContainer.scrollTop(0)},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length},show:function(t){var i=this.element.children().filter((function(i){return t===e(this).children(".red-ui-editableList-item-content").data("data")}));i.length>0&&this.uiContainer.scrollTop(this.uiContainer.scrollTop()+i.position().top)},getItem:function(e){var t=e.children(".red-ui-editableList-item-content");return t.length?t.data("data"):null}})}(jQuery),function(e){e.widget("nodered.treeList",{_create:function(){var t=this;this.element.addClass("red-ui-treeList"),this.element.attr("tabIndex",0);var i=e("<div>",{class:"red-ui-treeList-container"}).appendTo(this.element);this.element.on("keydown",(function(e){var i=t._topList.find(".selected").parent().data("data");if(i||40!==e.keyCode&&38!==e.keyCode){var o;switch(e.keyCode){case 13:e.preventDefault(),e.stopPropagation(),i.children?i.treeList.container.hasClass("expanded")?i.treeList.collapse():i.treeList.expand():t._trigger("confirm",null,i);break;case 37:e.preventDefault(),e.stopPropagation(),i.children&&i.treeList.container.hasClass("expanded")?i.treeList.collapse():i.parent&&(o=i.parent);break;case 38:e.preventDefault(),e.stopPropagation(),(o=t._getPreviousSibling(i))&&(o=t._getLastDescendant(o)),!o&&i.parent&&(o=i.parent);break;case 39:e.preventDefault(),e.stopPropagation(),i.children&&(i.treeList.container.hasClass("expanded")||i.treeList.expand());break;case 40:if(e.preventDefault(),e.stopPropagation(),i.children&&Array.isArray(i.children)&&i.children.length>0&&i.treeList.container.hasClass("expanded"))o=i.children[0];else for(o=t._getNextSibling(i);!o&&i.parent;)i=i.parent,o=t._getNextSibling(i)}o&&t.select(o)}else t.select(t._data[0])})),this._data=[],this._items={},this._selected=new Set,this._topList=e('<ol class="red-ui-treeList-list">').css({position:"absolute",top:0,left:0,right:0,bottom:0}).appendTo(i);var o={addButton:!1,scrollOnAdd:!1,height:"100%",addItem:function(e,i,o){t._addSubtree(t._topList,e,o,0)}};this.options.header&&(o.header=this.options.header),!1!==this.options.rootSortable&&this.options.sortable&&(o.sortable=this.options.sortable,o.connectWith=".red-ui-treeList-sortable",this._topList.addClass("red-ui-treeList-sortable")),this._topList.editableList(o),this.options.data&&this.data(this.options.data)},_getLastDescendant:function(e){return e.children&&e.treeList.container.hasClass("expanded")&&0!==e.children.length?this._getLastDescendant(e.children[e.children.length-1]):e},_getPreviousSibling:function(e){var t,i=(t=e.parent?e.parent.children:this._data).indexOf(e);return 0===i?null:t[i-1]},_getNextSibling:function(e){var t,i=(t=e.parent?e.parent.children:this._data).indexOf(e);return i===t.length-1?null:t[i+1]},_addChildren:function(t,i,o,n,a){var r=this,s=e('<ol class="red-ui-treeList-list">').appendTo(t).editableList({connectWith:".red-ui-treeList-sortable",sortable:r.options.sortable,addButton:!1,scrollOnAdd:!1,height:"auto",addItem:function(e,t,i){r._addSubtree(s,e,i,n+1)},sortItems:function(t){var o=[],n=[];t.each((function(){var t=e(this).data("data");o.push(t);var a=r._fixDepths(i,t);a&&n.push(a)})),Array.isArray(i.children)&&(i.children=o),n.forEach((function(e){r._trigger("changeparent",null,e)})),r._trigger("sort",null,i)},filter:i.treeList.childFilter});r.options.sortable&&s.addClass("red-ui-treeList-sortable");var d=0,l=function(){for(var e=d,t=0;t<30;t++){if((d=e+t)===o.length)return void setTimeout((function(){a&&a()}),10);o[d].parent=i,s.editableList("addItem",o[d])}++d<o.length&&setTimeout((function(){l()}),10)};return l(),s.hide(),s},_fixDepths:function(t,i){var o=this,n=null;if(i.parent!==t){reparented=!0;var a=i.parent;i.parent=t,n={item:i,old:a}}if(i.depth!==t.depth+1){i.depth=t.depth+1;var r=(i.gutter?i.gutter.width()+2:0)+20*i.depth;i.treeList.labelPadding.width(r+"px"),i.element&&e(i.element).css({width:"calc(100% - "+(r+20+(i.icon?20:0))+"px)"}),i.children&&Array.isArray(i.children)&&i.children.forEach((function(e){o._fixDepths(i,e)}))}return n},_initItem:function(t,i){if(!t.treeList){var o=this;this._items[t.id]=t,t.treeList={},t.depth=i,t.treeList.remove=function(e){if(t.treeList.parentList&&t.treeList.parentList.editableList("removeItem",t,e),t.parent){var i=t.parent.children.indexOf(t);t.parent.children.splice(i,1),o._trigger("sort",null,t.parent)}o._selected.delete(t),delete t.treeList,delete o._items[t.id]},t.treeList.insertChildAt=function(e,i,n){e.parent=t,t.children.splice(i,0,e);var a=function(e,t){o._initItem(t,e.depth+1),t.parent=e,t.children&&"function"!=typeof t.children&&t.children.forEach((function(i){a(t,i,e.depth+2)}))};a(t,e),!t.deferBuild&&t.treeList.childList&&(t.treeList.childList.editableList("insertItemAt",e,i),n&&setTimeout((function(){o.select(e)}),100),o._trigger("sort",null,t),o.activeFilter&&o.filter(o.activeFilter))},t.treeList.addChild=function(e,i){t.treeList.insertChildAt(e,t.children.length,i)},t.treeList.expand=function(n){if(t.children){if(!t.treeList.container)return t.expanded=!0,void(n&&n(!1));var a=t.treeList.container;if(a.hasClass("expanded"))n&&n(!1);else{if(a.hasClass("built")||!t.deferBuild&&"function"!=typeof t.children)o._loadingData||t.children.length>20?t.treeList.childList.show():t.treeList.childList.slideDown("fast"),t.expanded=!0,n&&n(!o._loadingData);else{a.addClass("built");var r,s=!1,d=0,l=(Date.now(),function(e){s=!0,t.treeList.childList=o._addChildren(a,t,e,i,(function(){n&&n(!0),o._trigger("childrenloaded",null,t)}));var l=Date.now()-d;l<400?setTimeout((function(){t.treeList.childList.slideDown("fast"),r&&r.remove()}),400-l):(t.treeList.childList.slideDown("fast"),r&&r.remove()),t.expanded=!0});"function"==typeof t.children?t.children(l,t):(delete t.deferBuild,l(t.children)),s||(d=Date.now(),r=e('<div class="red-ui-treeList-spinner">').css({"background-position":35+20*i+"px 50%"}).appendTo(a))}a.addClass("expanded")}}else n&&n(!1)},t.treeList.collapse=function(){t.children&&(t.expanded=!1,t.treeList.container&&(t.children.length<20?t.treeList.childList.slideUp("fast"):t.treeList.childList.hide(),t.treeList.container.removeClass("expanded")))},t.treeList.sortChildren=function(e){t.children&&(t.children.sort(e),t.treeList.childList&&(t.treeList.childList.editableList("sort",e),t.treeList.childList.editableList("sort",null)))},t.treeList.replaceElement=function(i){if(t.element){if(t.treeList.container){e(t.element).remove(),e(i).appendTo(t.treeList.label);var o=(t.gutter?t.gutter.width()+2:0)+20*t.depth;e(i).css({width:"calc(100% - "+(o+20+(t.icon?20:0))+"px)"})}t.element=i}},t.children&&"function"!=typeof t.children&&t.children.forEach((function(e){o._initItem(e,i+1)}))}},_addSubtree:function(t,i,o,n){var a=this;this._initItem(o,n),o.treeList.container=i,o.treeList.parentList=t;var r=e("<div>",{class:"red-ui-treeList-label"});r.appendTo(i),o.treeList.label=r,o.class&&r.addClass(o.class),o.gutter&&o.gutter.css({position:"absolute"}).appendTo(r);var s=(o.gutter?o.gutter.width()+2:0)+20*n;o.treeList.labelPadding=e("<span>").css({display:"inline-block",width:s+"px"}).appendTo(r),r.on("mouseover",(function(e){a._trigger("itemmouseover",e,o)})),r.on("mouseout",(function(e){a._trigger("itemmouseout",e,o)})),r.on("mouseenter",(function(e){a._trigger("itemmouseenter",e,o)})),r.on("mouseleave",(function(e){a._trigger("itemmouseleave",e,o)})),o.treeList.makeLeaf=function(e){if(d.children().length){if(e&&o.children){var t=function(e){e.children&&e.children.forEach((function(e){e.element&&e.element.detach(),e.gutter&&e.gutter.detach(),t(e)}))};t(o)}d.empty(),o.deferBuild||(o.treeList.childList.remove(),delete o.treeList.childList),r.off("click.red-ui-treeList-expand"),d.off("click.red-ui-treeList-expand"),delete o.children,i.removeClass("expanded"),delete o.expanded}},o.treeList.makeParent=function(t){d.children().length||(e('<i class="fa fa-angle-right" />').appendTo(d),d.on("click.red-ui-treeList-expand",(function(e){e.stopPropagation(),e.preventDefault(),i.hasClass("expanded")?o.treeList.collapse():o.treeList.expand()})),r.on("click.red-ui-treeList-expand",(function(e){i.hasClass("expanded")?(o.hasOwnProperty("selected")||r.hasClass("selected"))&&o.treeList.collapse():o.treeList.expand()})),o.children||(o.children=t||[],o.treeList.childList=a._addChildren(i,o,o.children,n)))};var d=e('<span class="red-ui-treeList-icon"></span>').appendTo(r);if(o.children&&o.treeList.makeParent(),o.checkbox){var l=e('<span class="red-ui-treeList-icon"></span>'),c=e('<input class="red-ui-treeList-checkbox" type="checkbox">').prop("checked",o.selected).appendTo(l);c.on("click",(function(e){e.stopPropagation()})),c.on("change",(function(e){o.selected=this.checked,o.selected?a._selected.add(o):a._selected.delete(o),r.toggleClass("selected",this.checked),a._trigger("select",e,o)})),o.children||r.on("click",(function(e){e.stopPropagation(),c.trigger("click")})),o.treeList.select=function(e){e!==o.selected&&c.trigger("click")},l.appendTo(r)}else r.on("click",(function(e){a.options.multi||a.clearSelection(),r.addClass("selected"),a._selected.add(o),a._trigger("select",e,o)})),r.on("dblclick",(function(e){o.children||a._trigger("confirm",e,o)})),o.treeList.select=function(e){a.options.multi||a.clearSelection(),r.toggleClass("selected",e),e?(a._selected.add(o),a._trigger("select",null,o)):a._selected.delete(o),a.reveal(o)};r.toggleClass("selected",!!o.selected),o.selected&&a._selected.add(o),o.icon&&("string"==typeof o.icon?e('<span class="red-ui-treeList-icon"><i class="'+o.icon+'" /></span>').appendTo(r):e('<span class="red-ui-treeList-icon">').appendTo(r).append(o.icon)),o.hasOwnProperty("label")||o.hasOwnProperty("sublabel")?(o.hasOwnProperty("label")&&e('<span class="red-ui-treeList-label-text"></span>').text(o.label).appendTo(r),o.hasOwnProperty("sublabel")&&e('<span class="red-ui-treeList-sublabel-text"></span>').text(o.sublabel).appendTo(r)):o.element&&(e(o.element).appendTo(r),e(o.element).css({width:"calc(100% - "+(s+20+(o.icon?20:0))+"px)"})),o.children&&(Array.isArray(o.children)&&!o.deferBuild&&(o.treeList.childList=a._addChildren(i,o,o.children,n)),o.expanded&&o.treeList.expand())},empty:function(){this._topList.editableList("empty")},data:function(e){var t=this;if(void 0===e)return this._data;this._data=e,this._items={},this._topList.editableList("empty"),this._loadingData=!0;for(var i=0;i<e.length;i++)this._topList.editableList("addItem",e[i]);setTimeout((function(){delete t._loadingData}),200),this._trigger("select")},show:function(e,t){if("string"==typeof e&&(e=this._items[e]),e){for(var i=this,o=[],n=e;n;)o.unshift(n),n=n.parent;var a=!1,r=function(e){a=a||e;var n=o.shift();0===o.length?setTimeout((function(){i.reveal(n),t&&t()}),a?200:0):n.treeList.expand(r)};r()}},reveal:function(e){if("string"==typeof e&&(e=this._items[e]),e){var t=this._topList.offset().top,i=e.treeList.label.offset().top,o=this._topList.parent().scrollTop();i-=t+o;var n=this._topList.parent().height(),a=e.treeList.label.outerHeight();i<a/2?this._topList.parent().scrollTop(o+i-a/2-a):i+a>n&&this._topList.parent().scrollTop(o+(i+2.5*a-n))}},select:function(e,t,i){var o=this;this.options.multi||!1===i||this.clearSelection(),Array.isArray(e)?e.forEach((function(e){o.select(e,t,!1)})):("string"==typeof e&&(e=this._items[e]),e&&(e.selected=!0,this._selected.add(e),e.treeList.label&&e.treeList.label.addClass("selected"),!1!==t&&this._trigger("select",null,e)))},clearSelection:function(){this._selected.forEach((function(e){e.selected=!1,e.treeList.label&&e.treeList.label.removeClass("selected")})),this._selected.clear()},selected:function(){var e=[];return this._selected.forEach((function(t){e.push(t)})),this.options.multi?e:e.length?e[0]:void 0},filter:function(e){this.activeFilter=e;var t=0,i=function(o){var n=0;e&&e(o)&&(n++,t++);var a=0;return o.children&&"function"!=typeof o.children&&(o.treeList.childList?a=o.treeList.childList.editableList("filter",i):(o.treeList.childFilter=i,e&&o.children.forEach((function(e){i(e)&&a++}))),n+=a,e&&a>0&&setTimeout((function(){o.treeList.expand()}),10)),e?n>0:(t++,!0)};return this._topList.editableList("filter",i),t},get:function(e){return this._items[e]||null}})}(jQuery),function(e){e.widget("nodered.checkboxSet",{_create:function(){var t=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var i=this.element.prop("checked");this.states=[e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],i?this.states[1].show():this.states[0].show(),this.element.on("change",(function(){this.checked?(t.states[0].hide(),t.states[1].show(),t.states[2].hide()):(t.states[1].hide(),t.states[0].show(),t.states[2].hide());var e=this.checked;t.children.forEach((function(t){t.checkboxSet("state",e,!1,!0)}))})),this.uiElement.on("click",(function(e){e.stopPropagation(),t.state(!1===t.state())})),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)},updateChild:function(e){var t=0;this.children.forEach((function(e,i){!0===e.checkboxSet("state")&&t++})),0===t?this.state(!1,!0):t===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,i){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var o=this.partialFlag||e;this.element.prop("checked",o),!0===e?(this.states[0].hide(),this.states[1].show(),this.states[2].hide()):!1===e?(this.states[2].hide(),this.states[1].hide(),this.states[0].show()):null===e&&(this.states[0].hide(),this.states[1].hide(),this.states[2].show()),t||this.element.trigger("change",null),!i&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var e={};function t(a){var r,s;if(null!==a&&a.id&&!1===RED.settings.theme("menu."+a.id))return null;if(null===a)r=$('<li class="red-ui-menu-divider"></li>');else{r=$("<li></li>"),a.group&&r.addClass("red-ui-menu-group-"+a.group);var d="<a "+(a.id?'id="'+a.id+'" ':"")+'tabindex="-1" href="#">';a.toggle&&(d+='<i class="fa fa-square pull-left"></i>',d+='<i class="fa fa-check-square pull-left"></i>'),void 0!==a.icon&&(/\.(png|svg)/.test(a.icon)?d+='<img src="'+a.icon+'"/> ':d+='<i class="'+(a.icon?a.icon:'" style="display: inline-block;"')+'"></i> '),a.sublabel?d+='<span class="red-ui-menu-label-container"><span class="red-ui-menu-label">'+a.label+'</span><span class="red-ui-menu-sublabel">'+a.sublabel+"</span></span>":d+='<span class="red-ui-menu-label">'+a.label+"</span>",d+="</a>";var l=$(d).appendTo(r);if(e[a.id]=a,a.onselect?(l.on("click",(function(e){e.preventDefault(),$(this).parent().hasClass("disabled")||(a.toggle?!0===a.toggle?n(a.id,!o(a.id)):n(a.id,!0):i(a.id))})),a.toggle&&(s=RED.settings.get("menu-"+a.id),a.setting&&(null!==s?(RED.settings.set(a.setting,s),RED.settings.remove("menu-"+a.id)):s=RED.settings.get(a.setting)),s?(l.addClass("active"),i(a.id,!0)):!1===s?(l.removeClass("active"),i(a.id,!1)):a.hasOwnProperty("selected")&&(a.selected?l.addClass("active"):l.removeClass("active"),i(a.id,a.selected)))):a.href?l.attr("target","_blank").attr("href",a.href):a.options||(r.addClass("disabled"),l.on("click",(function(e){e.preventDefault()}))),a.options){r.addClass("red-ui-menu-dropdown-submenu pull-left");for(var c=$('<ul id="'+a.id+'-submenu" class="red-ui-menu-dropdown"></ul>').appendTo(r),p=0;p<a.options.length;p++){var u=t(a.options[p]);u&&u.appendTo(c)}}a.disabled&&r.addClass("disabled")}return r}function i(t,i){var o=e[t],n=o.onselect;"string"==typeof o.onselect&&(n=RED.actions.get(o.onselect)),n?n.call(o,i):console.log("No callback for",t,o.onselect)}function o(e){return $("#"+e).hasClass("active")}function n(t,a){var r=!1;o(t)==a&&(r=!0);var s=e[t];if(a?$("#"+t).addClass("active"):$("#"+t).removeClass("active"),s){if(s.toggle&&"string"==typeof s.toggle&&a)for(var d in e)if(e.hasOwnProperty(d)){var l=e[d];l.id!=s.id&&s.toggle==l.toggle&&n(l.id,!1)}!r&&s.onselect&&i(s.id,a),s.local||r||RED.settings.set(s.setting||"menu-"+s.id,a)}}return{init:function(e){var i=$("<ul/>",{class:"red-ui-menu red-ui-menu-dropdown pull-right"});if(e.id){i.attr({id:e.id+"-submenu"});var o=$("#"+e.id);1===o.length&&(i.insertAfter(o),o.on("click",(function(e){e.stopPropagation(),e.preventDefault(),i.is(":visible")?($(document).off("click.red-ui-menu"),i.hide()):($(document).on("click.red-ui-menu",(function(e){$(document).off("click.red-ui-menu"),activeMenu=null,i.hide()})),$(".red-ui-menu.red-ui-menu-dropdown").hide(),i.show())})))}for(var n=!1,a=0;a<e.options.length;a++){var r=e.options[a];if(null!==r||!n){var s=t(r);s&&(s.appendTo(i),n=null===r)}}return i},setSelected:n,isSelected:o,toggleSelected:function(e){n(e,!o(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,i){var o=t(i);if(null!==i&&i.group){var n=$("#"+e+"-submenu").children(".red-ui-menu-group-"+i.group);if(0===n.length)o.appendTo("#"+e+"-submenu");else{for(var a=0;a<n.length;a++){var r=n[a],s=$(r).find(".red-ui-menu-label").html();if(i.label<s){$(r).before(o);break}}a===n.length&&o.appendTo("#"+e+"-submenu")}}else o.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(t,i){var o=e[t];o&&(o.onselect=i)}}}(),RED.panels={create:function(e){var t=e.container||$("#"+e.id),i=t.children();if(2!==i.length)throw console.log(e.id),new Error("Container must have exactly two children");var o=!e.dir||"vertical"===e.dir;t.addClass("red-ui-panels"),o||t.addClass("red-ui-panels-horizontal"),$(i[0]).addClass("red-ui-panel"),$(i[1]).addClass("red-ui-panel");var n,a=$('<div class="red-ui-panels-separator"></div>').insertAfter(i[0]),r=[],s=!1,d=.5;a.draggable({axis:o?"y":"x",containment:t,scroll:!1,start:function(e,t){n=o?t.position.top:t.position.left,r=[o?$(i[0]).height():$(i[0]).width(),o?$(i[1]).height():$(i[1]).width()]},drag:function(a,s){var l=o?t.height():t.width(),c=(o?s.position.top:s.position.left)-n,p=[r[0]+c,r[1]-c];o?($(i[0]).height(p[0]),s.position.top-=c):($(i[0]).width(p[0]),s.position.left-=c),e.resize&&e.resize(p[0],p[1]),d=p[0]/(l-8)},stop:function(e,t){s=!0}});var l={ratio:function(e){if(void 0===e)return d;d=e,s=!0,0===e||1===e?a.hide():a.show(),o?l.resize(t.height()):l.resize(t.width())},resize:function(n){var a;if(o?(a=[$(i[0]).outerHeight(),$(i[1]).outerHeight()],t.height(n)):(a=[$(i[0]).outerWidth(),$(i[1]).outerWidth()],t.width(n)),s){var r=d*(n-8);a=[r,n-r-8],o?$(i[0]).outerHeight(a[0]):$(i[0]).outerWidth(a[0])}e.resize&&(a=o?[$(i[0]).height(),$(i[1]).height()]:[$(i[0]).width(),$(i[1]).width()],e.resize(a[0],a[1]))}};return l}},RED.popover=function(){var e={default:{top:10,topTop:30,leftRight:17,leftLeft:25,leftBottom:8,leftTop:11},small:{top:6,topTop:20,leftRight:8,leftLeft:26,leftBottom:8,leftTop:9}};return{create:function(t){var i=t.target,o=t.direction||"right",n=t.trigger,a=t.content,r=t.delay||{show:750,hide:50},s=t.autoClose,d=t.width||"auto",l=t.size||"default";if(!e[l])throw new Error("Invalid RED.popover size value:",l);var c,p,u=null,f=function(s){if(c){var f=i.data("red-ui-popover");if(t.tooltip&&f)return void(c=!1);if(p=$('<div class="red-ui-popover"></div>'),"default"!==l&&p.addClass("red-ui-popover-size-"+l),"function"==typeof a){var v=a.call(g);if(null===v)return;"string"==typeof v?p.text(v):p.append(v)}else p.html(a);"auto"!==d&&p.width(d),p.appendTo("body");var b=i.offset(),m=i.outerWidth(),y=i.outerHeight(),w=p.height(),E=p.width(),D=$(window).scrollTop(),R=$(window).scrollLeft(),x=D+$(window).height(),_=R+$(window).width(),k=0,T=0,C=o;"right"===C?(k=b.top+y/2-w/2-e[l].top,T=b.left+m+e[l].leftRight):"left"===C?(k=b.top+y/2-w/2-e[l].top,T=b.left-e[l].leftLeft-E):"bottom"===C?(k=b.top+y+e[l].top,(T=b.left+m/2-E/2-e[l].leftBottom)<0?(C="right",k=b.top+y/2-w/2-e[l].top,T=b.left+m+e[l].leftRight):T+E+10>_?(C="left",k=b.top+y/2-w/2-e[l].top,T=b.left-e[l].leftLeft-E,k+w+y/2+5>x&&(k-=k+w+y/2-x+5)):k+w>x&&(C="top",k=b.top-e[l].topTop-w,T=b.left+m/2-E/2-e[l].leftTop)):"top"===C&&(k=b.top-e[l].topTop-w,T=b.left+m/2-E/2-e[l].leftTop,k<0&&(C="bottom",k=b.top+y+e[l].top,T=b.left+m/2-E/2-e[l].leftBottom)),p.addClass("red-ui-popover-"+C).css({top:k,left:T}),f&&f.close(!0),i.data("red-ui-popover",g),t.tooltip&&p.on("mousedown",(function(e){h(!0)})),"hover"===n&&t.interactive&&(p.on("mouseenter",(function(e){clearTimeout(u),c=!0})),p.on("mouseleave",(function(e){u&&clearTimeout(u),c&&(u=setTimeout((function(){c=!1,h()}),r.hide))}))),s?p.show():p.fadeIn("fast")}},h=function(e){$(document).off("mousedown.red-ui-popover"),c||p&&(e?p.remove():p.fadeOut("fast",(function(){$(this).remove()})),p=null,i.removeData("red-ui-popover",g))};"hover"===n?(i.on("mouseenter",(function(e){clearTimeout(u),c||(c=!0,u=setTimeout(f,r.show))})),i.on("mouseleave disabled",(function(e){u&&clearTimeout(u),c&&(c=!1,setTimeout(h,r.hide))}))):"click"===n?(i.on("click",(function(e){e.preventDefault(),e.stopPropagation(),(c=!c)?f():h()})),s&&i.on("mouseleave disabled",(function(e){u&&clearTimeout(u),c&&(c=!1,setTimeout(h,s))}))):"modal"===n?$(document).on("mousedown.red-ui-popover",(function(e){for(var t=e.target;"BODY"!==t.nodeName&&t!==p[0];)t=t.parentElement;"BODY"===t.nodeName&&(c=!1,h())})):s&&setTimeout((function(){c=!1,h()}),s);var g={setContent:function(e){return a=e,g},open:function(e){return c=!0,f(e),g},close:function(e){return c=!1,h(e),g}};return g},tooltip:function(e,t,i){var o=t;return i&&(o=function(){var e=t,o=RED.keyboard.getShortcut(i);return o&&o.key&&(e=$("<span>"+t+' <span class="red-ui-popover-key">'+RED.keyboard.formatKey(o.key,!0)+"</span></span>")),e}),RED.popover.create({tooltip:!0,target:e,trigger:"hover",size:"small",direction:"bottom",content:o,delay:{show:750,hide:50}})},menu:function(e){var t=$('<ul class="red-ui-menu"></ul>');"compact"===e.style&&t.addClass("red-ui-menu-compact");var i,o=e.options||[];o.forEach((function(e){var o=$("<li>").appendTo(t),n=$('<a href="#"></a>').text(e.label).appendTo(o);n.on("click",(function(t){t.preventDefault(),e.onselect&&e.onselect(),a.hide()})),i||(i=n)}));var n=RED.popover.panel(t),a={show:function(i){$(document).on("keydown.red-ui-menu",(function(e){var i=t.find(":focus").parent();40===e.keyCode?(e.preventDefault(),i.length>0?i.index()===o.length-1?(console.log("WARP TO TOP"),t.children().first().children().first().focus()):(console.log("GO DOWN ONE"),i.next().children().first().focus()):t.children().first().children().first().focus()):38===e.keyCode?(e.preventDefault(),i.length>0?0===i.index()?(console.log("WARP TO BOTTOM"),t.children().last().children().first().focus()):(console.log("GO UP ONE"),i.prev().children().first().focus()):t.children().last().children().first().focus()):27===e.keyCode&&(e.preventDefault(),a.hide(!0)),e.stopPropagation()})),i.onclose=function(){$(document).off("keydown.red-ui-menu"),e.onclose&&e.onclose(!0)},n.show(i)},hide:function(t){$(document).off("keydown.red-ui-menu"),n.hide(e.disposeOnClose),e.onclose&&e.onclose(t)}};return a},panel:function(e){var t=$('<div class="red-ui-editor-dialog red-ui-popover-panel"></div>');function i(e){$(document).off("mousedown.red-ui-popover-panel-close"),$(document).off("keydown.red-ui-popover-panel-close"),t.hide(),t.css({height:"auto"}),!1!==e&&t.remove()}return t.css({display:"none"}),t.appendTo(document.body),e.appendTo(t),{container:t,show:function(e){var o=e.onclose,n=e.target,a=e.align||"right",r=e.offset||[0,0],s=n.offset(),d=(n.width(),n.height()),l=t.height(),c=t.width(),p=d+s.top+r[1];p+l>$(window).height()&&(p-=p+l-$(window).height()+5),p<0&&(l.height(l+p),p=0),"right"===a?t.css({top:p+"px",left:s.left+r[0]+"px"}):"left"===a&&t.css({top:p+"px",left:s.left-c+r[0]+"px"}),t.slideDown(100),$(document).on("keydown.red-ui-popover-panel-close",(function(t){27===t.keyCode&&(o&&o(),i(e.dispose))})),$(document).on("mousedown.red-ui-popover-panel-close",(function(n){$(n.target).closest(t).length||$(n.target).closest(".red-ui-editor-dialog").length||(o&&o(),i(e.dispose))}))},hide:i}}}}(),function(e){e.widget("nodered.searchBox",{_create:function(){var t=this;(this.currentTimeout=null,this.lastSent="",this.element.val(""),this.element.addClass("red-ui-searchBox-input"),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),"compact"===this.options.style&&this.uiContainer.addClass("red-ui-searchBox-compact"),0===this.element.parents("form").length)&&this.element.wrap("<form>").parent().addClass("red-ui-searchBox-form");if(e('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=e('<a class="red-ui-searchBox-clear" href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",(function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.trigger("focus")})),this.options.options){this.uiContainer.addClass("red-ui-searchBox-has-options"),this.optsButton=e('<a class="red-ui-searchBox-opts" href="#"><i class="fa fa-caret-down"></i></a>').appendTo(this.uiContainer);var i=!1;this.optsMenu=RED.popover.menu({style:this.options.style,options:this.options.options.map((function(e){return{label:e.label,onselect:function(){t.element.val(e.value+" "),t._change(e.value,!0)}}})),onclose:function(e){i=!1,t.element.trigger("focus")},disposeOnClose:!1});var o=function(){i=!0,t.optsMenu.show({target:t.optsButton,align:"left",offset:[t.optsButton.width()-2,-1],dispose:!1})};this.optsButton.on("click",(function(e){e.preventDefault(),i?t.optsMenu.hide(!0):o()})),this.optsButton.on("keydown",(function(e){i||40!==e.keyCode||o()})),this.element.on("keydown",(function(e){i||40!==e.keyCode||o()}))}this.resultCount=e("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",(function(e){27===e.keyCode&&t.element.val(""),13===e.keyCode&&e.preventDefault()})),this.element.on("keyup",(function(i){t._change(e(this).val())})),this.element.on("focus",(function(){e(document).one("mousedown",(function(){t.element.blur()}))}))},_change:function(e,t){var i=!1;""===e?(this.clearButton.hide(),i=!0):(this.clearButton.show(),i=e.length>=(this.options.minimumLength||0));var o=this.element.val();if(i=i&&o!==this.lastSent)if(!t&&this.options.delay>0){clearTimeout(this.currentTimeout);var n=this;this.currentTimeout=setTimeout((function(){n.lastSent=n.element.val(),n._trigger("change")}),this.options.delay)}else this.lastSent=this.element.val(),this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){var e,t="fa fa-lemon-o",i=!1,o=!1;return{create:function(n){var a,r,s,d,l={},c=0,p=0,u=n.order,f=n.element||$("#"+n.id),h=f.wrap("<div>").parent(),g=f.wrap("<div>").parent();if(h.addClass("red-ui-tabs"),n.vertical&&h.addClass("red-ui-tabs-vertical"),n.addButton){h.addClass("red-ui-tabs-add");var v=$('<div class="red-ui-tab-button red-ui-tabs-add"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(h);if(v.find("a").on("click",(function(e){e.preventDefault(),"function"==typeof n.addButton?n.addButton():"string"==typeof n.addButton&&RED.actions.invoke(n.addButton)})),"string"==typeof n.addButton){var b=n.addButton;n.addButtonCaption&&(b=n.addButtonCaption),RED.popover.tooltip(v,b,n.addButton)}f.on("dblclick",(function(e){var t=f.children(),i=e.clientX,o=0;t.each((function(e){if($(this).offset().left>i)return!1;o=e+1})),"function"==typeof n.addButton?n.addButton({index:o}):"string"==typeof n.addButton&&RED.actions.invoke(n.addButton,{index:o})}))}if(n.searchButton){h.addClass("red-ui-tabs-search");var m=$('<div class="red-ui-tab-button red-ui-tabs-search"><a href="#"><i class="fa fa-list-ul"></i></a></div>').appendTo(h);if(m.find("a").on("click",(function(e){e.preventDefault(),"function"==typeof n.searchButton?n.searchButton():"string"==typeof n.searchButton&&RED.actions.invoke(n.searchButton)})),"string"==typeof n.searchButton){b=n.searchButton;n.searchButtonCaption&&(b=n.searchButtonCaption),RED.popover.tooltip(m,b,n.searchButton)}}if(n.scrollable&&(h.addClass("red-ui-tabs-scrollable"),g.addClass("red-ui-tabs-scroll-container"),g.on("scroll",_),(s=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(h).find("a")).on("mousedown",(function(e){E(e,"-=150")})).on("click",(function(e){e.preventDefault()})),(d=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(h).find("a")).on("mousedown",(function(e){E(e,"+=150")})).on("click",(function(e){e.preventDefault()}))),n.collapsible){h.addClass("red-ui-tabs-collapsible");var y=$('<div class="red-ui-tab-link-buttons"></div>').appendTo(h);if(!1!==n.menu){var w=$('<a href="#"><i class="fa fa-caret-down"></i></a>').appendTo(y);w.addClass("red-ui-tab-link-button-menu"),w.on("click",(function(e){if(e.stopPropagation(),e.preventDefault(),!r){var i=[];f.children().each((function(e,o){var n=$(o).data("tabId"),a={id:"red-ui-tabs-menu-option-"+n,icon:l[n].iconClass||t,label:l[n].name,onselect:function(){T(n)}};i.push(a)})),i=[].concat(i),(r=RED.menu.init({options:i})).css({position:"absolute"}),r.appendTo("body")}var o=w.offset();r.css({top:o.top+w.height()-2+"px",left:o.left-r.width()+w.width()+"px"}),r.is(":visible")?$(document).off("click.red-ui-tabmenu"):($(".red-ui-menu.red-ui-menu-dropdown").hide(),$(document).on("click.red-ui-tabmenu",(function(e){$(document).off("click.red-ui-tabmenu"),r.hide()}))),r.toggle()}))}}function E(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var i=g.scrollLeft();g.animate({scrollLeft:t},100);var o=setInterval((function(){var e=g.scrollLeft();e!==i?(i=e,g.animate({scrollLeft:t},100)):clearInterval(o)}),100);$(this).one("mouseup",(function(){clearInterval(o)}))}}function D(){var e=f.find("li.red-ui-tab.selected"),t=[];return e.each((function(){t.push(l[$(this).find("a").attr("href").slice(1)])})),t}function R(){n.onselect(D())}function x(t){if(!i){if(e&&Date.now()-e<400)return e=0,o=!0,k.call(this,t);e=Date.now();var a=f.find("li.red-ui-tab.active"),r=$(this).parent(),s=!1;if(n.onselect)if(t.metaKey||t.ctrlKey){if(r.hasClass("selected")){if(r.removeClass("selected"),r[0]!==a[0])return void R();if(0===(p=f.find("li.red-ui-tab.selected")).length)return void R();r=p.first()}else{if(!a.hasClass("selected")){l[a.find("a").attr("href").slice(1)];a.addClass("selected")}r.addClass("selected")}s=!0}else if(t.shiftKey){var d,c;if(a[0]!==r[0])a.index()<r.index()?(d=a,c=r):(d=r,c=a),f.find("li.red-ui-tab").removeClass("selected"),d.addClass("selected"),c.addClass("selected"),d.nextUntil(c).addClass("selected");s=!0}else{var p;(p=f.find("li.red-ui-tab.selected")).length>0&&(p.removeClass("selected"),s=!0)}var u=r.find("a");n.onclick&&n.onclick(l[u.attr("href").slice(1)]),T(u),s&&R()}}function _(){if(0!==f.children().length){var e=g.scrollLeft(),t=g.width(),i=f.width();0===e?s.hide():s.show(),e===i-t?d.hide():d.show()}}function k(e){if(e.preventDefault(),!e.metaKey&&!e.shiftKey)return n.ondblclick&&n.ondblclick(l[$(this).attr("href").slice(1)]),!1}function T(e){if("string"==typeof e&&(e=f.find("a[href='#"+e+"']")),0!==e.length&&!e.parent().hasClass("active")){f.children().removeClass("active"),f.children().css({transition:"width 100ms"}),e.parent().addClass("active");var t=e.parent().attr("id");if(h.find(".red-ui-tab-link-button").removeClass("active selected"),$("#"+t+"-link-button").addClass("active selected"),n.scrollable){var i=e.parent().position().left;i-21<0?g.animate({scrollLeft:"+="+(i-50)},300):i+120>g.width()&&g.animate({scrollLeft:"+="+(i+140-g.width())},300)}n.onchange&&n.onchange(l[e.attr("href").slice(1)]),C(),setTimeout((function(){f.children().css({transition:""})}),100)}}function C(){if(!n.vertical){var e=f.find("li.red-ui-tab"),t=h.width(),i=e.length;if(n.collapsible){var o=y.children().length,r=y.children(":visible").length;if((d=t-y.width()-10)<=80||d<198&&r>5){var s=y.find("a:last").prev();for(y.children().length;s.is(":not(:visible)");)s=s.prev();(d<=80||r>6)&&s.hide(),d=Math.max(80,t-y.width()-10)}else{r!==o&&(d=r<6?80:198),t-d-y.width()>40&&y.find("a:not(:visible):first").show(),d=t-y.width()-10}e.css({width:d})}else{var d;if(p=(a=100*(d=(t-12-6*i)/i)/t+"%")+"%",n.scrollable){d=Math.max(d,140),a=d+"px",p=0;var l=Math.max(h.width(),12+(d+6)*i);f.width(l),_()}else n.hasOwnProperty("minimumActiveTabWidth")&&(d<n.minimumActiveTabWidth?(i-=1,d=(t-12-n.minimumActiveTabWidth-6*i)/i,a=100*d/t+"%",p=n.minimumActiveTabWidth+"px"):p=0);e.css({width:a}),d<50?(f.find(".red-ui-tab-icon").hide(),f.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,d-38))+"px"})):(f.find(".red-ui-tab-icon").show(),f.find(".red-ui-tab-label").css({paddingLeft:""})),0!==p&&(f.find("li.red-ui-tab.active").css({width:n.minimumActiveTabWidth}),f.find("li.red-ui-tab.active .red-ui-tab-icon").show(),f.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}}function j(e){if(n.onselect){var t=f.find("li.red-ui-tab.selected");t.length>0&&(t.removeClass("selected"),R())}var i=f.find("a[href='#"+e+"']").parent();if(i.hasClass("active")){var o=i.prev();0===o.length&&(o=i.next()),T(o.find("a"))}i.remove(),l[e].pinned&&c--,n.onremove&&n.onremove(l[e]),delete l[e],C(),r&&(r.remove(),r=null)}f.children().first().addClass("active"),f.children().addClass("red-ui-tab"),f.find("li.red-ui-tab a").on("mouseup",x).on("click",(function(e){e.preventDefault()})).on("dblclick",(function(e){e.stopPropagation(),e.preventDefault()})),setTimeout((function(){C()}),0);var L={addTab:function(e,a){if(n.onselect){var s=f.find("li.red-ui-tab.selected");s.length>0&&(s.removeClass("selected"),R())}l[e.id]=e;var d=$("<li/>",{class:"red-ui-tab"});0===f.children().length&&(a=void 0),0===a?d.prependTo(f):a>0?d.insertAfter(f.find("li:nth-child("+a+")")):d.appendTo(f),d.attr("id","red-ui-tab-"+e.id.replace(".","-")),d.data("tabId",e.id),n.maximumTabWidth&&d.css("maxWidth",n.maximumTabWidth+"px");var p=$("<a/>",{href:"#"+e.id,class:"red-ui-tab-label"}).appendTo(d);if(e.icon?$('<img src="'+e.icon+'" class="red-ui-tab-icon"/>').appendTo(p):e.iconClass&&$("<i>",{class:"red-ui-tab-icon "+e.iconClass}).appendTo(p),$("<span/>",{class:"red-ui-text-bidi-aware"}).text(e.label).appendTo(p).attr("dir",RED.text.bidi.resolveBaseTextDir(e.label)),n.collapsible){d.addClass("red-ui-tab-pinned");var h=$('<a href="#'+e.id+'" class="red-ui-tab-link-button"></a>');if(e.pinned?0===c?h.prependTo(y):h.insertAfter(y.find("a.red-ui-tab-link-button-pinned:last")):!1!==n.menu?h.insertBefore(y.find("a:last")):h.appendTo(y),h.attr("id",d.attr("id")+"-link-button"),e.iconClass?$("<i>",{class:e.iconClass}).appendTo(h):$("<i>",{class:t}).appendTo(h),h.on("click",(function(t){t.preventDefault(),T(e.id)})),h.data("tabId",e.id),e.pinned&&(h.addClass("red-ui-tab-link-button-pinned"),c++),RED.popover.tooltip($(h),e.name,e.action),n.onreorder){var v,b,m=[];h.draggable({distance:10,axis:"x",containment:".red-ui-tab-link-buttons",start:function(e,t){if(i=!0,$(".red-ui-tab-link-buttons").width($(".red-ui-tab-link-buttons").width()),o)return o=!1,!1;y.children().each((function(e){m[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width(),menu:$(this).hasClass("red-ui-tab-link-button-menu")},$(this).is(h)&&(v=e,b=e)})),y.children().each((function(e){e!==v&&$(this).css({position:"absolute",left:m[e].left+"px",width:m[e].width+2,transition:"left 0.3s"})})),h.hasClass("active")||h.css({zIndex:1})},drag:function(e,t){t.position.left+=m[v].left;for(var i=t.position.left+m[v].width/2,o=0;o<m.length;o++)if(o!==v&&!m[o].menu&&!m[o].el.is(":not(:visible)")&&i>m[o].left&&i<m[o].left+m[o].width){o<v?(m[o].left+=m[v].width+8,m[v].el.detach().insertBefore(m[o].el)):(m[o].left-=m[v].width+8,m[v].el.detach().insertAfter(m[o].el)),m[o].el.css({left:m[o].left+"px"}),m.splice(o,0,m.splice(v,1)[0]),v=o;break}},stop:function(e,t){if(i=!1,y.children().css({position:"relative",left:"",transition:""}),$(".red-ui-tab-link-buttons").width("auto"),h.css({zIndex:""}),C(),b!==v){r&&(r.remove(),r=null);var o=$.makeArray(y.children().map((function(){return $(this).data("tabId")})));L.order(o),n.onreorder(o)}}})}}if(p.on("mouseup",x),p.on("click",(function(e){e.preventDefault()})),p.on("dblclick",(function(e){e.stopPropagation(),e.preventDefault()})),e.closeable){d.addClass("red-ui-tabs-closeable");var w=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(d);w.append('<i class="fa fa-times" />'),w.on("click",(function(t){t.preventDefault(),j(e.id)}))}var E=$('<span class="red-ui-tabs-badges"></span>').appendTo(d);if(n.onselect&&($('<i class="red-ui-tabs-badge-changed fa fa-circle"></i>').appendTo(E),$('<i class="red-ui-tabs-badge-selected fa fa-check-circle"></i>').appendTo(E)),n.onadd&&n.onadd(e),p.attr("title",e.label),1==f.find("li.red-ui-tab").length&&T(p),n.onreorder&&!n.collapsible){var D,_,k,O=[];d.draggable({axis:"x",distance:20,start:function(e,t){if(o)return o=!1,!1;i=!0,D=[],O=[],f.children().each((function(e){O[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(d)&&(_=e,k=e),D.push($(this).data("tabId"))})),f.children().each((function(e){e!==_&&$(this).css({position:"absolute",left:O[e].left+"px",width:O[e].width+2,transition:"left 0.3s"})})),d.hasClass("active")||d.css({zIndex:1})},drag:function(e,t){t.position.left+=O[_].left+g.scrollLeft();for(var i=t.position.left+O[_].width/2-g.scrollLeft(),o=0;o<O.length;o++)if(o!==_&&i>O[o].left&&i<O[o].left+O[o].width){o<_?(O[o].left+=O[_].width+8,O[_].el.detach().insertBefore(O[o].el)):(O[o].left-=O[_].width+8,O[_].el.detach().insertAfter(O[o].el)),O[o].el.css({left:O[o].left+"px"}),O.splice(o,0,O.splice(_,1)[0]),_=o;break}},stop:function(e,t){i=!1,f.children().css({position:"relative",left:"",transition:""}),d.hasClass("active")||d.css({zIndex:""}),C(),k!==_&&n.onreorder(D,$.makeArray(f.children().map((function(){return $(this).data("tabId")})))),T(O[_].el.data("tabId"))}})}setTimeout((function(){C()}),10),r&&(r.remove(),r=null),u&&L.order(u)},removeTab:j,activateTab:T,nextTab:function(){var e=f.find("li.active").next();e.length>0&&T(e.find("a"))},previousTab:function(){var e=f.find("li.active").prev();e.length>0&&T(e.find("a"))},resize:C,count:function(){return f.find("li.red-ui-tab").length},contains:function(e){return f.find("a[href='#"+e+"']").length>0},renameTab:function(e,t){l[e].label=t;var i=f.find("a[href='#"+e+"']");i.attr("title",t),i.find("span.red-ui-text-bidi-aware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),C()},selection:D,order:function(e){u=e;var t,i=$.makeArray(f.children().map((function(){return $(this).data("tabId")}))),o=!0;for(t=0;t<e.length;t++)if(e[t]!==i[t]){o=!1;break}if(!o){var a={},r=(f.children().detach().each((function(){a[$(this).data("tabId")]=$(this)})),{});for(n.collapsible&&y.children().detach().each((function(){var e=$(this).data("tabId");e||(e="__menu__"),r[e]=$(this)})),t=0;t<e.length;t++)a[e[t]]&&(a[e[t]].appendTo(f),n.collapsible&&r[e[t]].appendTo(y),delete a[e[t]]);for(t in a)a.hasOwnProperty(t)&&(a[t].appendTo(f),n.collapsible&&r[t].appendTo(y));n.collapsible&&(r.__menu__.appendTo(y),C())}}};return L}}}(),RED.stack={create:function(e){var t=e.container;t.addClass("red-ui-stack");var i=0,o=[],n=!0,a=function(){if(o.length>0){var e=0;o.forEach((function(t){e+=t.header.outerHeight()}));var n=t.innerHeight();i=n-e-(o.length-1),o.forEach((function(e){e.contentWrap.height(i)}))}};return e.fill&&e.singleExpanded&&($(window).on("resize",a),$(window).on("focus",a)),{add:function(r){o.push(r),r.container=$('<div class="red-ui-palette-category">').appendTo(t),n||r.container.hide();var s=$('<div class="red-ui-palette-header"></div>').appendTo(r.container);if(r.header=s,r.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(r.container),e.fill&&r.contentWrap.css("height",i),r.content=$("<div></div>").appendTo(r.contentWrap),!1!==r.collapsible){s.on("click",(function(){if(e.singleExpanded)if(r.isExpanded())2===o.length&&(o[0]===r?(o[0].collapse(),o[1].expand()):(o[1].collapse(),o[0].expand()));else{for(var t=0;t<o.length;t++)o[t].isExpanded()&&o[t].collapse();r.expand()}else r.toggle()}));var d=$('<i class="fa fa-angle-down"></i>').appendTo(s);r.expanded?(r.container.addClass("expanded"),d.addClass("expanded")):r.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(s),s.css("cursor","default");return r.title=$("<span></span>").html(r.title).appendTo(s),r.toggle=function(){return r.isExpanded()?(r.collapse(),!1):(r.expand(),!0)},r.expand=function(){if(!r.isExpanded())return r.onexpand&&r.onexpand.call(r),e.singleExpanded&&o.forEach((function(e){e!==r&&e.collapse()})),d.addClass("expanded"),r.container.addClass("expanded"),r.contentWrap.slideDown(200),!0},r.collapse=function(){if(r.isExpanded())return d.removeClass("expanded"),r.container.removeClass("expanded"),r.contentWrap.slideUp(200),!0},r.isExpanded=function(){return r.container.hasClass("expanded")},e.fill&&e.singleExpanded&&a(),r},hide:function(){return n=!1,o.forEach((function(e){e.container.hide()})),this},show:function(){return n=!0,o.forEach((function(e){e.container.show()})),this},resize:function(){a&&a()}}}},function(e){var t=function(e){var t=RED.utils.parseContextKey(e);return{option:t.store,value:t.key}},i=function(e,t){if(!t)return e;var i="string"==typeof t?t:t.value;return i!==RED.settings.context.default?"#:("+i+")::"+e:e},o=function(e){return/^red\/images\/typedInput\/.+\.png$/.test(e)&&(e=e.replace(/.png$/,".svg")),e},n={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:t,export:i},global:{value:"global",label:"global.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:t,export:i},str:{value:"str",label:"string",icon:"red/images/typedInput/az.svg"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.svg",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.svg",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.svg",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var e=this,t=this.value();try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}RED.editor.editJSON({value:t,complete:function(t){var i=t;try{i=JSON.stringify(JSON.parse(t))}catch(e){}e.value(i)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.svg"},date:{value:"date",label:"timestamp",icon:"fa fa-clock-o",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.svg",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var e=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(t){e.value(t.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.svg",expand:function(){var e=this;RED.editor.editBuffer({value:this.value(),complete:function(t){e.value(t)}})}},env:{value:"env",label:"env variable",icon:"red/images/typedInput/env.svg"},node:{value:"node",label:"node",icon:"red/images/typedInput/target.svg",valueLabel:function(t,i){var o=RED.nodes.node(i),n=e("<div>",{class:"red-ui-search-result-node"}).css({"margin-top":"2px","margin-left":"3px"}).appendTo(t),a=e("<span>").css({"line-height":"32px","margin-left":"6px"}).appendTo(t);if(o){var r=RED.utils.getNodeColor(o.type,o._def),s=RED.utils.getNodeIcon(o._def,o);"tab"===o.type&&(r="#C0DEED"),n.css("backgroundColor",r);var d=e("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(n);RED.utils.createIconElement(s,d,!0);var l=RED.utils.getNodeLabel(o,o.id);a.text(l)}else n.css({backgroundColor:"#eee","border-style":"dashed"})},expand:function(){var e=this;RED.tray.hide(),RED.view.selectNodes({single:!0,selected:[e.value()],onselect:function(t){e.value(t.id),RED.tray.show()},oncancel:function(){RED.tray.show()}})}},cred:{value:"cred",label:"credential",icon:"fa fa-lock",inputType:"password",valueLabel:function(t,i){var o=this;t.css("pointer-events","none"),t.css("flex-grow",0),this.elementDiv.hide();var n=e("<div>").css({position:"absolute",right:"6px",top:"6px","pointer-events":"all"}).appendTo(t),a=e('<button type="button" class="red-ui-button red-ui-button-small"></button>').css({width:"20px"}).appendTo(n).on("click",(function(e){e.preventDefault();var t=o.input[0].selectionStart;"text"===o.input.attr("type")?(o.input.attr("type","password"),r.removeClass("fa-eye-slash").addClass("fa-eye"),setTimeout((function(){o.input.focus(),o.input[0].setSelectionRange(t,t)}),50)):(o.input.attr("type","text"),r.removeClass("fa-eye").addClass("fa-eye-slash"),setTimeout((function(){o.input.focus(),o.input[0].setSelectionRange(t,t)}),50))})).hide(),r=e('<i class="fa fa-eye"></i>').css("margin-left","-2px").appendTo(a);if("__PWRD__"===i)var s=e('<div><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i></div>').css({padding:"6px 6px",borderRadius:"4px"}).addClass("red-ui-typedInput-value-label-inactive").appendTo(t),d=e('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-pencil"></i></button>').appendTo(n).on("click",(function(e){e.preventDefault(),s.hide(),t.css("background","none"),t.css("pointer-events","none"),o.input.val(""),o.element.val(""),o.elementDiv.show(),d.hide(),l.show(),a.show(),setTimeout((function(){o.input.focus()}),50)})),l=e('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-times"></i></button>').css("margin-left","3px").appendTo(n).on("click",(function(e){e.preventDefault(),s.show(),t.css("background",""),o.input.val("__PWRD__"),o.element.val("__PWRD__"),o.elementDiv.hide(),d.show(),l.hide(),a.hide(),o.input.attr("type","password"),r.removeClass("fa-eye-slash").addClass("fa-eye")})).hide();else t.css("background","none"),t.css("pointer-events","none"),this.elementDiv.show(),a.show()}}},a=!1;e.widget("nodered.typedInput",{_create:function(){try{if(!a&&RED&&RED._){for(var t in n)n.hasOwnProperty(t)&&(n[t].label=RED._("typedInput.type."+t,{defaultValue:n[t].label}));var i=RED.settings.context.stores.map((function(e){return{value:e,label:e,icon:'<i class="red-ui-typedInput-icon fa fa-database"></i>'}}));i.length<2?(n.flow.options=[],n.global.options=[]):(n.flow.options=i,n.global.options=i)}a=!0;var o=this;this.disarmClick=!1,this.input=e('<input class="red-ui-typedInput-input" type="text"></input>'),this.input.insertAfter(this.element),this.input.val(this.element.val()),this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.input.wrap("<div>").parent().addClass("red-ui-typedInput-input-wrap"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var r,s=this.element.attr("style");if(null!==(r=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(s))?(this.input.css("width","100%"),this.uiSelect.width(r[1]),this.uiWidth=null):0!==this.uiWidth&&this.uiSelect.width(this.uiWidth),["Right","Left"].forEach((function(e){var t=o.element.css("margin"+e);o.uiSelect.css("margin"+e,t),o.input.css("margin"+e,0)})),["type","placeholder","autocomplete","data-i18n"].forEach((function(e){var t=o.element.attr(e);o.input.attr(e,t)})),this.defaultInputType=this.input.attr("type"),this.uiSelect.addClass("red-ui-typedInput-container"),this.element.attr("type","hidden"),!this.options.types&&this.options.type?this.options.types=[this.options.type]:this.options.types=this.options.types||Object.keys(n),this.selectTrigger=e('<button class="red-ui-typedInput-type-select" tabindex="0"></button>').prependTo(this.uiSelect),e('<i class="red-ui-typedInput-icon fa fa-caret-down"></i>').toggle(this.options.types.length>1).appendTo(this.selectTrigger),this.selectLabel=e('<span class="red-ui-typedInput-type-label"></span>').appendTo(this.selectTrigger),this.valueLabelContainer=e('<div class="red-ui-typedInput-value-label">').appendTo(this.uiSelect),this.types(this.options.types),this.options.typeField){this.typeField=e(this.options.typeField).hide();var d=this.typeField.val();d&&this.typeMap[d]&&(this.options.default=d)}else this.typeField=e("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.input.on("focus",(function(){o.uiSelect.addClass("red-ui-typedInput-focus")})),this.input.on("blur",(function(){o.uiSelect.removeClass("red-ui-typedInput-focus")})),this.input.on("change",(function(){o.validate(),o.element.val(o.value()),o.element.trigger("change",o.propertyType,o.value())})),this.input.on("keydown",(function(e){e.keyCode>=37&&e.keyCode<=40&&e.stopPropagation()})),this.selectTrigger.on("click",(function(e){e.preventDefault(),e.stopPropagation(),o._showTypeMenu()})),this.selectTrigger.on("keydown",(function(e){40===e.keyCode&&o._showTypeMenu(),e.stopPropagation()})).on("focus",(function(){o.uiSelect.addClass("red-ui-typedInput-focus")})),this.optionSelectTrigger=e('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-caret-down"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=e('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),RED.popover.tooltip(this.optionSelectLabel,(function(){return o.optionValue})),this.optionSelectTrigger.on("click",(function(e){e.preventDefault(),e.stopPropagation(),o._showOptionSelectMenu()})).on("keydown",(function(e){40===e.keyCode&&o._showOptionSelectMenu(),e.stopPropagation()})).on("blur",(function(){o.uiSelect.removeClass("red-ui-typedInput-focus")})).on("focus",(function(){o.uiSelect.addClass("red-ui-typedInput-focus")})),this.optionExpandButton=e('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"></button>').appendTo(this.uiSelect),this.optionExpandButtonIcon=e('<i class="red-ui-typedInput-icon fa fa-ellipsis-h"></i>').appendTo(this.optionExpandButton),this.type(this.options.default||this.typeList[0].value)}catch(e){console.log(e.stack)}},_showTypeMenu:function(){if(this.typeList.length>1){this._showMenu(this.menu,this.selectTrigger);var e=this.menu.find("[value='"+this.propertyType+"']");setTimeout((function(){e.trigger("focus")}),120)}else this.input.trigger("focus")},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectTrigger);var e=this.optionMenu.find("[value='"+this.optionValue+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.trigger("focus")}},_hideMenu:function(t){if(e(document).off("mousedown.red-ui-typedInput-close-property-select"),t.hide(),t.css({height:"auto"}),t.opts.multiple){var i=[];t.find('input[type="checkbox"]').each((function(){e(this).prop("checked")&&i.push(e(this).data("value"))})),t.callback(i)}this.elementDiv.is(":visible")?this.input.trigger("focus"):this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.trigger("focus"):this.selectTrigger.trigger("focus")},_createMenu:function(t,i,n){var a=this,r=e("<div>").addClass("red-ui-typedInput-options red-ui-editor-dialog");return r.opts=i,r.callback=n,t.forEach((function(t){"string"==typeof t&&(t={value:t,label:t});var s,d=e('<a href="#"></a>').attr("value",t.value).appendTo(r);t.label&&d.text(t.label),t.title&&d.prop("title",t.title),t.icon?0===t.icon.indexOf("<")?e(t.icon).prependTo(d):-1!==t.icon.indexOf("/")?e("<img>",{src:o(t.icon),style:"margin-right: 4px; height: 18px;"}).prependTo(d):e("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(d):d.css({paddingLeft:"18px"}),t.icon||t.label||d.text(t.value),i.multiple&&(s=e('<input type="checkbox">').css("pointer-events","none").data("value",t.value).prependTo(d).on("mousedown",(function(e){e.preventDefault()}))),d.on("click",(function(e){e.preventDefault(),e.stopPropagation(),i.multiple?s.prop("checked",!s.prop("checked")):(n(t.value),a._hideMenu(r))}))})),r.css({display:"none"}),r.appendTo(document.body),r.on("keydown",(function(t){40===t.keyCode?(t.preventDefault(),e(this).children(":focus").next().trigger("focus")):38===t.keyCode?(t.preventDefault(),e(this).children(":focus").prev().trigger("focus")):27===t.keyCode&&(t.preventDefault(),a._hideMenu(r)),t.stopPropagation()})),r},_showMenu:function(t,i){if(this.disarmClick)this.disarmClick=!1;else{if(t.opts.multiple){var o={};this.value().split(",").forEach((function(e){o[e]=!0})),t.find('input[type="checkbox"]').each((function(){e(this).prop("checked",o[e(this).data("value")])}))}var n=this,a=i.offset(),r=i.height(),s=t.height(),d=r+a.top;d+s>e(window).height()&&(d-=d+s-e(window).height()+5),d<0&&(t.height(s+d),d=0),t.css({top:d+"px",left:a.left+"px"}),t.slideDown(100),this._delay((function(){n.uiSelect.addClass("red-ui-typedInput-focus"),e(document).on("mousedown.red-ui-typedInput-close-property-select",(function(o){e(o.target).closest(t).length||n._hideMenu(t),e(o.target).closest(i).length&&(n.disarmClick=!0,o.preventDefault())}))}))}},_getLabelWidth:function(t,i){var o=t.outerWidth();if(0===o){var n=e('<div class="red-ui-editor"></div>').css({position:"absolute","white-space":"nowrap",top:-2e3}).appendTo(document.body),a=e('<div class="red-ui-typedInput-container"></div>').appendTo(n),r=t.clone().appendTo(a);setTimeout((function(){o=r.outerWidth(),n.remove(),i(o)}),50)}else i(o)},_updateOptionSelectLabel:function(t){var i=this.typeMap[this.propertyType];this.optionSelectLabel.empty(),this.typeMap[this.propertyType].valueLabel?i.multiple?this.typeMap[this.propertyType].valueLabel.call(this,this.optionSelectLabel,t):this.typeMap[this.propertyType].valueLabel.call(this,this.optionSelectLabel,t.value):i.multiple?this.optionSelectLabel.text(t.length+" selected"):(t.icon?0===t.icon.indexOf("<")?e(t.icon).prependTo(this.optionSelectLabel):-1!==t.icon.indexOf("/")?e("<img>",{src:o(t.icon),style:"height: 18px;"}).prependTo(this.optionSelectLabel):e("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(this.optionSelectLabel):t.label?this.optionSelectLabel.text(t.label):this.optionSelectLabel.text(t.value),i.hasValue&&(this.optionValue=t.value,this.input.trigger("change",this.propertyType,this.value())))},_destroy:function(){this.optionMenu&&this.optionMenu.remove(),this.menu.remove(),this.uiSelect.remove()},types:function(e){var t=this,i=this.type();this.typeMap={},this.typeList=e.map((function(e){var i;return i="string"==typeof e?n[e]:e,t.typeMap[i.value]=i,i})),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.selectTrigger.find(".fa-caret-down").toggle(this.typeList.length>1),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,{},(function(e){t.type(e)})),i&&!this.typeMap.hasOwnProperty(i)?this.type(this.typeList[0].value):(this.propertyType=null,this.type(i))},width:function(e){this.uiWidth=e,null!==this.uiWidth&&this.uiSelect.width(this.uiWidth)},value:function(e){var t=this,i=this.typeMap[this.propertyType];if(!arguments.length){var o=this.input.val();return i.export&&(o=i.export(o,this.optionValue)),o}var n=[];if(i.options){var a=[e];i.multiple&&(n=[],a=e.split(",")),a.forEach((function(e){for(var o=0;o<i.options.length;o++){var a=i.options[o];if("string"==typeof a){if(a===e||a===""+e){n.push(t.activeOptions[a]);break}}else if(a.value===e){n.push(a);break}}})),this.input.val(e),i.multiple?this._updateOptionSelectLabel(n):(0===n.length&&(n=[{value:""}]),this._updateOptionSelectLabel(n[0]))}else this.input.val(e),i.valueLabel&&(this.valueLabelContainer.empty(),i.valueLabel.call(this,this.valueLabelContainer,e));this.input.trigger("change",this.type(),e)},type:function(t){if(!arguments.length)return this.propertyType;var i,n=this,a=this.typeMap[t];if(a&&this.propertyType!==t)if(this.propertyType=t,this.typeField&&this.typeField.val(t),this.selectLabel.empty(),a.icon&&!1!==a.showLabel&&(0===a.icon.indexOf("<")?e(a.icon).prependTo(this.selectLabel):-1!==a.icon.indexOf("/")?((i=new Image).name=a.icon,i.src=o(a.icon),e("<img>",{src:o(a.icon),style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):e("<i>",{class:"red-ui-typedInput-icon "+a.icon,style:"min-width: 13px; margin-right: 4px;"}).prependTo(this.selectLabel)),(!1===a.hasValue||!1!==a.showLabel&&!a.icon)&&this.selectLabel.text(a.label),!1===a.hasValue?this.selectTrigger.addClass("red-ui-typedInput-full-width"):this.selectTrigger.removeClass("red-ui-typedInput-full-width"),this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),a.options){if(this.optionExpandButton&&(this.optionExpandButton.hide(),this.optionExpandButton.shown=!1),this.optionSelectTrigger){var r;if(this.optionSelectTrigger.css({display:"inline-flex"}),a.hasValue?(this.optionSelectTrigger.css({"flex-grow":0}),this.elementDiv.show(),this.valueLabelContainer.hide()):(this.optionSelectTrigger.css({"flex-grow":1}),this.elementDiv.hide(),this.valueLabelContainer.hide()),this.activeOptions={},a.options.forEach((function(e){"string"==typeof e?n.activeOptions[e]={label:e,value:e}:n.activeOptions[e.value]=e})),n.activeOptions.hasOwnProperty(n.optionValue)||(n.optionValue=null),a.hasValue){var s=this.optionValue||a.options[0];if(a.parse){var d=a.parse(this.input.val());d.option&&(s=d.option,this.activeOptions.hasOwnProperty(s)||(d.option=Object.keys(this.activeOptions)[0],s=d.option)),this.input.val(d.value),a.export&&this.element.val(a.export(d.value,d.option||s))}"string"==typeof s?(this.optionValue=s,this.activeOptions.hasOwnProperty(s)||(s=Object.keys(this.activeOptions)[0]),s?this._updateOptionSelectLabel(this.activeOptions[s]):this.optionSelectTrigger.hide()):s?(this.optionValue=s.value,this._updateOptionSelectLabel(s)):this.optionSelectTrigger.hide()}else{var l=!1,c=this.input.val();if(a.multiple){var p={};c.split(",").forEach((function(e){e&&(p[e]=!0)}));for(u=0;u<a.options.length;u++)r=a.options[u],delete p[r.value||r];e.isEmptyObject(p)||this.value((a.default||[]).join(","))}else{for(var u=0;u<a.options.length;u++){if("string"==typeof(r=a.options[u])&&r===c){n._updateOptionSelectLabel({value:c}),l=!0;break}if(r.value===c){n._updateOptionSelectLabel(r),l=!0;break}}l||("string"==typeof(r=a.options[0])?(this.value(r),n._updateOptionSelectLabel({value:r})):(this.value(r.value),n._updateOptionSelectLabel(r)))}}this.optionMenu=this._createMenu(a.options,a,(function(e){a.multiple?(n._updateOptionSelectLabel(e),a.hasValue||n.value(e.join(","))):(n._updateOptionSelectLabel(n.activeOptions[e]),a.hasValue||n.value(n.activeOptions[e].value))}))}this._trigger("typechange",null,this.propertyType),this.input.trigger("change",this.propertyType,this.value())}else this.optionSelectTrigger&&this.optionSelectTrigger.hide(),a.inputType?this.input.attr("type",a.inputType):this.input.attr("type",this.defaultInputType),!1===a.hasValue?(this.oldValue=this.input.val(),this.input.val(""),this.elementDiv.hide(),this.valueLabelContainer.hide()):a.valueLabel?(this.valueLabelContainer.css("pointer-events",""),this.valueLabelContainer.css("flex-grow",1),this.valueLabelContainer.show(),this.valueLabelContainer.empty(),this.elementDiv.hide(),a.valueLabel.call(this,this.valueLabelContainer,this.input.val())):(void 0!==this.oldValue&&(this.input.val(this.oldValue),delete this.oldValue),this.valueLabelContainer.hide(),this.elementDiv.show()),this.optionExpandButton&&(a.expand?(a.expand.icon?this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa "+a.expand.icon):this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa fa-ellipsis-h"),this.optionExpandButton.shown=!0,this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",(function(t){if(t.preventDefault(),"function"==typeof a.expand)a.expand.call(n);else{var i=e("<div>"),o=a.expand.content.call(n,i),r=RED.popover.panel(i);r.container.css({width:n.valueLabelContainer.width()}),a.expand.minWidth&&r.container.css({minWidth:a.expand.minWidth+"px"}),r.show({target:n.optionExpandButton,onclose:o.onclose,align:"left"})}}))):(this.optionExpandButton.shown=!1,this.optionExpandButton.hide())),this._trigger("typechange",null,this.propertyType),this.input.trigger("change",this.propertyType,this.value())},validate:function(){var e,t=this.value(),i=this.type();if(this.typeMap[i]&&this.typeMap[i].validate){var o=this.typeMap[i].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show()},hide:function(){this.uiSelect.hide()}})}(jQuery),function(e){e.widget("nodered.toggleButton",{_create:function(){var t=this,i=!1;this.options.hasOwnProperty("invertState")&&(i=this.options.invertState);var o=this.options.baseClass||"red-ui-button",n=this.options.hasOwnProperty("enabledIcon")?this.options.enabledIcon:"fa-check-square-o",a=this.options.hasOwnProperty("disabledIcon")?this.options.disabledIcon:"fa-square-o",r=this.options.hasOwnProperty("enabledLabel")?this.options.enabledLabel:RED._("editor:workspace.enabled"),s=this.options.hasOwnProperty("disabledLabel")?this.options.disabledLabel:RED._("editor:workspace.disabled");this.element.css("display","none"),this.element.on("focus",(function(){t.button.focus()})),this.button=e('<button type="button" class="red-ui-toggleButton '+o+' toggle single"></button>'),(r||s)&&(this.buttonLabel=e("<span>").appendTo(this.button)),this.options.class&&this.button.addClass(this.options.class),this.element.after(this.button),n&&a&&(this.buttonIcon=e('<i class="fa"></i>').prependTo(this.button)),this.button.addClass("selected"),this.buttonIcon&&this.buttonIcon.addClass(n),this.buttonLabel&&this.buttonLabel.text(r);var d=this.button.width();this.button.removeClass("selected"),this.buttonIcon&&(this.buttonIcon.removeClass(n),t.buttonIcon.addClass(a)),this.buttonLabel&&t.buttonLabel.text(s),d=Math.max(d,this.button.width()),this.buttonIcon&&this.buttonIcon.removeClass(a),d>0&&this.button.width(Math.ceil(d)),this.button.on("click",(function(e){e.stopPropagation(),t.state?t.element.prop("checked",i):t.element.prop("checked",!i),t.element.trigger("change")})),this.element.on("change",(function(o){e(this).prop("checked")!==i?(t.button.addClass("selected"),t.state=!0,t.buttonIcon&&(t.buttonIcon.addClass(n),t.buttonIcon.removeClass(a)),t.buttonLabel&&t.buttonLabel.text(r)):(t.button.removeClass("selected"),t.state=!1,t.buttonIcon&&(t.buttonIcon.addClass(a),t.buttonIcon.removeClass(n)),t.buttonLabel&&t.buttonLabel.text(s))})),this.element.trigger("change")}})}(jQuery),RED.colorPicker={create:function(e){var t=e.value,i=e.id,o=e.palette||[],n=e.cellWidth||30,a=e.cellHeight||30,r=e.cellMargin||2,s=e.cellPerRow||6,d=$("<div>",{style:"display:inline-block"}),l=$("<input/>",{id:i,type:"hidden",value:t}).appendTo(d),c=$("<input/>",{id:i+"-opacity",type:"hidden",value:e.hasOwnProperty("opacity")?e.opacity:"1"}).appendTo(d),p=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(d);$('<i class="fa fa-caret-down"></i>').appendTo(p);var u=$("<div>",{class:"red-ui-search-result-node"}).appendTo(p);$("<div>",{class:"red-ui-color-picker-cell-none"}).appendTo(u);var f=$("<div>",{class:"red-ui-color-picker-swatch"}).appendTo(u),h=function(t){if("none"===t)f.addClass("red-ui-color-picker-cell-none").css({"background-color":"",opacity:1}),u.css({"border-color":""});else{var i=parseFloat(c.val());f.removeClass("red-ui-color-picker-cell-none").css({"background-color":t,opacity:i});var o=RED.utils.getDarkerColor(t);"#"===o[0]?o+=Math.round(255*Math.floor(100*i)/100).toString(16):o="",u.css({"border-color":o})}e.hasOwnProperty("opacity")&&$(".red-ui-color-picker-opacity-slider-overlay").css({"background-image":"linear-gradient(90deg, transparent 0%, "+t+" 100%)"})};return p.on("click",(function(t){var i=o.length,d=$("<div/>",{class:"red-ui-color-picker"}).css({width:(n+r+r)*s+"px",height:Math.ceil(i/s)*(a+r+r)+"+px"}),u=0,f=null;f=$("<div/>").appendTo(d);var g=$("<input>",{type:"text",value:l.val()}).appendTo(f),v=g;if(g.on("change",(function(e){var t=g.val();l.val(t).trigger("change"),h(t)})),e.none&&(f=$("<div/>").appendTo(d),$("<button/>",{class:"red-ui-color-picker-cell red-ui-color-picker-cell-none"}).css({width:n+"px",height:a+"px",margin:r+"px"}).appendTo(f).on("click",(function(e){e.preventDefault(),g.val("none"),g.trigger("change")}))),o.forEach((function(e){u%s==0&&(f=$("<div/>").appendTo(d)),$("<button/>",{class:"red-ui-color-picker-cell"}).css({width:n+"px",height:a+"px",margin:r+"px",backgroundColor:e,"border-color":RED.utils.getDarkerColor(e)}).appendTo(f).on("click",(function(t){t.preventDefault(),g.val(e),g.trigger("change")})),u++})),(e.none||e.hasOwnProperty("opacity"))&&(f=$("<div/>").appendTo(d),e.hasOwnProperty("opacity"))){var b=$("<div>",{class:"red-ui-color-picker-opacity-slider"}).appendTo(f);b.on("mousedown",(function(e){if(e.target!==m[0]){var t=e.offsetX/b.width();m.css({left:t*(b.width()-m.outerWidth())+"px"}),t=Math.floor(100*t),c.val(t/100),y.text(t+"%"),h(l.val())}})),$("<div>",{class:"red-ui-color-picker-opacity-slider-overlay"}).appendTo(b);var m=$("<div>",{class:"red-ui-color-picker-opacity-slider-handle red-ui-button red-ui-button-small"}).appendTo(b).draggable({containment:"parent",axis:"x",drag:function(e,t){var i=Math.max(0,t.position.left/($(this).parent().width()-$(this).outerWidth()));99===(i=Math.floor(100*i))&&(i=100),c.val(i/100),y.text(i+"%"),h(l.val())}}),y=$("<small></small>").appendTo(f);setTimeout((function(){m.css({left:parseFloat(c.val())*(b.width()-m.outerWidth())+"px"}),y.text(Math.floor(100*c.val())+"%")}),50)}var w=RED.popover.panel(d);setTimeout((function(){h(l.val())}),50),w.show({target:p,onclose:function(){p.focus()}}),v&&v.focus()})),setTimeout((function(){h(l.val())}),50),d}},RED.actions=function(){var e={};return{add:function(t,i){e[t]=i},remove:function(t){delete e[t]},get:function(t){return e[t]},invoke:function(t,i){e.hasOwnProperty(t)&&e[t](i)},list:function(){var t=[];return Object.keys(e).forEach((function(e){var i=RED.keyboard.getShortcut(e),o=!1;o=i?i.user:!!RED.keyboard.getUserShortcut(e),t.push({id:e,scope:i?i.scope:void 0,key:i?i.key:void 0,user:o})})),t}}}(),RED.deploy=function(){var e={full:{img:"red/images/deploy-full-o.svg"},nodes:{img:"red/images/deploy-nodes-o.svg"},flows:{img:"red/images/deploy-flows-o.svg"}},t={unknown:!1,unusedConfig:!1,invalid:!1},i="full",o=!1,n=null;function a(t){i=t,$("#red-ui-header-button-deploy-icon").attr("src",e[t].img)}function r(e){console.log("getNodeInfo");var t="";if(e.z){var i=RED.nodes.workspace(e.z);t=i?i.label:(i=RED.nodes.subflow(e.z)).name}var o=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:o}}function s(e,t){return console.log("sortNodeInfo"),e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function d(e,t){console.log("resolveConflict");var i=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(i);var o=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(i),a=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(i),r=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(i);i.i18n(),n=null;var s=[{text:RED._("common.label.cancel"),click:function(){d.close()}},{id:"red-ui-deploy-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),d.close())}},{id:"red-ui-deploy-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(n),d.close())}}];t&&s.push({id:"red-ui-deploy-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){u(!0,t),d.close()}});var d=RED.notify(i,{modal:!0,fixed:!0,width:600,buttons:s}),l=Date.now();RED.diff.getRemoteDiff((function(e){var t=Math.max(1e3-(Date.now()-l),0);n=e,setTimeout((function(){o.hide(),0===Object.keys(e.conflicts).length?(a.show(),$("#red-ui-deploy-dialog-confirm-deploy-merge").removeClass("disabled")):r.show(),$("#red-ui-deploy-dialog-confirm-deploy-review").removeClass("disabled")}),t)}))}function l(e){if(console.log("cropList"),e.length>5){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function c(e){return console.log("sanitize"),e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function p(){console.log("Restart");var e=Date.now();$(".red-ui-deploy-button-content").css("opacity",0),$(".red-ui-deploy-button-spinner").show();var t=!$("#red-ui-header-button-deploy").hasClass("disabled");$("#red-ui-header-button-deploy").addClass("disabled"),o=!0,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$.ajax({url:"flows",type:"POST",headers:{"Node-RED-Deployment-Type":"reload"}}).done((function(e,i,o){t&&$("#red-ui-header-button-deploy").removeClass("disabled"),RED.notify("<p>"+RED._("deploy.successfulRestart")+"</p>","success")})).fail((function(e,i,o){t&&$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?d(nns,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")})).always((function(){o=!1;var t=Math.max(0,300-(Date.now()-e));setTimeout((function(){$(".red-ui-deploy-button-content").css("opacity",1),$(".red-ui-deploy-button-spinner").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide()}),t)}))}function u(e,n){if(console.log("save"),!$("#red-ui-header-button-deploy").hasClass("disabled")){if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");if(!e){var a,p,f=!1,h=[],g=[];RED.nodes.eachNode((function(e){e.valid||e.d||g.push(r(e)),"unknown"===e.type&&-1==h.indexOf(e.name)&&h.push(e.name)})),a=h.length>0,p=g.length>0;var v=[];RED.nodes.eachConfig((function(e){!1!==e._def.hasUsers&&0===e.users.length&&(v.push(r(e)),f=!0)}));var b,m,y=!1,w=[];if(a&&!t.unknown?(y=!0,b="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+l(h).map((function(e){return c(e)})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",w=[{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){u(!0),m.close()}}]):p&&!t.invalid&&(y=!0,g.sort(s),b="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+l(g.map((function(e){return c((e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")")}))).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",w=[{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){u(!0),m.close()}}]),y)return w.unshift({text:RED._("common.label.cancel"),click:function(){m.close()}}),void(m=RED.notify(b,{modal:!0,fixed:!0,buttons:w}))}var E=RED.nodes.createCompleteNodeSet(),D=Date.now();$(".red-ui-deploy-button-content").css("opacity",0),$(".red-ui-deploy-button-spinner").show(),$("#red-ui-header-button-deploy").addClass("disabled");var R={flows:E};n||(R.rev=RED.nodes.version()),o=!0,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(R),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":i}}).done((function(e,t,i){console.log("Done"),RED.settings.set("treelist",XAPP.treelist.tree().getNodes()),RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(E),f?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode((function(e){console.log(" Deploy eachNode"),e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials})),RED.nodes.eachConfig((function(e){console.log(" Deploy eachConfig"),e.changed=!1,e.credentials&&delete e.credentials})),RED.nodes.eachSubflow((function(e){console.log(" Deploy eachSubflow"),e.changed=!1})),RED.nodes.eachWorkspace((function(e){e.changed=!1})),RED.history.markAllDirty(),RED.events.emit("deploy")})).fail((function(e,t,i){RED.nodes.dirty(!0),$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?d(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")})).always((function(){o=!1;var e=Math.max(0,300-(Date.now()-D));setTimeout((function(){$(".red-ui-deploy-button-content").css("opacity",1),$(".red-ui-deploy-button-spinner").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide()}),e)}))}}return{init:function(e){var t,i=(e=e||{}).type||"default";if("default"==i)$('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content"><img id="red-ui-header-button-deploy-icon" src="red/images/deploy-full-o.svg"> <span>'+RED._("deploy.deploy")+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="red-ui-header-button-deploy-options" class="red-ui-deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo("#toolbar-deploy"),RED.menu.init({id:"red-ui-header-button-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.svg",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&a("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.svg",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&a("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.svg",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&a("nodes")}},null,{id:"deploymenu-item-reload",icon:"red/images/deploy-reload.svg",label:RED._("deploy.restartFlows"),sublabel:RED._("deploy.restartFlowsDesc"),onselect:"core:restart-flows"}]});else if("simple"==i){var n=e.label||RED._("deploy.deploy"),r="red/images/deploy-full-o.svg";e.hasOwnProperty("icon")&&(r=e.icon),$('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content">'+(r?'<img id="red-ui-header-button-deploy-icon" src="'+r+'"> ':"")+"<span>"+n+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".red-ui-header-toolbar")}$("#red-ui-header-button-deploy").on("click",(function(e){e.preventDefault(),u()})),RED.actions.add("core:deploy-flows",u),"default"===i&&(RED.actions.add("core:restart-flows",p),RED.actions.add("core:set-deploy-type-to-full",(function(){RED.menu.setSelected("deploymenu-item-full",!0)})),RED.actions.add("core:set-deploy-type-to-modified-flows",(function(){RED.menu.setSelected("deploymenu-item-flow",!0)})),RED.actions.add("core:set-deploy-type-to-modified-nodes",(function(){RED.menu.setSelected("deploymenu-item-node",!0)}))),RED.events.on("workspace:dirty",(function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#red-ui-header-button-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#red-ui-header-button-deploy").addClass("disabled"))})),RED.comms.subscribe("notification/runtime-deploy",(function(e,i){if(!t){var n=RED.nodes.version();if(null===n||o||n===i.revision)return;var a=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));t=RED.notify(a,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){t.close(),t=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){t.close(),d(RED.nodes.createCompleteNodeSet(),!1),t=null}}]})}}))},setDeployInflight:function(e){o=e}}}(),RED.diff=function(){var e=!1;function t(e,t,i){var n=$('<div class="red-ui-diff-panel"></div>').appendTo(e),d=$('<div class="red-ui-diff-panel-headers"></div>').appendTo(n);"merge"===i.mode&&n.addClass("red-ui-diff-panel-merge");var l=function(e,t){var i=$('<ol class="red-ui-diff-list"></ol>').appendTo(e);return i.editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,i,n){var d=n.diff,l=n.remoteDiff,c=n.tab.n,p=n.def,u=t.conflicts,f=$("<div>",{class:"red-ui-diff-list-flow"}).appendTo(e);f.addClass("collapsed");var h,g,v=$("<div>",{class:"red-ui-diff-list-flow-title"}).appendTo(f),b=$("<div>").appendTo(f),m=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(v),y=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(v);l&&(h=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(v)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(m),o(c,p).appendTo(m);var w=(n.newTab||n.tab).n,E=$("<span>",{class:"red-ui-diff-list-flow-title-meta"}).appendTo(m);"tab"===w.type?E.text(w.label||w.id):"subflow"===c.type?E.text(w.name||w.id):E.text(RED._("diff.globalNodes"));var D={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(n.newTab||n.remoteTab){var R,x={node:d.newConfig.all[c.id],all:d.newConfig.all,diff:d};if(l&&(R={node:l.newConfig.all[c.id]||null,all:l.newConfig.all,diff:l}),void 0!==c.type){var _,k=$("<div>",{class:"red-ui-diff-list-node red-ui-diff-list-node-props collapsed"}).appendTo(b),T=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(k),C=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(T),j=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(T);d.newConfig.all[c.id]?d.added[c.id]?(j.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(j)):d.changed[c.id]?(j.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(j)):(j.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(j)):j.addClass("red-ui-diff-empty"),l&&(_=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(T),l.newConfig.all[c.id]?l.added[c.id]?(_.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(_)):l.changed[c.id]?(_.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(_)):(_.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(_)):(_.addClass("red-ui-diff-empty"),l.deleted[c.id])),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(C),$("<span>").text(RED._("diff.flowProperties")).appendTo(C),T.on("click",(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")})),r(p,c,x,R).appendTo(k),g="",u[c.id]?(D.conflicts++,j.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(j),_.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(_),k.addClass("red-ui-diff-list-node-conflict")):g=t.resolutions[c.id],s(c,k,j,_,!0,!u[c.id],g,t)}}var L=0,O=0,S={};if(n.tab.nodes.forEach((function(e){S[e.id]=!0,a(e,D,t).appendTo(b)})),n.newTab&&(L=n.newTab.nodes.length,n.newTab.nodes.forEach((function(e){S[e.id]||(S[e.id]=!0,a(e,D,t).appendTo(b))}))),n.remoteTab&&(O=n.remoteTab.nodes.length,n.remoteTab.nodes.forEach((function(e){S[e.id]||a(e,D,t).appendTo(b)}))),v.on("click",(function(e){v.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".red-ui-diff-list-node").addClass("collapsed"),$(this).parent().find(".red-ui-debug-msg-element").addClass("collapsed"))})),d.deleted[c.id])$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(y);else if(n.newTab)if(d.added[c.id])$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(y);else{c.id&&(d.changed[c.id]?D.local.changedCount++:D.local.unchangedCount++);var I=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(y);$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:L})).appendTo(I),D.conflicts+D.local.addedCount+D.local.changedCount+D.local.deletedCount>0&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(I),D.conflicts>0&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+D.conflicts+"</span></span>").appendTo(I),D.local.addedCount>0&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+D.local.addedCount+"</span></span>").appendTo(I),D.local.changedCount>0&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+D.local.changedCount+"</span></span>").appendTo(I),D.local.deletedCount>0&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+D.local.deletedCount+"</span></span>").appendTo(I),$('<span class="red-ui-diff-status"> ] </span>').appendTo(I))}else y.addClass("red-ui-diff-empty");if(l){if(l.deleted[c.id])$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(n.remoteTab)if(l.added[c.id])$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{c.id&&(l.changed[c.id]?D.remote.changedCount++:D.remote.unchangedCount++);var P=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(h);$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:O})).appendTo(P),D.conflicts+D.remote.addedCount+D.remote.changedCount+D.remote.deletedCount>0&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(P),D.conflicts>0&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+D.conflicts+"</span></span>").appendTo(P),D.remote.addedCount>0&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+D.remote.addedCount+"</span></span>").appendTo(P),D.remote.changedCount>0&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+D.remote.changedCount+"</span></span>").appendTo(P),D.remote.deletedCount>0&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+D.remote.deletedCount+"</span></span>").appendTo(P),$('<span class="red-ui-diff-status"> ] </span>').appendTo(P))}else h.addClass("red-ui-diff-empty");if(g="",D.conflicts>0?v.addClass("red-ui-diff-list-node-conflict"):g=t.resolutions[c.id],c.id){var N=!(D.conflicts>0&&(d.deleted[c.id]||l.deleted[c.id]));s(c,v,y,h,!1,N,g,t)}}0===f.find(".red-ui-diff-list-node").length&&f.addClass("red-ui-diff-list-flow-empty"),e.i18n()}}),i}(n,t),c=t.localDiff,p=t.remoteDiff,u=(t.conflicts,c.currentConfig),f=c.newConfig;if(void 0!==p){n.addClass("red-ui-diff-three-way");var h=i.oldRevTitle||RED._("diff.local"),g=i.newRevTitle||RED._("diff.remote");$("<div></div>").text(h).appendTo(d),$("<div></div>").text(g).appendTo(d)}else n.removeClass("red-ui-diff-three-way");return{list:l,finish:function(){var e={diff:c,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:u.globals},newTab:{n:{},nodes:f.globals}};void 0!==p&&(e.remoteTab={n:{},nodes:p.newConfig.globals},e.remoteDiff=p),l.editableList("addItem",e);var t,i={};for(t in u.tabOrder.forEach((function(e){var t=u.tabs[e],o={diff:c,def:RED.nodes.getType("tab"),tab:t};f.tabs.hasOwnProperty(e)&&(o.newTab=f.tabs[e]),void 0!==p&&(o.remoteTab=p.newConfig.tabs[e],o.remoteDiff=p),i[e]=!0,l.editableList("addItem",o)})),f.tabOrder.forEach((function(e){if(!i[e]){i[e]=!0;var t=f.tabs[e],o={diff:c,def:RED.nodes.getType("tab"),tab:t,newTab:t};void 0!==p&&(o.remoteDiff=p),l.editableList("addItem",o)}})),void 0!==p&&p.newConfig.tabOrder.forEach((function(e){if(!i[e]){var t=p.newConfig.tabs[e],o={diff:c,remoteDiff:p,def:RED.nodes.getType("tab"),tab:t,remoteTab:t};l.editableList("addItem",o)}})),u.subflows)u.subflows.hasOwnProperty(t)&&(i[t]=!0,e={diff:c,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:u.subflows[t]},f.subflows.hasOwnProperty(t)&&(e.newTab=f.subflows[t]),void 0!==p&&(e.remoteTab=p.newConfig.subflows[t],e.remoteDiff=p),l.editableList("addItem",e));for(t in f.subflows)f.subflows.hasOwnProperty(t)&&!i[t]&&(i[t]=!0,e={diff:c,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:f.subflows[t],newTab:f.subflows[t]},void 0!==p&&(e.remoteDiff=p),l.editableList("addItem",e));if(void 0!==p)for(t in p.newConfig.subflows)p.newConfig.subflows.hasOwnProperty(t)&&!i[t]&&(e={diff:c,remoteDiff:p,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:p.newConfig.subflows[t],remoteTab:p.newConfig.subflows[t]},l.editableList("addItem",e))}}}function i(e,t){var i=$("<div>",{class:"red-ui-diff-list-wires"}),o=$("<ol></ol>"),a=0;return e.forEach((function(e,i){var r=$("<li>").appendTo(o);if(e&&e.length>0){$("<span>").text(i+1).appendTo(r);var s=$("<ul>").appendTo(r);e.forEach((function(e){a++;var i=$("<li>").appendTo(s),o=t[e];o?n(o,RED.nodes.getType(o.type)||{}).appendTo(i):i.text(e)}))}else r.text("none")})),0===a?i.text("none"):o.appendTo(i),i}function o(e,t){var i=$("<div>",{class:"red-ui-diff-list-node-icon"}),o=RED.utils.getNodeColor(e.type,t),n=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(o="#C0DEED"),i.css("backgroundColor",o);var a=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(i);return RED.utils.createIconElement(n,a,!1),i}function n(e,t){var i=$("<div>",{class:"red-ui-diff-list-node-title"});o(e,t).appendTo(i);var n=e.label||e.name||e.id;return $("<div>",{class:"red-ui-diff-list-node-description"}).text(n).appendTo(i),i}function a(e,t,i){var o=i.localDiff,a=i.remoteDiff,d=i.conflicts[e.id],l=!0;o.added[e.id]&&(t.local.addedCount++,l=!1),a&&a.added[e.id]&&(t.remote.addedCount++,l=!1),o.deleted[e.id]&&(t.local.deletedCount++,l=!1),a&&a.deleted[e.id]&&(t.remote.deletedCount++,l=!1),o.changed[e.id]&&(t.local.changedCount++,!0,l=!1),a&&a.changed[e.id]&&(t.remote.changedCount++,!0,l=!1);var c=RED.nodes.getType(e.type);void 0===c&&(c=/^subflow:/.test(e.type)?{icon:"subflow.svg",category:"subflows",color:"#DDAA99",defaults:{name:{value:""}}}:{});var p,u=$("<div>",{class:"red-ui-diff-list-node collapsed"}),f=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(u),h=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(f),g=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(f);if(a&&(p=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(f)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(h),l)t.local.unchangedCount++,n(e,c).appendTo(h),g.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g),a&&(t.remote.unchangedCount++,p.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p)),u.addClass("red-ui-diff-status-unchanged");else if(o.added[e.id])g.addClass("red-ui-diff-status-added"),p&&p.addClass("red-ui-diff-empty"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(g),n(e,c).appendTo(h);else if(a&&a.added[e.id])g.addClass("red-ui-diff-empty"),p.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(p),n(e,c).appendTo(h);else{if(n(e,c).appendTo(h),o.moved[e.id]){var v=o.newConfig.all[e.id];if(o.deleted[e.z]||e.z===v.z||""===e.z||o.newConfig.all[e.z]){g.addClass("red-ui-diff-status-moved");var b="";b=e.z===v.z?RED._("diff.type.movedFrom",{id:o.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:v.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+b+"</span>").appendTo(g)}else g.addClass("red-ui-diff-empty");!0}else o.deleted[e.z]?(g.addClass("red-ui-diff-empty"),!0):o.deleted[e.id]?(g.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(g),!0):o.changed[e.id]?o.newConfig.all[e.id].z!==e.z?g.addClass("red-ui-diff-empty"):(g.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(g),!0):o.newConfig.all[e.id].z!==e.z?g.addClass("red-ui-diff-empty"):(t.local.unchangedCount++,g.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g));if(a)if(a.moved[e.id]){var m=a.newConfig.all[e.id];if(a.deleted[e.z]||e.z===m.z||""===e.z||a.newConfig.all[e.z]){p.addClass("red-ui-diff-status-moved");var y="";y=e.z===m.z?RED._("diff.type.movedFrom",{id:a.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:m.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+y+"</span>").appendTo(p)}else p.addClass("red-ui-diff-empty")}else a.deleted[e.z]?p.addClass("red-ui-diff-empty"):a.deleted[e.id]?(p.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(p)):a.changed[e.id]?a.newConfig.all[e.id].z!==e.z?p.addClass("red-ui-diff-empty"):(p.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(p)):a.newConfig.all[e.id].z!==e.z?p.addClass("red-ui-diff-empty"):(t.remote.unchangedCount++,p.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p))}var w,E={node:o.newConfig.all[e.id],all:o.newConfig.all,diff:o};a&&(w={node:a.newConfig.all[e.id]||null,all:a.newConfig.all,diff:a});var D="";return d?(t.conflicts++,g.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(g),p.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(p),u.addClass("red-ui-diff-list-node-conflict")):D=i.resolutions[e.id],s(e,u,g,p,!1,!d,D,i),f.on("click",(function(t){$(this).parent().toggleClass("collapsed"),0===$(this).siblings(".red-ui-diff-list-node-properties").length&&r(c,e,E,w).appendTo(u)})),u}function r(e,t,o,n){var a,r={},s=o.node;n&&(a=n.node);var d=$("<div>",{class:"red-ui-diff-list-node-properties"}),l=$("<table>").appendTo(d),c=$("<colgroup><col/><col/></colgroup>").appendTo(l);void 0!==a&&$("<col/>").appendTo(c);var p,u,f,h,g,b,m,y=$("<tbody>").appendTo(l),w=!1,E=!1,D=!1;p=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("id").appendTo(p),u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(p),s?(u.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"></span>').appendTo(u),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(u),r["local.id"]=RED.utils.createObjectElement(s.id).appendTo(h)):u.addClass("red-ui-diff-empty"),void 0!==a&&((f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(p)).addClass("red-ui-diff-status-unchanged"),a?($('<span class="red-ui-diff-status"></span>').appendTo(f),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(f),r["remote.id"]=RED.utils.createObjectElement(a.id).appendTo(h)):f.addClass("red-ui-diff-empty")),t.hasOwnProperty("x")&&(s&&(s.x===t.x&&s.y===t.y||(w=!0)),a&&(a.x===t.x&&a.y===t.y||(E=!0)),(E&&w&&(s.x!==a.x||s.y!==a.y)||!w&&E&&o.diff.deleted[t.id]||w&&!E&&n.diff.deleted[t.id])&&(D=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("position").appendTo(p),u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(p),s?(u.addClass("red-ui-diff-status-"+(w?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(u),r["local.position"]=RED.utils.createObjectElement({x:s.x,y:s.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){r["remote."+e]&&r["remote."+e].prop("expand")(e,t)}}).appendTo(h)):u.addClass("red-ui-diff-empty"),void 0!==a&&((f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(p)).addClass("red-ui-diff-status-"+(E?"changed":"unchanged")),a?($('<span class="red-ui-diff-status">'+(E?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(f),r["remote.position"]=RED.utils.createObjectElement({x:a.x,y:a.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){r["local."+e]&&r["local."+e].prop("expand")(e,t)}}).appendTo(h)):f.addClass("red-ui-diff-empty"))),w=E=D=!1,t.hasOwnProperty("wires")&&(g=JSON.stringify(t.wires),s&&(b=JSON.stringify(s.wires),g!==b&&(w=!0)),a&&(m=JSON.stringify(a.wires),g!==m&&(E=!0)),(E&&w&&b!==m||!w&&E&&o.diff.deleted[t.id]||w&&!E&&n.diff.deleted[t.id])&&(D=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("wires").appendTo(p),u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(p),s?(D?(u.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("red-ui-diff-status-"+(w?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),i(s.wires,o.all).appendTo(u)):u.addClass("red-ui-diff-empty"),void 0!==a&&(f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(p),a?(D?(f.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("red-ui-diff-status-"+(E?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(E?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),i(a.wires,n.all).appendTo(f)):f.addClass("red-ui-diff-empty")));var R=Object.keys(t).filter((function(t){return!("inputLabels"==t||"outputLabels"==t||"z"==t||"wires"==t||"x"===t||"y"===t||"id"===t||"type"===t||e.defaults&&e.defaults.hasOwnProperty(t))}));return e.defaults&&(R=R.concat(Object.keys(e.defaults))),"tab"!==t.type&&(R=R.concat(["inputLabels","outputLabels"])),(s&&s.hasOwnProperty("icon")||a&&a.hasOwnProperty("icon"))&&-1===R.indexOf("icon")&&R.unshift("icon"),R.forEach((function(e){w=!1,E=!1,D=!1,g=JSON.stringify(t[e]),s&&(b=JSON.stringify(s[e]),g!==b&&(w=!0)),a&&(m=JSON.stringify(a[e]),g!==m&&(E=!0)),(E&&w&&b!==m||!w&&E&&o.diff.deleted[t.id]||w&&!E&&n.diff.deleted[t.id])&&(D=!0),p=$("<tr>").appendTo(y);var i=$("<td>",{class:"red-ui-diff-list-cell-label"}).text(e).appendTo(p);u=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(p),s?(D?(u.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("red-ui-diff-status-"+(w?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(u),r["local."+e]=RED.utils.createObjectElement(s[e],{path:e,exposeApi:!0,ontoggle:function(t,i){r["remote."+e]&&r["remote."+e].prop("expand")(t,i)}}).appendTo(h)):u.addClass("red-ui-diff-empty"),void 0!==a&&(f=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(p),a?(D?(f.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("red-ui-diff-status-"+(E?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(E?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),h=$('<span class="red-ui-diff-list-element"></span>').appendTo(f),r["remote."+e]=RED.utils.createObjectElement(a[e],{path:e,exposeApi:!0,ontoggle:function(t,i){r["local."+e]&&r["local."+e].prop("expand")(t,i)}}).appendTo(h)):f.addClass("red-ui-diff-empty")),s&&a&&"string"==typeof s[e]&&(/\n/.test(s[e])||/\n/.test(a[e]))&&$('<button class="red-ui-button red-ui-button-small red-ui-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').on("click",(function(){v(s[e],a[e])})).appendTo(i)})),d}function s(e,t,i,o,n,a,r,s){var l="red-ui-diff-selectbox-"+e.id.replace(/\./g,"-")+(n?"-props":""),c="";(e.z||n)&&(c="red-ui-diff-selectbox-tab-"+(n?e.id:e.z).replace(/\./g,"-"));var p=!n&&("tab"===e.type||"subflow"===e.type),u=function(i){var o;if(void 0===e.type);else if(p)o="red-ui-diff-selectbox-tab-"+e.id.replace(/\./g,"-"),$("."+o+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+o+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-local"),$("."+o+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-remote")):($("."+o+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-local"),$("."+o+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-remote"));else{var a="red-ui-diff-selectbox-"+(n?e.id:e.z).replace(/\./g,"-");$("#"+a+"-local").prop("checked",!1),$("#"+a+"-remote").prop("checked",!1);var r=$("#"+a+"-local").closest(".red-ui-diff-list-flow").find(".red-ui-diff-list-flow-title");r.removeClass("red-ui-diff-select-local"),r.removeClass("red-ui-diff-select-remote")}"local"===this.value?(t.removeClass("red-ui-diff-select-remote"),t.addClass("red-ui-diff-select-local")):"remote"===this.value&&(t.addClass("red-ui-diff-select-remote"),t.removeClass("red-ui-diff-select-local")),d(s)},f=$("<label>",{class:"red-ui-diff-selectbox",for:l+"-local"}).on("click",(function(e){e.stopPropagation()})).appendTo(i),h=$("<input>",{class:"red-ui-diff-selectbox-input "+c+"-local",id:l+"-local",type:"radio",value:"local",name:l}).data("node-id",e.id).on("change",u).appendTo(f),g=$("<label>",{class:"red-ui-diff-selectbox",for:l+"-remote"}).on("click",(function(e){e.stopPropagation()})).appendTo(o),v=$("<input>",{class:"red-ui-diff-selectbox-input "+c+"-remote",id:l+"-remote",type:"radio",value:"remote",name:l}).data("node-id",e.id).on("change",u).appendTo(g);"local"===r?h.prop("checked",!0):"remote"===r&&v.prop("checked",!0),(a||i.hasClass("red-ui-diff-empty")||o.hasClass("red-ui-diff-empty"))&&(f.hide(),g.hide())}function d(e){var t=0;$(".red-ui-diff-selectbox>input:checked").each((function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()}));var i=Object.keys(e.conflicts).length;i-t==0?$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:i-t})):$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:i-t})),i===t&&($("#red-ui-diff-view-diff-merge").removeClass("disabled"),$("#red-ui-diff-view-resolve-diff").removeClass("disabled"))}function l(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){var i=RED.nodes.createCompleteNodeSet(),o=RED.nodes.originalFlow(),n=t.flows,a=u(o,i),r=u(o,n);r.rev=t.rev,e(f(a,r))}})}function c(i){void 0===i?l(c):function(i,o){if(e)return;(o=o||{}).mode,i.localDiff;var n=i.remoteDiff,a=i.conflicts,r={title:o.title||RED._("diff.reviewChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("merge"===o.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var r=e.find(".red-ui-tray-body"),s=($('<div class="red-ui-diff-dialog-toolbar"><span><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span> </div>').prependTo(r),t($('<div class="red-ui-diff-container"></div>').appendTo(r),i,o));s.list.hide(),n?($("#red-ui-diff-view-diff-merge").show(),0===Object.keys(a).length?$("#red-ui-diff-view-diff-merge").removeClass("disabled"):$("#red-ui-diff-view-diff-merge").addClass("disabled")):$("#red-ui-diff-view-diff-merge").hide(),d(i),setTimeout((function(){s.finish(),s.list.show()}),300),$("#red-ui-sidebar-shade").show()},close:function(){e=!1,$("#red-ui-sidebar-shade").hide()},show:function(){}};"merge"===o.mode&&r.buttons.push({id:"red-ui-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-diff-view-diff-merge").hasClass("disabled")||(d(i),g(i),RED.tray.close())}});RED.tray.show(r)}(i,{mode:"merge"})}function p(e){var t=[],i={},o={},n=[],a={};return e.forEach((function(e){a[e.id]=e,"tab"===e.type?(t.push(e.id),i[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(o[e.id]={n:e,nodes:[]})})),e.forEach((function(e){"tab"!==e.type&&"subflow"!==e.type&&(i[e.z]?i[e.z].nodes.push(e):o[e.z]?o[e.z].nodes.push(e):n.push(e))})),{all:a,tabOrder:t,tabs:i,subflows:o,globals:n}}function u(e,t){var i=p(e),o=p(t),n={},a={},r={},s={};return Object.keys(i.all).forEach((function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);o.all.hasOwnProperty(e)?JSON.stringify(i.all[e])!==JSON.stringify(o.all[e])&&(r[e]=!0,i.all[e].z!==o.all[e].z&&(s[e]=!0)):a[e]=!0})),Object.keys(o.all).forEach((function(e){i.all.hasOwnProperty(e)||(n[e]=!0)})),{currentConfig:i,newConfig:o,added:n,deleted:a,changed:r,moved:s}}function f(e,t){var i,o,n={},a={},r={localDiff:e,remoteDiff:t,conflicts:n,resolutions:a},s={};for(i in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(i)){s[i]=!0;var d=e.newConfig.all[i];if(e.changed[i]&&t.deleted[i])n[i]=!0;else if(e.deleted[i]&&t.changed[i])n[i]=!0;else if(e.changed[i]&&t.changed[i]){var l=t.newConfig.all[i];JSON.stringify(d)!==JSON.stringify(l)&&(n[i]=!0)}n[i]||(t.added[i]||t.changed[i]||t.deleted[i]?a[i]="remote":a[i]="local")}for(i in e.added)e.added.hasOwnProperty(i)&&(o=e.newConfig.all[i],t.deleted[o.z]?n[i]=!0:a[i]="local");for(i in t.added)t.added.hasOwnProperty(i)&&(o=t.newConfig.all[i],e.deleted[o.z]?n[i]=!0:a[i]="remote");return r}function h(e){e.localDiff.currentConfig;var t,i=e.localDiff,o=e.remoteDiff,n=e.conflicts,a=e.resolutions;for(t in n)if(n.hasOwnProperty(t)&&!a.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var r,s=[],d={},l={};for(t in i.newConfig.all)i.newConfig.all.hasOwnProperty(t)&&(r=RED.nodes.node(t),"local"===a[t]?(r&&(d[t]=r.changed),s.push(i.newConfig.all[t])):"remote"===a[t]?!o.deleted[t]&&o.newConfig.all.hasOwnProperty(t)&&(r&&(d[t]=r.changed),l[t]=1,s.push(o.newConfig.all[t])):console.log("Unresolved",t));for(t in o.added)o.added.hasOwnProperty(t)&&((r=RED.nodes.node(t))&&(d[t]=r.changed),i.added.hasOwnProperty(t)||(l[t]=2,s.push(o.newConfig.all[t])));return{config:s,nodeChangedStates:d,localChangedStates:l}}function g(e){var t=h(e),i=t.config,o=t.nodeChangedStates,n=t.localChangedStates,a=RED.nodes.dirty(),r={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:o,dirty:a,rev:RED.nodes.version()};RED.history.push(r);var s=RED.nodes.originalFlow();for(var d in e.remoteDiff.added)e.remoteDiff.added.hasOwnProperty(d)&&e.remoteDiff.newConfig.all.hasOwnProperty(d)&&s.push(JSON.parse(JSON.stringify(e.remoteDiff.newConfig.all[d])));RED.nodes.clear();var l=RED.nodes.import(i);RED.nodes.originalFlow(s),l.nodes.forEach((function(e){(o[e.id]||n[e.id])&&(e.changed=!0)})),RED.nodes.version(e.remoteDiff.rev),a&&RED.nodes.dirty(!0),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}function v(t,i){var o={title:RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var o=e.find(".red-ui-tray-body"),n=$('<div class="red-ui-diff-text"></div>').appendTo(o),a=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(n);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(a);for(var r,s=$("<tbody>").appendTo(a),d=function(e,t,i){var o,n,a=e.split(/\r?\n/),r=t.split(/\r?\n/),s=a.length,d=r.length,l={a:[],b:[]},c=[];for(o=0;o<s+1;o++)for(c[o]=[],n=0;n<d+1;n++)c[o][n]=0;for(o=s-1;o>=0;o--)for(n=d-1;n>=0;n--)1!==y(a[o],r[n],i)?c[o][n]=c[o+1][n+1]+1:c[o][n]=Math.max(c[o+1][n],c[o][n+1]);o=0,n=0;for(;o<s&&n<d;){var p=y(a[o],r[n],i);if(1!==p){var u=0;0===p?u=0:2==p&&(u=3),l.a.push({i:o+1,j:n+1,line:a[o],type:u}),l.b.push({i:n+1,j:o+1,line:r[n],type:u}),o++,n++}else c[o+1][n]>=c[o][n+1]?(l.a.push({i:o+1,line:a[o],type:1}),o++):(l.b.push({i:n+1,line:r[n],type:4}),n++)}for(;o<s||n<d;)o==s?(l.b.push({i:n+1,line:r[n],type:4}),n++):n==d&&(l.a.push({i:o+1,line:a[o],type:1}),o++);return l}(t||"",i||""),l=0,c=0,p=Math.max(d.a.length,d.b.length),u=[],f=[],h=0,g=0,v=0;v<p;v++){d[v];var w=l<d.a.length?d.a[l]:{type:2,line:""},E=c<d.b.length?d.b[c]:{type:2,line:""};0===w.type&&0!==E.type?(w={type:2,line:""},c++):0===E.type&&0!==w.type?(E={type:2,line:""},l++):(l++,c++),u.push({a:w,b:E}),void 0===r?(r={start:v,end:v},h=0,g=0===w.type&&0===E.type?0:1):0===w.type&&0===E.type?0===g?(r.end=v,h++):1===g?(r.end=v,g=2,h=0):2===g&&(r.end=v,8===++h&&(r.end-=5,f.push(r),r={start:v-5,end:v-5},g=0,h=0)):(r.end=v,h++,0===g?(r.end>3&&(r.end-=3,r.empty=!0,f.push(r),r={start:v-3,end:v-3}),g=1):2===g&&(g=1))}0===g&&(r.empty=!0),r.end=p,f.push(r),console.table(f);for(var D=0;D<f.length;D++)if((r=f[D]).empty)b(r.start,r.end,u).appendTo(s);else for(v=r.start;v<r.end;v++){var R=m(u[v]).appendTo(s);v===r.start?R.addClass("start-block"):v===r.end-1&&R.addClass("end-block")}},close:function(){e=!1},show:function(){}};RED.tray.show(o)}function b(e,t,i){diffRow=$('<tr class="red-ui-diff-text-header red-ui-diff-text-expand">');var o=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),n=$("<span></span>").appendTo(o);return t<i.length-1&&n.text("@@ -"+(i[t-1].a.i+1)+" +"+(i[t-1].b.i+1)),diffRow.on("click",(function(o){if(t-e>20){var a=$(this).offset();if(e>0){for(var r=e;r<e+10;r++)m(i[r]).addClass("unchanged").insertBefore($(this));e+=10}if(t<i.length-1){for(r=t-1;r>t-11;r--)m(i[r]).addClass("unchanged").insertAfter($(this));t-=10}t<i.length-1&&n.text("@@ -"+(i[t-1].a.i+1)+" +"+(i[t-1].b.i+1));var s=$(this).offset().top-a.top;$(".red-ui-diff-text").scrollTop($(".red-ui-diff-text").scrollTop()+s)}else{for(r=e;r<t;r++)m(i[r]).addClass("unchanged").insertBefore($(this));$(this).remove()}})),diffRow}function m(e){var t=$("<tr>"),i=e.a,o=e.b,n=$('<td class="lineno">').text(2===i.type?"":i.i).appendTo(t),a=$('<td class="linetext">').text(i.line).appendTo(t);return 2===i.type?(n.addClass("blank"),a.addClass("blank")):4===i.type?(n.addClass("added"),a.addClass("added")):1===i.type&&(n.addClass("removed"),a.addClass("removed")),n=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),a=$('<td class="linetext">').text(o.line).appendTo(t),2===o.type?(n.addClass("blank"),a.addClass("blank")):4===o.type?(n.addClass("added"),a.addClass("added")):1===o.type&&(n.addClass("removed"),a.addClass("removed")),t}function y(e,t,i){return i?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function w(e,i){var o=$("<div></div>");return e.forEach((function(e){var n=e.hunks,a=e.binary,r=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(o);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(r);var s=$("<tbody>").appendTo(r),l=$('<tr class="red-ui-diff-text-file-header">').appendTo(s),c=$('<td colspan="3"></td>').appendTo(l);$('<i class="red-ui-diff-list-chevron fa fa-angle-down"></i>').appendTo(c);l.on("click",(function(e){l.toggleClass("collapsed");var t=l.hasClass("collapsed");l.nextUntil(".red-ui-diff-text-file-header").toggle(!t)}));$('<span class="filename"></span>').text(e.file).appendTo(c);var p,h=0,g=0,v={};if(i.project.files&&i.project.files.flow===e.file){i.unmerged&&$('<span style="float: right;"><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span>').appendTo(c);var b=$('<tr class="red-ui-diff-text-header">').appendTo(s),m=$('<td class="red-ui-diff-flow-diff" colspan="3"></td>').appendTo(b),y=i.project.name,w=i.project.files.flow,E="projects/"+y+"/files/"+i.commonRev+"/"+w,D="projects/"+y+"/files/"+i.oldRev+"/"+w,R="projects/"+y+"/files/"+i.newRev+"/"+w,x=[$.Deferred(),$.Deferred(),$.Deferred()];if(i.commonRev){E="projects/"+y+"/files/"+i.commonRev+"/"+w;$.ajax({dataType:"json",url:E}).then((function(e){x[0].resolve(e)})).fail((function(){x[0].resolve(null)}))}else x[0].resolve(null);$.ajax({dataType:"json",url:D}).then((function(e){x[1].resolve(e)})).fail((function(){x[1].resolve({content:"[]"})})),$.ajax({dataType:"json",url:R}).then((function(e){x[2].resolve(e)})).fail((function(){x[2].resolve({content:"[]"})})),$.when.apply($,x).always((function(e,o,n){var a,r,s;if(e)try{a=JSON.parse(e.content||"[]")}catch(e){return console.log(RED._("diff.commonVersionError"),E),void console.log(e)}try{r=JSON.parse(o.content||"[]")}catch(e){return console.log(RED._("diff.oldVersionError"),D),void console.log(e)}a||(a=r);try{s=JSON.parse(n.content||"[]")}catch(e){return console.log(RED._("diff.newVersionError"),s),void console.log(e)}var l=u(a,r),c=u(a,s);i.currentDiff=f(l,c);var p=t(m,i.currentDiff,{title:w,mode:i.commonRev?"merge":"view",oldRevTitle:i.oldRevTitle,newRevTitle:i.newRevTitle});p.list.hide(),d(i.currentDiff),setTimeout((function(){p.finish(),p.list.show()}),300)}))}else if(a){var _=$('<tr class="red-ui-diff-text-header">').appendTo(s),k=$('<td colspan="3"></td>').appendTo(_);$("<span></span>").text(RED._("diff.noBinaryFileShowed")).appendTo(k)}else i.unmerged&&(p=$('<span style="float: right;">'+RED._("diff.conflictHeader",{resolved:g,unresolved:h})+"</span>").appendTo(c)),n.forEach((function(t){var o=$('<tr class="red-ui-diff-text-header">').appendTo(s),n=$('<td colspan="3"></td>').appendTo(o),a=($("<span></span>").text(t.header).appendTo(n),t.conflict),r=t.localStartLine,d=t.remoteStartLine;a&&h++,t.lines.forEach((function(o,n){var l,c=t.diffStart+n,u=a&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(o),f=$("<tr>").appendTo(s),b=$('<td class="lineno">').appendTo(f);u?b.attr("colspan",2):l=$('<td class="lineno">').appendTo(f);var m=$('<td class="linetext">').appendTo(f),y=1;if(a&&(y=2),u){if(f.addClass("mergeHeader"),/^\+\+=======$/.test(o))t.changeSeparator=c,f.addClass("mergeHeader-separator");else{var w=/^..<<<<<<</.test(o);w?($("<span>").text("<<<<<<< Local Changes").appendTo(m),t.localChangeStart=c):(t.remoteChangeEnd=c,$("<span>").text(">>>>>>> Remote Changes").appendTo(m)),f.addClass("mergeHeader-"+(w?"ours":"theirs")),$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(w?"down":"up")+'"></i> use '+(w?"local":"remote")+" changes</button>").appendTo(m).on("click",(function(o){var n,a;o.preventDefault(),g++,w?((a=(n=f.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),a.next().remove()):((a=(n=f.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),a.prev().remove()),a.remove(),f.remove(),n.find(".linetext").addClass("added"),p.empty(),$("<span>"+RED._("diff.conflictHeader",{resolved:g,unresolved:h})+"</span>").appendTo(p),v[e.file]=v[e.file]||{},v[e.file][t.localChangeStart]={changeStart:t.localChangeStart,separator:t.changeSeparator,changeEnd:t.remoteChangeEnd,selection:w?"A":"B"},i.resolveConflict&&i.resolveConflict({conflicts:h,resolved:g,resolutions:v})}))}}else{var E=o[0];a&&!i.unmerged&&" "===E&&(E=o[1]),$('<span class="prefix">').text(E).appendTo(m);var D=!1;a&&i.unmerged?($('<span class="prefix">').text(o[1]).appendTo(m),"+"===o[0]&&(b.text(r++),D=!0),"+"===o[1]&&(l.text(d++),D=!0)):"+"===o[0]||a&&"+"===o[1]?(b.addClass("added"),l.addClass("added"),m.addClass("added"),l.text(d++),D=!0):("-"===o[0]||a&&"-"===o[1])&&(b.addClass("removed"),l.addClass("removed"),m.addClass("removed"),b.text(r++),D=!0),D||(m.addClass("unchanged"),r>0&&"\\"!==o[0]&&""!==o&&b.text(r++),d>0&&"\\"!==o[0]&&""!==o&&l.text(d++)),$("<span>").text(o.substring(y)).appendTo(m)}}))}))})),o}function E(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var i,o,n=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,a=/^\+\+\+ b\/(.*)\t?/,r=/^Binary files /,s=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,d=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,l=[],c=0;c<t.length;c++){var p=t[c],u=n.exec(p);if(u)o&&(i.hunks.push(o),l.push(i)),o=null,i={file:u[1]||u[3],hunks:[]};else if(r.test(p))i&&(i.binary=!0);else{var f=a.exec(p);if(f)i.file=f[1];else{var h=s.exec(p);if(h){o&&i.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=d.exec(p)){o&&i.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}o&&o.lines.push(p)}}}return o&&i.hunks.push(o),l.push(i),l}return{init:function(){RED.actions.add("core:show-remote-diff",c)},getRemoteDiff:l,showRemoteDiff:c,showUnifiedDiff:function(t){var i,o=t.diff,n=t.title,a=E(o);t.unmerged&&(t.resolveConflict=function(e){i=e,e.conflicts===e.resolved&&$("#red-ui-diff-view-resolve-diff").removeClass("disabled")});var r={title:n||RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._(t.unmerged?"common.label.cancel":"common.label.close"),click:function(){t.oncancel&&t.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){var i=e.find(".red-ui-tray-body"),o=$('<div class="red-ui-diff-text"></div>').appendTo(i);w(a,t).appendTo(o)},close:function(){e=!1},show:function(){}};t.unmerged&&r.buttons.push({id:"red-ui-diff-view-resolve-diff",text:RED._("diff.saveConflict"),class:"primary disabled",click:function(){if(!$("#red-ui-diff-view-resolve-diff").hasClass("disabled")){if(t.currentDiff){var e=h(t.currentDiff);(i={resolutions:{}}).resolutions[t.project.files.flow]=JSON.stringify(e.config,"",4)}t.onresolve&&t.onresolve(i),RED.tray.close()}}}),RED.tray.show(r)},showCommitDiff:function(t){var i=function(e){for(var t={},i=e.split("\n"),o=[],n=0;n<i.length;n++)if(/^commit /.test(i[n]))t.sha=i[n].substring(7);else if(/^Author: /.test(i[n])){t.author=i[n].substring(8);var a=/^(.*) <(.*)>$/.exec(t.author);a&&(t.authorName=a[1],t.authorEmail=a[2])}else if(/^Date: /.test(i[n]))t.date=i[n].substring(8);else if(/^    /.test(i[n]))t.title?(4!==i[n].length||o.length>0)&&o.push(i[n].substring(4)):t.title=i[n].substring(4);else if(/^diff /.test(i[n])){t.files=E(i.slice(n));break}return t.comment=o.join("\n"),t}(t.commit),o={title:RED._("diff.viewCommitDiff"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var o=e.find(".red-ui-tray-body"),n=$('<div class="red-ui-diff-text"></div>').appendTo(o),a=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(n);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(a);var r=$("<tbody>").appendTo(a),s=$('<tr class="red-ui-diff-text-commit-header">').appendTo(r),d=$('<td colspan="3"></td>').appendTo(s);$("<h3>").text(i.title).appendTo(d),$('<div class="commit-body"></div>').text(i.comment).appendTo(d);var l=$('<div class="commit-summary"></div>').appendTo(d);$('<div style="float: right">').text("Commit "+i.sha).appendTo(l),$("<div>").text((i.authorName||i.author)+" - "+t.date).appendTo(l),i.files&&w(i.files,t).appendTo(n)},close:function(){e=!1},show:function(){}};RED.tray.show(o)},mergeDiff:g}}(),RED.keyboard=function(){var e,t=/Mac/i.test(window.navigator.platform),o=!0,n={},a={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},r={16:!0,17:!0,18:!0,91:!0,93:!0},s={},d={},l={59:186,61:187,173:189};function c(e){return((RED.settings.get("editor")||{}).keymap||{})[e]}function p(e){for(var t,i=e.toLowerCase().split("-"),o={},n=0;n<i.length;n++)switch(i[n]){case"ctrl":case"cmd":o.ctrl=!0,o.meta=!0;break;case"alt":o.alt=!0;break;case"shift":o.shift=!0;break;case"":t=a["-"];break;default:if(a.hasOwnProperty(i[n]))t=a[i[n]];else{if(i[n].length>1)return null;t=i[n].toUpperCase().charCodeAt(0)}}return[t,o]}function u(e,t){for(var i=e.target,o=0;"BODY"!==i.nodeName&&i.id!==t.scope;)i=i.parentElement,o++;return"BODY"===i.nodeName&&"*"!==t.scope&&(o=-1),o}function f(t){var i=e||n;(t.ctrlKey||t.metaKey)&&(i=i.ctrl),i&&t.shiftKey&&(i=i.shift),i&&t.altKey&&(i=i.alt);var o=l[t.keyCode]||t.keyCode;if(i&&i[o]){var a=i[o];if(!a.handlers)return e?(e=null,f(t)):Object.keys(a).length>0?(e=a,t.preventDefault(),null):null;var r,s=1/0,d=0,c=a.handlers.length;for(d=0;d<c;d++){var p=u(t,a.handlers[d]);p>-1&&p<s&&(s=p,r=a.handlers[d])}return e=null,a=r}if(e)return e=null,f(t)}function h(e,t,i,o){var a=i,r=o;"function"!=typeof i&&"string"!=typeof i||(a={},r=i);var l=[],u=0;if("string"==typeof t){if("string"==typeof r){if(o||d.hasOwnProperty(r)||(d[r]={scope:e,key:t,user:!1}),!o)if(c(r))return;s[r]={scope:e,key:t},"boolean"==typeof o&&(s[r].user=o)}var f=t.split(" ");for(u=0;u<f.length;u++){var h=p(f[u]);if(!h)return;l.push(h)}}else l.push([t,a]);var g=n;for(u=0;u<l.length;u++)t=l[u][0],(a=l[u][1]).ctrl&&(g.ctrl=g.ctrl||{},g=g.ctrl),a.shift&&(g.shift=g.shift||{},g=g.shift),a.alt&&(g.alt=g.alt||{},g=g.alt),g[t]=g[t]||{},g=g[t];g.handlers=g.handlers||[],g.handlers.push({scope:e,ondown:r}),g.scope=e,g.ondown=r}function g(e,t){var i=t||{},o=[],a=0;if("string"==typeof e){var r=e.split(" ");for(a=0;a<r.length;a++){var d=p(r[a]);if(!d)return void console.log("Unrecognised key specifier:",e);o.push(d)}}else o.push([e,i]);var l=n;for(a=0;a<o.length;a++){if(e=o[a][0],(i=o[a][1]).ctrl&&(l=l.ctrl),l&&i.shift&&(l=l.shift),l&&i.alt&&(l=l.alt),!l[e])return;l=l[e]}"string"==typeof l.ondown&&("boolean"==typeof t&&t?s[l.ondown]={user:t}:delete s[l.ondown]),delete l.scope,delete l.ondown,delete l.handlers}d3.select(window).on("keydown",(function(){if(o&&!r[d3.event.keyCode]){var e=f(d3.event);e&&e.ondown&&("string"==typeof e.ondown?RED.actions.invoke(e.ondown):e.ondown(),d3.event.preventDefault())}}));function v(e){e.preventDefault();var t=$(this),i=t.data("data");if(!t.hasClass("keyboard-shortcut-entry-expanded")){b();var o=t.find(".keyboard-shortcut-entry-key"),n=t.find(".keyboard-shortcut-entry-scope");t.addClass("keyboard-shortcut-entry-expanded");var a=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(i.key||"").appendTo(o);a.on("keyup",(function(e){if(13===e.keyCode)return b();var t=$(this).val(),i=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!i)}));var r=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="red-ui-workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(n);r.i18n(),"workspace"===i.scope&&(i.scope="red-ui-workspace"),r.val(i.scope||"*");var s=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(n),d=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-check"></i></button>').appendTo(s),l=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(s);d.on("click",(function(e){e.stopPropagation(),b()})),l.on("click",(function(e){e.stopPropagation(),t.empty(),t.removeClass("keyboard-shortcut-entry-expanded");var o=RED.settings.get("editor")||{},n=o.keymap||{};n[i.id]=null,o.keymap=n,RED.settings.set("editor",o),RED.keyboard.revertToDefault(i.id);var a=RED.keyboard.getShortcut(i.id),r={id:i.id,scope:a?a.scope:void 0,key:a?a.key:void 0,user:a?a.user:void 0};m(t,r)})),a.trigger("focus")}}function b(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var i=t.data("data"),o=t.find(".keyboard-shortcut-entry-key input"),n=t.find(".keyboard-shortcut-entry-scope select");if(!e){var a=o.val().trim(),r=n.val();if(""===a||RED.keyboard.validateKey(a)){var s=RED.keyboard.getShortcut(i.id);if(!s&&a||s&&(s.scope!==r||s.key!==a)){var d=t.find(".keyboard-shortcut-entry-key"),l=t.find(".keyboard-shortcut-entry-scope");d.empty(),l.empty(),i.key&&RED.keyboard.remove(i.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===a?(d.parent().addClass("keyboard-shortcut-entry-unassigned"),d.append($("<span>").text(RED._("keyboard.unassigned"))),delete i.key,delete i.scope):(d.parent().removeClass("keyboard-shortcut-entry-unassigned"),d.append(RED.keyboard.formatKey(a)),$("<span>").text(r).appendTo(l),i.key=a,i.scope=r,RED.keyboard.add(i.scope,i.key,i.id,!0));var c=RED.settings.get("editor")||{},p=c.keymap||{};p[i.id]=RED.keyboard.getShortcut(i.id),c.keymap=p,RED.settings.set("editor",c)}}}o.remove(),n.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function m(e,t){var i=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var o=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,(function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()})),n=$("<div>").addClass("keyboard-shortcut-entry-text").text(o).appendTo(i),a=$('<i class="fa fa-user"></i>').prependTo(n);t.user||a.css("opacity",0);var r=$('<div class="keyboard-shortcut-entry-key">').appendTo(i);t.key?r.append(RED.keyboard.formatKey(t.key)):(i.addClass("keyboard-shortcut-entry-unassigned"),r.append($("<span>").text(RED._("keyboard.unassigned"))));var s=$('<div class="keyboard-shortcut-entry-scope">').appendTo(i);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(s),e.on("click",v)}function y(){var e=$('<div id="red-ui-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input autocomplete="off" name="keyboard-filter" id="red-ui-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("#red-ui-settings-tab-keyboard-filter").searchBox({delay:100,change:function(){var e=$(this).val().trim();""===e?t.editableList("filter",null):(e=e.replace(/\s/g,""),t.editableList("filter",(function(t){return t.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(e)>-1})))}});var t=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){m(e,i)}}),i=RED.actions.list();return i.sort((function(e,t){var i=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),o=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return i.localeCompare(o)})),i.forEach((function(e){t.editableList("addItem",e)})),e}return{init:function(){!function(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");if(null!==e){localStorage.removeItem("keymap");var t=RED.settings.get("editor")||{};t.keymap=JSON.parse(e),RED.settings.set("editor",t)}}}();var e=(RED.settings.get("editor")||{}).keymap||{};$.getJSON("red/keymap.json",(function(t){for(var i in t)if(t.hasOwnProperty(i)){var o=t[i];for(var n in o)o.hasOwnProperty(n)&&(e.hasOwnProperty(o[n])||h(i,n,o[n],!1),d[o[n]]={scope:i,key:n,user:!1})}for(var a in e)if(e.hasOwnProperty(a)&&e[a]){var r=e[a];if(r.hasOwnProperty("key"))"workspace"===(i=r.scope)&&(i="red-ui-workspace"),h(i,r.key,a,!0)}})),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:y,focus:function(){setTimeout((function(){$("#red-ui-settings-tab-keyboard-filter").trigger("focus")}),200)}})},add:h,remove:g,getShortcut:function(e){return s[e]},getUserShortcut:c,revertToDefault:function(e){var t=s[e];if(t&&g(t.key),d.hasOwnProperty(e)){var i=d[e];h(i.scope,i.key,e,!1)}},formatKey:function(e,i){var o=t?e.replace(/ctrl-?/,"&#8984;"):e;return o=(o=(o=(o=(o=(o=t?o.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;"),i?o:'<span class="help-key-block"><span class="help-key">'+o.split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++){if(!p(t[i]))return!1}return!0},disable:function(){o=!1},enable:function(){o=!0}}}(),RED.workspaces=function(){var e,t=0,i=0;function o(t,o,n){if(t)e.addTab(t,n),e.resize();else{var a=RED.nodes.id();do{i+=1}while(0!==$("#red-ui-workspace-tabs a[title='"+RED._("workspace.defaultName",{number:i})+"']").size());t={type:"tab",id:a,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:i})},RED.nodes.addWorkspace(t,n),e.addTab(t,n),e.activateTab(a),o||(RED.history.push({t:"add",workspaces:[t],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),t}function n(e){if(1!==r){var t=RED.nodes.getWorkspaceOrder();e._index=t.indexOf(e.id),f(e);var i=RED.nodes.removeWorkspace(e.id);i.t="delete",i.dirty=RED.nodes.dirty(),i.workspaces=[e],RED.history.push(i),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function a(i){var o=RED.nodes.workspace(i);if(o){var a;RED.view.state(RED.state.EDITING);var s={title:RED._("workspace.editFlow",{name:RED.utils.sanitize(o.label)}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===r?" disabled":""),text:RED._("common.label.delete"),click:function(){n(o),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var t=$("#node-input-name").val(),i=!1,n={};o.label!=t&&(n.label=o.label,i=!0,o.label=t,e.renameTab(o.id,t));var r=$("#node-input-disabled").prop("checked");o.disabled!==r&&(n.disabled=o.disabled,i=!0,o.disabled=r);var s=a.getValue();if(o.info!==s&&(n.info=o.info,i=!0,o.info=s),$("#red-ui-tab-"+o.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!o.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!o.disabled),i){var d={t:"edit",changes:n,node:o,dirty:RED.nodes.dirty()};o.changed=!0,RED.history.push(d),RED.nodes.dirty(!0),RED.sidebar.config.refresh(),n.hasOwnProperty("disabled")&&(RED.nodes.eachNode((function(e){e.z===o.id&&(e.dirty=!0)})),RED.view.redraw()),RED.events.emit("flows:change",o)}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),i=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),o=0;o<t.size();o++)i-=$(t[o]).outerHeight(!0);i-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",i+"px"),a.resize()},open:function(e){var t=e.find(".red-ui-tray-footer"),i=e.find(".red-ui-tray-body"),n=$('<div class="red-ui-tray-footer-left"></div>').appendTo(t),r=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(i);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>').appendTo(r),o.hasOwnProperty("disabled")||(o.disabled=!1),$('<input id="node-input-disabled" type="checkbox">').prop("checked",o.disabled).appendTo(n).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0});$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="min-height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(r);a=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$("#node-info-input-info-expand").on("click",(function(e){e.preventDefault();var t=a.getValue();RED.editor.editMarkdown({value:t,width:"Infinity",cursor:a.getCursorPosition(),complete:function(e,t){a.setValue(e,-1),a.gotoLine(t.row+1,t.column,!1),setTimeout((function(){a.focus()}),300)}})})),$('<input type="text" style="display: none;" />').prependTo(r),r.on("submit",(function(e){e.preventDefault()})),$("#node-input-name").val(o.label),RED.text.bidi.prepareInput($("#node-input-name")),a.getSession().setValue(o.info||"",-1),r.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT);var e=RED.view.selection();e.nodes||e.links||o.id!==t||RED.sidebar.info.refresh(o),a.destroy()}};RED.tray.show(s)}else{var d=RED.nodes.subflow(i);d&&RED.editor.editSubflow(d)}}var r=0;function s(){e=RED.tabs.create({id:"red-ui-workspace-tabs",onchange:function(e){var i={old:t};t=e.id,i.workspace=t,RED.events.emit("workspace:change",i),window.location.hash="flow/"+e.id,$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!e.disabled),RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?a(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&r++,$('<span class="red-ui-workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("red-ui-workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",r<=1),1===r&&($("#red-ui-workspace .red-ui-tabs").show(),$("#red-ui-workspace-chart").show(),$("#red-ui-workspace-footer").children().show())},onremove:function(e){"tab"===e.type&&r--,RED.menu.setDisabled("menu-item-workspace-delete",r<=1),0===r&&d()},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),h(t)},onselect:function(e){RED.view.select(!1),0===e.length?($("#red-ui-workspace-chart svg").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-palette-container").css({"pointer-events":"auto",filter:"none"}),$(".red-ui-sidebar-shade").hide()):(RED.view.select(!1),$("#red-ui-workspace-chart svg").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-palette-container").css({"pointer-events":"none",filter:"opacity(60%)"}),$(".red-ui-sidebar-shade").show())},minimumActiveTabWidth:150,scrollable:!0,addButton:"core:add-flow",addButtonCaption:RED._("workspace.addFlow"),searchButton:"core:list-flows",searchButtonCaption:RED._("workspace.listFlows")}),r=0}function d(){$("#red-ui-workspace .red-ui-tabs").hide(),$("#red-ui-workspace-chart").hide(),$("#red-ui-workspace-footer").children().hide()}function l(e){a(e||t)}function c(e){u(e,!1)}function p(e){u(e,!0)}function u(e,i){var o=RED.nodes.workspace(e||t);if(o&&o.disabled!==i){var n={disabled:o.disabled};o.disabled=i,$("#red-ui-tab-"+o.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!o.disabled),e===t&&$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!o.disabled);var a={t:"edit",changes:n,node:o,dirty:RED.nodes.dirty()};o.changed=!0,RED.history.push(a),RED.events.emit("flows:change",o),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var r=RED.view.selection();r.nodes||r.links||o.id!==t||RED.sidebar.info.refresh(o),n.hasOwnProperty("disabled")&&(RED.nodes.eachNode((function(e){e.z===o.id&&(e.dirty=!0)})),RED.view.redraw())}}function f(i){i?(e.contains(i.id)&&e.removeTab(i.id),i.id===t&&(t=0)):n(RED.nodes.workspace(t))}function h(t){var i=t.filter((function(e){return void 0!==RED.nodes.workspace(e)})),o=RED.nodes.getWorkspaceOrder();JSON.stringify(i)!==JSON.stringify(o)&&(RED.nodes.setWorkspaceOrder(i),RED.events.emit("flows:reorder",i)),e.order(t)}return{init:function(){$('<div id="system-main-container" class="j-container-main"><div id="system-message-container"></div></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-editor-shade" class="hide"></div>').appendTo("#red-ui-workspace"),s(),RED.events.on("sidebar:resize",e.resize),RED.actions.add("core:show-next-tab",e.nextTab),RED.actions.add("core:show-previous-tab",e.previousTab),RED.menu.setAction("menu-item-workspace-delete",(function(){n(RED.nodes.workspace(t))})),$(window).on("resize",(function(){e.resize()})),RED.actions.add("core:add-flow",(function(e){o(void 0,void 0,e?e.index:void 0)})),RED.actions.add("core:edit-flow",l),RED.actions.add("core:remove-flow",f),RED.actions.add("core:enable-flow",c),RED.actions.add("core:disable-flow",p),RED.actions.add("core:list-flows",(function(){RED.actions.invoke("core:search","type:tab ")})),d()},add:o,remove:f,order:h,edit:l,contains:function(t){return e.contains(t)},count:function(){return r},active:function(){return t},selection:function(){return e.selection()},show:function(t){if(!e.contains(t)){var i=RED.nodes.subflow(t);if(!i)return;o({type:"subflow",id:t,icon:"red/images/subflow_tab.svg",label:i.name,closeable:!0})}e.activateTab(t)},refresh:function(){RED.nodes.eachWorkspace((function(t){e.renameTab(t.id,t.label)})),RED.nodes.eachSubflow((function(t){e.contains(t.id)&&e.renameTab(t.id,t.name)})),RED.sidebar.config.refresh()},resize:function(){e.resize()},enable:c,disable:p}}(),
/*!
 RED.statusBar.add({
     id: "widget-identifier",
     align: "left|right",
     element: widgetElement
 })
*/
RED.statusBar=function(){var e,t,i={};return{init:function(){e=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-left">').appendTo("#red-ui-workspace-footer"),t=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-right">').appendTo("#red-ui-workspace-footer")},add:function(o){i[o.id]=o;var n=$('<span class="red-ui-statusbar-widget"></span>');o.element.appendTo(n),"left"===o.align?e.append(n):"right"===o.align&&t.prepend(n)}}}(),RED.view=function(){var e,t,o,n,a,r,s,d,l,c,p,u,f,h,g,v,b,m=5e3,y=5e3,w=.75,E=1,D=100,R=30,x=650,_=1e3,k=0,T=[],C=0,j={},L=20,O=!1,S=!1,I=null,P=[],N=[],A=[],z={},M=null,B=null,G=[],U={},F=null,J=null,q=null,V=null,W=null,K=0,H=null,Y=[0,0],Q=null,X=0,Z=null,ee=null,te=!1,ie=null,oe=null,ne=0,ae=0,re=[],se=null,de=-1,le=!1,ce="",pe={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3",gray:"#d3d3d3"},ue=1,fe=0,he=(g=new Set,v=[],b={add:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)b.add(e[t]);else g.has(e.id)||(v.push({n:e}),g.add(e.id))},remove:function(e,t){if(g.has(e.id))if(g.delete(e.id),void 0!==t&&v[t].n===e)v.splice(t,1);else for(var i=0;i<v.length;i++)if(v[i].n===e){v.splice(i,1);break}},clear:function(){g.clear(),v=[]},length:function(){return v.length},get:function(e){return v[e]},forEach:function(e){v.forEach(e)},nodes:function(){return v.map((function(e){return e.n}))}});function ge(e){de=-1;for(var t=0;t<e.length;t++){var i=e[t];i.el=c.append("svg:path").attr("class","red-ui-flow-drag-line"),("link out"===i.node.type&&i.portType===fe||"link in"===i.node.type&&i.portType===ue)&&(i.el.attr("class","red-ui-flow-link-link red-ui-flow-drag-line"),i.virtualLink=!0,de=i.portType===fe?ue:fe),h.push(i)}-1!==de&&P.forEach((function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)}))}function ve(){for(-1!==de&&P.forEach((function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)})),de=-1;h.length;){var e=h.pop();e.el&&e.el.remove()}}function be(){var e=RED.workspaces.active();P=RED.nodes.filterNodes({z:e}),N=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function me(e,t,i,o,n){var a=o-t,r=i-e,s=Math.sqrt(a*a+r*r),d=w;if(r*n>0?s<D&&(d=.75-(D-s)/D*.75):d=.4-.2*Math.max(0,(D-Math.min(Math.abs(r),Math.abs(a)))/D),r*n>0)return"M "+e+" "+t+" C "+(e+n*(D*d))+" "+(t+0*R)+" "+(i-n*d*D)+" "+(o-0*R)+" "+i+" "+o;var l=Math.floor(i-r/2),c=Math.floor(o-a/2);0===a&&(c=o+R);var p=R/2,u=(o+c)/2,f=e+n*D*d,h=a>0?Math.min(u-a/2,t+p):Math.max(u-a/2,t-p),g=i-n*D*d,v=a>0?Math.max(u,o-p):Math.min(u,o+p),b=(e+f)/2,m=a>0?1:-1,y=[[b,t],[f,a>0?Math.max(t,h-p):Math.min(t,h+p)],[b,a>0?Math.min(c,h+p):Math.max(c,h-p)],[g,a>0?Math.max(c,v-p):Math.min(c,v+p)],[(i+g)/2,o]];return y[2][1]===h+m*p&&(Math.abs(a)<10*p&&(y[1][1]=h-m*p/2,y[3][1]=v-m*p/2),y[2][0]=f),"M "+e+" "+t+" C "+y[0][0]+" "+y[0][1]+" "+y[1][0]+" "+y[1][1]+" "+f+" "+h+" S "+y[2][0]+" "+y[2][1]+" "+l+" "+c+" S "+y[3][0]+" "+y[3][1]+" "+g+" "+v+" S "+y[4][0]+" "+y[4][1]+" "+i+" "+o}function ye(e,t,i){var o=/^subflow:(.+)$/.exec(e);if(I&&o){if(o[1]===I.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(o[1],I.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var n={id:RED.nodes.id(),z:RED.workspaces.active()};if(n.type=e,n._def=RED.nodes.getType(n.type),o){var a=RED.nodes.subflow(o[1]);n.name="",n.inputs=a.in.length,n.outputs=a.out.length}else{for(var r in n.inputs=n._def.inputs||0,n.outputs=n._def.outputs,n._def.defaults)n._def.defaults.hasOwnProperty(r)&&void 0!==n._def.defaults[r].value&&(n[r]=JSON.parse(JSON.stringify(n._def.defaults[r].value)));if(n._def.onadd)try{n._def.onadd.call(n)}catch(e){console.log("Definition error: "+n.type+".onadd:",e)}}n.changed=!0,n.moved=!0,n.w=D,n.h=Math.max(R,15*(n.outputs||0)),n.resize=!0;var s={t:"add",nodes:[n.id],dirty:RED.nodes.dirty()};if(I){var d=RED.subflow.refresh(!0);d&&(s.subflow={id:I.id,changed:I.changed,instances:d.instances})}return{node:n,historyEvent:s}}function we(){var e;if(RED.view.DEBUG&&console.warn("canvasMouseDown",X),X!==RED.state.SELECTING_NODE){if(1===d3.event.button)return X=RED.state.PANNING,Q=[d3.event.pageX,d3.event.pageY],void(re=[a.scrollLeft(),a.scrollTop()]);if(q||J||V||(F=null,Le()),0===X&&Z&&(Z.remove(),Z=null),(0===X||X===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){d3.event.stopPropagation(),Ce();var t=bt((e=d3.mouse(this))[0],e[1]);h.length>0&&(t=t||RED.nodes.group(h[0].node.g)),Ee(e,null,t)}0!==X||d3.event.metaKey||d3.event.ctrlKey||C||(e=d3.mouse(this),Z=s.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","nr-ui-view-lasso"),d3.event.preventDefault())}else d3.event.stopPropagation()}function Ee(e,t,i,o){i&&!i.active&&(ft(i,!1),ht(i),RED.view.redraw());var n=e[0],a=e[1];RED.settings.get("editor").view["view-snap-grid"]&&(e[0]=Math.round(e[0]/L)*L,e[1]=Math.round(e[1]/L)*L);var r,d=$("#red-ui-main-container").position();X!==RED.state.QUICK_JOINING&&(X=RED.state.QUICK_JOINING,$(window).on("keyup",Ge)),!0,ee&&ee.remove(),(ee=s.append("g").attr("transform","translate("+(e[0]-D/2)+","+(e[1]-R/2)+")")).append("rect").attr("class","red-ui-flow-node-placeholder").attr("rx",5).attr("ry",5).attr("width",D).attr("height",R).attr("fill","none"),h.length>0&&(r=h[0].virtualLink?{type:"link in"===h[0].node.type?"link out":"link in"}:h[0].portType===fe?{input:!0}:{output:!0},se={node:h[0].node,port:h[0].port,portType:h[0].portType},h[0].virtualLink&&(se.virtualLink=!0),ve()),t&&(r={input:!0,output:!0});var l,p,u=function(){if(se){se.el||(se.el=c.append("svg:path").attr("class","red-ui-flow-drag-line"));var t=-((se.portType===fe&&se.node.outputs||1)-1)/2*13+13*se.port,i=se.portType===fe?1:-1;se.el.attr("d",me(se.node.x+i*se.node.w/2,se.node.y+t,e[0]-i*D/2,e[1],i))}};se&&u(),RED.typeSearch.show({x:d3.event.clientX-d.left-D/2-(n-e[0]),y:d3.event.clientY-d.top+R/2+5-(a-e[1]),disableFocus:o,filter:r,move:function(t,i){if(ee){var o=d3.transform(ee.attr("transform")).translate;ee.attr("transform","translate("+(o[0]+t)+","+(o[1]+i)+")"),e[0]+=t,e[1]+=i,u()}},cancel:function(){se&&(se.el&&se.el.remove(),se=null),!1,ee&&ee.remove(),Be(),Le(),ve()},add:function(n,a){o&&(a=!1,Be());var r=ye(n);if(r){a&&(X=RED.state.QUICK_JOINING);var s=r.node,d=r.historyEvent;s.x=e[0],s.y=e[1];var c=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");if(void 0===c||/^link (in|out)$/.test(s._def.type)||s._def.defaults.hasOwnProperty("l")||(s.l=c),se){var f,h,g=se,v=null;if(g.portType===fe&&(s.inputs>0||g.virtualLink)?(v=g.node,h=g.port,f=s):g.portType===ue&&(s.outputs>0||g.virtualLink)&&(v=s,f=g.node,h=0),null!==v){if(g.virtualLink){d={t:"multi",events:[d]};var b=$.extend(!0,{},{v:v.links}).v,m=$.extend(!0,{},{v:f.links}).v;v.links.push(f.id),f.links.push(v.id),v.dirty=!0,f.dirty=!0,d.events.push({t:"edit",node:v,dirty:RED.nodes.dirty(),changed:v.changed,changes:{links:b}}),d.events.push({t:"edit",node:f,dirty:RED.nodes.dirty(),changed:f.changed,changes:{links:m}}),v.changed=!0,f.changed=!0}else{var y={source:v,sourcePort:h,target:f};RED.nodes.addLink(y),d.links=[y]}a?(se.node=s,se.port=0):(se.el.remove(),se=null,X===RED.state.QUICK_JOINING&&(g.portType===fe&&s.outputs>0?ge([{node:s,port:0,portType:fe}]):!se&&g.portType===ue&&s.inputs>0?ge([{node:s,port:0,portType:ue}]):Be()))}else ve(),Be()}else a?s.outputs>0?se={node:s,port:0,portType:fe}:s.inputs>0?se={node:s,port:0,portType:ue}:Be():X===RED.state.QUICK_JOINING&&(s.outputs>0?ge([{node:s,port:0,portType:fe}]):s.inputs>0?ge([{node:s,port:0,portType:ue}]):Be());if(RED.nodes.add(s),RED.editor.validateNode(s),i&&(RED.group.addToGroup(i,s),"multi"!==d.t&&(d={t:"multi",events:[d]}),d.events.push({t:"addToGroup",group:i,nodes:s})),t){Be(),RED.nodes.removeLink(t);var w={source:t.source,sourcePort:t.sourcePort,target:s},E={source:s,sourcePort:0,target:t.target};RED.nodes.addLink(w),RED.nodes.addLink(E),d.links=(d.links||[]).concat([w,E]),d.removedLinks=[t]}if(RED.history.push(d),RED.nodes.dirty(!0),Ce(),s.selected=!0,i&&(ft(i,!1),ht(i)),he.add(s),be(),Le(),void 0!==l){var x=l+p/2,_=s.x-s.w/2-x;_!=2*L&&(s.x=s.x+2*L-_,s.dirty=!0,s.x=Math.ceil(s.x/L)*L)}a?(void 0===l&&setTimeout((function(){RED.typeSearch.refresh({filter:{input:!0}})}),100),l=s.x,p=s.w,e[0]=s.x+s.w/2+D/2+2*L,ee.attr("transform","translate("+(e[0]-D/2)+","+(e[1]-R/2)+")"),u()):(!1,ee.remove())}}}),be(),Le()}function De(){var i,n;if(X===RED.state.PANNING){var s=[d3.event.pageX,d3.event.pageY];if(d3.event.touches){var d=d3.event.touches.item(0);s=[d.pageX,d.pageY]}var l=[Q[0]-s[0],Q[1]-s[1]];return a.scrollLeft(re[0]+l[0]),void a.scrollTop(re[1]+l[1])}if(Q=d3.touches(this)[0]||d3.mouse(this),Z){var c,p,u=parseInt(Z.attr("ox")),f=parseInt(Z.attr("oy")),g=parseInt(Z.attr("x")),v=parseInt(Z.attr("y"));return c=Q[0]<u?u-(g=Q[0]):Q[0]-g,p=Q[1]<f?f-(v=Q[1]):Q[1]-v,void Z.attr("x",g).attr("y",v).attr("width",c).attr("height",p)}if(X!==RED.state.SELECTING_NODE){if(X==RED.state.QUICK_JOINING||X==RED.state.IMPORT_DRAGGING||q||V||null!=F)if(X==RED.state.JOINING||X===RED.state.QUICK_JOINING){if(0===h.length&&null!==W){if(d3.event.shiftKey){var b,w=[],E=[];if(F&&(W===fe&&F.source===q&&F.sourcePort===K||W===ue&&F.target===q))E=[F];else b=W===fe?{source:q,sourcePort:K}:{target:q},E=RED.nodes.filterLinks(b);for(N=0;N<E.length;N++){var D=E[N];RED.nodes.removeLink(D),w.push({link:D,node:W===fe?D.target:D.source,port:W===fe?0:D.sourcePort,portType:W===fe?ue:fe})}0===w.length?Be():(ge(w),X=0,be(),X=RED.state.JOINING)}else q&&!se&&ge([{node:q,port:K,portType:W}]);F=null}for(n=Q,N=0;N<h.length;N++){var R=h[N],$=-((R.portType===fe&&R.node.outputs||1)-1)/2*13+13*R.port,x=R.portType===fe?1:-1;R.el.attr("d",me(R.node.x+x*R.node.w/2,R.node.y+$,n[0],n[1],x))}d3.event.preventDefault()}else if(X==RED.state.MOVING){n=d3.mouse(document.body),isNaN(n[0])&&(n=d3.touches(document.body)[0]);var _=(Y[0]-n[0])*(Y[0]-n[0])+(Y[1]-n[1])*(Y[1]-n[1]);(_>3&&!oe||oe&&_>10)&&(X=RED.state.MOVING_ACTIVE,ae=0,S=!1,1===he.length()&&(i=he.get(0),S=i.n.hasOwnProperty("_def")&&(i.n.hasOwnProperty("inputs")&&i.n.inputs>0||!i.n.hasOwnProperty("inputs")&&i.n._def.inputs>0)&&(i.n.hasOwnProperty("outputs")&&i.n.outputs>0||!i.n.hasOwnProperty("outputs")&&i.n._def.outputs>0)&&0===RED.nodes.filterLinks({source:i.n}).length&&0===RED.nodes.filterLinks({target:i.n}).length))}else if(X==RED.state.MOVING_ACTIVE||X==RED.state.IMPORT_DRAGGING){n=Q;for(var k=0,T=0,C=m,j=y,I=0;I<he.length();I++)i=he.get(I),d3.event.shiftKey&&(i.n.ox=i.n.x,i.n.oy=i.n.y),i.n.x=n[0]+i.dx,i.n.y=n[1]+i.dy,i.n.dirty=!0,"group"===i.n.type?(!1!==i.n.groupMoved&&(i.n.groupMoved=!0),RED.group.markDirty(i.n),k=Math.min(i.n.x-5,k),T=Math.min(i.n.y-5,T),C=Math.max(i.n.x+i.n.w+5,C),j=Math.max(i.n.y+i.n.h+5,j)):(k=Math.min(i.n.x-i.n.w/2-5,k),T=Math.min(i.n.y-i.n.h/2-5,T),C=Math.max(i.n.x+i.n.w/2+5,C),j=Math.max(i.n.y+i.n.h/2+5,j));if(0!==k||0!==T)for(N=0;N<he.length();N++)(i=he.get(N)).n.x-=k,i.n.y-=T;if(C!==m||j!==y)for(N=0;N<he.length();N++)(i=he.get(N)).n.x-=C-m,i.n.y-=j-y;var P=[0,0];if(O!=d3.event.shiftKey&&he.length()>0){var N=0;do{i=he.get(N++)}while(N<he.length()&&"group"===i.n.type);if("group"===i.n.type?(P[0]=i.n.x-L*Math.floor(i.n.x/L)-L/2,P[1]=i.n.y-L*Math.floor(i.n.y/L)-L/2):(P[0]=i.n.x-(L*Math.floor((i.n.x-i.n.w/2)/L)+i.n.w/2),P[1]=i.n.y-L*Math.floor(i.n.y/L)),0!==P[0]||0!==P[1])for(N=0;N<he.length();N++)(i=he.get(N)).n.x-=P[0],i.n.y-=P[1],i.n.x==i.n.ox&&i.n.y==i.n.oy&&(i.dirty=!1)}1===he.length()&&"group"!==he.get(0).n.type&&(i=he.get(0),S&&(t||(t=setTimeout((function(){var o=[],n=1/0,a=null,s=i.n.x,d=i.n.y;if(r[0][0].getIntersectionList){var l=r[0][0].createSVGRect();l.x=s,l.y=d,l.width=1,l.height=1,o=r[0][0].getIntersectionList(l,r[0][0])}else o=RED.view.getLinksAtPoint(s,d);for(var c=0;c<o.length;c++)if(d3.select(o[c]).classed("red-ui-flow-link-background"))for(var p=o[c].getTotalLength(),u=0;u<p;u+=10){var f=o[c].getPointAtLength(u),h=(f.x-s)*(f.x-s)+(f.y-d)*(f.y-d);h<200&&h<n&&(n=h,a=o[c])}e&&e!==a&&d3.select(e.parentNode).classed("red-ui-flow-link-splice",!1),a?d3.select(a.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),e=a,t=null}),100))),"subflow"!==i.n.type&&!i.n.g&&G&&(o||(o=setTimeout((function(){B=bt(i.n.x,i.n.y);for(var e=0;e<G.length;e++){var t=G[e];t===B?(t.hovered=!0,t.dirty=!0):t.hovered&&(t.hovered=!1,t.dirty=!0)}o=null}),50))))}}else d3.event.stopPropagation()}function Re(){var t,i;if(RED.view.DEBUG&&console.warn("canvasMouseUp",X),X!==RED.state.PANNING)if(X!==RED.state.SELECTING_NODE){if(X!==RED.state.QUICK_JOINING){if(q&&X==RED.state.JOINING){var o=[];for(t=0;t<h.length;t++)h[t].link&&o.push(h[t].link);o.length>0&&(i={t:"delete",links:o,dirty:RED.nodes.dirty()},RED.history.push(i),RED.nodes.dirty(!0)),ve()}if(Z){var n=parseInt(Z.attr("x")),a=parseInt(Z.attr("y")),r=n+parseInt(Z.attr("width")),s=a+parseInt(Z.attr("height")),d=M;d3.event.shiftKey||(Ce(),d&&n<d.x+d.w&&r>d.x&&a<d.y+d.h&&s>d.y&&(ht(d),M.selected=!0)),G.forEach((function(e){if(!e.selected&&e.x>n&&e.x+e.w<r&&e.y>a&&e.y+e.h<s&&(!M||RED.group.contains(M,e))){for(;e.g&&(!M||e.g!==M.id);)e=RED.nodes.group(e.g);e.selected||ft(e,!0)}})),P.forEach((function(e){if(!e.selected&&e.x>n&&e.x<r&&e.y>a&&e.y<s&&(!M||RED.group.contains(M,e)))if(!e.g||M&&e.g===M.id)e.selected=!0,e.dirty=!0,he.add(e);else{console.log("HERE");for(var t=RED.nodes.group(e.g);t.g&&(!M||t.g!==M.id);)t=RED.nodes.group(t.g);t.selected||ft(t,!0)}})),I&&(I.in.forEach((function(e){e.selected=e.x>n&&e.x<r&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,he.add(e))})),I.out.forEach((function(e){e.selected=e.x>n&&e.x<r&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,he.add(e))})),I.status&&(I.status.selected=I.status.x>n&&I.status.x<r&&I.status.y>a&&I.status.y<s,I.status.selected&&(I.status.dirty=!0,he.add(I.status)))),Le(),Z.remove(),Z=null}else X!=RED.state.DEFAULT||null!=J||d3.event.ctrlKey||d3.event.metaKey||(Ce(),Le());if(X==RED.state.MOVING_ACTIVE&&he.length()>0){var l=null;if(B){for(var c=0;c<he.length();c++){var p=he.get(c);RED.group.addToGroup(B,p.n)}l=B,B.hovered=!1,ht(B),M.selected=!0,B=null}var u=[];for(c=0;c<he.length();c++){(p=he.get(c)).ox===p.n.x&&p.oy===p.n.y||(u.push({n:p.n,ox:p.ox,oy:p.oy,moved:p.n.moved}),p.n.dirty=!0,p.n.moved=!0)}if(u.length>0&&X==RED.state.MOVING_ACTIVE){if(i={t:"move",nodes:u,dirty:RED.nodes.dirty()},e){var f=d3.select(e).data()[0];RED.nodes.removeLink(f);var g={source:f.source,sourcePort:f.sourcePort,target:he.get(0).n},v={source:he.get(0).n,sourcePort:0,target:f.target};RED.nodes.addLink(g),RED.nodes.addLink(v),i.links=[g,v],i.removedLinks=[f],be()}l&&(i.addToGroup=l),RED.nodes.dirty(!0),RED.history.push(i)}}if(X==RED.state.MOVING||X==RED.state.MOVING_ACTIVE)for(t=0;t<he.length();t++){var b=he.get(t);delete b.ox,delete b.oy}X==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),be(),RED.nodes.dirty(!0)),Be()}}else d3.event.stopPropagation();else Be()}function $e(){E<2&&ke(E+.1)}function xe(){E>.3&&ke(E-.1)}function _e(){ke(1)}function ke(e){var t=[a.width(),a.height()],i=[a.scrollLeft(),a.scrollTop()],o=[(i[0]+t[0]/2)/E,(i[1]+t[1]/2)/E],n=[(i[0]+t[0]/2)/(E=e),(i[1]+t[1]/2)/E],r=[(n[0]-o[0])*E,(n[1]-o[1])*E];a.scrollLeft(i[0]-r[0]),a.scrollTop(i[1]-r[1]),RED.view.navigator.resize()}function Te(){if(X!==RED.state.SELECTING_NODE||!n.single){if(M){var e=M;Ce(),ht(e),RED.group.getNodes(e,!1).forEach((function(e){"group"===e.type?ft(e,!0,!0):(he.add(e),e.selected=!0,e.dirty=!0)})),M.selected=!0}else Ce(),gt(),G.forEach((function(e){e.g?(e.selected=!1,e.dirty=!0):(ft(e,!0),e.selected||(e.selected=!0,e.dirty=!0))})),P.forEach((function(e){X===RED.state.SELECTING_NODE&&n.filter&&!n.filter(e)||e.g||e.selected||(e.selected=!0,e.dirty=!0,he.add(e))})),X!==RED.state.SELECTING_NODE&&I&&(I.in.forEach((function(e){e.selected||(e.selected=!0,e.dirty=!0,he.add(e))})),I.out.forEach((function(e){e.selected||(e.selected=!0,e.dirty=!0,he.add(e))})),I.status&&(I.status.selected||(I.status.selected=!0,I.status.dirty=!0,he.add(I.status))));F=null,X!==RED.state.SELECTING_NODE&&Le()}}function Ce(){RED.view.DEBUG&&console.warn("clearSelection",X,"movingSet.length():",he.length());for(var e=0;e<he.length();e++){var t=he.get(e);t.n.dirty=!0,t.n.selected=!1}he.clear(),F=null,M&&(M.active=!1,M.dirty=!0,M=null),G.forEach((function(e){e.selected=!1,e.dirty=!0}))}var je=null;function Le(){var e={},t=RED.workspaces.active(),i=RED.workspaces.selection();if(0===i.length){e=Tt(),N=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var o={};A=[],Object.keys(z).forEach((function(e){z[e].dirty=!0})),z={};for(var n=0;n<he.length();n++){var a=he.get(n);if(("link out"===a.n.type||"link in"===a.n.type)&&a.n.z===t){var r=a.n;z[r.id]=r;var s={};r.links.forEach((function(e){var t=RED.nodes.node(e);t&&("link out"===r.type?t.z===r.z?o[r.id+":"+t.id]||(N.push({source:r,sourcePort:0,target:t,link:!0}),o[r.id+":"+t.id]=!0,z[t.id]=t,t.dirty=!0):(s[t.z]=s[t.z]||[],s[t.z].push(t)):t.z===r.z?o[t.id+":"+r.id]||(N.push({source:t,sourcePort:0,target:r,link:!0}),o[t.id+":"+r.id]=!0,z[t.id]=t,t.dirty=!0):(s[t.z]=s[t.z]||[],s[t.z].push(t)))})),Object.keys(s).length>0&&A.push({refresh:Math.floor(1e4*Math.random()),node:r,links:s})}}0===A.length&&null!==F&&F.link&&(N.push(F),z[F.source.id]=F.source,F.source.dirty=!0,z[F.target.id]=F.target,F.target.dirty=!0)}else e.flows=i;var d=t+":"+JSON.stringify(e,(function(e,t){return"nodes"===e||"flows"===e?t.map((function(e){return e.id})):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t}));d!==je&&(je=d,RED.events.emit("view:selection-changed",e))}function Oe(){if(he.length()>0){var e=he.get(0).n;"subflow"===e.type?RED.editor.editSubflow(I):"group"===e.type?RED.editor.editGroup(e):RED.editor.edit(e)}}function Se(){if(X!==RED.state.SELECTING_NODE){qe&&(qe.remove(),qe=null);var e=RED.workspaces.selection();if(e.length>0){var t=0;if(e.forEach((function(e){"tab"===e.type&&t++})),t===RED.workspaces.count())return;for(var i={t:"delete",dirty:RED.nodes.dirty(),nodes:[],links:[],groups:[],workspaces:[],subflows:[]},o=RED.nodes.getWorkspaceOrder().slice(0),n=0;n<e.length;n++){var a,r=e[n];r._index=o.indexOf(r.id),RED.workspaces.remove(r),"tab"===r.type?(i.workspaces.push(r),a=RED.nodes.removeWorkspace(r.id)):(a=RED.subflow.removeSubflow(r.id),i.subflows=i.subflows.concat(a.subflows)),i.nodes=i.nodes.concat(a.nodes),i.links=i.links.concat(a.links),i.groups=i.groups.concat(a.groups)}RED.history.push(i),RED.nodes.dirty(!0),be(),Le()}else if(he.length()>0||null!=F){var s,d,l,c=[],p=[],u=[],f=[],h=[],g=[],v=RED.nodes.dirty(),b=[];if(he.length()>0){for(n=0;n<he.length();n++)"group"===(d=he.get(n).n).type&&b.push(d);for(n=0;n<b.length;n++)b[n].nodes.forEach((function(e){"group"===e.type&&-1===b.indexOf(e)&&b.push(e)}));for(n=0;n<he.length();n++)if((d=he.get(n).n).selected=!1,"group"!==d.type&&"subflow"!==d.type){d.x<0&&(d.x=25);var m=RED.nodes.remove(d.id);if(c.push(d),c=c.concat(m.nodes),p=p.concat(m.links),d.g){var y=RED.nodes.group(d.g);if(-1===b.indexOf(y)){var w=y.nodes.indexOf(d);y.nodes.splice(w,1),RED.group.markDirty(y)}}}else"out"===d.direction?f.push(d):"in"===d.direction?h.push(d):"status"===d.direction&&(l=d),d.dirty=!0;for(n=b.length-1;n>=0;n--){var E=b[n];u.push(E),RED.nodes.removeGroup(E)}f.length>0&&(s=RED.subflow.removeOutput(f))&&(p=p.concat(s.links)),1==h.length&&(s=RED.subflow.removeInput())&&(p=p.concat(s.links)),l&&(s=RED.subflow.removeStatus())&&(p=p.concat(s.links));var D=RED.subflow.refresh(!0);D&&(g=D.instances),he.clear(),(c.length>0||f.length>0||h.length>0||l||u.length>0)&&RED.nodes.dirty(!0)}if(F&&F.link){var R=F.source.id,x=F.target.id,_=F.target.links.indexOf(R),k=F.source.links.indexOf(x);i={t:"multi",events:[{t:"edit",node:F.source,changed:F.source.changed,changes:{links:$.extend(!0,{},{v:F.source.links}).v}},{t:"edit",node:F.target,changed:F.target.changed,changes:{links:$.extend(!0,{},{v:F.target.links}).v}}],dirty:RED.nodes.dirty()},RED.nodes.dirty(!0),F.source.changed=!0,F.target.changed=!0,F.target.links.splice(_,1),F.source.links.splice(k,1),F.source.dirty=!0,F.target.dirty=!0}else F&&(RED.nodes.removeLink(F),p.push(F)),RED.nodes.dirty(!0),i={t:"delete",nodes:c,links:p,groups:u,subflowOutputs:f,subflowInputs:h,subflow:{id:I?I.id:void 0,instances:g},dirty:v},l&&(i.subflow.status=l);RED.history.push(i),F=null,be(),Le()}}}function Ie(){if(X!==RED.state.SELECTING_NODE){var e=[],t=RED.workspaces.selection();if(t.length>0?(e=[],t.forEach((function(t){"tab"===t.type&&(e.push(t),e=(e=e.concat(RED.nodes.groups(t.id))).concat(RED.nodes.filterNodes({z:t.id})))}))):(t=RED.view.selection()).nodes&&t.nodes.forEach((function(t){e.push(t),"group"===t.type&&(e=e.concat(RED.group.getNodes(t,!0)))})),e.length>0){for(var i=[],o=0,n=0,a={},r=0;r<e.length;r++){var s=e[r];if(!a[s.id]&&(a[s.id]=!0,"subflow"!=s.type)){for(var d in"group"===s.type?n++:o++,s._def.defaults)if(s._def.defaults.hasOwnProperty(d)&&s._def.defaults[d].type){var l=RED.nodes.node(s[d]);l&&l._def.exclusive&&i.push(RED.nodes.convertNode(l))}i.push(RED.nodes.convertNode(s))}}ce=JSON.stringify(i),o>0?RED.notify(RED._("clipboard.nodeCopied",{count:o}),{id:"clipboard"}):n>0&&RED.notify(RED._("clipboard.groupCopied",{count:n}),{id:"clipboard"})}}}function Pe(e,t){for(var i=Me(e),o=0,n=0;n<i.length;n++){var a=ze(i[n],t)[0];o<a&&(o=a)}return{lines:i,width:o}}var Ne={},Ae={};function ze(e,t){if(Ne[t]){if(Ae[t][e])return Ae[t][e]}else Ne[t]=document.createElement("span"),Ne[t].className=t,Ne[t].style.position="absolute",Ne[t].style.top="-1000px",document.getElementById("red-ui-editor").appendChild(Ne[t]),Ae[t]={};Ne[t].textContent=e||"";var i=Ne[t].offsetWidth,o=Ne[t].offsetHeight;return Ae[t][e]=[i,o],Ae[t][e]}function Me(e){var t=[],i=e.split(/\\n /);if(i.length>1){var o=0;for(o=0;o<i.length-1;o++)/\\$/.test(i[o])?(t.push(i[o]+"\\n "+i[o+1]),o++):t.push(i[o]);o===i.length-1&&t.push(i[i.length-1])}else t=i;return t=t.map((function(e){return e.replace(/\\\\n /g,"\\n ").trim()}))}function Be(){q=null,V=null,null,H=null,J=null,X=0,W=null,e=null,S=!1,B&&(B.hovered=!1,B=null),d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),t&&(clearTimeout(t),t=null),o&&(clearTimeout(o),o=null)}function Ge(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(Be(),ve(),$(window).off("keyup",Ge))}function Ue(e,t,i,o){RED.view.DEBUG&&console.warn("portMouseDown",X,e,t,i),1!==(o=o||d3.event)&&(X!==RED.state.SELECTING_NODE?(q=e,W=t,K=i||0,X!==RED.state.QUICK_JOINING&&(X=RED.state.JOINING,document.body.style.cursor="crosshair",(o.ctrlKey||o.metaKey)&&(X=RED.state.QUICK_JOINING,ge([{node:q,port:K,portType:W}]),$(window).on("keyup",Ge))),o.stopPropagation(),o.preventDefault()):o.stopPropagation())}function Fe(e,t,i,o){if(RED.view.DEBUG&&console.warn("portMouseUp",X,e,t,i),o=o||d3.event,X!==RED.state.SELECTING_NODE){if(X===RED.state.QUICK_JOINING&&h.length>0){if(h[0].node===e)return;if(h[0].virtualLink&&("link in"===h[0].node.type&&"link out"!==e.type||"link out"===h[0].node.type&&"link in"!==e.type))return}if(document.body.style.cursor="",X==RED.state.JOINING||X==RED.state.QUICK_JOINING){if("undefined"!=typeof TouchEvent&&o instanceof TouchEvent){var n=!1;if(RED.nodes.eachNode((function(e){if(e.z==RED.workspaces.active()){var o=e.w/2,a=e.h/2;e.x-o<Q[0]&&e.x+o>Q[0]&&e.y-a<Q[1]&&e.y+a>Q[1]&&(n=!0,t=(H=e).inputs>0?ue:fe,i=0)}})),!n&&I){var a=[];I.status&&a.push(I.status),I.in&&(a=a.concat(I.in)),I.out&&(a=a.concat(I.out));for(var r=0;r<a.length;r++){var s=a[r],d=s.w/2,l=s.h/2;if(s.x-d<Q[0]&&s.x+d>Q[0]&&s.y-l<Q[1]&&s.y+l>Q[1]){n=!0,t="in"===(H=s).direction?fe:ue,i=0;break}}}}else H=e;var c=[],p=[],u=[],f=null;for(r=0;r<h.length;r++)h[r].link&&p.push(h[r].link);var g=[];for(r=0;r<h.length;r++)if(t!=h[r].portType&&H!==h[r].node){var v,b,m,y=h[r];y.portType===fe?(v=y.node,m=y.port,b=H):y.portType===ue&&(v=H,b=y.node,m=i);var w={source:v,sourcePort:m,target:b};if(y.virtualLink){if(/^link (in|out)$/.test(v.type)&&/^link (in|out)$/.test(b.type)&&v.type!==b.type&&-1===v.links.indexOf(b.id)&&-1===b.links.indexOf(v.id)){var E=$.extend(!0,{},{v:v.links}).v,D=$.extend(!0,{},{v:b.links}).v;v.links.push(b.id),b.links.push(v.id),v.dirty=!0,b.dirty=!0,u.push(v),u.push(b),w.link=!0,N.push(w),z[v.id]=v,z[b.id]=b,f=w,g.push({t:"edit",node:v,dirty:RED.nodes.dirty(),changed:v.changed,changes:{links:E}}),g.push({t:"edit",node:b,dirty:RED.nodes.dirty(),changed:b.changed,changes:{links:D}}),v.changed=!0,b.changed=!0}}else if(!("link out"===e.type&&t===fe||"link in"===e.type&&t===ue||t===fe&&"subflow"!==H.type&&0===H.outputs||t===ue&&"subflow"!==H.type&&0===H.inputs||y.portType===ue&&"subflow"===H.type&&("status"===H.direction||"out"===H.direction)||y.portType===fe&&"subflow"===H.type&&"in"===H.direction))0!==RED.nodes.filterLinks({source:v,target:b,sourcePort:m}).length||(RED.nodes.addLink(w),c.push(w))}if(c.length>0||p.length>0||u.length>0){var R;if(R=u.length>0?{t:"multi",events:g,dirty:RED.nodes.dirty()}:{t:"add",links:c,removedLinks:p,dirty:RED.nodes.dirty()},I){var x=RED.subflow.refresh(!0);x&&(R.subflow={id:I.id,changed:I.changed,instances:x.instances})}RED.history.push(R),be(),RED.nodes.dirty(!0)}if(X===RED.state.QUICK_JOINING)return void((c.length>0||u.length>0)&&(ve(),t===ue&&e.outputs>0?ge([{node:e,port:0,portType:fe}]):t===fe&&e.inputs>0?ge([{node:e,port:0,portType:ue}]):Be(),F=f,J=f,f&&Le()));Be(),ve(),F=f,J=f,f&&Le()}}else o.stopPropagation()}var Je=null,qe=null;function Ve(e){var t=d3.select(e);if("red-ui-workspace-chart-event-layer"===t.attr("class"))return[0,0];var i=[0,0];if("g"===e.nodeName.toLowerCase()){var o=t.attr("transform");o&&(i=d3.transform(o).translate)}else i=[t.attr("x")||0,t.attr("y")||0];var n=Ve(e.parentNode);return[i[0]+n[0],i[1]+n[1]]}function We(e,t,i,o){var n=s.append("g").attr("transform","translate("+e+","+t+")").attr("class","red-ui-flow-port-tooltip"),a=i.indexOf("\\n ");a>-1&&"\\"!==i[a-1]&&(i=i.substring(0,a)+"...");var r=i.split("\n"),d=6,l=12,c=[],p=0;r.forEach((function(e,t){var i=ze(e||"&nbsp;","red-ui-flow-port-tooltip-label");d=Math.max(d,i[0]+14),c.push(i[1]),0===t&&(p=i[1]),l+=i[1]}));var u,f,h,g=d/2-5-2,v=l/2-5-2,b=l-4,m=-l/2;return"left"===o?(u="M0 0 l -5 -5 v -"+v+" q 0 -2 -2 -2 h -"+d+" q -2 0 -2 2 v "+b+" q 0 2 2 2 h "+d+" q 2 0 2 -2 v -"+v+" l 5 -5",f=-14,h="end"):"right"===o?(u="M0 0 l 5 -5 v -"+v+" q 0 -2 2 -2 h "+d+" q 2 0 2 2 v "+b+" q 0 2 -2 2 h -"+d+" q -2 0 -2 -2 v -"+v+" l -5 -5",f=14,h="start"):"top"===o&&(u="M0 0 l 5 -5 h "+g+" q 2 0 2 -2 v -"+l+" q 0 -2 -2 -2 h -"+(d-4)+" q -2 0 -2 2 v "+l+" q 0 2 2 2 h "+g+" l 5 5",f=-d/2+6,m=-l-p+12,h="start"),n.append("path").attr("d",u),r.forEach((function(e,t){m+=c[t],n.append("svg:text").attr("class","red-ui-flow-port-tooltip-label").attr("x",f).attr("y",m).attr("text-anchor",h).text(e||" ")})),n}function Ke(e,t,i,o){if(X!==RED.state.SELECTING_NODE){clearTimeout(Je);var n=X!=RED.state.JOINING&&X!=RED.state.QUICK_JOINING||h.length>0&&h[0].portType!==i&&(!h[0].virtualLink||"link in"===h[0].node.type&&"link out"===t.type||"link out"===h[0].node.type&&"link in"===t.type);n&&(i===ue&&(t._def&&t._def.inputLabels||t.inputLabels)||i===fe&&(t._def&&t._def.outputLabels||t.outputLabels))&&(Je=setTimeout((function(){var n=function(e,t,i){var o,n=t===ue?e.inputLabels:e.outputLabels;if(n&&n[i])return n[i];var a=t===ue?e._def.inputLabels:e._def.outputLabels;if("string"==typeof a)o=a;else if("function"==typeof a)try{o=a.call(e,i)}catch(i){console.log("Definition error: "+e.type+"."+(t===ue?"inputLabels":"outputLabels"),i),o=null}else $.isArray(a)&&(o=a[i]);return o}(t,i,o);if(n){var a=Ve(e.node());Je=null,qe=We(a[0]+(i===ue?-2:12),a[1]+5,n,i===ue?"left":"right")}}),500)),e.classed("red-ui-flow-port-hovered",n)}else d3.event.stopPropagation()}function He(e,t,i,o){X!==RED.state.SELECTING_NODE?(clearTimeout(Je),qe&&(qe.remove(),qe=null),e.classed("red-ui-flow-port-hovered",!1)):d3.event.stopPropagation()}function Ye(e){for(X=RED.state.MOVING,i=0;i<he.length();i++){var t=he.get(i);t.ox=t.n.x,t.oy=t.n.y,t.dx=t.n.x-e[0],t.dy=t.n.y-e[1]}Y=d3.mouse(document.body),isNaN(Y[0])&&(Y=d3.touches(document.body)[0])}function Qe(e){if(RED.view.DEBUG&&console.warn("nodeMouseUp",X,e),X!==RED.state.SELECTING_NODE){if(oe&&q==e&&ae>0&&ae<x)return X=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(I),ae=0,void d3.event.stopPropagation();if(X===RED.state.MOVING&&!le&&!e.selected&&e.g&&RED.nodes.group(e.g).selected){Ce(),ft(RED.nodes.group(e.g),!1),ht(RED.nodes.group(e.g)),q.selected=!0,he.add(q);var t=d3.touches(this)[0]||d3.mouse(this);return t[0]+=e.x-e.w/2,t[1]+=e.y-e.h/2,Ye(t),void Le()}le=!1;var i=e._def?e.inputs>0?1:0:"in"==e.direction?0:1,o=!1;X!==RED.state.JOINING&&X!==RED.state.QUICK_JOINING||(o=!0,h.length>0&&(h[0].virtualLink?"link in"===e.type?i=1:"link out"===e.type&&(i=0):i=1===h[0].portType?fe:ue)),Fe(e,i,0),o&&d3.selectAll(".red-ui-flow-port-hovered").classed("red-ui-flow-port-hovered",!1)}else d3.event.stopPropagation()}function Xe(t){if(RED.view.DEBUG&&console.warn("nodeMouseDown",X,t),1!==d3.event.button){if(X==RED.state.IMPORT_DRAGGING){RED.keyboard.remove("escape");var i=RED.history.peek();if(e){var o=d3.select(e).data()[0];RED.nodes.removeLink(o);var a={source:o.source,sourcePort:o.sourcePort,target:he.get(0).n},r={source:he.get(0).n,sourcePort:0,target:o.target};RED.nodes.addLink(a),RED.nodes.addLink(r),i.links=[a,r],i.removedLinks=[o],be()}if(B){for(var s=0;s<he.length();s++){var d=he.get(s);RED.group.addToGroup(B,d.n)}i.addedToGroup=B,B.hovered=!1,ht(B),M.selected=!0,B=null}return Le(),RED.nodes.dirty(!0),Be(),void d3.event.stopPropagation()}if(X!=RED.state.QUICK_JOINING){if(X===RED.state.SELECTING_NODE)return d3.event.stopPropagation(),n.single?void n.done(t):(t.selected?(t.selected=!1,he.remove(t)):n.filter&&!n.filter(t)||(t.selected=!0,he.add(t)),void(t.dirty=!0));q=t;var l=Date.now();if(ae=l-ne,ne=l,oe=ie==q&&(d3.event.touches||0===d3.event.button)&&!d3.event.shiftKey&&!d3.event.metaKey&&!d3.event.altKey&&!d3.event.ctrlKey&&ae<x,ie=q,!t.selected&&t.g){var c=RED.nodes.group(t.g);if(c!==M&&(d3.event.ctrlKey||d3.event.metaKey))M&&c.g===M.id?(le=!0,c.selected?vt(c):ft(c,!0)):(gt(),le=!0,c.selected?vt(c):ft(c,!0));else if(c===M)if(d3.event.shiftKey){if(!d3.event.ctrlKey&&!d3.event.metaKey){var p=M;Ce(),ht(p),M.selected=!0}var u=RED.nodes.getAllFlowNodes(q);for(d=0;d<u.length;d++)u[d].selected||(u[d].selected=!0,u[d].dirty=!0,he.add(u[d]))}else{if(!d3.event.ctrlKey&&!d3.event.metaKey){p=M;Ce(),vt(c),ft(c,!1,!1),p&&(ht(p),M.selected=!0)}q.selected=!0,he.add(q)}else{le=!c.selected;p=M;c.selected||Ce(),p?p!==c&&p.id!==c.g?(p.active=!1,p.dirty=!0):(M=p).active=!0:oe=!1,ft(c,!(M&&M===c),!!le),M&&M===c&&(q.selected=!0,he.add(q))}if(2!=d3.event.button)(f=d3.touches(this)[0]||d3.mouse(this))[0]+=t.x-t.w/2,f[1]+=t.y-t.h/2,Ye(f)}else if(t.selected&&(d3.event.ctrlKey||d3.event.metaKey))q.selected=!1,he.remove(q);else{if(d3.event.shiftKey){Ce();for(u=RED.nodes.getAllFlowNodes(q),d=0;d<u.length;d++)u[d].selected=!0,u[d].dirty=!0,he.add(u[d])}else t.selected||(d3.event.ctrlKey||d3.event.metaKey?gt():Ce(),q.selected=!0,he.add(q));var f;if(F=null,2!=d3.event.button)X=RED.state.MOVING,(f=d3.touches(this)[0]||d3.mouse(this))[0]+=t.x-t.w/2,f[1]+=t.y-t.h/2,Ye(f)}t.dirty=!0,Le(),d3.event.stopPropagation()}else d3.event.stopPropagation()}}function Ze(e){RED.view.DEBUG&&console.warn("nodeTouchStart",X,e);var t=d3.select(this),i=d3.event.touches.item(0),o=[i.pageX,i.pageY];T=[i.pageX,i.pageY],k=0,C=setTimeout((function(){wt(t,o)}),_),Xe.call(this,e),d3.event.preventDefault()}function et(e){RED.view.DEBUG&&console.warn("nodeTouchEnd",X,e),d3.event.preventDefault(),clearTimeout(C),C=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Qe.call(this,e)}function tt(e){if(RED.view.DEBUG&&console.warn("nodeMouseOver",X,e),0===X||X===RED.state.SELECTING_NODE){if(X===RED.state.SELECTING_NODE&&n&&n.filter?n.filter(e)&&this.parentNode.classList.add("red-ui-flow-node-hovered"):this.parentNode.classList.add("red-ui-flow-node-hovered"),clearTimeout(Je),e.hasOwnProperty("l")?!e.l:"link in"===e.type||"link out"===e.type){var t=this.parentNode;Je=setTimeout((function(){var i;if(e._def.label){i=e._def.label;try{i=("function"==typeof i?i.call(e):i)||""}catch(t){console.log("Definition error: "+e.type+".label",t),i=e.type}}if(""!==i){var o=Ve(t);Je=null,qe=We(o[0]+e.w/2,o[1]-1,i,"top")}}),500)}}else if(X===RED.state.JOINING||X===RED.state.QUICK_JOINING){var i,o;if(h.length>0)h[0].virtualLink&&h[0].portType===ue||h[0].portType===fe?(i=".red-ui-flow-port-input .red-ui-flow-port",o=ue):(i=".red-ui-flow-port-output .red-ui-flow-port",o=fe),Ke(d3.select(this.parentNode).selectAll(i),e,o,0)}}function it(e){var t;(RED.view.DEBUG&&console.warn("nodeMouseOut",X,e),this.parentNode.classList.remove("red-ui-flow-node-hovered"),clearTimeout(Je),qe&&(qe.remove(),qe=null),X===RED.state.JOINING||X===RED.state.QUICK_JOINING)&&(h.length>0&&(h[0].virtualLink&&h[0].portType===ue||h[0].portType===fe?t=".red-ui-flow-port-input .red-ui-flow-port":t=".red-ui-flow-port-output .red-ui-flow-port",He(d3.select(this.parentNode).selectAll(t))))}function ot(e){Ue(this.__data__,this.__portType__,this.__portIndex__,e)}function nt(e){Ue(this.__data__,this.__portType__,this.__portIndex__,e),e.preventDefault()}function at(e){Fe(this.__data__,this.__portType__,this.__portIndex__,e)}function rt(e){Fe(this.__data__,this.__portType__,this.__portIndex__,e),e.preventDefault()}function st(e){Ke(d3.select(this),this.__data__,this.__portType__,this.__portIndex__)}function dt(e){He(d3.select(this),this.__data__,this.__portType__,this.__portIndex__)}function lt(e){if(X!==RED.state.SELECTING_NODE){if(J=e,Ce(),F=J,Le(),d3.event.stopPropagation(),d3.event.metaKey||d3.event.ctrlKey){d3.select(this).classed("red-ui-flow-link-splice",!0);var t=d3.mouse(this),i=bt(t[0],t[1]);Ee(t,F,i)}}else d3.event.stopPropagation()}function ct(e){if(X!==RED.state.SELECTING_NODE){J=e,Ce(),F=J,Le(),d3.event.stopPropagation();var t=d3.select(document.body),i=d3.event.touches.item(0),o=[i.pageX,i.pageY];C=setTimeout((function(){C=null,wt(t,o)}),_),d3.event.preventDefault()}else d3.event.stopPropagation()}function pt(e){if(oe&&V==e&&ae>0&&ae<x)return X=RED.state.DEFAULT,RED.editor.editGroup(e),void d3.event.stopPropagation()}function ut(e){var t=d3.touches(this.parentNode)[0]||d3.mouse(this.parentNode);if(1!==d3.event.button){if(X==RED.state.IMPORT_DRAGGING)RED.keyboard.remove("escape");else{if(X==RED.state.QUICK_JOINING)return void d3.event.stopPropagation();if(X===RED.state.SELECTING_NODE)return void d3.event.stopPropagation()}V=e;var i=Date.now();if(ae=i-ne,ne=i,oe=ie==e&&(d3.event.touches||0===d3.event.button)&&!d3.event.shiftKey&&!d3.event.metaKey&&!d3.event.altKey&&!d3.event.ctrlKey&&ae<x,ie=e,e.selected&&(d3.event.ctrlKey||d3.event.metaKey))e===M&&gt(),vt(e),d3.event.stopPropagation();else{if(e.selected)M&&e.g!==M.id&&gt();else{if(!d3.event.ctrlKey&&!d3.event.metaKey){var o=M;Ce(),o&&e.g===o.id&&(ht(o),M.selected=!0)}M&&(RED.group.contains(M,e)||gt()),ft(e,!0)}if(2!=d3.event.button){e.nodes[0];Ye(t),V.dx=V.x-t[0],V.dy=V.y-t[1]}}Le(),d3.event.stopPropagation()}}function ft(e,t,i){if(e.selected||(e.selected=!0,e.dirty=!0),!1!==i&&he.add(e),t){var o=new Set(he.nodes());RED.group.getNodes(e,!0).forEach((function(e){o.has(e)||he.add(e),e.dirty=!0}))}}function ht(e){M&&gt(),e.active=!0,e.dirty=!0,M=e,he.remove(e)}function gt(){M&&(M.active=!1,M.dirty=!0,vt(M),ft(M,!0),M=null)}function vt(e){e.selected&&(e.selected=!1,e.dirty=!0);var t=new Set(e.nodes);t.add(e);for(var i=he.length()-1;i>=0;i-=1){var o=he.get(i);(t.has(o.n)||o.n===e)&&(o.n.selected=!1,o.n.dirty=!0,he.remove(o.n,i))}}function bt(e,t){for(var i={},o=0;o<G.length;o++){var n=G[o];e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h&&(i[n.id]=n)}var a=Object.keys(i);return a.length>1&&(a.forEach((function(e){i[e]&&i[e].g&&delete i[i[e].g]})),a=Object.keys(i)),0===a.length?null:i[a[a.length-1]]}function mt(e){var t=!0,i=RED.nodes.workspace(RED.workspaces.active());return!i||i.disabled||e.d?t=!1:e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function yt(e){if(X!==RED.state.SELECTING_NODE){var t=RED.workspaces.active(),i=RED.nodes.workspace(t);if(!i||i.disabled||e.d)I?RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabledSubflow")}),"warning"):RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(e._def.button.toggle&&(e[e._def.button.toggle]=!e[e._def.button.toggle],e.dirty=!0),e._def.button.onclick)try{e._def.button.onclick.call(e)}catch(t){console.log("Definition error: "+e.type+".onclick",t)}e.dirty}d3.event&&d3.event.preventDefault()}else d3.event&&d3.event.stopPropagation()}function wt(e,t){var i=q,o=[];o.push({name:"delete",disabled:0===he.length()&&null===F,onselect:function(){Se()}}),o.push({name:"cut",disabled:0===he.length(),onselect:function(){Ie(),Se()}}),o.push({name:"copy",disabled:0===he.length(),onselect:function(){Ie()}}),o.push({name:"paste",disabled:0===ce.length,onselect:function(){_t(ce,{generateIds:!0,touchImport:!0})}}),o.push({name:"edit",disabled:1!=he.length(),onselect:function(){RED.editor.edit(i)}}),o.push({name:"select",onselect:function(){Te()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),o.push({name:"add",onselect:function(){chartPos=a.offset(),Ee([t[0]-chartPos.left+a.scrollLeft(),t[1]-chartPos.top+a.scrollTop()],void 0,void 0,!0)}}),RED.touch.radialMenu.show(e,t,o),Be()}function Et(e,t,i){var o=null;if(0===e.indexOf("font-awesome/")){var n=e.substr(13);if(!(o=RED.nodes.fontAwesome.getIconUnicode(n))){var a=RED.utils.getDefaultNodeIcon(i._def,i);e=RED.settings.apiRootUrl+"icons/"+a.module+"/"+a.file}}if(o)t.append("text").attr("xlink:href",e).attr("class","fa-lg").attr("x",15).text(o);else{var r=t.append("image").style("display","none").attr("xlink:href",e).attr("class","red-ui-flow-node-icon").attr("x",0).attr("width","30").attr("height","30"),s=new Image;s.src=e,s.onload=function(){if(!e.match(/\.svg$/)){var t=Math.max(s.width,s.height),i=1;t>30&&(i=30/t);var o=s.width*i,n=s.height*i;r.attr("width",o),r.attr("height",n),r.attr("x",15-o/2)}r.attr("xlink:href",e),r.style("display",null)}}}function Dt(e){var t=this.__data__;if(t.validationErrors&&t.validationErrors.length>0){clearTimeout(Je);var i=this;Je=setTimeout((function(){var e=Ve(i);Je=null,qe=We(e[0],e[1],RED._("editor.errors.invalidProperties")+"\n  - "+t.validationErrors.join("\n    - "),"top")}),500)}}function Rt(){clearTimeout(Je),qe&&(qe.remove(),qe=null)}function $t(e,t){if(e.z===RED.workspaces.active()&&(t||(t=document.getElementById(e.id)),t)){if(te&&e.status){t.__statusGroup__.style.display="inline";var i=pe[e.status.fill];if(null==e.status.shape&&null==i)t.__statusShape__.style.display="none",t.__statusGroup__.setAttribute("transform","translate(-14,"+(e.h+3)+")");else{t.__statusGroup__.setAttribute("transform","translate(3,"+(e.h+3)+")");var o="red-ui-flow-node-status-"+(e.status.shape||"dot")+"-"+e.status.fill;t.__statusShape__.style.display="inline",t.__statusShape__.setAttribute("class","red-ui-flow-node-status "+o)}e.status.hasOwnProperty("text")?t.__statusLabel__.textContent=e.status.text:t.__statusLabel__.textContent=""}else t.__statusGroup__.style.display="none";delete e.dirtyStatus}}function xt(){}function _t(e,t){var i=(t=t||{addFlow:!1,touchImport:!1,generateIds:!1}).addFlow,o=t.touchImport;if(X!==RED.state.SELECTING_NODE){var n;if("string"==typeof e){if(""===e)return;try{n=JSON.parse(e)}catch(e){var a=new Error(RED._("clipboard.invalidFlow",{message:e.message}));throw a.code="NODE_RED",a}}else n=e;$.isArray(n)||(n=[n]);try{var r;I&&(r=I.changed);var s=RED.nodes.import(n,{generateIds:t.generateIds,addFlow:i,importMap:t.importMap});if(s){var d=s.nodes,l=s.links,c=s.groups,p=s.workspaces,u=s.subflows,f=s.removedNodes,h=s.missingWorkspace;i&&h&&RED.workspaces.show(h.id);var g=d.filter((function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}));g=g.concat(c.filter((function(e){return e.z===RED.workspaces.active()})));var v=d.map((function(e){return e.changed=!0,e.id}));if(Ce(),he.clear(),he.add(g),he.length()>0){null==Q&&(Q=[0,0]);var b=Q[0],m=Q[1];if(he.length()>0){var y=he.get(0).n;b=y.x,m=y.y}var w,E,x=0,_=0,k=he.length();for(w=0;w<k;w++)(E=he.get(w)).n.selected=!0,E.n.changed=!0,E.n.moved=!0,E.n.x-=b-Q[0],E.n.y-=m-Q[1],E.n.w=D,E.n.h=R,E.n.resize=!0,E.dx=E.n.x-Q[0],E.dy=E.n.y-Q[1],"group"===E.n.type?(E.n.groupMoved=!1,x=Math.min(E.n.x-5,x),_=Math.min(E.n.y-5,_)):(x=Math.min(E.n.x-D/2-5,x),_=Math.min(E.n.y-R/2-5,_));for(w=0;w<k;w++)if((E=he.get(w)).n.x-=x,E.n.y-=_,E.dx-=x,E.dy-=_,E.n._def.onadd)try{E.n._def.onadd.call(E.n)}catch(e){console.log("Definition error: "+E.n.type+".onadd:",e)}o||(X=RED.state.IMPORT_DRAGGING,S=!1,1===he.length()&&(E=he.get(0),S=E.n.hasOwnProperty("_def")&&(E.n.hasOwnProperty("inputs")&&E.n.inputs>0||!E.n.hasOwnProperty("inputs")&&E.n._def.inputs>0)&&(E.n.hasOwnProperty("outputs")&&E.n.outputs>0||!E.n.hasOwnProperty("outputs")&&E.n._def.outputs>0))),RED.keyboard.add("*","escape",(function(){RED.keyboard.remove("escape"),Ce(),RED.history.pop(),X=0}))}var T={t:"add",nodes:v,links:l,groups:c,workspaces:p,subflows:u,dirty:RED.nodes.dirty()};if(0===he.length()&&RED.nodes.dirty(!0),I){var C=RED.subflow.refresh(!0);C&&(T.subflow={id:I.id,changed:r,instances:C.instances})}if(f)T={t:"multi",events:[{t:"replace",config:f},T]};RED.history.push(T),be();var j=[],L=0,O=0;d.forEach((function(e){e.hasOwnProperty("x")&&e.hasOwnProperty("y")?L++:O++}));var P=c.length;if(p.length>0&&j.push(RED._("clipboard.flow",{count:p.length})),L>0&&j.push(RED._("clipboard.node",{count:L})),P>0&&j.push(RED._("clipboard.group",{count:P})),O>0&&j.push(RED._("clipboard.configNode",{count:L})),u.length>0&&j.push(RED._("clipboard.subflow",{count:u.length})),f&&f.length>0&&j.push(RED._("clipboard.replacedNodes",{count:f.length})),j.length>0){var N="<ul><li>"+j.join("</li><li>")+"</li></ul>";RED.notify("<p>"+RED._("clipboard.nodesImported")+"</p>"+N,{id:"clipboard"})}}}catch(e){if("import_conflict"===e.code)throw e;"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}}function kt(e){if(X!==RED.state.SELECTING_NODE){if(RED.workspaces.selection().length>0);else if(he.length()>0){for(var t=[],i=0;i<he.length();i++){var o=he.get(i).n;"group"!==o.type&&"subflow"!==o.type&&e!=o.d&&(t.push({t:"edit",node:o,changed:o.changed,changes:{d:o.d}}),e?o.d=!0:delete o.d,o.dirty=!0,o.changed=!0,RED.events.emit("nodes:change",o))}t.length>0&&(RED.history.push({t:"multi",events:t,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}RED.view.redraw()}}function Tt(){var e={},t=new Set;he.length()>0&&he.forEach((function(e){"group"!==e.n.type&&t.add(e.n)}));var i=G.filter((function(e){return e.selected&&!e.active}));return i.length>0&&(1===i.length&&i[0].active||i.forEach((function(e){RED.group.getNodes(e,!0).forEach((function(e){t.delete(e)})),t.add(e)}))),t.size>0&&(e.nodes=Array.from(t)),null!=F&&(e.link=F),e}return{init:function(){a=$("#red-ui-workspace-chart"),r=d3.select("#red-ui-workspace-chart").append("svg:svg").attr("width",m).attr("height",y).attr("pointer-events","all").style("cursor","crosshair").style("touch-action","none").on("mousedown",(function(){})).on("contextmenu",(function(){d3.event.preventDefault()})),(s=r.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","red-ui-workspace-chart-event-layer").on("mousemove",De).on("mousedown",we).on("mouseup",Re).on("mouseenter",(function(){Z?1!==d3.event.buttons&&(Z.remove(),Z=null):X===RED.state.PANNING&&4!==d3.event.buttons&&Be()})).on("touchend",(function(){d3.event.preventDefault(),clearTimeout(C),C=null,RED.touch.radialMenu.active()||Re.call(this)})).on("touchcancel",(function(){RED.view.DEBUG&&console.warn("eventLayer.touchcancel",X),d3.event.preventDefault(),Re.call(this)})).on("touchstart",(function(){var e;if(RED.view.DEBUG&&console.warn("eventLayer.touchstart",X),d3.event.touches.length>1){clearTimeout(C),C=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),i=e.pageY-t.pageY,o=e.pageX-t.pageX,n=a.offset(),r=[a.scrollLeft(),a.scrollTop()];T=[(t.pageX+o/2-n.left+r[0])/E,(t.pageY+i/2-n.top+r[1])/E],[t.pageX+o/2,t.pageY+i/2],k=Math.sqrt(i*i+o*o)}else{var s=d3.select(document.body),d=[(e=d3.event.touches.item(0)).pageX,e.pageY];T=[e.pageX,e.pageY],k=0;d3.touches(this)[0];C=setTimeout((function(){C=null,wt(s,d)}),_)}d3.event.preventDefault()})).on("touchmove",(function(){if(RED.touch.radialMenu.active())d3.event.preventDefault();else{var e;if(RED.view.DEBUG&&console.warn("eventLayer.touchmove",X,q),d3.event.touches.length<2){if(C){var t=(e=d3.event.touches.item(0)).pageX-T[0],i=e.pageY-T[1];Math.abs(t*t+i*i)>64&&(clearTimeout(C),C=null,q||V||(X=RED.state.PANNING,Q=[e.pageX,e.pageY],re=[a.scrollLeft(),a.scrollTop()]))}else Z&&d3.event.preventDefault();De.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),n=e.pageY-o.pageY,r=e.pageX-o.pageX,s=(a.offset(),[a.scrollLeft(),a.scrollTop()]),d=Math.sqrt(n*n+r*r),l=[o.pageX+r/2,o.pageY+n/2];if(!isNaN(d)){oldScaleFactor=E,E=Math.min(2,Math.max(.3,E+Math.floor(100*d-100*k)/1e4));var c=[T[0]*(E-oldScaleFactor),T[1]*(E-oldScaleFactor)];k=d,l,a.scrollLeft(s[0]+c[0]),a.scrollTop(s[1]+c[1])}}d3.event.preventDefault()}}))).append("svg:rect").attr("class","red-ui-workspace-chart-background").attr("width",m).attr("height",y),d=s.append("g").attr("class","red-ui-workspace-chart-grid"),f=s.append("g"),p=s.append("g"),l=s.append("g"),c=s.append("g"),u=s.append("g"),h=[],RED.events.on("workspace:change",(function(e){0!==e.old&&(j[e.old]={left:a.scrollLeft(),top:a.scrollTop()});var t=a.scrollLeft(),i=a.scrollTop();I=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",I),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||I),j[e.workspace]?(a.scrollLeft(j[e.workspace].left),a.scrollTop(j[e.workspace].top)):(a.scrollLeft(0),a.scrollTop(0));var o=a.scrollLeft()-t,n=a.scrollTop()-i;null!=Q&&(Q[0]+=o,Q[1]+=n),0===RED.workspaces.selection().length&&Ce(),RED.nodes.eachNode((function(e){e.dirty=!0,e.dirtyStatus=!0})),Le(),be()})),RED.statusBar.add({id:"view-zoom-controls",align:"right",element:$('<span class="button-group"><button class="red-ui-footer-button" id="red-ui-view-zoom-out"><i class="fa fa-minus"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-zero"><i class="fa fa-circle-o"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-in"><i class="fa fa-plus"></i></button></span>')}),$("#red-ui-view-zoom-out").on("click",xe),RED.popover.tooltip($("#red-ui-view-zoom-out"),RED._("actions.zoom-out"),"core:zoom-out"),$("#red-ui-view-zoom-zero").on("click",_e),RED.popover.tooltip($("#red-ui-view-zoom-zero"),RED._("actions.zoom-reset"),"core:zoom-reset"),$("#red-ui-view-zoom-in").on("click",$e),RED.popover.tooltip($("#red-ui-view-zoom-in"),RED._("actions.zoom-in"),"core:zoom-in"),a.on("DOMMouseScroll mousewheel",(function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?xe():$e())})),a.droppable({accept:".red-ui-palette-node",drop:function(e,t){d3.event=e;var i=ye($(t.draggable[0]).attr("data-palette-type"));if(i){var o=i.historyEvent,n=i.node,a=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");void 0===a||/^link (in|out)$/.test(n._def.type)||n._def.defaults.hasOwnProperty("l")||(n.l=a);var r=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),s=d3.touches(this)[0]||d3.mouse(this);s[1]+=this.scrollTop+(n.h/2-r[1]),s[0]+=this.scrollLeft+(n.w/2-r[0]),s[1]/=E,s[0]/=E,O&&(s[0]=L*Math.ceil(s[0]/L),s[1]=L*Math.ceil(s[1]/L)),n.x=s[0],n.y=s[1];var d=$(t.helper).data("splice");if(d){RED.nodes.removeLink(d);var l={source:d.source,sourcePort:d.sourcePort,target:n},c={source:n,sourcePort:0,target:d.target};RED.nodes.addLink(l),RED.nodes.addLink(c),o.links=[l,c],o.removedLinks=[d]}RED.nodes.add(n);var p=$(t.helper).data("group");p&&(RED.group.addToGroup(p,n),(o={t:"multi",events:[o]}).events.push({t:"addToGroup",group:p,nodes:n})),RED.history.push(o),RED.editor.validateNode(n),RED.nodes.dirty(!0),gt(),Ce(),n.selected=!0,he.add(n),p&&(ft(p,!1),ht(p),M=p),be(),Le(),n._def.autoedit&&RED.editor.edit(n)}}}),a.on("focus",(function(){$("#red-ui-workspace-tabs").addClass("red-ui-workspace-focussed")})),a.on("blur",(function(){$("#red-ui-workspace-tabs").removeClass("red-ui-workspace-focussed")})),RED.actions.add("core:copy-selection-to-internal-clipboard",Ie),RED.actions.add("core:cut-selection-to-internal-clipboard",(function(){Ie(),Se()})),RED.actions.add("core:paste-from-internal-clipboard",(function(){_t(ce,{generateIds:!0})})),RED.actions.add("core:delete-selection",Se),RED.actions.add("core:edit-selected-node",Oe),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:redo",RED.history.redo),RED.actions.add("core:select-all-nodes",Te),RED.actions.add("core:zoom-in",$e),RED.actions.add("core:zoom-out",xe),RED.actions.add("core:zoom-reset",_e),RED.actions.add("core:enable-selected-nodes",(function(){kt(!1)})),RED.actions.add("core:disable-selected-nodes",(function(){kt(!0)})),RED.actions.add("core:toggle-show-grid",(function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):function(e){e?d.style("visibility","visible"):d.style("visibility","hidden")}(e)})),RED.actions.add("core:toggle-snap-grid",(function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):function(e){O=e}(e)})),RED.actions.add("core:toggle-status",(function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(te=e,RED.nodes.eachNode((function(e){e.dirtyStatus=!0,e.dirty=!0})))})),RED.view.navigator.init(),RED.view.tools.init()},state:function(e){if(null==e)return X;X=e},updateActive:be,redraw:function(e,t){e&&(be(),Le()),t&&function(){if(s.attr("transform","scale("+E+")"),r.attr("width",m*E).attr("height",y*E),-1!==de||X!=RED.state.JOINING){var e={};if(I){var t=u.selectAll(".red-ui-flow-subflow-port-output").data(I.out,(function(e,t){return e.id}));t.exit().remove();var i=t.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-output").attr("transform",(function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"}));i.each((function(e,t){e.w=40,e.h=40})),i.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Qe).on("mousedown",Xe).on("touchstart",Ze).on("touchend",et),i.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(function(e,t){Ue(e,ue,0)})).on("touchstart",(function(e,t){Ue(e,ue,0),d3.event.preventDefault()})).on("mouseup",(function(e,t){Fe(e,ue,0)})).on("touchend",(function(e,t){Fe(e,ue,0),d3.event.preventDefault()})).on("mouseover",(function(e){Ke(d3.select(this),e,ue,0)})).on("mouseout",(function(e){He(d3.select(this))})),i.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",20).attr("y",12).style("font-size","10px").text("output"),i.append("svg:text").attr("class","red-ui-flow-port-label red-ui-flow-port-index").attr("x",20).attr("y",28).text((function(e,t){return t+1}));var o=u.selectAll(".red-ui-flow-subflow-port-input").data(I.in,(function(e,t){return e.id}));o.exit().remove();var n=o.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-input").attr("transform",(function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"}));n.each((function(e,t){e.w=40,e.h=40})),n.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Qe).on("mousedown",Xe).on("touchstart",Ze).on("touchend",et),n.append("g").attr("transform","translate(35,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(function(e,t){Ue(e,fe,t)})).on("touchstart",(function(e,t){Ue(e,fe,t),d3.event.preventDefault()})).on("mouseup",(function(e,t){Fe(e,fe,t)})).on("touchend",(function(e,t){Fe(e,fe,t),d3.event.preventDefault()})).on("mouseover",(function(e){Ke(d3.select(this),e,fe,0)})).on("mouseout",(function(e){He(d3.select(this))})),n.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",18).attr("y",20).style("font-size","10px").text("input");var a=u.selectAll(".red-ui-flow-subflow-port-status").data(I.status?[I.status]:[],(function(e,t){return e.id}));a.exit().remove();var d=a.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-status").attr("transform",(function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"}));d.each((function(e,t){e.w=40,e.h=40})),d.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Qe).on("mousedown",Xe).on("touchstart",Ze).on("touchend",et),d.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(function(e,t){Ue(e,ue,0)})).on("touchstart",(function(e,t){Ue(e,ue,0),d3.event.preventDefault()})).on("mouseup",(function(e,t){Fe(e,ue,0)})).on("touchend",(function(e,t){Fe(e,ue,0),d3.event.preventDefault()})).on("mouseover",(function(e){Ke(d3.select(this),e,ue,0)})).on("mouseout",(function(e){He(d3.select(this))})),d.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",22).attr("y",20).style("font-size","10px").text("status"),t.each((function(t,i){if(t.dirty){var o=d3.select(this);o.classed("red-ui-flow-node-selected",(function(e){return e.selected})),o.selectAll(".red-ui-flow-port-index").text((function(e){return e.i+1})),o.attr("transform",(function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"})),e[t.id]=t,t.dirty=!1}})),o.each((function(t,i){if(t.dirty){var o=d3.select(this);o.classed("red-ui-flow-node-selected",(function(e){return e.selected})),o.attr("transform",(function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"})),e[t.id]=t,t.dirty=!1}})),a.each((function(t,i){if(t.dirty){var o=d3.select(this);o.classed("red-ui-flow-node-selected",(function(e){return e.selected})),o.selectAll(".red-ui-flow-port-index").text((function(e){return e.i+1})),o.attr("transform",(function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"})),e[t.id]=t,t.dirty=!1}}))}else u.selectAll(".red-ui-flow-subflow-port-output").remove(),u.selectAll(".red-ui-flow-subflow-port-input").remove(),u.selectAll(".red-ui-flow-subflow-port-status").remove();var c=u.selectAll(".red-ui-flow-node-group").data(P,(function(e){return e.id}));c.exit().remove(),c.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-node-group").classed("red-ui-flow-subflow",null!=I).each((function(e,t){this.__outputs__=[],this.__inputs__=[];var i=d3.select(this),o=document.createDocumentFragment(),n="link in"===e.type||"link out"===e.type,a=e.hasOwnProperty("l")?!e.l:n;if(i.attr("id",e.id),e.h=R,e.resize=!0,e._def.button){var r=document.createElementNS("http://www.w3.org/2000/svg","g");r.__data__=e,r.setAttribute("transform","translate("+("right"==e._def.align?94:-25)+",2)"),r.setAttribute("class","red-ui-flow-node-button"),i[0][0].__buttonGroup__=r;var s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.__data__=e,s.setAttribute("class","red-ui-flow-node-button-background"),s.setAttribute("rx",5),s.setAttribute("ry",5),s.setAttribute("width",32),s.setAttribute("height",R-4),r.appendChild(s),i[0][0].__buttonGroupBackground__=s;var d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.__data__=e,d.setAttribute("class","red-ui-flow-node-button-button"),d.setAttribute("x","right"==e._def.align?11:5),d.setAttribute("y",4),d.setAttribute("rx",4),d.setAttribute("ry",4),d.setAttribute("width",16),d.setAttribute("height",R-12),d.setAttribute("fill",RED.utils.getNodeColor(e.type,e._def)),d3.select(d).on("mousedown",(function(e){!Z&&mt(e)&&(d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())})).on("mouseup",(function(e){!Z&&mt(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())})).on("mouseover",(function(e){!Z&&mt(e)&&d3.select(this).attr("fill-opacity",.4)})).on("mouseout",(function(e){if(!Z&&mt(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}})).on("click",yt).on("touchstart",(function(e){yt.call(this,e),d3.event.preventDefault()})),r.appendChild(d),i[0][0].__buttonGroupButton__=d,o.appendChild(r)}var l=document.createElementNS("http://www.w3.org/2000/svg","rect");if(l.__data__=e,l.setAttribute("class","red-ui-flow-node "+("unknown"==e.type?"red-ui-flow-node-unknown":"")),l.setAttribute("rx",5),l.setAttribute("ry",5),l.setAttribute("fill",RED.utils.getNodeColor(e.type,e._def)),i[0][0].__mainRect__=l,d3.select(l).on("mouseup",Qe).on("mousedown",Xe).on("touchstart",Ze).on("touchend",et).on("mouseover",tt).on("mouseout",it),o.appendChild(l),e._def.icon){var c=RED.utils.getNodeIcon(e._def,e),p=document.createElementNS("http://www.w3.org/2000/svg","g");p.__data__=e,p.setAttribute("class","red-ui-flow-node-icon-group"+("right"==e._def.align?" red-ui-flow-node-icon-group-right":"")),p.setAttribute("x",0),p.setAttribute("y",0),p.style["pointer-events"]="none",i[0][0].__iconGroup__=p;var u=document.createElementNS("http://www.w3.org/2000/svg","rect");u.setAttribute("x",0),u.setAttribute("y",0),u.setAttribute("class","red-ui-flow-node-icon-shade"),u.setAttribute("width",30),u.setAttribute("height",Math.min(50,e.h-4)),p.appendChild(u),i[0][0].__iconShade__=u,Et(c,d3.select(p),e);var f=document.createElementNS("http://www.w3.org/2000/svg","path");f.setAttribute("d","right"!=e._def.align?"M 30 1 l 0 "+(e.h-2):"M 0 1 l 0 "+(e.h-2)),f.setAttribute("class","red-ui-flow-node-icon-shade-border"),p.appendChild(f),i[0][0].__iconShadeBorder__=f,o.appendChild(p)}var h=document.createElementNS("http://www.w3.org/2000/svg","g");h.setAttribute("class","red-ui-flow-node-label"+(a?" hide":"")+(e._def.align?" red-ui-flow-node-label-"+e._def.align:"")),h.setAttribute("transform","translate(38,0)"),o.appendChild(h),i[0][0].__textGroup__=h;var g=document.createElementNS("http://www.w3.org/2000/svg","g");g.setAttribute("class","red-ui-flow-node-status-group"),g.style.display="none",i[0][0].__statusGroup__=g;var v=document.createElementNS("http://www.w3.org/2000/svg","rect");v.setAttribute("class","red-ui-flow-node-status"),v.setAttribute("x",6),v.setAttribute("y",1),v.setAttribute("width",9),v.setAttribute("height",9),v.setAttribute("rx",2),v.setAttribute("ry",2),v.setAttribute("stroke-width","3"),g.appendChild(v),i[0][0].__statusShape__=v;var b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("class","red-ui-flow-node-status-label"),b.setAttribute("x",20),b.setAttribute("y",10),g.appendChild(b),i[0][0].__statusLabel__=b,o.appendChild(g);var m=document.createElementNS("http://www.w3.org/2000/svg","g");m.setAttribute("class","red-ui-flow-node-changed hide"),m.setAttribute("transform","translate(20, -2)"),i[0][0].__changeBadge__=m;var y=document.createElementNS("http://www.w3.org/2000/svg","circle");y.setAttribute("r",5),m.appendChild(y),o.appendChild(m);var w=document.createElementNS("http://www.w3.org/2000/svg","g");w.setAttribute("class","red-ui-flow-node-error hide"),w.setAttribute("transform","translate(0, -2)"),i[0][0].__errorBadge__=w;var E=document.createElementNS("http://www.w3.org/2000/svg","path");E.setAttribute("d","M -5,4 l 10,0 -5,-8 z"),w.appendChild(E),E.__data__=e,E.addEventListener("mouseenter",Dt),E.addEventListener("mouseleave",Rt),o.appendChild(w),i[0][0].appendChild(o)})),c.each((function(t,i){if(t.dirty){var o=d3.select(this),n="link in"===t.type||"link out"===t.type,a=t.hasOwnProperty("l")?!t.l:n;e[t.id]=t;var r,s=RED.utils.getNodeLabel(t,t.type);if((t.resize||this.__hideLabel__!==a||this.__label__!==s||this.__outputs__.length!==t.outputs)&&(r=Pe(s,"red-ui-flow-node-label"),this.__label__=s,r.lines.length!==this.__labelLineCount__&&(t.resize=!0),this.__labelLineCount__=r.lines.length,t.h=a?Math.max(R,15*(t.outputs||0)):Math.max(6+24*r.lines.length,15*(t.outputs||0),30),this.__hideLabel__=a),t.resize){var d=t.w;t.w=a?R:Math.max(D,20*Math.ceil((r.width+50+(t._def.inputs>0?7:0))/20)),void 0!==d&&(t.x+=(t.w-d)/2),t.resize=!1}if(t._colorChanged){var l=RED.utils.getNodeColor(t.type,t._def);this.__mainRect__.setAttribute("fill",l),this.__buttonGroupButton__&&this.__buttonGroupButton__.settAttribute("fill",l),delete t._colorChanged}if(this.setAttribute("transform","translate("+(t.x-t.w/2)+","+(t.y-t.h/2)+")"),this.classList.toggle("red-ui-flow-node-selected",!!t.selected),X!=RED.state.MOVING_ACTIVE){if(this.classList.toggle("red-ui-flow-node-disabled",!0===t.d),this.__mainRect__.setAttribute("width",t.w),this.__mainRect__.setAttribute("height",t.h),this.__mainRect__.classList.toggle("red-ui-flow-node-highlighted",!!t.highlighted),r){for(var c=r.lines,p=r.lines.length,u=this.__textGroup__.childNodes;u.length>p;)u[u.length-1].remove();for(i=0;i<p;i++){if(i===u.length){var f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("class","red-ui-flow-node-label-text"),f.setAttribute("x",0),f.setAttribute("y",24*i),this.__textGroup__.appendChild(f)}u[i].textContent=c[i]}}var h="";if(t._def.labelStyle){h=t._def.labelStyle;try{h=("function"==typeof h?h.call(t):h)||""}catch(e){console.log("Definition error: "+t.type+".labelStyle",e),h=""}h=" "+h}h="red-ui-flow-node-label"+(t._def.align?" red-ui-flow-node-label-"+t._def.align:"")+h+(a?" hide":""),this.__textGroup__.setAttribute("class",h);var g=t.h/2-this.__labelLineCount__/2*24+13;!t._def.align&&0!==t.inputs&&0===t.outputs||"right"===t._def.align?(this.__iconGroup__&&(this.__iconGroup__.classList.add("red-ui-flow-node-icon-group-right"),this.__iconGroup__.setAttribute("transform","translate("+(t.w-30)+",0)")),this.__textGroup__.classList.add("red-ui-flow-node-label-right"),this.__textGroup__.setAttribute("transform","translate("+(t.w-38)+","+g+")")):(this.__iconGroup__&&(this.__iconGroup__.classList.remove("red-ui-flow-node-icon-group-right"),this.__iconGroup__.setAttribute("transform","")),this.__textGroup__.classList.remove("red-ui-flow-node-label-right"),this.__textGroup__.setAttribute("transform","translate(38,"+g+")"));var v=o.selectAll(".red-ui-flow-port-input");if(n&&(-1!==de||z[t.id])||0!==t.inputs||v.empty()){if((n&&(de===ue||z[t.id])||1===t.inputs)&&v.empty()){var b=o.append("g").attr("class","red-ui-flow-port-input");("link in"===t.type?b.append("circle").attr("cx",-1).attr("cy",5).attr("r",5).attr("class","red-ui-flow-port red-ui-flow-link-port"):b.append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10)).on("mousedown",(function(e){Ue(e,ue,0)})).on("touchstart",(function(e){Ue(e,ue,0),d3.event.preventDefault()})).on("mouseup",(function(e){Fe(e,ue,0)})).on("touchend",(function(e){Fe(e,ue,0),d3.event.preventDefault()})).on("mouseover",(function(e){Ke(d3.select(this),e,ue,0)})).on("mouseout",(function(e){He(d3.select(this))}))}}else v.remove();var m=t.outputs;n&&"link out"===t.type&&(m=de===fe||z[t.id]?1:0);for(var y=t.h/2-(m-1)/2*13;this.__outputs__.length>m;)this.__outputs__.pop().remove();for(var w=0;w<m;w++){var E,$;w===this.__outputs__.length?((E=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("class","red-ui-flow-port-output"),"link out"===t.type?(($=document.createElementNS("http://www.w3.org/2000/svg","circle")).setAttribute("cx",11),$.setAttribute("cy",5),$.setAttribute("r",5),$.setAttribute("class","red-ui-flow-port red-ui-flow-link-port")):(($=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("rx",3),$.setAttribute("ry",3),$.setAttribute("width",10),$.setAttribute("height",10),$.setAttribute("class","red-ui-flow-port")),E.appendChild($),$.__data__=this.__data__,$.__portType__=fe,$.__portIndex__=w,$.addEventListener("mousedown",ot),$.addEventListener("touchstart",nt),$.addEventListener("mouseup",at),$.addEventListener("touchend",rt),$.addEventListener("mouseover",st),$.addEventListener("mouseout",dt),this.appendChild(E),this.__outputs__.push(E)):E=this.__outputs__[w];var x=t.w-5;y=t.h/2-(m-1)/2*13,E.setAttribute("transform","translate("+x+","+(y+13*w-5)+")")}if(t._def.icon){var _,k=o.select(".red-ui-flow-node-icon"),T=o.select(".fa-lg");_=k.empty()?T.attr("xlink:href"):k.attr("xlink:href");var C=RED.utils.getNodeIcon(t._def,t);C!==_&&(k.empty()?T.remove():k.remove(),Et(C,o.select(".red-ui-flow-node-icon-group"),t),k=o.select(".red-ui-flow-node-icon"),T=o.select(".fa-lg")),k.attr("y",(function(){return(t.h-d3.select(this).attr("height"))/2})),this.__iconShade__.setAttribute("height",t.h),this.__iconShadeBorder__.setAttribute("d","M "+(!t._def.align&&0!==t.inputs&&0===t.outputs||"right"===t._def.align?0:30)+" 1 l 0 "+(t.h-2)),T.attr("y",(t.h+13)/2)}if(this.__changeBadge__.setAttribute("transform","translate("+(t.w-10)+", -2)"),this.__changeBadge__.classList.toggle("hide",!(t.changed||t.moved)),this.__errorBadge__.setAttribute("transform","translate("+(t.w-10-(t.changed||t.moved?14:0))+", -2)"),this.__errorBadge__.classList.toggle("hide",t.valid),o.selectAll(".red-ui-flow-port-input").each((function(e,t){d3.select(this).attr("transform",(function(e){return"translate(-5,"+(e.h/2-5)+")"}))})),t._def.button){var j=mt(t);this.__buttonGroup__.classList.toggle("red-ui-flow-node-button-disabled",!j),x="right"==t._def.align?t.w-6:-25,t._def.button.toggle&&!t[t._def.button.toggle]&&(x-="right"==t._def.align?8:-8),this.__buttonGroup__.setAttribute("transform","translate("+x+",2)"),t._def.button.toggle&&(this.__buttonGroupButton__.setAttribute("fill-opacity",t[t._def.button.toggle]?1:.2),this.__buttonGroupBackground__.setAttribute("fill-opacity",t[t._def.button.toggle]?1:.2)),"function"==typeof t._def.button.visible&&(!1===t._def.button.visible.call(t)?this.__buttonGroup__.style.display="none":this.__buttonGroup__.style.display="inherit")}}if(t.dirtyStatus&&$t(t,this),t.dirty=!1,t.g&&!U[t.g])for(var L=t.g;L&&!U[L];)U[L]=RED.nodes.group(L),L=U[L].g}}));var h=l.selectAll(".red-ui-flow-link").data(N,(function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}));h.enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link").each((function(e,t){var i=d3.select(this),o=document.createDocumentFragment();e.added=!0;var n=document.createElementNS("http://www.w3.org/2000/svg","path");n.__data__=e,n.setAttribute("class","red-ui-flow-link-background red-ui-flow-link-path"+(e.link?" red-ui-flow-link-link":"")),this.__pathBack__=n,o.appendChild(n),d3.select(n).on("mousedown",lt).on("touchstart",ct);var a=document.createElementNS("http://www.w3.org/2000/svg","path");a.__data__=e,a.setAttribute("class","red-ui-flow-link-outline red-ui-flow-link-path"),this.__pathOutline__=a,o.appendChild(a);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.__data__=e,r.setAttribute("class","red-ui-flow-link-line red-ui-flow-link-path"+(e.link?" red-ui-flow-link-link":I?" red-ui-flow-subflow-link":"")),this.__pathLine__=r,o.appendChild(r),i[0][0].appendChild(o)})),h.exit().remove(),h.each((function(t){if(d3.select(this),t.added||t===F||t.selected||e[t.source.id]||e[t.target.id]){var i=-((t.source.outputs||1)-1)/2*13+13*(t.sourcePort||0);t.x1=t.source.x+t.source.w/2,t.y1=t.source.y+i,t.x2=t.target.x-t.target.w/2,t.y2=t.target.y;var o=me(t.x1,t.y1,t.x2,t.y2,1);/NaN/.test(o)&&(o=""),this.__pathBack__.setAttribute("d",o),this.__pathOutline__.setAttribute("d",o),this.__pathLine__.setAttribute("d",o),this.__pathLine__.classList.toggle("red-ui-flow-node-disabled",!(!t.source.d&&!t.target.d)),this.__pathLine__.classList.toggle("red-ui-flow-subflow-link",!t.link&&I)}this.classList.toggle("red-ui-flow-link-selected",!(t!==F&&!t.selected)),"unknown"!=t.target.type&&t.source.type,this.classList.toggle("red-ui-flow-link-unknown",!("unknown"!=t.target.type&&"unknown"!=t.source.type)),delete t.added}));var g=l.selectAll(".red-ui-flow-link-off-flow").data(A,(function(e){return e.node.id+":"+e.refresh}));g.enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link-off-flow").each((function(e,t){var i=d3.select(this),o=1,n="start";"link in"===e.node.type&&(o=-1,n="end");var a=30*o,r=20*o,s=(i.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M 0 0 h "+a),e.links),d=Object.keys(s),l=RED.nodes.getWorkspaceOrder();d.sort((function(e,t){return l.indexOf(e)-l.indexOf(t)}));var c=10,p=R,u=-(d.length-1)*p/2,f=i.selectAll(".red-ui-flow-link-group").data(d);f.enter().append("g").attr("class","red-ui-flow-link-group").on("mouseover",(function(){0===X&&d3.select(this).classed("red-ui-flow-link-group-active",!0)})).on("mouseout",(function(){0===X&&d3.select(this).classed("red-ui-flow-link-group-active",!1)})).on("mousedown",(function(){d3.event.preventDefault(),d3.event.stopPropagation()})).on("mouseup",(function(t){if(0===X){d3.event.stopPropagation();var i=e.links[t];RED.workspaces.show(t),i.forEach((function(e){e.selected=!0,e.dirty=!0,he.add(e)})),Le()}})).each((function(e){var t=d3.select(this);t.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M "+a+" 0 C "+(a+1.7*r)+" 0 "+(a+.1*r)+" "+u+" "+(a+1.5*r)+" "+u+" "),t.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(a+1.5*r+17*o)+" "+(u-12)+" h "+-o*c+" a 3 3 45 0 "+(1===o?"0":"1")+" "+-3*o+" 3 v 18 a 3 3 45 0 "+(1===o?"0":"1")+" "+3*o+" 3 h "+o*c),t.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(a+1.5*r+20*o)+" "+(u-12)+" h "+30*o+" M "+(a+1.5*r+20*o)+" "+(u+12)+" h "+30*o).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","red-ui-flow-port red-ui-flow-link-port").attr("x",a+1.5*r-4+4*o).attr("y",u-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",a+1.5*r-(-1===o?D:0)).attr("y",u-12).attr("width",D).attr("height",24).style("stroke","none").style("fill","transparent");var i,s=RED.nodes.workspace(e);s&&(i=s.label||s.id),t.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",a+1.5*r+15*o).attr("y",u+1).style("font-size","10px").style("text-anchor",n).text(i),u+=p})),f.exit().remove()})),g.exit().remove(),(g=l.selectAll(".red-ui-flow-link-off-flow")).each((function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",(function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"}))}));var v=f.selectAll(".red-ui-flow-group").data(G,(function(e){return e.id}));v.exit().each((function(e,t){document.getElementById("group_select_"+e.id).remove()})).remove();var b=v.enter().insert("svg:g").attr("class","red-ui-flow-group"),w=!1;b.each((function(e,t){w=!0;var i=d3.select(this);i.attr("id",e.id);var o=p.append("g").attr("class","red-ui-flow-group").attr("id","group_select_"+e.id);o.append("rect").classed("red-ui-flow-group-outline-select",!0).classed("red-ui-flow-group-outline-select-background",!0).attr("rx",4).attr("ry",4).attr("x",-4).attr("y",-4),o.append("rect").classed("red-ui-flow-group-outline-select",!0).attr("rx",4).attr("ry",4).attr("x",-4).attr("y",-4),o.on("mousedown",(function(){ut.call(i[0][0],e)})),o.on("mouseup",(function(){pt.call(i[0][0],e)})),o.on("touchstart",(function(){ut.call(i[0][0],e),d3.event.preventDefault()})),o.on("touchend",(function(){pt.call(i[0][0],e),d3.event.preventDefault()})),i.append("rect").classed("red-ui-flow-group-outline",!0).attr("rx",.5).attr("ry",.5),i.append("rect").classed("red-ui-flow-group-body",!0).attr("rx",4).attr("ry",4).style({fill:e.fill||"none",stroke:e.stroke||"none"}),i.on("mousedown",ut).on("mouseup",pt),i.on("touchstart",(function(){ut.call(i[0][0],e),d3.event.preventDefault()})),i.on("touchend",(function(){pt.call(i[0][0],e),d3.event.preventDefault()})),i.append("svg:text").attr("class","red-ui-flow-group-label"),e.dirty=!0})),w&&v.sort((function(e,t){return e._root===t._root?e._depth-t._depth:e._root.localeCompare(t._root)})),v[0].reverse(),v.each((function(e,t){if(e.resize&&(e.minWidth=0,delete e.resize),e.dirty||U[e.id]){var i=d3.select(this),o=!1;if(e.nodes.length>0)if(e.groupMoved)delete e.groupMoved;else{var n=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,r=0,s=0,d=26;e.nodes.forEach((function(e){"group"!==e.type?(n=Math.min(n,e.x-e.w/2-d-(e._def.button&&"right"!==e._def.align?20:0)),a=Math.min(a,e.y-e.h/2-d),r=Math.max(r,e.x+e.w/2+d+(e._def.button&&"right"==e._def.align?20:0)),s=Math.max(s,e.y+e.h/2+d)):(n=Math.min(n,e.x-d),a=Math.min(a,e.y-d),r=Math.max(r,e.x+e.w+d),s=Math.max(s,e.y+e.h+d))})),e.x=n,e.y=a,e.w=r-n,e.h=s-a,o=!0,!1===e.groupMoved&&delete e.groupMoved}else e.w=40,e.h=40,o=!0;if(o){if(!e.minWidth)if(e.style.label&&e.name){var l=Pe(e.name||"","red-ui-flow-group-label");e.minWidth=l.width+8,e.labels=l.lines}else e.minWidth=40,e.labels=[];if(e.w=Math.max(e.minWidth,e.w),e.style.label&&e.labels.length>0){var c=e.style["label-position"]||"nw",p=16*(e.labels.length-1);"s"===c[0]&&(p+=8),e.h+=p,"n"===c[0]&&e.nodes.length>0&&(e.y-=p)}}i.attr("transform","translate("+e.x+","+e.y+")"),i.selectAll(".red-ui-flow-group-outline").attr("width",e.w).attr("height",e.h);var u=document.getElementById("group_select_"+e.id);u.setAttribute("transform","translate("+e.x+","+e.y+")"),e.hovered?u.classList.add("red-ui-flow-group-hovered"):u.classList.remove("red-ui-flow-group-hovered");var f=u.children[0];f.setAttribute("width",e.w+8),f.setAttribute("height",e.h+8),f.style.strokeOpacity=e.active||e.selected||e.highlighted?.8:0,f.style.strokeDasharray=e.active?"10 4":"",(f=u.children[1]).setAttribute("width",e.w+8),f.setAttribute("height",e.h+8),f.style.strokeOpacity=e.active||e.selected||e.highlighted?.8:0,f.style.strokeDasharray=e.active?"10 4":"",e.highlighted?u.classList.add("red-ui-flow-node-highlighted"):u.classList.remove("red-ui-flow-node-highlighted"),i.selectAll(".red-ui-flow-group-body").attr("width",e.w).attr("height",e.h).style("stroke",e.style.stroke||"").style("stroke-opacity",e.style.hasOwnProperty("stroke-opacity")?e.style["stroke-opacity"]:"").style("fill",e.style.fill||"").style("fill-opacity",e.style.hasOwnProperty("fill-opacity")?e.style["fill-opacity"]:"");var h=i.selectAll(".red-ui-flow-group-label");if(h.classed("hide",!e.style.label),e.style.label){var g=0,v=0;if(v="n"===(c=e.style["label-position"]||"nw")[0]?15:e.h-5-16*(e.labels.length-1),"w"===c[1]?(g=5,labelAnchor="start"):"e"===c[1]?(g=e.w-5,labelAnchor="end"):(g=e.w/2,labelAnchor="middle"),e.style.hasOwnProperty("color")?h.style("fill",e.style.color):h.style("fill",null),h.attr("transform","translate("+g+","+v+")").attr("text-anchor",labelAnchor),e.labels){var b=0;i.selectAll(".red-ui-flow-group-label-text").remove(),e.labels.forEach((function(e){h.append("tspan").classed("red-ui-flow-group-label-text",!0).text(e).attr("x",0).attr("y",b),b+=16}))}else i.selectAll(".red-ui-flow-group-label-text").remove()}delete U[e.id],delete e.dirty}}))}else l.selectAll(".red-ui-flow-link-selected").data(N,(function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i})).classed("red-ui-flow-link-selected",!1);RED.view.navigator.refresh(),d3.event&&d3.event.preventDefault()}()},focus:xt,importNodes:_t,calculateTextWidth:function(e,t){for(var i=Me(e),o=0,n=0;n<i.length;n++){var a=ze(i[n],t)[0];o<a&&(o=a)}return o},select:function(e){if(void 0!==e)if(Ce(),"string"==typeof e){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,he.clear(),he.add(t))}else e&&e.nodes&&(be(),he.clear(),e.nodes.forEach((function(e){"group"!==e.type?(e.selected=!0,e.dirty=!0,he.add(e)):ft(e,!0)})));Le()},selection:Tt,scale:function(){return E},getLinksAtPoint:function(e,t){for(var i=[],o=r.selectAll(".red-ui-flow-link-background")[0],n=0;n<o.length;n++){var a=o[n].getBBox();e>=a.x&&t>=a.y&&e<=a.x+a.width&&t<=a.y+a.height&&i.push(o[n])}return i},getGroupAtPoint:bt,getActiveGroup:function(){return M},reveal:function(e,t){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var i=RED.nodes.node(e)||RED.nodes.group(e);if(i)if(!i.z||"group"!==i.type&&"config"===i._def.category)"config"===i._def.category&&RED.sidebar.config.show(e);else{i.dirty=!0,RED.workspaces.show(i.z);var o=[a.width()/E,a.height()/E],n=[a.scrollLeft()/E,a.scrollTop()/E],r=i.x,s=i.y;if("group"===i.type&&(r+=i.w/2,s+=i.h/2),r<n[0]||s<n[1]||r>o[0]+n[0]||s>o[1]+n[1]){var d="-="+(n[0]-r+o[0]/2)*E,l="-="+(n[1]-s+o[1]/2)*E;a.animate({scrollLeft:d,scrollTop:l},200)}if(!1!==t&&(i.highlighted=!0,!i._flashing)){i._flashing=!0;var c=22,p=function(){c--,i.dirty=!0,c>=0?(i.highlighted=!i.highlighted,setTimeout(p,100)):(i.highlighted=!1,delete i._flashing),RED.view.redraw()};p()}}}},gridSize:function(e){if(void 0===e)return L;L=Math.max(5,e)},getActiveNodes:function(){return P},selectNodes:function(e){$("#red-ui-workspace-tabs-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-header-shade").show(),$("#red-ui-workspace").addClass("red-ui-workspace-select-mode"),X=RED.state.SELECTING_NODE,Ce(),e.selected&&e.selected.forEach((function(e){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,he.add(t))}));var t=function(){Ce(),$("#red-ui-workspace-tabs-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-workspace").removeClass("red-ui-workspace-select-mode"),Be(),o.close()};(n=e||{}).done=function(e){t(),n.onselect&&n.onselect(e)};var i=[{text:RED._("common.label.cancel"),click:function(e){t(),n.oncancel&&n.oncancel()}}];n.single||i.push({text:RED._("common.label.done"),class:"primary",click:function(e){var t=he.nodes();n.done(t)}});var o=RED.notify(n.prompt||RED._("workspace.selectNodes"),{modal:!1,fixed:!0,type:"compact",buttons:i})},scroll:function(e,t){a.scrollLeft(a.scrollLeft()+e),a.scrollTop(a.scrollTop()+t)},clickNodeButton:function(e){e._def.button&&yt(e)},clipboard:function(){return ce},redrawStatus:$t}}(),RED.view.navigator=function(){var e,t,i,o,n,a,r,s,d,l=25,c=5e3/l,p=5e3/l,u=!1;function f(){if(u){var e=o.selectAll(".red-ui-navigator-node").data(RED.view.getActiveNodes(),(function(e){return e.id}));e.exit().remove(),e.enter().insert("rect").attr("class","red-ui-navigator-node").attr("pointer-events","none"),e.each((function(e){d3.select(this).attr("x",(function(e){return(e.x-e.w/2)/l})).attr("y",(function(e){return(e.y-e.h/2)/l})).attr("width",(function(e){return Math.max(9,e.w/l)})).attr("height",(function(e){return Math.max(3,e.h/l)})).attr("fill",(function(e){return RED.utils.getNodeColor(e.type,e._def)}))}))}}function h(){d||g()}function g(){i&&(a=RED.view.scale(),r=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],n=[$("#red-ui-workspace-chart").scrollLeft(),$("#red-ui-workspace-chart").scrollTop()],i.attr("x",n[0]/l).attr("y",n[1]/l).attr("width",r[0]/l/a).attr("height",r[1]/l/a))}function v(){u?(u=!1,e.fadeOut(100),$("#red-ui-workspace-chart").off("scroll",h),$("#red-ui-view-navigate").removeClass("selected")):(u=!0,$("#red-ui-view-navigate").addClass("selected"),g(),f(),$("#red-ui-workspace-chart").on("scroll",h),e.fadeIn(200))}return{init:function(){$(window).on("resize",g),RED.events.on("sidebar:resize",g),RED.actions.add("core:toggle-navigator",v),e=$("<div>").css({position:"absolute",bottom:$("#red-ui-workspace-footer").height(),right:0,zIndex:1}).appendTo("#red-ui-workspace").hide(),(t=d3.select(e[0]).append("svg:svg").attr("width",c).attr("height",p).attr("pointer-events","all").attr("id","red-ui-navigator-canvas")).append("rect").attr("x",0).attr("y",0).attr("width",c).attr("height",p).style({fill:"none",stroke:"none",pointerEvents:"all"}).on("mousedown",(function(){a=RED.view.scale(),r=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],s=[r[0]/l/a,r[1]/l/a];var e=Math.max(0,Math.min(d3.event.offsetX+s[0]/2,c)-s[0]),t=Math.max(0,Math.min(d3.event.offsetY+s[1]/2,p)-s[1]);i.attr("x",e).attr("y",t),d=!0,$("#red-ui-workspace-chart").scrollLeft(e*l*a),$("#red-ui-workspace-chart").scrollTop(t*l*a)})).on("mousemove",(function(){if(d)if(0!==d3.event.buttons){var e=Math.max(0,Math.min(d3.event.offsetX+s[0]/2,c)-s[0]),t=Math.max(0,Math.min(d3.event.offsetY+s[1]/2,p)-s[1]);i.attr("x",e).attr("y",t),$("#red-ui-workspace-chart").scrollLeft(e*l*a),$("#red-ui-workspace-chart").scrollTop(t*l*a)}else d=!1})).on("mouseup",(function(){d=!1})),i=t.append("rect").attr("class","red-ui-navigator-border"),o=t.append("svg:g"),RED.statusBar.add({id:"view-navigator",align:"right",element:$('<button class="red-ui-footer-button-toggle single" id="red-ui-view-navigate"><i class="fa fa-map-o"></i></button>')}),$("#red-ui-view-navigate").on("click",(function(e){e.preventDefault(),v()})),RED.popover.tooltip($("#red-ui-view-navigate"),RED._("actions.toggle-navigator"),"core:toggle-navigator")},refresh:f,resize:g,toggle:v}}(),RED.view.tools=function(){function e(){var e=RED.view.selection();if(e.nodes){var t=[];e.nodes.forEach((function(e){var i=e.w/2+Math.round((e.x-e.w/2)/RED.view.gridSize())*RED.view.gridSize(),o=Math.round(e.y/RED.view.gridSize())*RED.view.gridSize();e.x===i&&e.y===o||(t.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=i,e.y=o,e.dirty=!0,e.moved=!0)})),t.length>0&&(RED.history.push({t:"move",nodes:t,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}var t=null,i=!1;function o(){if(i=!1,t.length>0){for(var e=[],o=0;o<t.length;o++)e.push({n:t[o].n,ox:t[o].ox,oy:t[o].oy,moved:t[o].moved}),t[o].n.moved=!0,t[o].n.dirty=!0,delete t[o].ox,delete t[o].oy;RED.view.redraw(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),t=null}}function n(e,n){if(null===t){t=[];var a=RED.view.selection();if(a.nodes)for(;a.nodes.length>0;){var r=a.nodes.shift();t.push({n:r}),"group"===r.type&&(a.nodes=a.nodes.concat(r.nodes))}}if(t&&t.length>0){i||($(document).one("keyup",o),i=!0);for(var s,d=0,l=0,c=0;c<t.length;c++)null==(s=t[c]).ox&&null==s.oy&&(s.ox=s.n.x,s.oy=s.n.y,s.moved=s.n.moved),s.n.moved=!0,s.n.dirty=!0,s.n.x+=e,s.n.y+=n,s.n.dirty=!0,"group"===s.n.type?(RED.group.markDirty(s.n),d=Math.min(s.n.x-5,d),l=Math.min(s.n.y-5,l)):(d=Math.min(s.n.x-s.n.w/2-5,d),l=Math.min(s.n.y-s.n.h/2-5,l));if(0!==d||0!==l)for(r=0;r<t.length;r++)(s=t[r]).n.x-=d,s.n.y-=l;RED.view.redraw()}else RED.view.scroll(10*e,10*n)}function a(e){var t=RED.view.selection(),i=[],o=[];t.nodes&&t.nodes.forEach((function(e){"subflow"!==e.type&&"group"!==e.type?o.push(e):"group"===e.type&&(o=o.concat(RED.group.getNodes(e,!0)))})),o.forEach((function(t){var o=!1,n=void 0===t.l||t.l,a=/^link (in|out)$/.test(t._def.type);e?(!1===t.l||a&&!t.hasOwnProperty("l"))&&(t.l=!0,o=!0):(!a&&(!t.hasOwnProperty("l")||!0===t.l)||a&&!0===t.l)&&(t.l=!1,o=!0),o&&(i.push({t:"edit",node:t,changed:t.changed,changes:{l:n}}),t.changed=!0,t.dirty=!0,t.resize=!0)})),i.length>0&&(RED.history.push({t:"multi",events:i,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)),RED.view.redraw()}return{init:function(){RED.actions.add("core:show-selected-node-labels",(function(){a(!0)})),RED.actions.add("core:hide-selected-node-labels",(function(){a(!1)})),RED.actions.add("core:align-selection-to-grid",e),RED.actions.add("core:scroll-view-up",(function(){RED.view.scroll(0,-RED.view.gridSize())})),RED.actions.add("core:scroll-view-right",(function(){RED.view.scroll(RED.view.gridSize(),0)})),RED.actions.add("core:scroll-view-down",(function(){RED.view.scroll(0,RED.view.gridSize())})),RED.actions.add("core:scroll-view-left",(function(){RED.view.scroll(-RED.view.gridSize(),0)})),RED.actions.add("core:step-view-up",(function(){RED.view.scroll(0,-5*RED.view.gridSize())})),RED.actions.add("core:step-view-right",(function(){RED.view.scroll(5*RED.view.gridSize(),0)})),RED.actions.add("core:step-view-down",(function(){RED.view.scroll(0,5*RED.view.gridSize())})),RED.actions.add("core:step-view-left",(function(){RED.view.scroll(-5*RED.view.gridSize(),0)})),RED.actions.add("core:move-selection-up",(function(){n(0,-1)})),RED.actions.add("core:move-selection-right",(function(){n(1,0)})),RED.actions.add("core:move-selection-down",(function(){n(0,1)})),RED.actions.add("core:move-selection-left",(function(){n(-1,0)})),RED.actions.add("core:step-selection-up",(function(){n(0,-RED.view.gridSize())})),RED.actions.add("core:step-selection-right",(function(){n(RED.view.gridSize(),0)})),RED.actions.add("core:step-selection-down",(function(){n(0,RED.view.gridSize())})),RED.actions.add("core:step-selection-left",(function(){n(-RED.view.gridSize(),0)}))},alignSelectionToGrid:e,moveSelection:n}}(),RED.sidebar=function(){var e,t={};var i={};function o(t){t?($("#red-ui-main-container").removeClass("red-ui-sidebar-closed"),e.resize()):$("#red-ui-main-container").addClass("red-ui-sidebar-closed"),RED.events.emit("sidebar:resize")}function n(i){i&&(a(i)||e.addTab(t[i]),e.activateTab(i),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function a(t){return e.contains(t)}return i.dragging=!1,{init:function(){!function(){$("#red-ui-sidebar-separator").draggable({axis:"x",start:function(e,t){i.closing=!1,i.opening=!1;var o=$("#red-ui-editor").width();i.start=t.position.left,i.chartWidth=$("#red-ui-workspace").width(),i.chartRight=o-$("#red-ui-workspace").width()-$("#red-ui-workspace").offset().left-2,i.dragging=!0,RED.menu.isSelected("menu-item-sidebar")||(i.opening=!0,$("#red-ui-sidebar").addClass("closing"),$("#red-ui-workspace").css("right",7),$("#red-ui-editor-stack").css("right",8),$("#red-ui-sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")),i.width=$("#red-ui-sidebar").width()},drag:function(t,o){var n=o.position.left-i.start,a=i.width-n;i.opening&&(a-=3),a>150&&i.chartWidth+n<200&&(o.position.left=200+i.start-i.chartWidth,n=o.position.left-i.start,a=i.width-n),a<150?(i.closing||($("#red-ui-sidebar").addClass("closing"),i.closing=!0),i.opening||(a=150,o.position.left=i.width-(150-i.start),n=o.position.left-i.start)):a>150&&(i.closing||i.opening)&&(i.closing=!1,$("#red-ui-sidebar").removeClass("closing"));var r=i.chartRight-n;$("#red-ui-workspace").css("right",r),$("#red-ui-editor-stack").css("right",r+1),$("#red-ui-sidebar").width(a),e.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){i.dragging=!1,i.closing&&($("#red-ui-sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#red-ui-sidebar").width()<180&&($("#red-ui-sidebar").width(180),$("#red-ui-workspace").css("right",187),$("#red-ui-editor-stack").css("right",188))),$("#red-ui-sidebar-separator").css("left","auto"),$("#red-ui-sidebar-separator").css("right",$("#red-ui-sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}});var t=$('<div class="red-ui-sidebar-control-right"><i class="fa fa-chevron-right"</div>').appendTo($("#red-ui-sidebar-separator"));t.on("click",(function(){t.hide(),RED.menu.toggleSelected("menu-item-sidebar")})),$("#red-ui-sidebar-separator").on("mouseenter",(function(){i.dragging||(RED.menu.isSelected("menu-item-sidebar")?t.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"):t.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left"),t.toggle("slide",{direction:"right"},200))})),$("#red-ui-sidebar-separator").on("mouseleave",(function(){i.dragging||(t.stop(!1,!0),t.hide())}))}(),e=RED.tabs.create({element:$('<ul id="red-ui-sidebar-tabs"></ul>').appendTo("#red-ui-sidebar"),onchange:function(e){$("#red-ui-sidebar-content").children().hide(),$("#red-ui-sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},collapsible:!0,onreorder:function(e){RED.settings.set("editor.sidebar.order",e)},order:RED.settings.get("editor.sidebar.order",["info","help","version-control","debug"])}),$('<div id="red-ui-sidebar-content"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-shade" class="hide"></div>').appendTo("#red-ui-sidebar"),RED.actions.add("core:toggle-sidebar",(function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):o(e)})),RED.popover.tooltip($("#red-ui-sidebar-separator").find(".red-ui-sidebar-control-right"),RED._("keyboard.toggleSidebar"),"core:toggle-sidebar"),n(),RED.sidebar.info.init(),RED.sidebar.help.init(),RED.sidebar.config.init(),RED.sidebar.context.init(),$("#red-ui-editor").width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(i,o,a,r){var s;"string"==typeof i?s={id:o.id,label:i,name:i,content:o,closeable:a,visible:r}:"object"==typeof i&&(s=i),delete s.closeable,s.wrapper=$("<div>",{style:"height:100%"}).appendTo("#red-ui-sidebar-content"),s.wrapper.append(s.content),s.wrapper.hide(),s.enableOnEdit||(s.shade=$("<div>",{class:"red-ui-sidebar-shade hide"}).appendTo(s.wrapper)),s.toolbar&&($("#red-ui-sidebar-footer").append(s.toolbar),$(s.toolbar).hide()),s.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+s.id,label:s.name,onselect:function(){n(s.id)},group:"sidebar-tabs"}),s.iconClass=s.iconClass||"fa fa-square-o",t[s.id]=s,!1!==s.visible&&e.addTab(t[s.id])},removeTab:function(i){e.removeTab(i),$(t[i].wrapper).remove(),t[i].footer&&t[i].footer.remove(),delete t[i],RED.menu.removeItem("menu-item-view-menu-"+i)},show:n,containsTab:a,toggleSidebar:o}}(),RED.palette=function(){var e,t=["config","unknown","deprecated"],i=["subflows","common","function","network","input","output","sequence","parser","storage","analysis","social","advanced"],o={};function n(e,t,i,o){0===$("#red-ui-palette-base-category-"+t).length&&a(e,t,o+":palette.label."+t),$("#red-ui-palette-container-"+t).show(),0===$("#red-ui-palette-"+i).length&&$("#red-ui-palette-base-category-"+t).append('<div id="red-ui-palette-'+i+'"></div>')}function a(e,t,i){var n=RED._(i,{defaultValue:t});n=(n||t).replace(/_/g," ");var a=$('<div id="red-ui-palette-container-'+t+'" class="red-ui-palette-category hide"><div id="red-ui-palette-header-'+t+'" class="red-ui-palette-header"><i class="expanded fa fa-angle-down"></i><span>'+n+'</span></div><div class="red-ui-palette-content" id="red-ui-palette-base-category-'+t+'"><div id="red-ui-palette-'+t+'"></div><div id="red-ui-palette-'+t+'-input"></div><div id="red-ui-palette-'+t+'-output"></div><div id="red-ui-palette-'+t+'-function"></div></div></div>').appendTo("#red-ui-palette-container");a.data("category",e),a.data("label",n),o[t]={container:a,close:function(){a.removeClass("red-ui-palette-open"),a.addClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideUp(),$("#red-ui-palette-header-"+t+" i").removeClass("expanded")},open:function(){a.addClass("red-ui-palette-open"),a.removeClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideDown(),$("#red-ui-palette-header-"+t+" i").addClass("expanded")},toggle:function(){a.hasClass("red-ui-palette-open")?o[t].close():o[t].open()}},$("#red-ui-palette-header-"+t).on("click",(function(e){o[t].toggle()}))}function r(e,t,i,o){t.attr("data-palette-label",i);for(var n=(i=RED.utils.sanitize(i)).split(/[ -]/),a=[],r="",s=0;s<n.length;s++){var d=n[s],l=0==s?"":" ";if(RED.view.calculateTextWidth(r+l+d,"red-ui-palette-label")<82)r+=l+d;else for(s>0&&a.push(r);;){if(!(RED.view.calculateTextWidth(d,"red-ui-palette-label")>=82)){r=d;break}for(var c=d.length;c>0;c--){var p=d.substring(0,c);if(RED.view.calculateTextWidth(p,"red-ui-palette-label")<82){a.push(p),d=d.substring(c);break}}}}a.push(r);var u,f=a.join("<br/>"),h=8+20*a.length;t.css({height:h+"px"}),t.find(".red-ui-palette-label").html(f).attr("dir",RED.text.bidi.resolveBaseTextDir(f)),t.find(".red-ui-palette-port").css({top:h/2-5+"px"});try{var g="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(i)+"</b></p>";(u=$("<div></div>").append($(g+(o||($("script[data-help-name='"+e+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter((function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&this.textContent.trim().length>0})).slice(0,2))).find("a").each((function(){var e=$(this).text();$(this).before(e),$(this).remove()}));var v=RED.nodes.getType(e);if(v){var b="";v&&!/^subflow:/.test(e)&&(b=v.set.module+" : "),b+=e,$('<button type="button" onclick="RED.sidebar.help.show(\''+e+'\'); return false;" class="red-ui-button red-ui-button-small" style="float: right"><i class="fa fa-book"></i></button>').appendTo(u),$("<p>",{style:"font-size: 0.8em"}).text(b).appendTo(u)}}catch(t){console.log("Error generating pop-over label for ",e),console.log(t.toString()),u="<p><b>"+i+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}t.data("popover").setContent(u)}function s(e){return $(".red-ui-palette-node[data-palette-type='"+e+"']")}function d(e){return e.replace(/[ /.]/g,"_")}function l(e,a){if(!s(e).length){var l=a.category;if(-1===t.indexOf(l)){var c=d(l),p=c.split("-")[0],u=$("<div>",{class:"red-ui-palette-node"}).attr("data-palette-type",e).data("category",p),f=e;if(void 0!==a.paletteLabel)try{f=("function"==typeof a.paletteLabel?a.paletteLabel.call(a):a.paletteLabel)||""}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}if($("<div/>",{class:"red-ui-palette-label"+(!a.align&&0!==a.inputs&&0===a.outputs||"right"===a.align?" red-ui-palette-label-right":"")}).appendTo(u),a.icon){var h=RED.utils.getNodeIcon(a),g=$("<div/>",{class:"red-ui-palette-icon-container"+(!a.align&&0!==a.inputs&&0===a.outputs||"right"===a.align?" red-ui-palette-icon-container-right":"")}).appendTo(u);g.attr("data-palette-icon",h),RED.utils.createIconElement(h,g,!0)}if(u.css("backgroundColor",RED.utils.getNodeColor(e,a)),a.outputs>0){var v=document.createElement("div");v.className="red-ui-palette-port red-ui-palette-port-output",u.append(v)}if(a.inputs>0){var b=document.createElement("div");b.className="red-ui-palette-port red-ui-palette-port-input",u.append(b)}n(l,p,c,-1!==i.indexOf(p)?"node-red":a.set.id),$("#red-ui-palette-"+c).append(u),u.on("mousedown",(function(e){e.preventDefault()}));var m=RED.popover.create({target:u,trigger:"hover",interactive:!0,width:"300px",content:"hi",delay:{show:750,hide:50}});u.data("popover",m);var y,w,E,D,R,x,_,k,T,C=$("#red-ui-workspace-chart"),j=$("#red-ui-workspace-chart>svg").get(0);$(u).draggable({helper:"clone",appendTo:"#red-ui-editor",revert:"invalid",revertDuration:200,containment:"#red-ui-main-container",start:function(){k=$("#red-ui-palette").width(),T=$("#red-ui-palette").parent().position().top+$("#red-ui-palette-container").position().top,_=null,(x=RED.view.getActiveGroup())&&document.getElementById("group_select_"+x.id).classList.add("red-ui-flow-group-active-hovered"),RED.view.focus()},stop:function(){d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),_&&document.getElementById("group_select_"+_.id).classList.remove("red-ui-flow-group-hovered"),x&&document.getElementById("group_select_"+x.id).classList.remove("red-ui-flow-group-active-hovered"),D&&(clearTimeout(D),D=null),R&&(clearTimeout(R),R=null)},drag:function(t,i){var o=s(e);i.originalPosition.left=o.offset().left,w=i.position.left-k+i.helper.width()/2+C.scrollLeft(),E=i.position.top-T+i.helper.height()/2+C.scrollTop(),R||(R=setTimeout((function(){w/=RED.view.scale(),E/=RED.view.scale();var e=RED.view.getGroupAtPoint(w,E);e!==_&&(_&&document.getElementById("group_select_"+_.id).classList.remove("red-ui-flow-group-hovered"),e&&document.getElementById("group_select_"+e.id).classList.add("red-ui-flow-group-hovered"),(_=e)?$(i.helper).data("group",_):$(i.helper).removeData("group")),R=null}),200)),a.inputs>0&&a.outputs>0&&(D||(D=setTimeout((function(){var e=[],t=1/0,o=null;if(j.getIntersectionList){var n=j.createSVGRect();n.x=w,n.y=E,n.width=1,n.height=1,e=j.getIntersectionList(n,j),w/=RED.view.scale(),E/=RED.view.scale()}else w/=RED.view.scale(),E/=RED.view.scale(),e=RED.view.getLinksAtPoint(w,E);for(var a=0;a<e.length;a++){var r=d3.select(e[a]);if(r.classed("red-ui-flow-link-background")&&!r.classed("red-ui-flow-link-link"))for(var s=e[a].getTotalLength(),d=0;d<s;d+=10){var l=e[a].getPointAtLength(d),c=(l.x-w)*(l.x-w)+(l.y-E)*(l.y-E);c<200&&c<t&&(t=c,o=e[a])}}y&&y!==o&&d3.select(y.parentNode).classed("red-ui-flow-link-splice",!1),o?d3.select(o.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),y!==o&&(o?$(i.helper).data("splice",d3.select(o).data()[0]):$(i.helper).removeData("splice")),y=o,D=null}),200)))}});var L=null;0===e.indexOf("subflow:")&&(u.on("dblclick",(function(t){RED.workspaces.show(e.substring(8)),t.preventDefault()})),L=RED.utils.renderMarkdown(a.info||"")),r(e,u,f,L),1===$("#red-ui-palette-container-"+p).find(".red-ui-palette-node").length&&o[p].open()}}}function c(e){var t=s(e),i=t.closest(".red-ui-palette-category");t.remove(),0===i.find(".red-ui-palette-node").length&&i.find("i").hasClass("expanded")&&(i.find(".red-ui-palette-content").slideToggle(),i.find("i").toggleClass("expanded"))}function p(e){var t=s(e);t.hide();for(var i=t.closest(".red-ui-palette-category"),o=i.find(".red-ui-palette-node"),n=0,a=0;a<o.length;a++)"none"===$(o[a]).css("display")&&(n+=1);n===o.length&&i.hide()}function u(e){var t=s(e);t.closest(".red-ui-palette-category").show(),t.show()}function f(e){var t=s("subflow:"+e.id),i=t.find(".red-ui-palette-port-input"),a=t.find(".red-ui-palette-port-output");if(t.find(".red-ui-palette-label").attr("class","red-ui-palette-label"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-label-right":"")),t.find(".red-ui-palette-icon-container").attr("class","red-ui-palette-icon-container"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-icon-container-right":"")),0===i.length&&e.in.length>0){var l=document.createElement("div");l.className="red-ui-palette-port red-ui-palette-port-input",t.append(l)}else 0!==i.length&&0===e.in.length&&i.remove();if(0===a.length&&e.out.length>0){var c=document.createElement("div");c.className="red-ui-palette-port red-ui-palette-port-output",t.append(c)}else 0!==a.length&&0===e.out.length&&a.remove();var p=t.attr("data-palette-label"),u=t.attr("data-palette-info");p===e.name&&u===e.info||(t.attr("data-palette-info",e.info),r(e.type+":"+e.id,t,e.name,RED.utils.renderMarkdown(e.info||""))),function(e,t){var i=RED.utils.getNodeIcon(t._def),o=e.find(".red-ui-palette-icon-container");o.attr("data-palette-icon")!==i&&(o.attr("data-palette-icon",i),RED.utils.createIconElement(i,o,!0))}(t,e);var f=t.data("category"),h=e.category||"subflows";if(f!==h){var g=d(h);n(h,g,g,"node-red");var v=t.closest(".red-ui-palette-category"),b=$("#red-ui-palette-"+g);b.append(t),1===b.find(".red-ui-palette-node").length&&o[g].open(),t.data("category",h),0===v.find(".red-ui-palette-node").length&&v.find("i").hasClass("expanded")&&(v.find(".red-ui-palette-content").slideToggle(),v.find("i").toggleClass("expanded"))}t.css("backgroundColor",e.color)}return{init:function(){$('<img src="red/images/spin.svg" class="red-ui-palette-spinner hide"/>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-search" class="red-ui-palette-search hide"><input type="text" data-i18n="[placeholder]palette.filter"></input></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-content" class="red-ui-palette-scroll hide"></div>').appendTo("#red-ui-palette"),$('<div class="red-ui-component-footer"></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-shade" class="hide"></div>').appendTo("#red-ui-palette"),$("#red-ui-palette > .red-ui-palette-spinner").show(),RED.events.on("registry:node-type-added",(function(e){var t=RED.nodes.getType(e);l(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)})),RED.events.on("registry:node-type-removed",(function(e){c(e)})),RED.events.on("registry:node-set-enabled",(function(e){for(var t=0;t<e.types.length;t++){u(e.types[t]);var i=RED.nodes.getType(e.types[t]);i&&i.onpaletteadd&&"function"==typeof i.onpaletteadd&&i.onpaletteadd.call(i)}})),RED.events.on("registry:node-set-disabled",(function(e){for(var t=0;t<e.types.length;t++){p(e.types[t]);var i=RED.nodes.getType(e.types[t]);i&&i.onpaletteremove&&"function"==typeof i.onpaletteremove&&i.onpaletteremove.call(i)}})),RED.events.on("registry:node-set-removed",(function(e){if(e.added)for(var t=0;t<e.types.length;t++){c(e.types[t]);var i=RED.nodes.getType(e.types[t]);i&&i.onpaletteremove&&"function"==typeof i.onpaletteremove&&i.onpaletteremove.call(i)}})),RED.events.on("subflows:change",f),$("#red-ui-palette-search input").searchBox({delay:100,change:function(){!function(e){var t=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(var i in $("#red-ui-palette-container .red-ui-palette-node").each((function(i,o){var n=$(o).attr("data-palette-label"),a=$(o).attr("data-palette-type");""===e||t.test(a)||t.test(n)?$(this).show():$(this).hide()})),o)o.hasOwnProperty(i)&&(0===o[i].container.find(".red-ui-palette-node").filter((function(){return"none"!==$(this).css("display")})).length?(o[i].close(),o[i].container.slideUp()):(o[i].open(),o[i].container.show()))}($(this).val())}}),e=$('<div class="red-ui-sidebar-control-left"><i class="fa fa-chevron-left"></i></div>').appendTo($("#red-ui-palette")),RED.popover.tooltip(e,RED._("keyboard.togglePalette"),"core:toggle-palette"),e.on("click",(function(){RED.menu.toggleSelected("menu-item-palette")})),$("#red-ui-palette").on("mouseenter",(function(){e.toggle("slide",{direction:"left"},200)})),$("#red-ui-palette").on("mouseleave",(function(){e.stop(!1,!0),e.hide()}));var t=[];RED.settings.paletteCategories?t=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(t=RED.settings.theme("palette.categories")),Array.isArray(t)||(t=[]);var n={};t.forEach((function(e){n[e]=!0,a(e,d(e),"palette.label."+d(e))})),i.forEach((function(e){n[e]||a(e,d(e),"palette.label."+d(e))}));var r=$('<span class="button-group"></span>').appendTo("#red-ui-palette .red-ui-component-footer"),s=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-up"></i></button>').appendTo(r);s.on("click",(function(e){for(var t in e.preventDefault(),o)o.hasOwnProperty(t)&&o[t].close()})),RED.popover.tooltip(s,RED._("palette.actions.collapse-all"));var h=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-down"></i></button>').appendTo(r);h.on("click",(function(e){for(var t in e.preventDefault(),o)o.hasOwnProperty(t)&&o[t].open()})),RED.popover.tooltip(h,RED._("palette.actions.expand-all")),RED.actions.add("core:toggle-palette",(function(t){void 0===t?RED.menu.toggleSelected("menu-item-palette"):function(t){t?($("#red-ui-main-container").removeClass("red-ui-palette-closed"),e.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left")):($("#red-ui-main-container").addClass("red-ui-palette-closed"),e.hide(),e.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"));setTimeout((function(){$(window).trigger("resize")}),200)}(t)}))},add:l,remove:c,hide:p,show:u,refresh:function(){RED.nodes.eachSubflow(f)},getCategories:function(){var e=[];return $("#red-ui-palette-container .red-ui-palette-category").each((function(t,i){e.push({id:$(i).data("category"),label:$(i).data("label")})})),e}}}(),RED.sidebar.info=function(){var e,t,i,o,n,a,r,s,d,l,c,p={property:!1};function u(){if(t){var i=$(e).parent().height()-l.outerHeight();t.resize(i)}}function f(){RED.sidebar.show("info")}function h(e){if(void 0!==e){var t;$(i).empty();var o,l,c=$('<table class="red-ui-info-table"></table>').appendTo(i),u=$("<tbody>").appendTo(c);if(null!==e)if(Array.isArray(e)){RED.sidebar.info.outliner.select(e),n.empty(),RED.utils.createNodeIcon({type:"_selection_"}).appendTo(n),a.text("Selection"),r.hide(),s.hide(),d=null;var f={nodes:0,flows:0,subflows:0,groups:0};e.forEach((function(e){"tab"===e.type?(f.flows++,f.nodes+=RED.nodes.filterNodes({z:e.id}).length):"subflow"===e.type?f.subflows++:"group"===e.type?f.groups++:f.nodes++})),t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(u);var h=$("<div>").appendTo($(t.children()[1]));f.flows>0&&$("<div>").text(RED._("clipboard.flow",{count:f.flows})).appendTo(h),f.subflows>0&&$("<div>").text(RED._("clipboard.subflow",{count:f.subflows})).appendTo(h),f.nodes>0&&$("<div>").text(RED._("clipboard.node",{count:f.nodes})).appendTo(h),f.groups>0&&$("<div>").text(RED._("clipboard.group",{count:f.groups})).appendTo(h)}else{RED.sidebar.info.outliner.select(e);var g=/^subflow(:(.+))?$/.exec(e.type);if(g){(o=g[2]?RED.nodes.subflow(g[2]):e).id;l=o.instances.length}n.empty(),RED.utils.createNodeIcon(e).appendTo(n);var b=RED.utils.getNodeLabel(e,e.type+": "+e.id),m=b.indexOf("\\n");m>-1&&(b=b.substring(0,m)+"..."),a.text(b),r.show(),d=e,t=$('<tr class="red-ui-help-info-row"><td></td><td></td></tr>').appendTo(u);var y="node";if("subflow"===e.type||g?y="subflow":"tab"===e.type?y="flow":"group"===e.type&&(y="group"),$(t.children()[0]).text(RED._("sidebar.info."+y)),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),"tab"===e.type||"subflow"===e.type)s.hide();else if("group"===e.type){s.hide(),t=$('<tr class="red-ui-help-info-row"><td>&nbsp;</td><td></td></tr>').appendTo(u);var w={nodes:0,groups:0};RED.group.getNodes(e,!0).forEach((function(e){"group"===e.type?w.groups++:w.nodes++}));h=$("<div>").appendTo($(t.children()[1]));w.nodes>0&&$("<div>").text(RED._("clipboard.node",{count:w.nodes})).appendTo(h),w.groups>0&&$("<div>").text(RED._("clipboard.group",{count:w.groups})).appendTo(h)}else{s.show(),g||(t=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.type")+"</td><td></td></tr>").appendTo(u),$(t.children()[1]).text("unknown"===e.type?e._orig.type:e.type),"unknown"===e.type&&$('<span style="float: right; font-size: 0.8em"><i class="fa fa-warning"></i></span>').prependTo($(t.children()[1])));var E=0;if(!g&&"subflow"!=e.type&&"group"!=e.type){var D,R=$('<tr class="red-ui-help-property-expand blank"><td colspan="2"></td></tr>').appendTo(u);if("unknown"===e.type?(D={},Object.keys(e._orig).forEach((function(e){"type"!==e&&(D[e]={})}))):e._def&&(D=e._def.defaults,t=$('<tr class="red-ui-help-info-property-row'+(p.property?"":" hide")+'"><td>'+RED._("sidebar.info.module")+"</td><td></td></tr>").appendTo(u),$(t.children()[1]).text(RED.nodes.getType(e.type).set.module),E++),D)for(var x in D)if("name"!=x&&"info"!=x&&D.hasOwnProperty(x)){var _=e[x];if(E++,t=$('<tr class="red-ui-help-info-property-row'+(p.property?"":" hide")+'"><td></td><td></td></tr>').appendTo(u),$(t.children()[0]).text(x),D[x].type){var k=RED.nodes.node(_);if(k){var T=RED.utils.getNodeLabel(k,_),C=t.children()[1],j=$("<span>",{class:""}).appendTo(C),L=$("<div>",{class:"red-ui-palette-node red-ui-palette-node-small"}).appendTo(j),O=RED.utils.getNodeColor(k.type,k._def),S=RED.utils.getNodeIcon(k._def);L.css({backgroundColor:O,cursor:"pointer"});var I=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(L);$("<div/>",{class:"red-ui-palette-icon",style:"background-image: url("+S+")"}).appendTo(I);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).text(T).appendTo(C);L.on("dblclick",(function(){RED.editor.editConfig("",k.type,k.id)}))}else RED.utils.createObjectElement(void 0).appendTo(t.children()[1])}else RED.utils.createObjectElement(_).appendTo(t.children()[1])}E>0&&$('<a href="#" class="node-info-property-header'+(p.property?" expanded":"")+'"><span class="red-ui-help-property-more">'+RED._("sidebar.info.showMore")+'</span><span class="red-ui-help-property-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a>').appendTo(R.children()[0])}"tab"!==e.type&&g&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(u),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(o.name)+'">'+RED.utils.sanitize(o.name)+"</span></td></tr>").appendTo(u))}if(g){t=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.category")+"</td><td></td></tr>").appendTo(u);var P=o.category||"subflows";$(t.children()[1]).text(RED._("palette.label."+P,{defaultValue:P})),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+l+"</td></tr>").appendTo(u)}var N="";if(e._def&&e._def.info){var A=e._def.info,z="function"==typeof A?A.call(e):A;N+=RED.utils.renderMarkdown(z)}e.info&&(N+=RED.utils.renderMarkdown(e.info||"")),!function(e,t){var i=(o=$('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>"),$(o).find("a").each((function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")})),o).appendTo(t);var o;i.find(".red-ui-text-bidi-aware").contents().filter((function(){return 3===this.nodeType&&""!==this.textContent.trim()})).wrap("<span></span>");var n="H3";i.find(n).wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),i=$(this).parent().next();1===i.length&&i[0].nodeName!==n;)i.toggle(!t),i=i.next();$(this).toggleClass("expanded",!t)}))}(N,$("<div>").css("padding","0 6px 6px").appendTo(i)),$(".red-ui-sidebar-info-stack").scrollTop(0),$(".node-info-property-header").on("click",(function(e){e.preventDefault(),p.property=!p.property,$(this).toggleClass("expanded",p.property),$(".red-ui-help-info-property-row").toggle(p.property)}))}else RED.sidebar.info.outliner.select(null)}else v()}var g=function(){var e,t,i=!0,o=15e3,n=-1;function a(){for(var i,a=Math.floor(Math.random()*n),s=RED._("infotips:info.tip"+a);i=/({{(.*?)}})/.exec(s);){var d=RED.keyboard.getShortcut(i[2]);if(!d)return;s=s.replace(i[1],RED.keyboard.formatKey(d.key))}for(;i=/(\[(.*?)\])/.exec(s);)s=s.replace(i[1],RED.keyboard.formatKey(i[2]));c.html(s).fadeIn(200),e&&(e=null,t=setInterval(r,o))}function r(){c.fadeOut(300,(function(){a()}))}function s(){if($(".red-ui-sidebar-info").addClass("show-tips"),u(),i&&!e&&!t){if(-1===n)do{n++}while(RED._("infotips:info.tip"+n)!=="infotips:info.tip"+n);e=setTimeout(a,1e3)}}function d(){$(".red-ui-sidebar-info").removeClass("show-tips"),u(),clearInterval(t),clearTimeout(e),t=null,e=null}return RED.actions.add("core:toggle-show-tips",(function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(i=e)?s():d()})),{start:s,stop:d,next:function(){clearInterval(t),e=!0,a()},enabled:function(){return i}}}();function v(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?h(RED.nodes.subflow(t.z)):h(t)}else h(e.nodes);else if(e.flows||e.subflows)h(e.flows);else{var i=RED.workspaces.active(),o=RED.nodes.workspace(i)||RED.nodes.subflow(i);if(o)h(o);else{var n=RED.nodes.workspace(RED.workspaces.active());n&&n.info?h(n):h(null)}}}return RED.events.on("view:selection-changed",v),{init:function(){(e=document.createElement("div")).className="red-ui-sidebar-info",RED.actions.add("core:show-info-tab",f);var p=$("<div>",{class:"red-ui-sidebar-info-stack"}).appendTo(e),h=$("<div>").css({overflow:"hidden",height:"calc(70%)"}).appendTo(p),v=$("<div>").css({overflow:"hidden",height:"100%",display:"flex","flex-direction":"column"}).appendTo(p);o=$("<div>",{class:"red-ui-palette-header red-ui-info-header"}).css({flex:"0 0 auto"}).appendTo(v),n=$("<span>").appendTo(o),a=$("<span>").appendTo(o),s=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-book"></button>').css({position:"absolute",top:"12px",right:"32px"}).on("click",(function(e){e.preventDefault(),e.stopPropagation(),d&&RED.sidebar.help.show(d.type)})).appendTo(o),RED.popover.tooltip(s,RED._("sidebar.help.showHelp")),r=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-search"></button>').css({position:"absolute",top:"12px",right:"8px"}).on("click",(function(e){e.preventDefault(),e.stopPropagation(),d&&(RED.sidebar.info.outliner.reveal(d),RED.view.reveal(d.id))})).appendTo(o),RED.popover.tooltip(r,RED._("sidebar.help.showInOutline")),i=$("<div>").css({flex:"1 1 auto","overflow-y":"scroll"}).appendTo(v),(t=RED.panels.create({container:p})).ratio(.6),RED.sidebar.info.outliner.build().appendTo(h),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),iconClass:"fa fa-info",action:"core:show-info-tab",content:e,pinned:!0,enableOnEdit:!0}),RED.events.on("sidebar:resize",u),$(window).on("resize",u),$(window).on("focus",u),l=$('<div class="red-ui-help-tips"></div>').appendTo(e),c=$('<div class="red-ui-help-tip"></div>').appendTo(l);var b=$('<div class="red-ui-help-tips-buttons"></div>').appendTo(l);$('<a href="#" class="red-ui-footer-button"><i class="fa fa-refresh"></a>').appendTo(b).on("click",(function(e){e.preventDefault(),g.next()})),$('<a href="#" class="red-ui-footer-button"><i class="fa fa-times"></a>').appendTo(b).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))})),g.enabled()?g.start():g.stop()},show:f,refresh:h,clear:function(){h(null)},set:function(e,t){console.warn("Deprecated use of RED.sidebar.info.set - use RED.sidebar.help.set instead"),RED.sidebar.help.set(e,t)}}}(),RED.sidebar.info.outliner=function(){var e,t,i,o,n,a,r,s,d={},l={};function c(){var e=[{label:RED._("menu.label.flows"),expanded:!0,children:[]},{id:"__subflow__",label:RED._("menu.label.subflows"),children:[f("__subflow__")]},{id:"__global__",flow:"__global__",label:RED._("sidebar.info.globalConfig"),types:{},children:[f("__global__")]}];return a=e[0],r=e[1],s={__global__:e[2]},e}var p,u={};function f(e){var t={empty:!0,element:$('<div class="red-ui-info-outline-item red-ui-info-outline-item-empty">').text(RED._("sidebar.info.empty"))};return u[e]=t,t}function h(e){var t=e.name||e.type+": "+e.id;if(e._def.label)try{t=("function"==typeof e._def.label?e._def.label.call(e):e._def.label)||""}catch(t){console.log("Definition error: "+e.type+".label",t)}var i=t.indexOf("\\n");return i>-1&&(t=t.substring(0,i)+"..."),t}function g(e){var t=$("<div>",{class:"red-ui-info-outline-item"});RED.utils.createNodeIcon(e).appendTo(t);var i=$("<div>",{class:"red-ui-search-result-description"}).appendTo(t),o=h(e),n=$("<div>",{class:"red-ui-search-result-node-label red-ui-info-outline-item-label"}).appendTo(i);return o?n.text(o):n.html("&nbsp;"),b(e,t),t}function v(e){var t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"}),i=$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t),o="string"==typeof e?e:e.label,n=o.indexOf("\\n");return n>-1&&(o=o.substring(0,n)+"..."),i.text(o),b(e,t),t}function b(e,t){var i=$("<div>",{class:"red-ui-info-outline-item-controls red-ui-info-outline-item-hover-controls"}).appendTo(t);if("config"===e._def.category&&"group"!==e.type){var o=$('<button type="button" class="red-ui-info-outline-item-control-users red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').text(e.users.length).appendTo(i).on("click",(function(t){t.preventDefault(),t.stopPropagation(),RED.search.show("uses:"+e.id)}));RED.popover.tooltip(o,(function(){return RED._("editor.nodesUse",{count:e.users.length})}))}if(e._def.button){var n=$('<button type="button" class="red-ui-info-outline-item-control-action red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').appendTo(i).on("click",(function(t){t.preventDefault(),t.stopPropagation(),RED.view.clickNodeButton(e)}));RED.popover.tooltip(n,RED._("sidebar.info.triggerAction"))}if("group"!==e.type&&"subflow"!==e.type){var a=$('<button type="button" class="red-ui-info-outline-item-control-disable red-ui-button red-ui-button-small"><i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i></button>').appendTo(i).on("click",(function(t){if(t.preventDefault(),t.stopPropagation(),"tab"===e.type)e.disabled?RED.workspaces.enable(e.id):RED.workspaces.disable(e.id);else{e.changed,e.d,RED.nodes.dirty();e.d?delete e.d:e.d=!0,e.dirty=!0,e.changed=!0,RED.events.emit("nodes:change",e),RED.nodes.dirty(!0),RED.view.redraw()}}));RED.popover.tooltip(a,(function(){return RED._("common.label."+("tab"===e.type&&e.disabled||"tab"!==e.type&&e.d?"enable":"disable"))}))}else $('<div class="red-ui-info-outline-item-control-spacer">').appendTo(i);i.find("button").on("dblclick",(function(e){e.preventDefault(),e.stopPropagation()}))}function m(t){d={};var i=c();n.empty(),function(e){var t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"});t.css("width","calc(100% - 40px)"),$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t).text(e.name);var i=$("<div>",{class:"red-ui-info-outline-item-controls"}).appendTo(t),o=$('<button class="red-ui-button red-ui-button-small" style="position:absolute;right:5px;top: 3px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(i).on("click",(function(e){e.preventDefault(),RED.projects.editProject()}));return RED.popover.tooltip(o,RED._("sidebar.project.showProjectSettings")),t}(t).appendTo(n),o.show(),e.treeList("data",i)}function y(){e.treeList("data",c())}function w(e){d[e.id]={id:e.id,element:v(e),children:[],deferBuild:!0,icon:"red-ui-icons red-ui-icons-flow",gutter:T(e)},l[e.id]?(d[e.id].children=l[e.id],delete l[e.id]):d[e.id].children.push(f(e.id)),a.treeList.addChild(d[e.id]),d[e.id].element.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),d[e.id].treeList.container.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),L()}function E(e){var t=d[e.id],i=e.label||e.id,o=i.indexOf("\\n");o>-1&&(i=i.substring(0,o)+"..."),t.element.find(".red-ui-info-outline-item-label").text(i),t.element.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),t.treeList.container.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),L()}function D(e){var t={};e.forEach((function(e,i){t[e]=i})),a.treeList.sortChildren((function(e,i){return"__global__"===e.id?-1:"__global__"===i.id?1:t[e.id]-t[i.id]}))}function R(e){d[e.id]={id:e.id,element:g(e),children:[],deferBuild:!0,gutter:T(e)},l[e.id]?(d[e.id].children=l[e.id],delete l[e.id]):d[e.id].children.push(f(e.id)),u.__subflow__&&(u.__subflow__.treeList.remove(),delete u.__subflow__),r.treeList.addChild(d[e.id]),L()}function x(e){d[e.id].treeList.replaceElement(g(e)),RED.nodes.eachNode((function(t){t.type=="subflow:"+e.id&&d[t.id].treeList.replaceElement(g(t))})),L()}function _(e){var t=d[e.id],i=e.g||e.z||"__global__",o=h(e);o?t.element.find(".red-ui-info-outline-item-label").text(o):t.element.find(".red-ui-info-outline-item-label").html("&nbsp;");var n=t.parent.id;if(n||(n=t.parent.parent.flow),i!==n){var a=t.parent;t.treeList.remove(!0),0===a.children.length&&(a.config?(a.treeList.remove(),delete s[a.parent.id||a.parent.parent.id].types[e.type],0===a.parent.children.length&&("__global__"===a.parent.id?a.parent.treeList.addChild(f(a.parent.id)):(delete s[a.parent.parent.id],a.parent.treeList.remove(),0===a.parent.parent.children.length&&a.parent.parent.treeList.addChild(f(a.parent.parent.id))))):a.treeList.addChild(f(a.id))),"config"===e._def.category&&"group"!==e.type?(C(i,e.type),s[i].types[e.type].treeList.addChild(d[e.id])):(u[i]&&(u[i].treeList.remove(),delete u[i]),d[i].treeList.addChild(t))}t.element.toggleClass("red-ui-info-outline-item-disabled",!!e.d),"config"===e._def.category&&"group"!==e.type&&t.element.find(".red-ui-info-outline-item-control-users").text(e.users.length),L()}function k(e){var t=d[e.id];t.treeList.remove(),delete d[e.id],u[e.id]&&delete u[e.id];var i=t.parent;0===i.children.length&&(i.config?(i.treeList.remove(),delete s[i.parent.id||e.z].types[e.type],0===i.parent.children.length&&("__global__"===i.parent.id?i.parent.treeList.addChild(f(i.parent.id)):(delete s[e.z],i.parent.treeList.remove(),0===i.parent.parent.children.length&&i.parent.parent.treeList.addChild(f(i.parent.parent.id))))):i.treeList.addChild(f(i.id)))}function T(e){var t=$("<span>",{class:"red-ui-info-outline-gutter"}),i=$('<button type="button" class="red-ui-info-outline-item-control-reveal red-ui-button red-ui-button-small"><i class="fa fa-search"></i></button>').appendTo(t).on("click",(function(t){t.preventDefault(),t.stopPropagation(),RED.view.reveal(e.id)}));return RED.popover.tooltip(i,RED._("sidebar.info.find")),t}function C(e,t){u[e]&&(u[e].treeList.remove(),delete u[e]),s[e]||(s[e]={config:!0,flow:e,types:{},label:RED._("menu.label.displayConfig"),children:[]},d[e].treeList.insertChildAt(s[e],0)),s[e].types[t]||(s[e].types[t]={config:!0,label:t,children:[]},s[e].treeList.addChild(s[e].types[t]))}function j(e){d[e.id]={id:e.id,element:g(e),gutter:T(e)},"group"===e.type&&(d[e.id].children=[],d[e.id].deferBuild=!0,l[e.id]&&(d[e.id].children=l[e.id],delete l[e.id]));var t=e.g||e.z||"__global__";"config"!==e._def.category||"group"===e.type?d[t]?(u[t]&&(u[t].treeList.remove(),delete u[t]),d[t].treeList?d[t].treeList.addChild(d[e.id]):d[t].children.push(d[e.id])):(l[t]=l[t]||[],l[t].push(d[e.id])):(C(t,e.type),s[t].types[e.type].treeList.addChild(d[e.id])),d[e.id].element.toggleClass("red-ui-info-outline-item-disabled",!!e.d),L()}function L(){p&&clearTimeout(p),i&&(p=setTimeout((function(){t.searchBox("change")}),100))}return{build:function(){var a=$("<div>",{class:"red-ui-info-outline"}).css({height:"100%"}),r=$("<div>",{class:"red-ui-sidebar-header red-ui-info-toolbar"}).appendTo(a);return t=$('<input type="text" data-i18n="[placeholder]menu.label.search">').appendTo(r).searchBox({style:"compact",delay:500,change:function(){var t=$(this).val(),o=RED.search.search(t);if(t){i=t;for(var n={},a=0,r=o.length;a<r;a++)n[o[a].node.id]=!0;e.treeList("filter",(function(e){return 0===e.depth||e.id&&d[e.id]&&n[e.id]}),!0)}else{i=null,e.treeList("filter",null);var s=e.treeList("selected");s.id&&e.treeList("show",s.id)}},options:[{label:RED._("sidebar.info.search.configNodes"),value:"is:config"},{label:RED._("sidebar.info.search.unusedConfigNodes"),value:"is:config is:unused"},{label:RED._("sidebar.info.search.invalidNodes"),value:"is:invalid"},{label:RED._("sidebar.info.search.uknownNodes"),value:"type:unknown"},{label:RED._("sidebar.info.search.unusedSubflows"),value:"is:subflow is:unused"}]}),o=$('<div class="red-ui-treeList-label red-ui-info-outline-project"><span class="red-ui-treeList-icon"><i class="fa fa-archive"></i></span></div>').hide().appendTo(a),n=$("<span>").appendTo(o),(e=$("<div>").css({width:"100%"}).appendTo(a).treeList({data:c()})).on("treelistselect",(function(e,t){var i=RED.nodes.node(t.id)||RED.nodes.group(t.id);i&&("group"===i.type||"config"!==i._def.category?RED.view.select({nodes:[i]}):RED.view.select({nodes:[]}))})),e.on("treelistconfirm",(function(e,t){var i=RED.nodes.node(t.id);i&&("config"===i._def.category?RED.editor.editConfig("",i.type,i.id):RED.editor.edit(i))})),RED.events.on("projects:load",m),RED.events.on("flows:add",w),RED.events.on("flows:remove",k),RED.events.on("flows:change",E),RED.events.on("flows:reorder",D),RED.events.on("subflows:add",R),RED.events.on("subflows:remove",k),RED.events.on("subflows:change",x),RED.events.on("nodes:add",j),RED.events.on("nodes:remove",k),RED.events.on("nodes:change",_),RED.events.on("groups:add",j),RED.events.on("groups:remove",k),RED.events.on("groups:change",_),RED.events.on("workspace:clear",y),a},search:function(e){t.searchBox("value",e)},select:function(t){t?Array.isArray(t)?e.treeList("select",t.map((function(e){return d[e.id]})),!1):e.treeList("select",d[t.id],!1):e.treeList("clearSelection")},reveal:function(t){e.treeList("show",d[t.id])}}}(),RED.sidebar.help=function(){var e,t,i,o,n,a,r,s;function d(){var i=$(e).parent().height()-t.outerHeight();o.resize(i)}function l(){s||(s=setTimeout((function(){s=null,function(){[];var e=RED.nodes.registry.getModuleList(),t=Object.keys(e);t.sort();var i=[{label:RED._("sidebar.help.nodeHelp"),children:[],expanded:!0}],o=RED.nodes.registry.getNodeTypes().filter((function(e){return/subflow/.test(e)}));o.length>0&&(i[0].children.push({label:RED._("menu.label.subflows"),children:[]}),o.forEach((function(e){var t=RED.nodes.getType(e);i[0].children[0].children.push({id:"node-type:"+e,nodeType:e,subflowLabel:t.label().toLowerCase(),element:f({_def:t,type:t.label()})})})));t.forEach((function(t){var o=e[t],n=[];Object.keys(o.sets).forEach((function(e){o.sets[e].types.forEach((function(e){$("script[data-help-name='"+e+"']").length&&n.push({id:"node-type:"+e,nodeType:e,element:f({_def:RED.nodes.getType(e),type:e})})}))})),n.length>0&&(n.sort((function(e,t){return e.nodeType.localeCompare(t.nodeType)})),i[0].children.push({id:t,icon:"fa fa-cube",label:t,children:n}))})),a.treeList("data",i)}()}),500))}function c(e){var t=a.treeList("get","node-type:subflow:"+e.id);t.subflowLabel=e._def.label().toLowerCase(),t.treeList.replaceElement(f({_def:e._def,type:e._def.label()}))}function p(){var e=$("#red-ui-sidebar-help-show-toc");e.hasClass("selected")&&(e.removeClass("selected"),n=o.ratio(),r.css({transition:"height 0.2s"}),o.ratio(0),setTimeout((function(){r.css({transition:""})}),250))}function u(){var e=$("#red-ui-sidebar-help-show-toc");e.hasClass("selected")||(e.addClass("selected"),r.css({transition:"height 0.2s"}),o.ratio(Math.max(.3,Math.min(n,.7))),setTimeout((function(){r.css({transition:""});var e=a.treeList("selected");e.id&&a.treeList("show",e)}),250))}function f(e){var t=$("<div>",{class:"red-ui-info-outline-item"});RED.utils.createNodeIcon(e).appendTo(t);var i=$("<div>",{class:"red-ui-search-result-description"}).appendTo(t);return $("<div>",{class:"red-ui-search-result-node-label red-ui-info-outline-item-label"}).text(e.name||e.type).appendTo(i),t}function h(e){var t,n;i.empty();var r=/^subflow(:(.+))?$/.exec(e);if(r&&r[2]){var s=RED.nodes.subflow(r[2]);t=RED.utils.renderMarkdown(s.info||"")||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>",n=s.name||e}else t=$("script[data-help-name='"+e+"']").html()||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>",n=e;v(n,t,i),o.ratio()>.7&&o.ratio(.7),a.treeList("show","node-type:"+e),a.treeList("select","node-type:"+e,!1)}function g(e,t){!1!==t&&RED.sidebar.show("help"),e&&h(e),d()}function v(e,t,i){e&&$("<h1>",{class:"red-ui-help-title"}).text(e).appendTo(i);var o,n=(o=$('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(t)+'">'+t+"</span></div>"),$(o).find("a").each((function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")})),o).appendTo(i);n.find(".red-ui-text-bidi-aware").contents().filter((function(){return 3===this.nodeType&&""!==this.textContent.trim()})).wrap("<span></span>");n.find("H3").wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),i=$(this).parent().next();1===i.length&&"H3"!==i[0].nodeName;)i.toggle(!t),i=i.next();$(this).toggleClass("expanded",!t)})),i.parent().scrollTop(0)}return RED.events.on("view:selection-changed",(function(e){if(void 0===e&&(e=RED.view.selection()),e.nodes&&1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction||"group"!==t.type&&h(t.type)}})),{init:function(){(e=document.createElement("div")).className="red-ui-sidebar-info",t=$("<div>",{class:"red-ui-sidebar-header red-ui-info-toolbar"}).appendTo(e),$('<span class="button-group"><a id="red-ui-sidebar-help-show-toc" class="red-ui-button red-ui-button-small selected" href="#"><i class="fa fa-list-ul"></i></a></span>').appendTo(t);var n=t.find("#red-ui-sidebar-help-show-toc");RED.popover.tooltip(n,RED._("sidebar.help.showTopics")),n.on("click",(function(e){e.preventDefault(),$(this).hasClass("selected")?p():u()}));var s=$("<div>",{class:"red-ui-sidebar-help-stack"}).appendTo(e);r=$("<div>",{class:"red-ui-sidebar-help-toc"}).appendTo(s);var f=$("<div>").css({"overflow-y":"scroll"}).appendTo(s);(o=RED.panels.create({container:s})).ratio(.3),helpSearch=$('<input type="text" data-i18n="[placeholder]sidebar.help.search">').appendTo(t).searchBox({style:"compact",delay:100,change:function(){var e=$(this).val().toLowerCase();if(e){u();a.treeList("filter",(function(t){return 0===t.depth||(t.nodeType&&t.nodeType.indexOf(e)>-1||t.subflowLabel&&t.subflowLabel.indexOf(e)>-1)}),!0)}else{a.treeList("filter",null);var t=a.treeList("selected");t.id&&a.treeList("show",t.id)}}}),i=$("<div>",{class:"red-ui-help"}).css({padding:"6px"}).appendTo(f),$('<span class="red-ui-help-info-none">'+RED._("sidebar.help.noHelp")+"</span>").appendTo(i),(a=$("<div>").css({width:"100%"}).appendTo(r).treeList({data:[]})).on("treelistselect",(function(e,t){t.nodeType&&h(t.nodeType)})),RED.sidebar.addTab({id:"help",label:RED._("sidebar.help.label"),name:RED._("sidebar.help.name"),iconClass:"fa fa-book",action:"core:show-help-tab",content:e,pinned:!0,enableOnEdit:!0,onchange:function(){d()}}),$(window).on("resize",d),$(window).on("focus",d),RED.events.on("registry:node-type-added",l),RED.events.on("registry:node-type-removed",l),RED.events.on("subflows:change",c),RED.actions.add("core:show-help-tab",g)},show:g,set:function(e,t){$(i).empty(),v(t,e,i),p(),g()}}}(),RED.sidebar.config=function(){var e=document.createElement("div");e.className="red-ui-sidebar-node-config",e.id="red-ui-sidebar-node-config",e.tabIndex=0,$('<div class="red-ui-sidebar-header"><span class="button-group"><a class="red-ui-sidebar-header-button-toggle selected" id="red-ui-sidebar-config-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="red-ui-sidebar-header-button-toggle" id="red-ui-sidebar-config-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </span></div>').appendTo(e);var t=$('<div><a class="red-ui-footer-button" id="red-ui-sidebar-config-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="red-ui-footer-button" id="red-ui-sidebar-config-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),i=$("<div>").appendTo(e),o=$("<div>").appendTo(e),n=$("<div>").appendTo(e),a=!1,r={};function s(t,i,o){if(t=t.replace(/\./i,"-"),r[t])r[t].label!==o&&(r[t].list.parent().find(".red-ui-palette-node-config-label").text(o),r[t].label=o);else{var n=$('<div class="red-ui-palette-category red-ui-sidebar-config-category" id="red-ui-sidebar-config-category-'+t+'"></div>').appendTo(i),a=$('<div class="red-ui-sidebar-config-tray-header red-ui-palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(n);o?$('<span class="red-ui-palette-node-config-label"/>').text(o).appendTo(a):$('<span class="red-ui-palette-node-config-label" data-i18n="sidebar.config.'+t+'">').appendTo(a),$('<span class="red-ui-sidebar-node-config-filter-info"></span>').appendTo(a),category=$('<ul class="red-ui-palette-content red-ui-sidebar-node-config-list"></ul>').appendTo(n),category.on("click",(function(t){$(e).find(".red-ui-palette-node").removeClass("selected")})),n.i18n();var s=a.find("i"),d={label:o,list:category,size:function(){return d.list.find("li:not(.red-ui-palette-node-config-none)").length},open:function(e){s.hasClass("expanded")||(s.addClass("expanded"),e?d.list.show():d.list.slideDown())},close:function(e){s.hasClass("expanded")&&(s.removeClass("expanded"),e?d.list.hide():d.list.slideUp())},isOpen:function(){return s.hasClass("expanded")}};a.on("click",(function(e){d.isOpen()?d.close():d.open()})),r[t]=d}return r[t]}function d(t,i){var o=s(t.replace(/\./i,"-")),n=o.list;if(i.sort((function(e,t){return e.type<t.type?-1:e.type>t.type?1:0})),a){var r=i.length;(r-=(i=i.filter((function(e){return!1!==e._def.hasUsers&&0===e.users.length}))).length)>0?n.parent().find(".red-ui-sidebar-node-config-filter-info").text(RED._("sidebar.config.filtered",{count:r})).show():n.parent().find(".red-ui-sidebar-node-config-filter-info").hide()}else n.parent().find(".red-ui-sidebar-node-config-filter-info").hide();if(n.empty(),0===i.length)$('<li class="red-ui-palette-node-config-none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(n),o.close(!0);else{var d="";i.forEach((function(t){var i=RED.utils.getNodeLabel(t,t.id);t.type!=d&&($('<li class="red-ui-palette-node-config-type">'+t.type+"</li>").appendTo(n),d=t.type);var o=$('<li class="red-ui-palette-node_id_'+t.id.replace(/\./g,"-")+'"></li>').appendTo(n),a=$('<div class="red-ui-palette-node-config red-ui-palette-node"></div>').appendTo(o);o.data("node",t.id);i=$('<div class="red-ui-palette-label"></div>').text(i).appendTo(a);if(t.d&&(a.addClass("red-ui-palette-node-config-disabled"),$('<i class="fa fa-ban"></i>').prependTo(i)),!1!==t._def.hasUsers){var r=$("<div/>",{class:"red-ui-palette-icon-container red-ui-palette-icon-container-right"}).appendTo(a);0===t.users.length?r.text(0):$('<a href="#"/>').on("click",(function(e){e.stopPropagation(),e.preventDefault(),RED.search.show(t.id)})).text(t.users.length).appendTo(r),RED.popover.tooltip(r,RED._("editor.nodesUse",{count:t.users.length})),0===t.users.length&&a.addClass("red-ui-palette-node-config-unused")}a.on("click",(function(i){i.stopPropagation(),RED.view.select(!1),i.metaKey?$(this).toggleClass("selected"):($(e).find(".red-ui-palette-node").removeClass("selected"),$(this).addClass("selected")),RED.sidebar.info.refresh(t)})),a.on("dblclick",(function(e){e.stopPropagation(),RED.editor.editConfig("",t.type,t.id)}));var s=t.users.map((function(e){return e.id}));a.on("mouseover",(function(e){RED.nodes.eachNode((function(e){-1!=s.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)})),RED.view.redraw()})),a.on("mouseout",(function(e){RED.nodes.eachNode((function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)})),RED.view.redraw()}))})),o.open(!0)}}function l(){var e={global:!0};s("global",i),RED.nodes.eachWorkspace((function(t){e[t.id.replace(/\./g,"-")]=!0,s(t.id,o,t.label)})),RED.nodes.eachSubflow((function(t){e[t.id.replace(/\./g,"-")]=!0,s(t.id,n,t.name)})),$(".red-ui-sidebar-config-category").each((function(){var t=$(this).attr("id").substring(31);e[t]||($(this).remove(),delete r[t])}));var t=[],a={};for(var l in RED.nodes.eachConfig((function(e){e.z?(a[e.z.replace(/\./g,"-")]=a[e.z.replace(/\./g,"-")]||[],a[e.z.replace(/\./g,"-")].push(e)):e.z||t.push(e)})),e)e.hasOwnProperty(l)&&d(l,a[l]||[]);d("global",t)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:e,toolbar:t,iconClass:"fa fa-cog",action:"core:show-config-tab",onchange:function(){l()}}),RED.actions.add("core:show-config-tab",(function(){RED.sidebar.show("config")})),RED.actions.add("core:select-all-config-nodes",(function(){$(e).find(".red-ui-palette-node").addClass("selected")})),RED.actions.add("core:delete-config-selection",(function(){var t=[];if($(e).find(".red-ui-palette-node.selected").each((function(){t.push($(this).parent().data("node"))})),t.length>0){var i={t:"delete",nodes:[],changes:{},dirty:RED.nodes.dirty()};t.forEach((function(e){var t=RED.nodes.node(e);try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}i.nodes.push(t);for(var o=0;o<t.users.length;o++){var n=t.users[o];for(var a in i.changes[n.id]={changed:n.changed,valid:n.valid},n._def.defaults)n._def.defaults.hasOwnProperty(a)&&n[a]==e&&(i.changes[n.id][a]=e,n[a]="",n.changed=!0,n.dirty=!0);RED.editor.validateNode(n)}RED.nodes.remove(e)})),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(i)}})),RED.events.on("view:selection-changed",(function(){$(e).find(".red-ui-palette-node").removeClass("selected")})),$("#red-ui-sidebar-config-collapse-all").on("click",(function(e){for(var t in e.preventDefault(),r)r.hasOwnProperty(t)&&r[t].close()})),$("#red-ui-sidebar-config-expand-all").on("click",(function(e){for(var t in e.preventDefault(),r)r.hasOwnProperty(t)&&r[t].size()>0&&r[t].open()})),$("#red-ui-sidebar-config-filter-all").on("click",(function(e){e.preventDefault(),a&&($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-unused").removeClass("selected"),a=!a,l())})),$("#red-ui-sidebar-config-filter-unused").on("click",(function(e){e.preventDefault(),a||($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-all").removeClass("selected"),a=!a,l())})),RED.popover.tooltip($("#red-ui-sidebar-config-filter-all"),RED._("sidebar.config.showAllUnusedConfigNodes")),RED.popover.tooltip($("#red-ui-sidebar-config-filter-unused"),RED._("sidebar.config.showAllUnusedConfigNodes"))},show:function(e){"boolean"==typeof e&&(e?$("#red-ui-sidebar-config-filter-unused").trigger("click"):$("#red-ui-sidebar-config-filter-all").trigger("click")),l(),"string"==typeof e&&($("#red-ui-sidebar-config-filter-all").trigger("click"),e=e.replace(/\./g,"-"),setTimeout((function(){var t=$(".red-ui-palette-node_id_"+e),i=t.position().top,o=t.height(),n=$(".red-ui-sidebar-node-config"),a=n.height();i+o>a?n.animate({scrollTop:"-="+(a-(i+o)-30)},150):i<0&&n.animate({scrollTop:"+="+(i-10)},150);var r=21,s=function(){r%2==0?t.removeClass("node_highlighted"):t.addClass("node_highlighted"),--r>=0&&setTimeout(s,100)};s()}),100)),RED.sidebar.show("config")},refresh:l}}(),RED.sidebar.context=function(){var e,t,i,o,n,a,r,s,d;function l(e,t){s=e,t||o.prop("checked")?e?p(n,"context/node/"+e.id,e.id):p(n):($(n.table).empty(),e?$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(n.table).i18n():$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(n.table).i18n(),n.timestamp.html("&nbsp;"))}function c(e,t){d=e,t||i.prop("checked")?e?p(a,"context/flow/"+e.id,e.id):p(a):($(a.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(a.table).i18n(),a.timestamp.html("&nbsp;"))}function p(e,t,i){var o=e.table;i?function(e,t,i){var o=RED.settings.context.stores,n=e.table;$.getJSON(t,(function(a){$(n).empty();var r={};for(var s in a)if(a.hasOwnProperty(s))for(var d in a[s])a[s].hasOwnProperty(d)&&(r.hasOwnProperty(d)||(r[d]=[]),a[s][d].store=s,r[d].push(a[s][d]));var l=Object.keys(r);l.sort();for(var c=l.length,p=0;p<c;p++)r[l[p]].forEach((function(e){var a=l[p],s=(r[a].length,$('<tr class="red-ui-help-info-row"><td class="red-ui-sidebar-context-property"></td><td></td></tr>').appendTo(n));$(s.children()[0]).text(a);var d=$('<span class="button-group"></span>'),c=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(d).on("click",(function(o){o.preventDefault(),o.stopPropagation(),$.getJSON(t+"/"+a+"?store="+e.store,(function(e){e.msg===f&&e.format===h||(f=e.msg,h=e.format,d.detach(),$(s.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(f,h),{typeHint:e.format,sourceId:i+"."+a,tools:d,path:""}).appendTo(s.children()[1]))}))}));RED.popover.tooltip(c,RED._("sidebar.context.refrsh"));var u=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(d).on("click",(function(o){o.preventDefault(),o.stopPropagation();var r=RED.popover.create({trigger:"modal",target:s,direction:"left",content:function(){var o=$("<div>");$('<p data-i18n="sidebar.context.deleteConfirm"></p>').appendTo(o);var l=$("<p>").appendTo(o),c=$('<span class="button-group"></span>').appendTo(l);return $('<button class="red-ui-button" data-i18n="common.label.cancel"></button>').appendTo(c).on("click",(function(e){e.preventDefault(),r.close()})),c=$('<span class="button-group"></span>').appendTo(l),$('<button class="red-ui-button primary" data-i18n="common.label.delete"></button>').appendTo(c).on("click",(function(o){o.preventDefault(),r.close(),$.ajax({url:t+"/"+a+"?store="+e.store,type:"DELETE"}).done((function(o,r,l){$.getJSON(t+"/"+a+"?store="+e.store,(function(e){"undefined"===e.format?(s.remove(),0===n.children().length&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(n).i18n()):(f=e.msg,h=e.format,d.detach(),$(s.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(f,h),{typeHint:e.format,sourceId:i+"."+a,tools:d,path:""}).appendTo(s.children()[1]))}))})).fail((function(e,t,i){}))})),o.i18n()}});r.open()}));RED.popover.tooltip(u,RED._("sidebar.context.delete"));var f=e.msg,h=e.format;RED.utils.createObjectElement(RED.utils.decodeObject(f,h),{typeHint:e.format,sourceId:i+"."+a,tools:d,path:""}).appendTo(s.children()[1]),o.length>1&&$("<span>",{class:"red-ui-sidebar-context-property-storename"}).text(e.store).appendTo($(s.children()[0]))}));0===c&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(n).i18n(),$(e.timestamp).text((new Date).toLocaleString())}))}(e,t,i):($(o).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(o).i18n())}function u(){RED.sidebar.show("context")}return{init:function(){(e=$("<div>").css({position:"relative",height:"100%"})).className="red-ui-sidebar-context";var f=$("<div></div>"),h=$("<div>",{class:"red-ui-sidebar-context-stack"}).appendTo(e);t=RED.stack.create({container:h}),(n=t.add({title:RED._("sidebar.context.node"),collapsible:!0})).expand(),n.content.css({height:"100%"}),n.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(n.content);var g=$('<table class="red-ui-info-table"></table>').appendTo(n.content);n.table=$("<tbody>").appendTo(g);var v=$('<div style="float: right"></div>').appendTo(n.header),b=RED.settings.get("editor.context.nodeRefresh",!1);o=$('<input type="checkbox">').prop("checked",b).appendTo(v).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",(function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)})),RED.popover.tooltip(o.next(),RED._("sidebar.context.autoRefresh"));var m=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(v).on("click",(function(e){e.stopPropagation(),e.preventDefault(),l(s,!0)}));RED.popover.tooltip(m,RED._("sidebar.context.refrsh")),(a=t.add({title:RED._("sidebar.context.flow"),collapsible:!0})).expand(),a.content.css({height:"100%"}),a.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(a.content),g=$('<table class="red-ui-info-table"></table>').appendTo(a.content),a.table=$("<tbody>").appendTo(g),v=$('<div style="float: right"></div>').appendTo(a.header);var y=RED.settings.get("editor.context.flowRefresh",!1);i=$('<input type="checkbox">').prop("checked",y).appendTo(v).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",(function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)})),RED.popover.tooltip(i.next(),RED._("sidebar.context.autoRefresh"));var w=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(v).on("click",(function(e){e.stopPropagation(),e.preventDefault(),c(d,!0)}));RED.popover.tooltip(w,RED._("sidebar.context.refrsh")),(r=t.add({title:RED._("sidebar.context.global"),collapsible:!0})).expand(),r.content.css({height:"100%"}),r.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(r.content),g=$('<table class="red-ui-info-table"></table>').appendTo(r.content),r.table=$("<tbody>").appendTo(g),v=$('<div style="float: right"></div>').appendTo(r.header),$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(v).on("click",(function(e){e.stopPropagation(),e.preventDefault(),p(r,"context/global","global")})),RED.popover.tooltip(v,RED._("sidebar.context.refrsh")),RED.actions.add("core:show-context-tab",u),RED.sidebar.addTab({id:"context",label:RED._("sidebar.context.label"),name:RED._("sidebar.context.name"),iconClass:"fa fa-database",content:e,toolbar:f,enableOnEdit:!0,action:"core:show-context-tab"}),RED.events.on("view:selection-changed",(function(e){l(e.nodes&&1===e.nodes.length&&e.nodes[0])})),RED.events.on("workspace:change",(function(e){c(RED.nodes.workspace(e.workspace))})),$(r.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(r.table).i18n(),r.timestamp.html("&nbsp;")}}}(),RED.palette.editor=function(){var e,t,i,o,n,a,r=[],s=[],d={},l={},c={},p={},u="";function f(e,t){var i=Date.now()-e;i=i<300?300:0,setTimeout((function(){t()}),i)}function h(e,t,i,o){i.show();var n=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done((function(e,t,a){f(n,(function(){i.hide(),o()}))})).fail((function(e,t,a){f(n,(function(){i.hide(),o(e)}))}))}function g(e,t,i,o){var n={module:e};t&&(n.version=t),i&&(n.url=i),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"}).done((function(e,t,i){o()})).fail((function(e,t,i){o(e)}))}function v(e){p.hasOwnProperty(e)||(p[e]=setTimeout((function(){delete p[e],m(e)}),100))}function b(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var i=parseInt(t[1]),o=parseInt(t[2]),n=parseInt(t[3]);if((299*i+587*o+114*n)/1e3>160)return"rgb("+(i=Math.floor(.8*i))+","+(o=Math.floor(.8*o))+","+(n=Math.floor(.8*n))+")"}return e}function m(e){if(c.hasOwnProperty(e)){var t=c[e].info,i=c[e].elements;if(i){var n=0,a=0,r=0;for(var s in i.errorList.empty(),c[e].totalUseCount=0,c[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(s)){var p=0,u=t.sets[s],f=i.sets[s];if(u.err){r++;var h=u.err;u.err.message&&(h=u.err.message),$("<li>").text(h).appendTo(i.errorList)}u.enabled&&(n+=u.types.length),a+=u.types.length;for(var g=0;g<t.sets[s].types.length;g++){var v=t.sets[s].types[g];p+=l[v]||0;var m=f.swatches[v];if(u.enabled){var y=RED.nodes.getType(v);y&&y.color&&(m.css({background:RED.utils.getNodeColor(v,y)}),m.css({border:"1px solid "+b(m.css("backgroundColor"))}))}}c[e].setUseCount[s]=p,c[e].totalUseCount+=p,p>0?(f.enableButton.text(RED._("palette.editor.inuse")),f.enableButton.addClass("disabled")):(f.enableButton.removeClass("disabled"),u.enabled?f.enableButton.text(RED._("palette.editor.disable")):f.enableButton.text(RED._("palette.editor.enable"))),f.setRow.toggleClass("red-ui-palette-module-set-disabled",!u.enabled)}0===r?i.errorRow.hide():i.errorRow.show();var w=n===a?a:n+" / "+a;i.setCount.text(RED._("palette.editor.nodeCount",{count:a,label:w})),c[e].totalUseCount>0?(i.enableButton.text(RED._("palette.editor.inuse")),i.enableButton.addClass("disabled"),i.removeButton.hide()):(i.enableButton.removeClass("disabled"),t.local&&i.removeButton.css("display","inline-block"),0===n?i.enableButton.text(RED._("palette.editor.enableall")):i.enableButton.text(RED._("palette.editor.disableall")),i.container.toggleClass("disabled",0===n))}t.pending_version?(i.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(i.metaRow),i.updateButton.text(RED._("palette.editor.updated")).addClass("disabled").css("display","inline-block")):d.hasOwnProperty(e)&&1===function(e,t){for(var i=e.split(".").map((function(e){return parseInt(e)})),o=t.split(".").map((function(e){return parseInt(e)})),n=0;n<3;n++){var a=i[n]-o[n];if(a<0)return-1;if(a>0)return 1}return 0}(d[e].version,t.version)?(i.updateButton.show(),i.updateButton.text(RED._("palette.editor.update",{version:d[e].version}))):i.updateButton.hide()}else{c[e]={info:RED.nodes.registry.getModule(e)};var E=[e];for(var D in c[e].info.sets)c[e].info.sets.hasOwnProperty(D)&&(E.push(D),E=E.concat(c[e].info.sets[D].types));c[e].index=E.join(",").toLowerCase(),o.editableList("addItem",c[e])}}var y,w,E=[],D=!1,R=T;function x(e,t,o,n){if(E.push(e||n),e?D=!0:(n.modules&&(n.modules.forEach((function(e){d[e.id]=e,e.index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.types&&(e.index=e.index.concat(e.types)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()})),r=r.concat(n.modules)),i.searchBox("count",r.length)),a>1&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+E.length+"/"+a),E.length===a){D&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var s=250-(Date.now()-y);setTimeout((function(){$("#red-ui-palette-module-install-shade").hide()}),Math.max(s,0))}}function _(){if(0===r.length){r=[],d={},n.editableList("empty"),$(".red-ui-palette-module-shade-status").text(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];E=[],D=!1,a=e.length,e.length>1&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#red-ui-palette-module-install-shade").show(),y=Date.now();var t=0;e.forEach((function(e,o){$.getJSON(e,{_:(new Date).getTime()},(function(t){x(null,e,0,t),function(){for(var e in c)c.hasOwnProperty(e)&&m(e)}()})).fail((function(t,i,o){console.warn("Error loading catalog",e,":",o),x(t,e)})).always((function(){++t===a&&i.searchBox("change")}))}))}}function k(){if(n.editableList("empty"),""!==i.searchBox("value").trim()){s.sort(R);for(var e=0;e<Math.min(10,s.length);e++)n.editableList("addItem",s[e]);0===s.length&&n.editableList("addItem",{}),s.length>10&&n.editableList("addItem",{start:10,more:s.length-10})}else n.editableList("addItem",{count:r.length})}function T(e,t){var o=i.searchBox("value").trim();if(""===o)return C(e,t);var n=e.info.index.indexOf(o)-t.info.index.indexOf(o);return 0===n?C(e,t):n}function C(e,t){return e.info.id.localeCompare(t.info.id)}function j(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function L(){return _(),e.activateTab("nodes"),w}function O(e,t,i){if(!1!==RED.settings.theme("palette.editable")){var o=[{text:RED._("common.label.cancel"),click:function(){n.close()}}];e.url&&o.push({text:RED._("palette.editor.confirm.button.review"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var t=e.url||"";window.open(t)}}),o.push({text:RED._("palette.editor.confirm.button.install"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var o=RED.utils.addSpinnerOverlay(t,!0),a=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(a).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+e.id+" "+e.version),g(e.id,e.version,e.pkg_url,(function(t){if(o.remove(),t&&t.responseJSON)var n=RED.notify(RED._("palette.editor.errors.installFailed",{module:e.id,message:t.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){n.close()}},{text:RED._("eventLog.view"),click:function(){n.close(),RED.actions.invoke("core:show-event-log")}}]});i(t)})),n.close()}});var n=RED.notify(RED._("palette.editor.confirm.install.body",{module:e.id}),{modal:!0,fixed:!0,buttons:o})}else i(new Error("Palette not editable"))}return{init:function(){!1!==RED.settings.theme("palette.editable")&&(!function(){w=$('<div id="red-ui-settings-tab-palette"></div>');var a=$('<div id="red-ui-palette-editor"><ul id="red-ui-palette-editor-tabs"></ul></div>').appendTo(w);e=RED.tabs.create({element:w.find("#red-ui-palette-editor-tabs"),onchange:function(e){a.find(".red-ui-palette-editor-tab").hide(),e.content.show(),t&&t.searchBox("value",""),i&&i.searchBox("value",""),"install"===e.id?i&&i.trigger("focus"):t&&t.trigger("focus")},minimumActiveTabWidth:110}),function(i){var n=$("<div>",{class:"red-ui-palette-editor-tab"}).appendTo(i);e.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:n});var a=$("<div>",{class:"red-ui-palette-search"}).appendTo(n);t=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(a).searchBox({delay:200,change:function(){!function(e){u=e.toLowerCase();var i=o.editableList("filter"),n=o.editableList("length");""===e?t.searchBox("count"):t.searchBox("count",i+" / "+n)}($(this).val())}}),o=$("<ol>",{id:"red-ui-palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(n).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===u||(""===u||e.index.indexOf(u)>-1)},addItem:function(e,t,i){var o=i.info;if(o){var n=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(e),a=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(n);$("<span>").text(o.name).appendTo(a);var r=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(n),s=$("<span>").text(o.version).appendTo(r),l=$('<div class="red-ui-palette-module-meta red-ui-palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(n),c=$('<ul class="red-ui-palette-module-error-list"></ul>').appendTo(l),p=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(n),u=$('<a href="#" class="red-ui-button red-ui-button-small red-ui-palette-module-set-button"><i class="fa fa-angle-right red-ui-palette-module-node-chevron"></i> </a>').appendTo(p),f=$("<span>").appendTo(u),b=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(p),m=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.update")).appendTo(b);m.attr("id","up_"+Math.floor(1e9*Math.random())),m.on("click",(function(t){t.preventDefault(),$(this).hasClass("disabled")||function(e,t,i,o,n){if(!1===RED.settings.theme("palette.editable"))return void n(new Error("Palette not editable"));var a=RED.notify(RED._("palette.editor.confirm.update.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary red-ui-palette-module-install-confirm-button-update",click:function(){var r=RED.utils.addSpinnerOverlay(o,!0),s=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(r);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(s).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+e.name+" "+t),g(e.name,t,i,(function(t){if(r.remove(),t&&t.responseJSON)var i=RED.notify(RED._("palette.editor.errors.updateFailed",{module:e.name,message:t.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){i.close()}},{text:RED._("eventLog.view"),click:function(){i.close(),RED.actions.invoke("core:show-event-log")}}]});n(t)})),a.close()}}]})}(o,d[o.name].version,d[o.name].pkg_url,e,(function(e){}))}));var y=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.remove")).appendTo(b);y.attr("id","up_"+Math.floor(1e9*Math.random())),y.on("click",(function(t){t.preventDefault(),function(e,t,i){if(!1===RED.settings.theme("palette.editable"))return void i(new Error("Palette not editable"));var o=RED.notify(RED._("palette.editor.confirm.remove.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary red-ui-palette-module-install-confirm-button-remove",click:function(){var i=RED.utils.addSpinnerOverlay(t,!0),n=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(i);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(n).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.remove")+" : "+e.name),function(e,t){$.ajax({url:"nodes/"+e,type:"DELETE"}).done((function(e,i,o){t()})).fail((function(e,i,o){t(e)}))}(e.name,(function(t){if(i.remove(),t&&t.responseJSON)var o=RED.notify(RED._("palette.editor.errors.removeFailed",{module:e.name,message:t.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){o.close()}},{text:RED._("eventLog.view"),click:function(){o.close(),RED.actions.invoke("core:show-event-log")}}]})})),o.close()}}]})}(o,e,(function(e){}))})),o.local||y.hide();var w=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.disableall")).appendTo(b),E=$("<div>",{class:"red-ui-palette-module-content"}).appendTo(e),D=$('<div class="red-ui-palette-module-shade hide"><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(e);i.elements={updateButton:m,removeButton:y,enableButton:w,errorRow:l,errorList:c,setCount:f,container:e,shade:D,versionSpan:s,sets:{}},u.on("click",(function(t){t.preventDefault(),e.hasClass("expanded")?(e.removeClass("expanded"),E.slideUp()):(e.addClass("expanded"),E.slideDown())}));var R=Object.keys(o.sets);R.sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})),R.forEach((function(e){var t=o.sets[e],n=$("<div>",{class:"red-ui-palette-module-set"}).appendTo(E),a=$("<div>",{class:"red-ui-palette-module-set-button-group"}).appendTo(n),r={};t.types.forEach((function(e){var t=$("<div>",{class:"red-ui-palette-module-type"}).appendTo(n);r[e]=$("<span>",{class:"red-ui-palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"red-ui-palette-module-type-node"}).text(e).appendTo(t)}));var s=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').appendTo(a);s.on("click",(function(o){if(o.preventDefault(),0===i.setUseCount[e]){var n=RED.nodes.registry.getNodeSet(t.id);D.show();var a=!n.enabled;h(t.id,a,D,(function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(a?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))}))}})),i.elements.sets[t.name]={setRow:n,enableButton:s,swatches:r}})),w.on("click",(function(t){t.preventDefault(),0===i.totalUseCount&&h(o.name,e.hasClass("disabled"),D,(function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))}))})),v(o.name)}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}})}(a),function(t){var o=$("<div>",{class:"red-ui-palette-editor-tab hide"}).appendTo(t);e.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:o});var a=$("<div>",{class:"red-ui-palette-editor-toolbar"}).appendTo(o),l=$("<div>",{class:"red-ui-palette-search"}).appendTo(o);i=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(l).searchBox({delay:300,change:function(){var e=$(this).val().trim().toLowerCase();e.length>0?(s=r.filter((function(t){return t.index.indexOf(e)>-1})).map((function(e){return{info:e}})),k(),i.searchBox("count",s.length+" / "+r.length)):(i.searchBox("count",r.length),n.editableList("empty"),n.editableList("addItem",{count:r.length}))}}),$("<span>").text(RED._("palette.editor.sort")+" ").appendTo(a);var p=$('<span class="button-group"></span>').appendTo(a),u=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle selected"><i class="fa fa-sort-amount-desc"></i></a>').appendTo(p),f=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortAZ"></a>').appendTo(p),h=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(p);[{button:u,func:T},{button:f,func:C},{button:h,func:j}].forEach((function(e){e.button.on("click",(function(t){t.preventDefault(),$(this).hasClass("selected")||($(".red-ui-palette-editor-install-sort-option").removeClass("selected"),$(this).addClass("selected"),R=e.func,k())}))}));var g=$("<span>").appendTo(a),v=$('<a href="#" class="red-ui-sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(g);if(v.on("click",(function(e){e.preventDefault(),r=[],d={},_()})),RED.popover.tooltip(v,RED._("palette.editor.refresh")),n=$("<ol>",{style:"position: absolute;top: 79px;bottom: 0;left: 0;right: 0px;"}).appendTo(o).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){if(i.count)$("<div>",{class:"red-ui-search-empty"}).text(RED._("palette.editor.moduleCount",{count:i.count})).appendTo(e);else if(i.more){e.addClass("red-ui-palette-module-more");var o=$("<div>",{class:"red-ui-palette-module-header palette-module"}).appendTo(e);$('<a href="#"></a>').text(RED._("palette.editor.more",{count:i.more})).appendTo(o).on("click",(function(e){e.preventDefault(),n.editableList("removeItem",i);for(var t=i.start;t<Math.min(i.start+10,i.start+i.more);t++)n.editableList("addItem",s[t]);i.more>10&&n.editableList("addItem",{start:i.start+10,more:i.more-10})}))}else if(i.info){var a=i.info,r=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(e),d=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(r);$("<span>").text(a.name||a.id).appendTo(d),$('<a target="_blank" class="red-ui-palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",a.url).appendTo(d);var l=$('<div class="red-ui-palette-module-meta"></div>').appendTo(r);$("<div>",{class:"red-ui-palette-module-description"}).text(a.description).appendTo(l);var p=$('<div class="red-ui-palette-module-meta"></div>').appendTo(r);$('<span class="red-ui-palette-module-version"><i class="fa fa-tag"></i> '+a.version+"</span>").appendTo(p),$('<span class="red-ui-palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var i=Math.floor(t/7);if(i<4)return RED._("palette.editor.times.weeksV",{count:i});var o=Math.floor(i/4);if(i%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var n=Math.floor(o/12);return 0==(o%=12)?RED._("palette.editor.times.yearsV",{count:n}):RED._("palette.editor.times.year"+(n>1?"s":"")+"MonthsV",{y:n,count:o})}(a.updated_at)+"</span>").appendTo(p);var u=!1;if(a.types&&a.types.length>0)for(t=0;t<a.types.length;t++){var f=RED.nodes.registry.getNodeSetForType(a.types[t]);if(f){u=f.module;break}}var h=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(r),g=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(h),v=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.install")).appendTo(g);v.on("click",(function(t){t.preventDefault(),$(this).hasClass("disabled")||O(a,e,(function(e){}))})),c.hasOwnProperty(a.id)?(v.addClass("disabled"),v.text(RED._("palette.editor.installed"))):u&&(v.addClass("disabled"),v.text(RED._("palette.editor.conflict")),RED.popover.create({target:v,content:RED._("palette.editor.conflictTip",{module:u}),trigger:"hover",direction:"bottom",delay:{show:750,hide:50}})),i.elements={installButton:v}}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}}),!1!==RED.settings.theme("palette.upload")){var b=$('<span class="button-group">').prependTo(a),m=$('<button type="button" class="red-ui-sidebar-header-button red-ui-palette-editor-upload-button"><label><i class="fa fa-upload"></i><form id="red-ui-palette-editor-upload-form" enctype="multipart/form-data"><input name="tarball" type="file" accept=".tgz"></label></button>').appendTo(b),y=m.find('input[type="file"]');y.on("change",(function(e){this.files.length>0&&(x.text(this.files[0].name),w.slideDown(200))}));var w=$('<div class="red-ui-palette-editor-upload"></div>').appendTo(o),E=$("<div>").appendTo(w),D=$('<div class="placeholder-input"><i class="fa fa-upload"></i> </div>').appendTo(E),x=$("<span></span>").appendTo(D),L=$('<div class="red-ui-palette-editor-upload-buttons"></div>').appendTo(E);$('<button class="editor-button"></button>').text(RED._("common.label.cancel")).appendTo(L).on("click",(function(e){e.preventDefault(),w.slideUp(200),y.val("")})),$('<button class="editor-button primary"></button>').text(RED._("common.label.upload")).appendTo(L).on("click",(function(e){e.preventDefault();var t=RED.utils.addSpinnerOverlay(w,!0),i=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(t);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(i).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")})),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+y[0].files[0].name);var o=new FormData;o.append("tarball",y[0].files[0]);var n=y[0].files[0].name;$.ajax({url:"nodes",data:o,cache:!1,contentType:!1,processData:!1,method:"POST"}).always((function(e,i,o){t.remove(),y.val(""),w.slideUp(200)})).fail((function(e,t,i){var o=t;e.responseJSON&&(o=e.responseJSON.message);var a=RED.notify(RED._("palette.editor.errors.installFailed",{module:n,message:o}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){a.close()}},{text:RED._("eventLog.view"),click:function(){a.close(),RED.actions.invoke("core:show-event-log")}}]});y.val(""),w.slideUp(200)}))})),RED.popover.tooltip(m,RED._("palette.editor.upload"))}$('<div id="red-ui-palette-module-install-shade" class="red-ui-palette-module-shade hide"><div class="red-ui-palette-module-shade-status"></div><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(o)}(a)}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:L,close:function(){w.detach()},focus:function(){e.resize(),setTimeout((function(){t.trigger("focus")}),200)}}),RED.actions.add("core:manage-palette",(function(){RED.userSettings.show("palette")})),RED.events.on("registry:module-updated",(function(e){v(e.module)})),RED.events.on("registry:node-set-enabled",(function(e){v(e.module)})),RED.events.on("registry:node-set-disabled",(function(e){v(e.module)})),RED.events.on("registry:node-type-added",(function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)})),RED.events.on("registry:node-type-removed",(function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)})),RED.events.on("registry:node-set-added",(function(e){v(e.module);for(var t=0;t<s.length;t++)if(s[t].info.id===e.module){var i=s[t].elements.installButton;i.addClass("disabled"),i.text(RED._("palette.editor.installed"));break}})),RED.events.on("registry:node-set-removed",(function(e){if(!RED.nodes.registry.getModule(e.module)){var t=c[e.module];if(t){o.editableList("removeItem",t),delete c[e.module];for(var i=0;i<s.length;i++)if(s[i].info.id===e.module){var n=s[i].elements.installButton;n.removeClass("disabled"),n.text(RED._("palette.editor.install"));break}}}})),RED.events.on("nodes:add",(function(e){/^subflow:/.test(e.type)||(l[e.type]=(l[e.type]||0)+1,1===l[e.type]&&v(RED.nodes.registry.getNodeSetForType(e.type).module))})),RED.events.on("nodes:remove",(function(e){l.hasOwnProperty(e.type)&&(l[e.type]--,0===l[e.type]&&(delete l[e.type],v(RED.nodes.registry.getNodeSetForType(e.type).module)))})))},install:O}}(),RED.editor=function(){var e=[],t={},i={};function o(e,t){return"credentials/"+e.replace(/\s+/g,"-")+"/"+t}function n(e){var t,i,o,r,s=e.valid,d=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))i=(t=RED.nodes.subflow(e.type.substring(8))).valid,r=t.changed,void 0===i&&(i=n(t),r=t.changed),o=a(e,e._def.defaults,e),e.valid=i&&0===o.length,e.changed=e.changed||r,e.validationErrors=o;else if(e._def)o=a(e,e._def.defaults,e),e._def._creds&&(o=o.concat(a(e,e._def.credentials,e._def._creds))),e.valid=0===o.length,e.validationErrors=o;else if("subflow"==e.type){for(var l=RED.nodes.filterNodes({z:e.id}),c=0;c<l.length;c++)i=l[c].valid,r=l[c].changed,void 0===i&&(i=n(l[c]),r=l[c].changed),e.valid=e.valid&&i,e.changed=e.changed||r;var p=RED.nodes.filterNodes({type:"subflow:"+e.id}),u={};for(c=0;c<p.length;c++)p[c].valid=e.valid,p[c].changed=p[c].changed||e.changed,p[c].dirty=!0,u[p[c].z]=!0;Object.keys(u).forEach((function(e){var t=RED.nodes.subflow(e);t&&n(t)}))}return s===e.valid&&d===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&n(t)),e.valid}function a(e,t,i){var o=[];for(var n in t)t.hasOwnProperty(n)&&(r(e,t,n,i[n])||o.push(n));return o}function r(e,t,i,o){var n=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if(/^\$\{[a-zA-Z_][a-zA-Z0-9_]*\}$/.test(o))return!0;if("required"in t[i]&&t[i].required&&(n=""!==o),n&&"validate"in t[i])try{n=t[i].validate.call(e,o)}catch(t){console.log("Validation error:",e.type,e.id,"property: "+i,"value:",o,t)}if(n&&t[i].type&&RED.nodes.getType(t[i].type)&&!("validate"in t[i]))if(o&&"_ADD_"!=o){var a=RED.nodes.node(o);n=null!==a&&(null==a.valid||a.valid)}else n=t[i].hasOwnProperty("required")&&!t[i].required;return n}function s(e,t){for(var i in e._def.defaults)e._def.defaults.hasOwnProperty(i)&&d(e,e._def.defaults,i,t);if(e._def.credentials)for(i in e._def.credentials)e._def.credentials.hasOwnProperty(i)&&d(e,e._def.credentials,i,t)}function d(e,t,i,o){var n=$("#"+o+"-"+i);if(n.length>0){var a=n.val();t[i].hasOwnProperty("format")&&""!==t[i].format&&"DIV"===n[0].nodeName&&(a=n.text()),r(e,t,i,a)?n.removeClass("input-error"):n.addClass("input-error")}}function l(e,t){e.resize=!0,e.dirty=!0,e.dirtyStatus=!0;var i=[];t&&RED.nodes.eachLink((function(o){o.source===e&&t.hasOwnProperty(o.sourcePort)&&("-1"===t[o.sourcePort]?i.push(o):o.sourcePort=t[o.sourcePort])})),e.hasOwnProperty("__outputs")&&(e.outputs<e.__outputs&&RED.nodes.eachLink((function(t){t.source===e&&t.sourcePort>=e.outputs&&-1===i.indexOf(t)&&i.push(t)})),delete e.__outputs),e.inputs=Math.min(1,Math.max(0,parseInt(e.inputs))),isNaN(e.inputs)&&(e.inputs=0),0===e.inputs&&(i=i.concat(RED.nodes.filterLinks({target:e})));for(var o=0;o<i.length;o++)RED.nodes.removeLink(i[o]);return i}function c(e,t,i,o){var n=$("#"+o+"-"+t);if(0!==n.length){var a,r=n.width(),s=n.attr("style");r=null!==(a=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(s))?a[1]:"70%";var d=$("<div></div>").css({display:"inline-block",position:"relative"}),l=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(d),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(l);d.width(r).height(n.height()),0===d.width()&&d.width("70%"),n.replaceWith(d),c.attr("style","width:100%"),C(t,i,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="red-ui-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(d),$("#"+o+"-lookup-"+t).on("click",(function(e){k(t,i,c.find(":selected").val(),o),e.preventDefault()}));var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(i);u&&(p=RED.utils.getNodeLabel(u,u.id)),n.val(p)}}function p(e,t,i,o){var n=$("#"+o+"-"+t);n.val(e[t]),n.attr("type","hidden");var a=$("<a>",{id:o+"-edit-"+t,class:"red-ui-button"});n.after(a),e[t]?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),a.on("click",(function(e){k(t,i,n.val()||"_ADD_",o),e.preventDefault()}))}function u(e,t,i,o){var n=$("#"+i+"-"+t);if(0!==n.length)if("checkbox"===n.attr("type"))n.prop("checked",e[t]);else{var a=e[t];null==a&&(a=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===n[0].nodeName?(n.html(RED.text.format.getHtml(a,o[t].format,{},!1,"en")),RED.text.format.attach(n[0],o[t].format,{},!1,"en")):(n.val(a),"INPUT"!==n[0].nodeName&&"TEXTAREA"!==n[0].nodeName||RED.text.bidi.prepareInput(n))}}function f(e,t,i,o){var n=$("#"+o+"-"+i);void 0!==t&&"format"in t[i]&&""!==t[i].format&&"DIV"===n[0].nodeName?$("#"+o+"-"+i).on("change keyup",(function(t,i){i||s(e,o)})):$("#"+o+"-"+i).on("change",(function(t,i){i||s(e,o)}))}function h(e,t,i,o){var n;for(n in t)t.hasOwnProperty(n)&&("password"==t[n].type?i[n]?$("#"+o+"-"+n).val(i[n]):i["has_"+n]?$("#"+o+"-"+n).val("__PWRD__"):$("#"+o+"-"+n).val(""):u(i,n,o,t),f(e,t,n,o))}function g(e,t,i){var o=!1;for(var n in e.credentials||(e.credentials={_:{}}),t)if(t.hasOwnProperty(n)){var a=$("#"+i+"-"+n).val();if("password"==t[n].type){if(e.credentials["has_"+n]=""!==a,"__PWRD__"==a)continue;o=!0}e.credentials[n]=a,a!=e.credentials._[n]&&(o=!0)}return o}function v(e,t,i,n){for(var a in t.defaults)if(t.defaults.hasOwnProperty(a)){if(t.defaults[a].type){var r=RED.nodes.getType(t.defaults[a].type);r?r.exclusive?p(e,a,t.defaults[a].type,i):c(e,a,t.defaults[a].type,i):(console.log("Unknown type:",t.defaults[a].type),u(e,a,i,t.defaults))}else u(e,a,i,t.defaults);f(e,t.defaults,a,i)}var d=function(){if(t.oneditprepare)try{t.oneditprepare.call(e)}catch(t){console.log("oneditprepare",e.id,e.type,t.toString())}for(var o in t.defaults)t.defaults.hasOwnProperty(o)&&$("#"+i+"-"+o).trigger("change",[!0]);if(t.credentials)for(o in t.credentials)t.credentials.hasOwnProperty(o)&&$("#"+i+"-"+o).trigger("change",[!0]);s(e,i),n&&n()};t.credentials||/^subflow:/.test(t.type)?e.credentials?(h(e,t.credentials,e.credentials,i),d()):$.getJSON(o(e.type,e.id),(function(o){e.credentials=o,e.credentials._=$.extend(!0,{},o),/^subflow:/.test(t.type)||h(e,t.credentials,e.credentials,i),d()})):d()}function b(){for(var t,i=e.length-1;i<e.length;i++){var o=e[i];if(t=o.type,"group"===o.type)t=RED._("group.editGroup",{name:RED.utils.sanitize(o.name||o.id)});else if("_expression"===o.type)t=RED._("expressionEditor.title");else if("_js"===o.type)t=RED._("jsEditor.title");else if("_text"===o.type)t=RED._("textEditor.title");else if("_json"===o.type)t=RED._("jsonEditor.title");else if("_markdown"===o.type)t=RED._("markdownEditor.title");else if("_buffer"===o.type)t=RED._("bufferEditor.title");else if("subflow"===o.type)t=RED._("subflow.editSubflow",{name:RED.utils.sanitize(o.name)});else if(0===o.type.indexOf("subflow:")){var n=RED.nodes.subflow(o.type.substring(8));t=RED._("subflow.editSubflowInstance",{name:RED.utils.sanitize(n.name)})}else if(void 0!==o._def){if(void 0!==o._def.paletteLabel)try{t=RED.utils.sanitize(("function"==typeof o._def.paletteLabel?o._def.paletteLabel.call(o._def):o._def.paletteLabel)||"")}catch(e){console.log("Definition error: "+o.type+".paletteLabel",e)}i===e.length-1&&(t=RED.nodes.node(o.id)?RED._("editor.editNode",{type:RED.utils.sanitize(t)}):RED._("editor.addNewConfig",{type:RED.utils.sanitize(t)}))}}return t}function m(e,t){return JSON.stringify(e)===JSON.stringify(t)}function y(e,t,i,o,n){var a=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return a.html($("script[data-template-name='"+i+"']").html()),o=o||"node-red",a.find("[data-i18n]").each((function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var i=e[t];if(-1===i.indexOf(":")){var n="";if(0===i.indexOf("[")){var a=i.split("]");n=a[0]+"]",i=a[1]}e[t]=n+o+":"+i}}$(this).attr("data-i18n",e.join(";"))})),"subflow-template"===i&&RED.subflow.buildEditForm(i,n),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-password" type="password"/></span>').prependTo(a),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-username"  type="text"/></span>').prependTo(a),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-user"  type="text"/></span>').prependTo(a),a.on("submit",(function(e){e.preventDefault()})),a.find("input").attr("autocomplete","off"),a}function w(e,t){var i,o=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),n=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),a=$("#red-ui-editor-node-label-form-inputs"),r=$("#red-ui-editor-node-label-form-outputs"),s=$("#node-input-inputs").val();void 0===s?i="subflow"===t.type?t.in.length:t.inputs||t._def.inputs||0:(i=Math.min(1,Math.max(0,parseInt(s))),isNaN(i)&&(i=0));var d,l,c=a.children(),p=c.length;if(1===p&&$(c[0]).hasClass("red-ui-editor-node-label-form-none")&&p--,p<i)for(0===p&&$(c[0]).remove(),l=p;l<i;l++)E("input",l,"",o).appendTo(a);else if(p>i){for(l=i;l<p;l++)$(c[l]).remove();0===i&&E().appendTo(a)}var u=$("#node-input-outputs").val();if(void 0===u)"subflow"===t.type?d=t.out.length:i=t.outputs||t._def.outputs||0;else if(isNaN(u)){var f=JSON.parse(u),h=Object.keys(f);c=r.children(),1===(p=c.length)&&$(c[0]).hasClass("red-ui-editor-node-label-form-none")&&p--,d=0;var g=[];h.forEach((function(e){var t=$("#red-ui-editor-node-label-form-output-"+e).parent();0===t.length&&-1!==f[e]?(0===p&&($(c[0]).remove(),p=-1),t=E("output",e,"",n)):t.detach(),-1!==f[e]&&(d++,g.push({i:parseInt(f[e]),r:t}))})),g.sort((function(e,t){return e.i-t.i})),g.forEach((function(e,t){e.r.find("label").text(t+1+"."),e.r.appendTo(r)})),0===g.length&&E("output",l,"").appendTo(r)}else d=Math.max(0,parseInt(u));if(c=r.children(),1===(p=c.length)&&$(c[0]).hasClass("red-ui-editor-node-label-form-none")&&p--,p<d)for(0===p&&$(c[0]).remove(),l=p;l<d;l++)E("output",l,"").appendTo(r);else if(p>d){for(l=d;l<p;l++)$(c[l]).remove();0===d&&E().appendTo(r)}}function E(e,t,i,o){var n=$("<div>",{class:"red-ui-editor-node-label-form-row"});if(void 0===e)$("<span>").text(RED._("editor.noDefaultLabel")).appendTo(n),n.addClass("red-ui-editor-node-label-form-none");else{n.addClass("");var a="red-ui-editor-node-label-form-"+e+"-"+t;$("<label>",{for:a}).text(t+1+".").appendTo(n);var r=$("<input>",{type:"text",id:a,placeholder:o}).val(i).appendTo(n);$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-times"></i></button>').appendTo(n).on("click",(function(e){e.preventDefault(),r.val("")}))}return n}function D(e,t,i,o,n){var a=$('<div class="red-ui-icon-picker">'),r=$("<div>",{class:"red-ui-search-container"}).appendTo(a);searchInput=$('<input type="text">').attr("placeholder",RED._("editor.searchIcons")).appendTo(r).searchBox({delay:50,change:function(){var e=$(this).val().trim();""===e?(s.find(".red-ui-icon-list-module").show(),s.find(".red-ui-icon-list-icon").show()):(s.find(".red-ui-icon-list-module").hide(),s.find(".red-ui-icon-list-icon").each((function(t,i){-1===$(i).data("icon").indexOf(e)?$(i).hide():$(i).show()})))}});$("<div>").appendTo(a);var s=$('<div class="red-ui-icon-list">').appendTo(a),d=$('<div class="red-ui-icon-meta"></div>').appendTo(a),l=$("<span>").appendTo(d);$('<button type="button" class="red-ui-button red-ui-button-small">'+RED._("editor.useDefault")+"</button>").appendTo(d).on("click",(function(e){e.preventDefault(),p.hide(),n(null)}));!t&&o&&s.addClass("red-ui-icon-list-dark"),setTimeout((function(){var e=RED.nodes.getIconSets();Object.keys(e).forEach((function(a){if(!o||"font-awesome"===a){var r=e[a];if(r.length>0){var d=$('<div class="red-ui-icon-list-module"></div>').text(a).appendTo(s);$('<i class="fa fa-cube"></i>').prependTo(d),r.forEach((function(e){var o=$("<div>",{class:"red-ui-icon-list-icon"}).appendTo(s),r=$("<div>",{class:"red-ui-search-result-node"}).appendTo(o),d=RED.settings.apiRootUrl+"icons/"+a+"/"+e;if(o.data("icon",d),t){r.css({backgroundColor:t});var c=RED.utils.getDarkerColor(t);c!==t&&r.css("border-color",c)}var u=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(r);RED.utils.createIconElement(d,u,!0),i.module===a&&i.file===e&&o.addClass("selected"),o.on("mouseover",(function(){l.text(e)})),o.on("mouseout",(function(){l.html("&nbsp;")})),o.on("click",(function(){p.hide(),n(a+"/"+e)}))}))}}})),setTimeout((function(){c.remove()}),50)}),300);var c=RED.utils.addSpinnerOverlay(s,!0),p=RED.popover.panel(a);p.show({target:e}),a.slideDown(100),searchInput.trigger("focus")}function R(e,t){var i,o=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e);if("subflow"===t.type){var n=$("<div/>",{class:"form-row"}).appendTo(o);$("<label/>",{for:"subflow-appearance-input-category","data-i18n":"editor:subflow.category"}).appendTo(n);var a=$("<select/>",{id:"subflow-appearance-input-category"}).css({width:"250px"}).appendTo(n);$("<input/>",{type:"text",id:"subflow-appearance-input-custom-category"}).css({display:"none","margin-left":"10px",width:"calc(100% - 250px)"}).appendTo(n);var r=RED.palette.getCategories();r.sort((function(e,t){return e.label.localeCompare(t.label)})),r.forEach((function(e){a.append($("<option/>").val(e.id).text(e.label))})),a.append($("<option/>").attr("disabled",!0).text("---")),a.append($("<option/>").val("_custom_").text(RED._("palette.addCategory"))),$("#subflow-appearance-input-category").on("change",(function(){"_custom_"===$(this).val()?($("#subflow-appearance-input-category").width(120),$("#subflow-appearance-input-custom-category").show()):($("#subflow-appearance-input-category").width(250),$("#subflow-appearance-input-custom-category").hide())})),$("#subflow-appearance-input-category").val(t.category||"subflows");t.id;$("#red-ui-editor-subflow-user-count").text(RED._("subflow.subflowInstances",{count:t.instances.length})).show()}if($('<div class="form-row"><label for="node-input-show-label-btn" data-i18n="editor.label"></label><span style="margin-right: 2px;"/><input type="checkbox" id="node-input-show-label"/></div>').appendTo(o),$("#node-input-show-label").toggleButton({enabledLabel:RED._("editor.show"),disabledLabel:RED._("editor.hide")}),t.hasOwnProperty("l")||(t.l=!/^link (in|out)$/.test(t._def.type)),$("#node-input-show-label").prop("checked",t.l).trigger("change"),"subflow"===t.type){var s=t.color?t.color:"#DDAA99",d=$("<div/>",{class:"form-row"}).appendTo(o);$("<label/>").text(RED._("editor.color")).appendTo(d);RED.colorPicker.create({id:"red-ui-editor-node-color",value:s,palette:["#DDAA99","#3FADB5","#87A980","#A6BBCF","#AAAA66","#C0C0C0","#C0DEED","#C7E9C0","#D7D7A0","#D8BFD8","#DAC4B4","#DEB887","#DEBD5C","#E2D96E","#E6E0F8","#E7E7AE","#E9967A","#F3B567","#FDD0A2","#FDF0C2","#FFAAAA","#FFCC66","#FFF0F0","#FFFFFF"],sortPalette:function(e,t){return e.l-t.l}}).appendTo(d),$("#red-ui-editor-node-color").on("change",(function(e){var t=$(this).val();p.css("backgroundColor",t);var i=RED.utils.getDarkerColor(t);i!==t&&p.css("border-color",i)}))}if(!t._def.defaults||!t._def.defaults.hasOwnProperty("icon")){var l=$('<div class="form-row"></div>').appendTo(o);$('<label data-i18n="editor.settingIcon">').appendTo(l);var c=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(l);$('<i class="fa fa-caret-down"></i>').appendTo(c);var p=$("<div>",{class:"red-ui-search-result-node"}).appendTo(c),u=RED.utils.getNodeColor(t.type,t._def),f=RED.utils.getNodeIcon(t._def,t);p.css("backgroundColor",u);var h=RED.utils.getDarkerColor(u);h!==u&&p.css("border-color",h);var g=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(p);RED.utils.createIconElement(f,g,!0),c.on("click",(function(e){var i;e.preventDefault();var o=$("#red-ui-editor-node-icon").val()||"";i=o?RED.utils.separateIconPath(o):RED.utils.getDefaultNodeIcon(t._def,t);var n=RED.utils.getNodeColor(t.type,t._def);"subflow"===t.type&&(n=$("#red-ui-editor-node-color").val()),D(c,n,i,!1,(function(e){$("#red-ui-editor-node-icon").val(e||"");var i=RED.utils.getNodeIcon(t._def,{type:t.type,icon:e});RED.utils.createIconElement(i,g,!0)}))})),RED.popover.tooltip(c,(function(){return $("#red-ui-editor-node-icon").val()||RED._("editor.default")})),$('<input type="hidden" id="red-ui-editor-node-icon">').val(t.icon).appendTo(l)}$('<div class="form-row"><span data-i18n="editor.portLabels"></span></div>').appendTo(o);var v=t.inputs||t._def.inputs||0,b=t.outputs||t._def.outputs||0;"subflow"===t.type&&(v=t.in.length,b=t.out.length);var m=t.inputLabels||[],y=t.outputLabels||[],w=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),R=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelInputs"></span><div id="red-ui-editor-node-label-form-inputs"></div></div>').appendTo(o);var x=$("#red-ui-editor-node-label-form-inputs");if(v>0)for(i=0;i<v;i++)E("input",i,m[i],w).appendTo(x);else E().appendTo(x);$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelOutputs"></span><div id="red-ui-editor-node-label-form-outputs"></div></div>').appendTo(o);var _=$("#red-ui-editor-node-label-form-outputs");if(b>0)for(i=0;i<b;i++)E("output",i,y[i],R).appendTo(_);else E().appendTo(_)}function x(e,t,i){var o=$("#red-ui-editor-node-label-form-inputs").children().find("input"),n=$("#red-ui-editor-node-label-form-outputs").children().find("input"),a=!1,r=!1,s=o.map((function(){var e=$(this).val();return a=a||""!==e,e})).toArray().slice(0,e.inputs);return(void 0===e.inputLabels&&a||void 0!==e.inputLabels&&JSON.stringify(s)!==JSON.stringify(e.inputLabels))&&(t.inputLabels=e.inputLabels,e.inputLabels=s,r=!0),a=!1,s=new Array(e.outputs),n.each((function(){var e=$(this).attr("id").substring(37);if(!i||!i.hasOwnProperty(e)||-1!==(e=parseInt(i[e]))){var t=$(this).val();a=a||""!==t,s[e]=t}})),(void 0===e.outputLabels&&a||void 0!==e.outputLabels&&JSON.stringify(s)!==JSON.stringify(e.outputLabels))&&(t.outputLabels=e.outputLabels,e.outputLabels=s,r=!0),r}function _(e,t){var i=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),o=($("<div></div>").appendTo(i),$('<div class="form-row node-text-editor-row" style="position:relative; padding-top: 4px; height: 100%"></div>').appendTo(i));$('<div style="height: 100%" class="node-text-editor" id="node-info-input-info-editor" ></div>').appendTo(o);var n=RED.editor.createEditor({id:"node-info-input-info-editor",mode:"ace/mode/markdown",value:""});return t.info&&n.getSession().setValue(t.info,-1),t.infoEditor=n,n}function k(t,i,o,a){var r,s,d="_ADD_"==o,l=RED.nodes.getType(i),c=RED.nodes.node(o),p=!1;s="node-red"===l.set.module?"node-red":l.set.id;var u="",f=RED.nodes.subflow(RED.workspaces.active());if(f&&(u=f.id),null==c){for(var h in c={id:RED.nodes.id(),_def:l,type:i,z:u,users:[]},l.defaults)l.defaults[h].value&&(c[h]=JSON.parse(JSON.stringify(l.defaults[h].value)));c._=l._}e.push(c),RED.view.state(RED.state.EDITING);var m={title:b(),resize:function(e){if($(".red-ui-tray-content").height(e.height-50),c&&c._def.oneditresize){var t=$("#node-config-dialog-edit-form");try{c._def.oneditresize.call(c,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",c.id,c.type,e.toString())}}},open:function(e,t){e.find(".red-ui-tray-header");var o=e.find(".red-ui-tray-body"),n=e.find(".red-ui-tray-footer"),a=$('<div class="red-ui-tray-footer-left"></div>').appendTo(n);$('<input id="node-config-input-node-disabled" type="checkbox">').prop("checked",!!c.d).appendTo(a).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0}),!1!==l.hasUsers&&$('<span><i class="fa fa-info-circle"></i> <span id="red-ui-editor-config-user-count"></span></span>').css("margin-left","10px").appendTo(a),n.append('<span class="red-ui-tray-footer-right"><span id="red-ui-editor-config-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="red-ui-editor-config-scope"></select></span>');var d=$("<ul></ul>").appendTo(o),u=$("<div></div>").appendTo(o),f=RED.tabs.create({element:d,onchange:function(e){u.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),p&&RED.tray.resize()},collapsible:!0,menu:!1}),h={id:"editor-tab-cproperties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(u).hide(),iconClass:"fa fa-cog"};if(f.addTab(h),y(h.content,"node-config-dialog-edit-form",i,s),!l.defaults||!l.defaults.hasOwnProperty("info")){var g={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(u).hide(),iconClass:"fa fa-file-text-o",onchange:function(){r.focus()}};f.addTab(g),r=_(g.content,c)}v(c,l,"node-config-input",(function(){c._def.exclusive?$("#red-ui-editor-config-scope").hide():$("#red-ui-editor-config-scope").show(),$("#red-ui-editor-config-scope-warning").hide();var e={};c.users.forEach((function(t){e[t.z]=!0}));var i=Object.keys(e).length,a=$("#red-ui-editor-config-scope").empty();a.off("change"),a.append('<option value=""'+(c.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),a.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace((function(t){var i=t.label;e[t.id]&&(i="* "+i),$('<option value="'+t.id+'"'+(t.id==c.z?" selected":"")+"></option>").text(i).appendTo(a)})),a.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow((function(t){var i=t.name;e[t.id]&&(i="* "+i),$('<option value="'+t.id+'"'+(t.id==c.z?" selected":"")+"></option>").text(i).appendTo(a)})),i>0&&a.on("change",(function(){var t=$(this).val();""===t?$("#red-ui-editor-config-scope-warning").hide():!e[t]||i>1?$("#red-ui-editor-config-scope-warning").show():$("#red-ui-editor-config-scope-warning").hide()})),!1!==l.hasUsers&&$("#red-ui-editor-config-user-count").text(RED._("editor.nodesUse",{count:c.users.length})).parent().show(),o.i18n(),n.i18n(),p=!0,t()}))},close:function(){RED.workspaces.refresh(),r&&(r.destroy(),r=null),e.pop()},show:function(){c&&(RED.sidebar.info.refresh(c),RED.sidebar.help.show(i,!1))}};m.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var e=i,t=c.id,o=RED.nodes.getType(e);if(o.oneditcancel&&o.oneditcancel){var n=RED.nodes.node(t);if(n)try{o.oneditcancel.call(n,!1)}catch(e){console.log("oneditcancel",n.id,n.type,e.toString())}else try{o.oneditcancel.call({id:t},!0)}catch(i){console.log("oneditcancel",t,e,i.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:d?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,o,s=t,l=(c.id,i),p=d,u=RED.nodes.getType(l),f=$("#red-ui-editor-config-scope").val();if(u.oneditsave)try{u.oneditsave.call(c)}catch(e){console.log("oneditsave",c.id,c.type,e.toString())}for(e in u.defaults){var h;if(u.defaults.hasOwnProperty(e))if(null!=(h="checkbox"===(o=$("#node-config-input-"+e)).attr("type")?o.prop("checked"):"format"in u.defaults[e]&&""!==u.defaults[e].format&&"DIV"===o[0].nodeName?o.text():o.val())&&h!==c[e]){if(c._def.defaults[e].type){"_ADD_"==h&&(h="");var v=RED.nodes.node(c[e]);if(v){var b=v.users;b.splice(b.indexOf(c),1),RED.events.emit("nodes:change",v)}(v=RED.nodes.node(h))&&(v.users.push(c),RED.events.emit("nodes:change",v))}c[e]=h}}if(r){c.info=r.getValue();var m=c.info;if(r){var y=r.getValue();m?""===y.trim()?delete c.info:y!==m&&(c.info=y):""!==y.trim()&&(c.info=y)}}c.label=u.label,c.z=f,$("#node-config-input-node-disabled").prop("checked")?!0!==c.d&&(c.d=!0):!0===c.d&&delete c.d,f&&(c.users=c.users.filter((function(e){var t=!0;for(var i in e._def.defaults)e._def.defaults.hasOwnProperty(i)&&e._def.defaults[i].type===c.type&&e[i]===c.id&&e.z!==f&&(t=!1,e[i]=null,e.dirty=!0,e.changed=!0,n(e));return t}))),p&&RED.nodes.add(c),u.credentials&&g(c,u.credentials,"node-config-input"),n(c);var w={};w[c.id]=!0;for(var E=c.users.slice();E.length>0;){var D=E.pop();w[D.id]||(w[D.id]=!0,D.users&&(E=E.concat(D.users)),n(D))}RED.nodes.dirty(!0),RED.view.redraw(!0),p||(RED.events.emit("editor:save",c),RED.events.emit("nodes:change",c)),RED.tray.close((function(){C(s,l,c.id,a)}))}}],d||m.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=t,o=c.id,r=i,s=RED.nodes.getType(r);try{s.ondelete&&(console.log("Deprecated API warning: config node type ",r," has an ondelete function - should be oneditdelete"),s.ondelete.call(c)),s.oneditdelete&&s.oneditdelete.call(c)}catch(e){console.log("oneditdelete",c.id,c.type,e.toString())}for(var d={t:"delete",nodes:[c],changes:{},dirty:RED.nodes.dirty()},l=0;l<c.users.length;l++){var p=c.users[l];for(var u in d.changes[p.id]={changed:p.changed,valid:p.valid},p._def.defaults)p._def.defaults.hasOwnProperty(u)&&p[u]==o&&(d.changes[p.id][u]=o,p[u]="",p.changed=!0,p.dirty=!0);n(p)}RED.nodes.remove(o),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(d),RED.tray.close((function(){C(e,r,"",a)}))}}),RED.tray.show(m)}function T(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function C(e,t,i,o){if(o){var n=$("#"+o+"-edit-"+e);if(n.length)i?n.text(RED._("editor.configEdit")):n.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(i);else{var a=$("#"+o+"-"+e),r=RED.nodes.getType(t);a.children().remove();var s=RED.nodes.workspace(RED.workspaces.active());s||(s=RED.nodes.subflow(RED.workspaces.active()));var d=[];RED.nodes.eachConfig((function(e){if(e.type==t&&(!e.z||e.z===s.id)){var i=RED.utils.getNodeLabel(e,e.id);e.__label__=i+(e.d?" ["+RED._("workspace.disabled")+"]":""),d.push(e)}}));var l=T;"function"==typeof r.sort&&(l=r.sort);try{d.sort(l)}catch(e){console.log("Definition error: "+r.type+".sort",e)}d.forEach((function(e){$('<option value="'+e.id+'"'+(i==e.id?" selected":"")+"></option>").text(RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)).appendTo(a),delete e.__label__})),a.append('<option value="_ADD_"'+(""===i?" selected":"")+">"+RED._("editor.addNewType",{type:t})+"</option>"),window.setTimeout((function(){a.trigger("change")}),50)}}}function j(i,o){t.hasOwnProperty(i)?(e.length>0&&(o.parent=e[e.length-1].id),e.push({type:i}),o.title=o.title||b(),o.onclose=function(){e.pop()},t[i].show(o)):console.log("Unknown type editor:",i)}return{init:function(){ace.config.set("basePath","vendor/ace"),RED.tray.init(),RED.actions.add("core:confirm-edit-tray",(function(){$(document.activeElement).blur(),$("#node-dialog-ok").trigger("click"),$("#node-config-dialog-ok").trigger("click")})),RED.actions.add("core:cancel-edit-tray",(function(){$(document.activeElement).blur(),$("#node-dialog-cancel").trigger("click"),$("#node-config-dialog-cancel").trigger("click")}))},edit:function(t,o){var a,r,s,d=t,c=!1,p=!1;e.push(t),RED.view.state(RED.state.EDITING);var u=t.type;"subflow:"==t.type.substring(0,8)&&(u="subflow");var f={title:b(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],i=[],o=RED.nodes.remove(d.id);t.push(d);var n={t:"delete",nodes:t=t.concat(o.nodes),links:i=i.concat(o.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(n),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(d._def){if(d._def.oneditcancel)try{d._def.oneditcancel.call(d)}catch(e){console.log("oneditcancel",d.id,d.type,e.toString())}for(var e in d._def.defaults)if(d._def.defaults.hasOwnProperty(e)){var t=d._def.defaults[e];if(t.type){var i=RED.nodes.getType(t.type);if(i&&i.exclusive){var o=$("#node-input-"+e).val()||"";""===o||d[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,i,o,c={},p=!1,f=RED.nodes.dirty();if(d._def.oneditsave){var h={};for(e in d._def.defaults)d._def.defaults.hasOwnProperty(e)&&("string"==typeof d[e]||"number"==typeof d[e]?h[e]=d[e]:h[e]=$.extend(!0,{},{v:d[e]}).v);try{!0===d._def.oneditsave.call(d)&&(p=!0)}catch(e){console.log("oneditsave",d.id,d.type,e.toString())}for(e in d._def.defaults)d._def.defaults.hasOwnProperty(e)&&(null===h[e]||"string"==typeof h[e]||"number"==typeof h[e]?h[e]!==d[e]&&(c[e]=h[e],p=!0):JSON.stringify(h[e])!==JSON.stringify(d[e])&&(c[e]=h[e],p=!0))}if(d._def.defaults)for(e in d._def.defaults)if(d._def.defaults.hasOwnProperty(e)){var v=$("#node-input-"+e);if("checkbox"===v.attr("type")?o=v.prop("checked"):"select"===v.prop("nodeName")&&"multiple"===v.attr("multiple")?null==(o=v.val())&&(o=[]):o="format"in d._def.defaults[e]&&""!==d._def.defaults[e].format&&"DIV"===v[0].nodeName?v.text():v.val(),null!=o){if("outputs"===e){if(""===o.trim())continue;if(isNaN(o)){i=JSON.parse(o);var b=0,y=!1;Object.keys(i).forEach((function(e){isNaN(e)?(b++,delete i[e]):(i[e]=i[e]+"","-1"!==i[e]?(b++,i[e]!==e?y=!0:delete i[e]):y=!0)})),o=b,y&&(p=!0)}else o=parseInt(o)}if(d._def.defaults[e].type&&"_ADD_"==o&&(o=""),d[e]!=o){if(d._def.defaults[e].type){var w=RED.nodes.node(d[e]);if(w){var E=w.users;E.splice(E.indexOf(d),1),RED.events.emit("nodes:change",w)}(w=RED.nodes.node(o))&&(w.users.push(d),RED.events.emit("nodes:change",w))}c[e]=d[e],d[e]=o,p=!0}}}if(d._def.credentials){var D=d._def.credentials,R=g(d,D,"node-input");p=p||R}var _=l(d,i);if(x(d,c,i)&&(p=!0),!d._def.defaults||!d._def.defaults.hasOwnProperty("icon")){var k=$("#red-ui-editor-node-icon").val()||"";if(a)if(""!==k&&k!==r)c.icon=d.icon,d.icon=k,p=!0;else{var T=RED.utils.getDefaultNodeIcon(d._def,d),C=T.module+"/"+T.file;r!==C&&(c.icon=d.icon,d.icon=C,p=!0)}else k!==d.icon&&(c.icon=d.icon,d.icon=k,p=!0)}$("#node-input-show-label").prop("checked")?/^link (in|out)$/.test(t.type)?(t.l||(c.l=t.l,p=!0),t.l=!0):(t.hasOwnProperty("l")&&!t.l&&(c.l=t.l,p=!0),delete t.l):/^link (in|out)$/.test(t.type)?(t.hasOwnProperty("l")&&t.l&&(c.l=t.l,p=!0),delete t.l):(!1!==t.l&&(c.l=t.l,p=!0),t.l=!1),$("#node-input-node-disabled").prop("checked")?!0!==t.d&&(c.d=t.d,p=!0,t.d=!0):!0===t.d&&(c.d=t.d,p=!0,delete t.d),t.resize=!0;var j=t.info;if(s){var L=s.getValue();j?""===L.trim()?(p=!0,c.info=j,delete t.info):L!==j&&(p=!0,c.info=j,t.info=L):""!==L.trim()&&(p=!0,c.info=void 0,t.info=L)}if("subflow"===u){var O=d.env,S=RED.subflow.exportSubflowInstanceEnv(d);S&&S.length>0&&S.forEach((function(e){"cred"===e.type&&(d.credentials=d.credentials||{_:{}},d.credentials[e.name]=e.value,d.credentials["has_"+e.name]=""!==e.value,"__PWRD__"!==e.value&&(p=!0),delete e.value)})),m(O,S)||(d.env=S,c.env=d.env,p=!0)}if(p){var I=d.changed;d.changed=!0,RED.nodes.dirty(!0);var P=RED.nodes.subflow(RED.workspaces.active()),N=null;P&&(N=[],RED.nodes.eachNode((function(e){e.type=="subflow:"+RED.workspaces.active()&&(N.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,l(e))})));var A={t:"edit",node:d,changes:c,links:_,dirty:f,changed:I};i&&(A.outputMap=i),N&&(A.subflow={instances:N}),RED.history.push(A)}d.dirty=!0,n(d),RED.events.emit("editor:save",d),RED.events.emit("nodes:change",d),RED.tray.close()}}],resize:function(e){i[u]=e.width,$(".red-ui-tray-content").height(e.height-50);var t=$(".red-ui-tray-content form").height(e.height-50-40);if(d&&d._def.oneditresize)try{d._def.oneditresize.call(d,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",d.id,d.type,e.toString())}},open:function(e,i){d.hasOwnProperty("outputs")&&(d.__outputs=d.outputs);var n=e.find(".red-ui-tray-footer"),l=e.find(".red-ui-tray-body");l.parent().css("overflow","hidden");$('<div class="red-ui-tray-footer-left"></div>').appendTo(n);var p,f=$("<ul></ul>").appendTo(l),h=$("<div></div>").appendTo(l),g=RED.tabs.create({element:f,onchange:function(e){h.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),c&&RED.tray.resize()},collapsible:!0,menu:!1});p="node-red"===t._def.set.module?"node-red":t._def.set.id;var b=RED.utils.getDefaultNodeIcon(t._def,t);r=b.module+"/"+b.file,a=!t.icon||t.icon===r;var m={id:"editor-tab-properties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(h).hide(),iconClass:"fa fa-cog"};if(y(m.content,"dialog-form",u,p,t),g.addTab(m),/^subflow:/.test(t.type)){var E={id:"editor-subflow-envProperties",label:RED._("editor-tab.envProperties"),name:RED._("editor-tab.envProperties"),content:$("<div>",{id:"editor-subflow-envProperties-content",class:"red-ui-tray-content"}).appendTo(h).hide(),iconClass:"fa fa-list"};g.addTab(E)}if(!t._def.defaults||!t._def.defaults.hasOwnProperty("info")){var D={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(h).hide(),iconClass:"fa fa-file-text-o",onchange:function(){s.focus()}};g.addTab(D),s=_(D.content,t)}var x={id:"editor-tab-appearance",label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(h).hide(),iconClass:"fa fa-object-group",onchange:function(){w(this.content,t)}};R(x.content,t),g.addTab(x),v(t,t._def,"node-input",(function(){l.i18n(),c=!0,o&&g.activateTab(o),i()}))},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),d&&!p&&RED.sidebar.info.refresh(d),RED.workspaces.refresh(),s&&(s.destroy(),s=null),RED.view.redraw(!0),e.pop()},show:function(){d&&(RED.sidebar.info.refresh(d),RED.sidebar.help.show(d.type,!1))}};if(i.hasOwnProperty(u)&&(f.width=i[u]),"subflow"===u){var h=d.type.substring(8);f.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(h),p=!0,$("#node-dialog-ok").trigger("click")}})}RED.tray.show(f)},editConfig:k,editSubflow:function(t){var i,a=t;e.push(t),RED.view.state(RED.state.EDITING);var r=!1,s={title:b(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,o=RED.nodes.dirty(),r=$("#subflow-input-name").val();r!=a.name&&(e.name=a.name,a.name=r,t=!0);var s=i.getValue();s!=a.info&&(e.info=a.info,a.info=s,t=!0),x(a,e,null)&&(t=!0);var d=$("#red-ui-editor-node-icon").val()||"";(void 0===a.icon&&"node-red/subflow.svg"!==d||void 0!==a.icon&&a.icon!==d)&&(e.icon=a.icon,a.icon=d,t=!0);var c=$("#subflow-appearance-input-category").val().trim();"_custom_"===c&&""===(c=$("#subflow-appearance-input-custom-category").val().trim())&&(c=a.category),"subflows"===c&&(c=""),c!=a.category&&(e.category=a.category,a.category=c,t=!0);var p=a.color,u=$("#red-ui-editor-node-color").val();p!==u&&(a.color=u,e.color=u,t=!0,RED.utils.clearNodeColorCache(),"subflow"===a.type&&(RED.nodes.getType("subflow:"+a.id).color=u));var f=a.env,h=RED.subflow.exportSubflowTemplateEnv($("#node-input-env-container").editableList("items"));if(h&&h.length>0&&h.forEach((function(e){"cred"===e.type&&(a.credentials=a.credentials||{_:{}},a.credentials[e.name]=e.value,a.credentials["has_"+e.name]=""!==e.value,"__PWRD__"!==e.value&&(t=!0),delete e.value)})),m(f,h)||(a.env=h,e.env=a.env,t=!0),t){var g=a.changed;a.changed=!0,n(a);var v=[];RED.nodes.eachNode((function(e){e.type=="subflow:"+a.id&&(v.push({id:e.id,changed:e.changed}),e._def.color=a.color,e.changed=!0,e.dirty=!0,l(e),n(e))})),RED.events.emit("subflows:change",a),RED.nodes.dirty(!0);var b={t:"edit",node:a,changes:e,dirty:o,changed:g,subflow:{instances:v}};RED.history.push(b)}a.dirty=!0,RED.tray.close()}}],resize:function(e){if($(".red-ui-tray-content").height(e.height-50),$("#node-input-env-container").length){for(var t=$("#dialog-form>div:not(#subflow-env-tabs-content)"),i=e.height,o=0;o<t.size();o++)i-=$(t[o]).outerHeight(!0);$("#node-input-env-container").editableList("height",i-95)}},open:function(e,n){var s=e.find(".red-ui-tray-footer"),d=$("<div/>",{class:"red-ui-tray-footer-left"}).appendTo(s),l=e.find(".red-ui-tray-body");if(l.parent().css("overflow","hidden"),"subflow"===a.type){var c=$("<span/>").css({"margin-left":"10px"}).appendTo(d);$("<i/>",{class:"fa fa-info-circle"}).appendTo(c),$("<span/>").text(" ").appendTo(c),$("<i/>",{id:"red-ui-editor-subflow-user-count"}).appendTo(c)}a&&RED.sidebar.info.refresh(a);var p=$("<ul></ul>").appendTo(l),u=$("<div></div>").appendTo(l),f=RED.tabs.create({element:p,onchange:function(e){u.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),r&&RED.tray.resize()},collapsible:!0,menu:!1}),h={id:"editor-tab-properties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(u).hide(),iconClass:"fa fa-cog"};f.addTab(h);var g={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(u).hide(),iconClass:"fa fa-file-text-o",onchange:function(){i.focus()}};f.addTab(g),i=_(g.content,a);var v={id:"editor-tab-appearance",label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(u).hide(),iconClass:"fa fa-object-group",onchange:function(){w(this.content,a)}};R(v.content,a),f.addTab(v),y(h.content,"dialog-form","subflow-template",void 0,a),l.i18n(),$.getJSON(o("subflow",t.id),(function(e){t.credentials=e,t.credentials._=$.extend(!0,{},e),$("#subflow-input-name").val(t.name),RED.text.bidi.prepareInput($("#subflow-input-name")),r=!0,n()}))},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(a),RED.workspaces.refresh(),i.destroy(),i=null,e.pop(),a=null},show:function(){}};RED.tray.show(s)},editGroup:function(t){var o,n=t;e.push(t),RED.view.state(RED.state.EDITING);var a=!1,r={title:b(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e,t,i={},a=!1,r=RED.nodes.dirty();if(n._def.oneditsave){var s={};for(e in n._def.defaults)n._def.defaults.hasOwnProperty(e)&&("string"==typeof n[e]||"number"==typeof n[e]?s[e]=n[e]:s[e]=$.extend(!0,{},{v:n[e]}).v);try{!0===n._def.oneditsave.call(n)&&(a=!0)}catch(e){console.log("oneditsave",n.id,n.type,e.toString())}for(e in n._def.defaults)n._def.defaults.hasOwnProperty(e)&&(null===s[e]||"string"==typeof s[e]||"number"==typeof s[e]?s[e]!==n[e]&&(i[e]=s[e],a=!0):"nodes"!==e&&JSON.stringify(s[e])!==JSON.stringify(n[e])&&(i[e]=s[e],a=!0))}if(n._def.defaults)for(e in n._def.defaults)if(n._def.defaults.hasOwnProperty(e)){var d=$("#node-input-"+e);if("checkbox"===d.attr("type")?t=d.prop("checked"):"select"===d.prop("nodeName")&&"multiple"===d.attr("multiple")?null==(t=d.val())&&(t=[]):t="format"in n._def.defaults[e]&&""!==n._def.defaults[e].format&&"DIV"===d[0].nodeName?d.text():d.val(),null!=t&&(n._def.defaults[e].type&&"_ADD_"==t&&(t=""),n[e]!=t)){if(n._def.defaults[e].type){var l=RED.nodes.node(n[e]);if(l){var c=l.users;c.splice(c.indexOf(n),1),RED.events.emit("nodes:change",l)}(l=RED.nodes.node(t))&&(l.users.push(n),RED.events.emit("nodes:change",l))}i[e]=n[e],n[e]=t,a=!0}}var p=n.info;if(o){var u=o.getValue();p?""===u.trim()?(a=!0,i.info=p,delete n.info):u!==p&&(a=!0,i.info=p,n.info=u):""!==u.trim()&&(a=!0,i.info=void 0,n.info=u)}if(a){var f=n.changed;n.changed=!0,RED.nodes.dirty(!0);var h={t:"edit",node:n,changes:i,dirty:r,changed:f};RED.history.push(h),RED.events.emit("groups:change",n)}n.dirty=!0,RED.tray.close(),RED.view.redraw(!0)}}],resize:function(e){i.group=e.width,$(".red-ui-tray-content").height(e.height-50)},open:function(e,i){var r=e.find(".red-ui-tray-footer"),s=($("<div/>",{class:"red-ui-tray-footer-left"}).appendTo(r),e.find(".red-ui-tray-body"));s.parent().css("overflow","hidden");var d=$("<ul></ul>").appendTo(s),l=$("<div></div>").appendTo(s),c=RED.tabs.create({element:d,onchange:function(e){l.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),a&&RED.tray.resize()},collapsible:!0,menu:!1}),p={id:"editor-tab-properties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(l).hide(),iconClass:"fa fa-cog"};y(p.content,"dialog-form","group","node-red",t),c.addTab(p);var u={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"red-ui-tray-content"}).appendTo(l).hide(),iconClass:"fa fa-file-text-o",onchange:function(){o.focus()}};c.addTab(u),o=_(u.content,n),v(t,t._def,"node-input",(function(){s.i18n(),a=!0,i()}))},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(n),o.destroy(),o=null,e.pop(),n=null},show:function(){}};i.hasOwnProperty("group")&&(r.width=i.group),RED.tray.show(r)},editJavaScript:function(e){j("_js",e)},editExpression:function(e){j("_expression",e)},editJSON:function(e){j("_json",e)},editMarkdown:function(e){j("_markdown",e)},editText:function(e){"markdown"==e.mode?j("_markdown",e):j("_text",e)},editBuffer:function(e){j("_buffer",e)},buildEditForm:y,validateNode:n,updateNodeProperties:l,showIconPicker:D,showTypeEditor:j,registerTypeEditor:function(e,i){t[e]=i},createEditor:function(e){var i=e.element||$("#"+e.id)[0],o=$("<div>").appendTo(i);i=$("<div>").appendTo(i).addClass("red-ui-editor-text-container")[0];var n=ace.edit(i);n.setTheme("ace/theme/tomorrow");var a=n.getSession();if(a.on("changeAnnotation",(function(){for(var e=a.getAnnotations()||[],t=e.length,i=e.length;t--;)(/doctype first\. Expected/.test(e[t].text)||/Unexpected End of file\. Expected/.test(e[t].text))&&e.splice(t,1);i>e.length&&a.setAnnotations(e)})),e.mode&&a.setMode(e.mode),e.foldStyle?a.setFoldStyle(e.foldStyle):a.setFoldStyle("markbeginend"),e.options?n.setOptions(e.options):n.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,tooltipFollowsMouse:!1}),e.readOnly&&(n.setOption("readOnly",e.readOnly),n.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&n.renderer.setOption("showGutter",e.lineNumbers),n.$blockScrolling=1/0,e.value&&a.setValue(e.value,-1),e.globals&&setTimeout((function(){a.$worker&&a.$worker.send("setOptions",[{globals:e.globals,maxerr:1e3}])}),100),"ace/mode/markdown"===e.mode){if($(i).addClass("red-ui-editor-text-container-toolbar"),n.toolbar=t._markdown.buildToolbar(o,n),!1!==e.expandable){var r=$('<button type="button" class="red-ui-button" style="float: right;"><i class="fa fa-expand"></i></button>').appendTo(n.toolbar);RED.popover.tooltip(r,RED._("markdownEditor.expand")),r.on("click",(function(e){e.preventDefault();var t=n.getValue();RED.editor.editMarkdown({value:t,width:"Infinity",cursor:n.getCursorPosition(),complete:function(e,t){n.setValue(e,-1),n.gotoLine(t.row+1,t.column,!1),setTimeout((function(){n.focus()}),300)}})}))}var s=$('<button type="button" class="red-ui-editor-text-help red-ui-button red-ui-button-small"><i class="fa fa-question"></i></button>').appendTo($(i).parent());RED.popover.create({target:s,trigger:"click",size:"small",direction:"left",content:RED._("markdownEditor.format"),autoClose:50}),a.setUseWrapMode(!0)}return n}}}(),function(){var e={show:function(e){var t=e.value,i=e.complete,o="_buffer";0===$("script[data-template-name='"+o+"']").length&&$('<script type="text/x-red" data-template-name="_buffer"><div id="red-ui-editor-type-buffer-panels"><div id="red-ui-editor-type-buffer-panel-str" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-buffer-type red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span id="red-ui-editor-type-buffer-type-string" data-i18n="bufferEditor.modeString"></span><span id="red-ui-editor-type-buffer-type-array" data-i18n="bufferEditor.modeArray"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-buffer-str"></div></div></div><div id="red-ui-editor-type-buffer-panel-bin" class="red-ui-panel"><div class="form-row node-text-editor-row" style="margin-top: 10px; margin-bottom:0;"><div class="node-text-editor" id="red-ui-editor-type-buffer-bin"></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var n,a,r=[],s={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){i(JSON.stringify(n)),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();a&&a.resize(t)},open:function(e){e.find(".red-ui-tray-body");var i,s=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form",o,"editor");(r=RED.editor.createEditor({id:"red-ui-editor-type-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(t||"",-1),bufferBinEditor=RED.editor.createEditor({id:"red-ui-editor-type-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});var d=function(e){var t=!0,i="string"==typeof e,o=[];n=i?function(e){var t=[],i=0,o=e.length;for(i=0;i<o;i++){var n=e.charCodeAt(i);n<128?t.push(n):n<2048?(t.push(192|n>>6),t.push(128|63&n)):n<55296||n>=57344?(t.push(224|n>>12),t.push(128|n>>6&63),t.push(128|63&n)):(i++,n=65536+((1023&n)<<10|1023&e.charAt(i)),t.push(240|n>>18),t.push(128|n>>12&63),t.push(128|n>>6&63),t.push(128|63&n))}return t}(e):e;var a=0,r=n.length;for(a=0;a<r;a++){var s=parseInt(n[a]);if(!i&&(isNaN(s)||s<0||s>255)){t=!1;break}a>0&&(a%8==0?a%16==0?o.push("\n"):o.push("  "):o.push(" ")),o.push((s<16?"0":"")+s.toString(16).toUpperCase())}return t&&($("#red-ui-editor-type-buffer-type-string").toggle(i),$("#red-ui-editor-type-buffer-type-array").toggle(!i),bufferBinEditor.setValue(o.join(""),1)),t},l=function(){var e=r.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var i=JSON.parse(e);t=d(i)}catch(e){t=!1}}t||d(e)};r.getSession().on("change",(function(){clearTimeout(i),i=setTimeout(l,200)})),l(),s.i18n(),a=RED.panels.create({id:"red-ui-editor-type-buffer-panels",resize:function(e,t){var i=$("#red-ui-editor-type-buffer-panel-str");e-=$(i.children()[0]).outerHeight(!0);var o=$(i.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-buffer-str").css("height",e-5+"px"),r.resize();var n=$("#red-ui-editor-type-buffer-panel-bin");o=$(n.children()[0]),t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".red-ui-editor-type-buffer-type").on("click",(function(e){e.preventDefault(),RED.sidebar.help.set(RED._("bufferEditor.modeDesc"))}))},close:function(){e.onclose&&e.onclose(),r.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(s)}};RED.editor.registerTypeEditor("_buffer",e)}(),function(){var e={},t={show:function(t){var i,o,n,a,r=t.parent||"_",s=t.value,d=t.complete;0===$("script[data-template-name='_expression']").length&&$('<script type="text/x-red" data-template-name="_expression"><div id="red-ui-editor-type-expression-panels"><div id="red-ui-editor-type-expression-panel-expr" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-expression-legacy red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span data-i18n="expressionEditor.compatMode"></span></button><button id="red-ui-editor-type-expression-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="expressionEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-expression"></div></div></div><div id="red-ui-editor-type-expression-panel-info" class="red-ui-panel"><div class="form-row"><ul id="red-ui-editor-type-expression-tabs"></ul><div id="red-ui-editor-type-expression-tab-help" class="red-ui-editor-type-expression-tab-content hide"><div><select id="red-ui-editor-type-expression-func"></select><button id="red-ui-editor-type-expression-func-insert" class="red-ui-button" data-i18n="expressionEditor.insert"></button></div><div id="red-ui-editor-type-expression-help"></div></div><div id="red-ui-editor-type-expression-tab-test" class="red-ui-editor-type-expression-tab-content hide"><div><span style="display: inline-block; width: calc(50% - 5px);"><span data-i18n="expressionEditor.data"></span><button style="float: right; margin-right: 5px;" id="node-input-example-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button></span><span style="display: inline-block; margin-left: 10px; width: calc(50% - 5px);" data-i18n="expressionEditor.result"></span></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-data"></div><div style="display: inline-block; margin-left: 10px;  width:calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-result"></div></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var l={title:t.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#red-ui-editor-type-expression-help").text(""),d(i.getValue()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();a&&a.resize(t)},open:function(t){t.find(".red-ui-tray-body").addClass("red-ui-editor-type-expression");var d=RED.editor.buildEditForm(t.find(".red-ui-tray-body"),"dialog-form","_expression","editor"),c=$("#red-ui-editor-type-expression-func");Object.keys(jsonata.functions).forEach((function(e){c.append($("<option></option>").val(e).text(e))})),c.on("change",(function(e){var t=$(this).val(),i="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",o=RED.utils.renderMarkdown(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#red-ui-editor-type-expression-help").html(i+"<p>"+o+"</p>")})),i=RED.editor.createEditor({id:"red-ui-editor-type-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}});var p=null,u=-1;i.getSession().setValue(s||"",-1),i.on("changeSelection",(function(){var e=i.getCursorPosition(),t=i.getSession().getTokenAt(e.row,e.column);if(t!==p||t&&/paren/.test(t.type)&&e.column!==u){var o,n;p=t;var a=null;if(t&&"keyword"===t.type)o=e.row,a=t;else{var r=0,s=!1;for(t?("paren.rparen"===t.type&&(u=e.column,r=e.column-(t.start+t.value.length)),o=e.row,n=t.index):(o=e.row-1,n=-1);null===a&&o>-1;){var d=i.getSession().getTokens(o);for(-1===n&&(n=d.length-1);n>-1;){var l=d[n].type;if(s){if("keyword"===l){a=d[n];break}s=!1}"paren.lparen"===l?r-=d[n].value.length:"paren.rparen"===l&&(r+=d[n].value.length),r<0&&(s=!0,r=0),n--}a||o--}}i.session.removeMarker(null),a&&c.val(a.value).trigger("change")}})),d.i18n(),$("#red-ui-editor-type-expression-func-insert").on("click",(function(e){e.preventDefault();i.getCursorPosition();var t=c.val(),o=jsonata.getFunctionSnippet(t);i.insertSnippet(o),i.focus()})),$("#red-ui-editor-type-expression-reformat").on("click",(function(e){e.preventDefault();var t=i.getValue()||"";try{t=jsonata.format(t)}catch(e){}i.getSession().setValue(t||"",-1)})),c.change();var f,h=RED.tabs.create({element:$("#red-ui-editor-type-expression-tabs"),onchange:function(e){$(".red-ui-editor-type-expression-tab-content").hide(),e.content.show(),l.resize()}});h.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#red-ui-editor-type-expression-tab-help")}),h.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#red-ui-editor-type-expression-tab-test")}),o=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-data",value:e[r]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".red-ui-editor-type-expression-legacy").on("click",(function(e){e.preventDefault(),RED.sidebar.help.set(RED._("expressionEditor.compatModeDesc"))}));var g=function(){var e,t,a=o.getValue(),r=i.getValue(),s=!1,d=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(r);$(".red-ui-editor-type-expression-legacy").toggle(d);try{(t=jsonata(r)).assign("flowContext",(function(e){return s=!0,null})),t.assign("globalContext",(function(e){return s=!0,null}))}catch(e){return void n.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(a)}catch(e){return void n.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var l,c=t.evaluate(d?{msg:e}:e);if(s)return void n.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);l=void 0!==c?JSON.stringify(c,null,4):RED._("expressionEditor.noMatch"),n.setValue(l,-1)}catch(e){n.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};o.getSession().on("change",(function(){clearTimeout(f),f=setTimeout(g,200),e[r]=o.getValue()})),i.getSession().on("change",(function(){clearTimeout(f),f=setTimeout(g,200)})),n=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),a=RED.panels.create({id:"red-ui-editor-type-expression-panels",resize:function(e,t){var a=$("#red-ui-editor-type-expression-panel-expr");e-=$(a.children()[0]).outerHeight(!0);var r=$(a.children()[1]);e-=parseInt(r.css("marginTop"))+parseInt(r.css("marginBottom")),$("#red-ui-editor-type-expression").css("height",e-5+"px"),i.resize(),t-=$("#red-ui-editor-type-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".red-ui-editor-type-expression-tab-content").height(t),$("#red-ui-editor-type-expression-test-data").css("height",t-25+"px"),o.resize(),$("#red-ui-editor-type-expression-test-result").css("height",t-25+"px"),n.resize()}}),$("#node-input-example-reformat").on("click",(function(e){e.preventDefault();var t=o.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}o.getSession().setValue(t||"",-1)})),g()},close:function(){t.onclose&&t.onclose(),i.destroy(),o.destroy()},show:function(){}};RED.tray.show(l)}};RED.editor.registerTypeEditor("_expression",t)}(),function(){var e={show:function(e){var t,i=e.value,o=e.complete;0===$("script[data-template-name='_js']").length&&$('<script type="text/x-red" data-template-name="_js"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-js"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var n={title:e.title,width:e.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){o(t.getValue(),t.getCursorPosition()),RED.tray.close()}}],resize:function(e){for(var i=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<i.size();n++)o-=$(i[n]).outerHeight(!0);$(".node-text-editor").css("height",o+"px"),t.resize()},open:function(o){o.find(".red-ui-tray-body");var n=RED.editor.buildEditForm(o.find(".red-ui-tray-body"),"dialog-form","_js","editor");t=RED.editor.createEditor({id:"node-input-js",mode:e.mode||"ace/mode/javascript",value:i,globals:{msg:!0,context:!0,RED:!0,util:!0,flow:!0,global:!0,console:!0,Buffer:!0,setTimeout:!0,clearTimeout:!0,setInterval:!0,clearInterval:!0}}),e.cursor&&t.gotoLine(e.cursor.row+1,e.cursor.column,!1),n.i18n(),setTimeout((function(){t.focus()}),300)},close:function(){t.destroy(),e.onclose&&e.onclose()},show:function(){}};RED.tray.show(n)}};RED.editor.registerTypeEditor("_js",e)}(),function(){var e;function t(e,t,o){var n,a="";if(e.children.length>0)switch(e.children[Math.max(0,Math.min(e.children.length-1,o))].type){case"string":a="";break;case"number":a=0;break;case"boolean":a=!0;break;case"null":a=null;break;case"object":a={};break;case"array":a=[]}if("array"===e.type)n=e.children.length;else{var r={};e.children.forEach((function(e){r[e.key]=!0}));var s="item",d=2;for(n=s;r[n];)n=s+"-"+d++}var l=i(n,a,e.depth+1,e);e.treeList.insertChildAt(l,t,!0),e.treeList.expand()}function i(e,n,a,r){var s,d={depth:a,type:typeof n},l=$('<span class="red-ui-editor-type-json-editor-label">');if(null!=e){var c;d.key=e,c="string"==typeof e?'"'+e+'"':e;var p=$('<span class="red-ui-debug-msg-object-key red-ui-editor-type-json-editor-label-key">').text(c).appendTo(l);p.addClass("red-ui-debug-msg-type-"+typeof e),r&&"array"===r.type&&p.addClass("red-ui-editor-type-json-editor-label-array-key"),p.on("click",(function(e){if("array"!==d.parent.type){e.preventDefault(),e.stopPropagation();var t=Math.max(150,p.width()),i=$('<input type="text" class="red-ui-editor-type-json-editor-key">').css({width:t+"px"}).val(""+d.key).insertAfter(p).typedInput({types:["str"]});$(document).on("mousedown.nr-ui-json-editor",(function(e){for(var t=i.next(".red-ui-typedInput-container")[0],o=e.target;"BODY"!==o.nodeName&&o!==t&&!$(o).hasClass("red-ui-typedInput-options");)o=o.parentElement;if("BODY"===o.nodeName){var n,a=i.typedInput("value");d.key=a,n="string"==typeof a?'"'+a+'"':a,p.text(n),i.remove(),p.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor")}})),$(document).on("keydown.nr-ui-json-editor",(function(e){27===e.keyCode&&(i.remove(),p.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))})),p.hide()}})),$("<span>").text(" : ").appendTo(l)}Array.isArray(n)?(d.expanded=a<2,d.type="array",d.deferBuild=a>=2,d.children=function(e,t,o){for(var n=[],a=e.length,r=0;r<a;r++)n.push(i(r,e[r],t,o));return n}(n,a+1,d)):null!==n&&"object"===d.type?(d.expanded=a<2,d.children=function(e,t,o){var n=[];for(var a in e)e.hasOwnProperty(a)&&n.push(i(a,e[a],t,o));return n}(n,a+1,d),d.deferBuild=a>=2):(d.value=n,null===n&&(d.type="null"));var u,f,h="";switch(d.type){case"string":s="str",h='"'+d.value+'"',u="red-ui-debug-msg-type-string";break;case"number":s="num",h=d.value,u="red-ui-debug-msg-type-number";break;case"boolean":s="bool",h=d.value,u="red-ui-debug-msg-type-other";break;case"null":s=d.type,h=d.type,u="red-ui-debug-msg-type-null";break;case"object":s=d.type,h=d.type,u="red-ui-debug-msg-type-meta";break;case"array":s=d.type,h=d.type+"["+d.children.length+"]",u="red-ui-debug-msg-type-meta"}var g=$('<span class="red-ui-editor-type-json-editor-label-value">').addClass(u).text(h).appendTo(l);return g.on("click",(function(e){e.preventDefault(),e.stopPropagation(),"str"===s?h=h.substring(1,h.length-1):("array"===s||"object"===s)&&(h="");var t=Math.max(150,g.width()),i=$('<input type="text" class="red-ui-editor-type-json-editor-value">').css({width:t+"px"}).val(""+h).insertAfter(g).typedInput({types:["str","num","bool",{value:"null",label:RED._("common.type.null"),hasValue:!1},{value:"array",label:RED._("common.type.array"),hasValue:!1,icon:"red/images/typedInput/json.png"},{value:"object",label:RED._("common.type.object"),hasValue:!1,icon:"red/images/typedInput/json.png"}],default:s});$(document).on("mousedown.nr-ui-json-editor",(function(e){for(var t=i.next(".red-ui-typedInput-container")[0],o=e.target;"BODY"!==o.nodeName&&o!==t&&!$(o).hasClass("red-ui-typedInput-options");)o=o.parentElement;if("BODY"===o.nodeName){var n;switch(s=i.typedInput("type"),h=i.typedInput("value"),"num"===s&&(h=h.trim(),isNaN(h)?s="str":""===h&&(h=0)),d.value=h,s){case"str":d.children&&(f=d.children),d.treeList.makeLeaf(!0),d.type="string",n="red-ui-debug-msg-type-string",h='"'+h+'"';break;case"num":d.children&&(f=d.children),d.treeList.makeLeaf(!0),d.type="number",n="red-ui-debug-msg-type-number";break;case"bool":d.children&&(f=d.children),d.treeList.makeLeaf(!0),d.type="boolean",n="red-ui-debug-msg-type-other",d.value="true"===h;break;case"null":d.children&&(f=d.children),d.treeList.makeLeaf(!0),d.type="null",n="red-ui-debug-msg-type-null",d.value=h="null";break;case"object":d.treeList.makeParent(f),d.type="object",n="red-ui-debug-msg-type-meta",d.value=h="object",d.children.forEach((function(e,t){if(e.hasOwnProperty("_key")){var i;e.key=e._key,delete e._key;var o=e.element.find(".red-ui-editor-type-json-editor-label-key");o.removeClass("red-ui-editor-type-json-editor-label-array-key"),"string"==typeof e.key?(i='"'+e.key+'"',o.addClass("red-ui-debug-msg-type-string"),o.removeClass("red-ui-debug-msg-type-number")):(i=e.key,o.removeClass("red-ui-debug-msg-type-string"),o.addClass("red-ui-debug-msg-type-number")),o.text(i)}}));break;case"array":d.treeList.makeParent(f),d.type="array",n="red-ui-debug-msg-type-meta",d.value=h="array["+d.children.length+"]",d.children.forEach((function(e,t){e._key=e.key,e.key=t,e.element.find(".red-ui-editor-type-json-editor-label-key").addClass("red-ui-editor-type-json-editor-label-array-key").text(""+e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")}))}g.text(h).removeClass().addClass("red-ui-editor-type-json-editor-label-value "+n),i.remove(),g.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor")}})),$(document).on("keydown.nr-ui-json-editor",(function(e){27===e.keyCode&&(i.remove(),g.show(),"str"===s&&(h='"'+h+'"'),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))})),g.hide()})),d.gutter=$('<span class="red-ui-editor-type-json-editor-item-gutter"></span>'),r?$('<span class="red-ui-editor-type-json-editor-item-handle"><i class="fa fa-bars"></span>').appendTo(d.gutter):$("<span></span>").appendTo(d.gutter),$('<button type="button" class="editor-button editor-button-small"><i class="fa fa-caret-down"></button>').appendTo(d.gutter).on("click",(function(e){e.preventDefault(),e.stopPropagation(),function(e,n){var a=e.offset(),r=[];n.parent&&(r.push({id:"red-ui-editor-type-json-menu-insert-above",icon:"fa fa-toggle-up",label:RED._("jsonEditor.insertAbove"),onselect:function(){var e=n.parent.children.indexOf(n);t(n.parent,e,e)}}),r.push({id:"red-ui-editor-type-json-menu-insert-below",icon:"fa fa-toggle-down",label:RED._("jsonEditor.insertBelow"),onselect:function(){var e=n.parent.children.indexOf(n)+1;t(n.parent,e,e-1)}})),"array"!==n.type&&"object"!==n.type||r.push({id:"red-ui-editor-type-json-menu-add-child",icon:"fa fa-plus",label:RED._("jsonEditor.addItem"),onselect:function(){t(n,n.children.length,n.children.length-1)}}),n.parent&&(r.push({id:"red-ui-editor-type-json-menu-copy-path",icon:"fa fa-terminal",label:RED._("jsonEditor.copyPath"),onselect:function(){for(var e=n,t="";e.parent;)t=("array"===e.parent.type?"["+e.key+"]":/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(e.key)?e.key:'["'+e.key.replace(/"/,'\\"')+'"]')+(t.length>0&&"["!==t[0]?".":"")+t,e=e.parent;RED.clipboard.copyText(t,n.element,"clipboard.copyMessagePath")}}),r.push({id:"red-ui-editor-type-json-menu-duplicate",icon:"fa fa-copy",label:RED._("jsonEditor.duplicate"),onselect:function(){var e=n.key;if("array"===n.parent.type)e=n.parent.children.length;else{var t=/^(.*?)(-(\d+))?$/.exec(e),a={};n.parent.children.forEach((function(e){a[e.key]=!0}));var r=t[1],s=2;for(void 0!==t[3]&&(s=parseInt(t[3])),e=r;a[e];)e=r+"-"+s++}var d=i(e,o(n),n.parent.depth+1,n.parent),l=n.parent.children.indexOf(n)+1;n.parent.treeList.insertChildAt(d,l,!0),n.parent.treeList.expand()}}),r.push({id:"red-ui-editor-type-json-menu-delete",icon:"fa fa-times",label:RED._("common.label.delete"),onselect:function(){n.treeList.remove()}})),"array"!==n.type&&"object"!==n.type||(r.push(null),r.push({id:"red-ui-editor-type-json-menu-expand-children",icon:"fa fa-angle-double-down",label:RED._("jsonEditor.expandItems"),onselect:function(){n.treeList.expand(),n.children.forEach((function(e){e.treeList.expand()}))}}),r.push({id:"red-ui-editor-type-json-menu-collapse-children",icon:"fa fa-angle-double-up",label:RED._("jsonEditor.collapseItems"),onselect:function(){n.treeList.collapse(),n.children.forEach((function(e){e.treeList.collapse()}))}}));var s=RED.menu.init({id:"red-ui-editor-type-json-menu",options:r});s.css({position:"absolute"}),s.on("mouseleave",(function(){$(this).hide()})),s.on("mouseup",(function(){$(this).hide()})),s.appendTo("body");var d=a.top,l=s.height(),c=$(window).height();d+l>c&&(d-=d+l-c+20),s.css({top:d+"px",left:a.left+"px"}),s.show()}($(this),d)})),d.element=l,d}function o(e){var t;switch(e.type){case"string":case"boolean":t=e.value;break;case"number":t=Number(e.value);break;case"null":t=null;break;case"object":t={},e.children.forEach((function(e){t[e.key]=o(e)}));break;case"array":t=e.children.map((function(e){return o(e)}))}return t}var n={show:function(t){var n,a,r=t.value,s=t.complete,d="_json";0===$("script[data-template-name='_json']").length&&$('<script type="text/x-red" data-template-name="_json"><ul id="red-ui-editor-type-json-tabs"></ul><div id="red-ui-editor-type-json-tab-raw" class="red-ui-editor-type-json-tab-content hide"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button id="node-input-json-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-json"></div></div></div><div id="red-ui-editor-type-json-tab-ui" class="red-ui-editor-type-json-tab-content hide"><div id="red-ui-editor-type-json-tab-ui-container"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var l,c=function(){var e=n.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}},p={title:t.title,width:t.width||700,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var i;t.requireValid&&!c()||("json-ui"===e?i=l?JSON.stringify(o(l),null,4):n.getValue():"json-raw"===e&&(i=n.getValue()),s&&s(i),RED.tray.close())}}],resize:function(e){var t=$(".red-ui-editor-type-json-tab-content").height();$(".node-text-editor").css("height",t-45+"px"),n.resize()},open:function(s){s.find(".red-ui-tray-body");var u=RED.editor.buildEditForm(s.find(".red-ui-tray-body"),"dialog-form",d,"editor"),f=$("#red-ui-editor-type-json-tab-ui-container").css({height:"100%"}),h=$('<div class="red-ui-debug-msg-payload red-ui-editor-type-json-editor">').appendTo(f).treeList({rootSortable:!1,sortable:".red-ui-editor-type-json-editor-item-handle"}).on("treelistchangeparent",(function(e,t){"array"===t.old.type&&t.old.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.old.children.length+"]"),"array"===t.item.parent.type&&t.item.parent.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.item.parent.children.length+"]")})).on("treelistsort",(function(e,t){t.children.forEach((function(e,i){"array"===t.type?(e.key=i,e.element.find(".red-ui-editor-type-json-editor-label-key").text(e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")):e.element.find(".red-ui-editor-type-json-editor-label-key").text('"'+e.key+'"').removeClass("red-ui-debug-msg-type-number").addClass("red-ui-debug-msg-type-string")}))}));(n=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(r||"",-1),t.requireValid&&(n.getSession().on("change",(function(){clearTimeout(a),a=setTimeout(c,200)})),c()),$("#node-input-json-reformat").on("click",(function(e){e.preventDefault();var t=n.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}n.getSession().setValue(t||"",-1)})),u.i18n();var g=!1,v=RED.tabs.create({element:$("#red-ui-editor-type-json-tabs"),onchange:function(t){if(e=t.id,$(".red-ui-editor-type-json-tab-content").hide(),g)if("json-raw"===t.id){if(l){var a=JSON.stringify(o(l),null,4);n.getSession().setValue(a||"",-1)}}else if("json-ui"===t.id){var r=n.getValue().trim()||"{}";try{var s=JSON.parse(r);(l=i(null,s,0,null)).class="red-ui-editor-type-json-root-node",h.treeList("data",[l])}catch(e){l=null,h.treeList("data",[{label:RED._("jsonEditor.error.invalidJSON")+e.toString()}])}}t.content.show(),p.resize()}});v.addTab({id:"json-raw",label:RED._("jsonEditor.rawMode"),content:$("#red-ui-editor-type-json-tab-raw")}),v.addTab({id:"json-ui",label:RED._("jsonEditor.uiMode"),content:$("#red-ui-editor-type-json-tab-ui")}),g=!0},close:function(){t.onclose&&t.onclose()},show:function(){}};RED.tray.show(p)}};RED.editor.registerTypeEditor("_json",n)}(),function(){var e,t={show:function(t){var i,o=t.value,n=t.complete,a="_markdown";0===$("script[data-template-name='"+a+"']").length&&$('<script type="text/x-red" data-template-name="_markdown"><div id="red-ui-editor-type-markdown-panels"><div id="red-ui-editor-type-markdown-panel-editor" class="red-ui-panel"><div style="height: 100%; margin: auto;"><div id="red-ui-editor-type-markdown-toolbar"></div><div class="node-text-editor" style="height: 100%" id="red-ui-editor-type-markdown"></div></div></div><div class="red-ui-panel"><div class="red-ui-editor-type-markdown-panel-preview red-ui-help"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var r={title:t.title,width:t.width||1/0,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){n(i.getValue(),i.getCursorPosition()),RED.tray.close()}}],resize:function(t){var i=$("#dialog-form").width();e&&e.resize(i)},open:function(n){n.find(".red-ui-tray-body").addClass("red-ui-editor-type-markdown-editor");var r,s=RED.editor.buildEditForm(n.find(".red-ui-tray-body"),"dialog-form",a,"editor");(i=RED.editor.createEditor({id:"red-ui-editor-type-markdown",value:o,mode:"ace/mode/markdown",expandable:!1})).getSession().on("change",(function(){clearTimeout(r),r=setTimeout((function(){var e=$(".red-ui-editor-type-markdown-panel-preview").scrollTop();$(".red-ui-editor-type-markdown-panel-preview").html(RED.utils.renderMarkdown(i.getValue())),$(".red-ui-editor-type-markdown-panel-preview").scrollTop(e)}),200)})),t.header&&t.header.appendTo(n.find("#red-ui-editor-type-markdown-title")),o&&$(".red-ui-editor-type-markdown-panel-preview").html(RED.utils.renderMarkdown(i.getValue())),(e=RED.panels.create({id:"red-ui-editor-type-markdown-panels",dir:"horizontal",resize:function(e,t){i.resize()}})).ratio(1),$('<span class="button-group" style="float:right"><button type="button" id="node-btn-markdown-preview" class="red-ui-button toggle single"><i class="fa fa-eye"></i></button></span>').appendTo(i.toolbar),$("#node-btn-markdown-preview").on("click",(function(t){t.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),e.ratio(1)):($(this).addClass("selected"),e.ratio(.5))})),RED.popover.tooltip($("#node-btn-markdown-preview"),RED._("markdownEditor.toggle-preview")),t.cursor&&i.gotoLine(t.cursor.row+1,t.cursor.column,!1),s.i18n()},close:function(){i.destroy(),t.onclose&&t.onclose()},show:function(){}};RED.tray.show(r)},buildToolbar:function(e,t){var i={h1:{newline:!0,before:"# ",tooltip:RED._("markdownEditor.heading1")},h2:{newline:!0,before:"## ",tooltip:RED._("markdownEditor.heading2")},h3:{newline:!0,before:"### ",tooltip:RED._("markdownEditor.heading3")},b:{before:"**",after:"**",tooltip:RED._("markdownEditor.bold")},i:{before:"_",after:"_",tooltip:RED._("markdownEditor.italic")},code:{before:"`",after:"`",tooltip:RED._("markdownEditor.code")},ol:{before:" * ",newline:!0,tooltip:RED._("markdownEditor.ordered-list")},ul:{before:" - ",newline:!0,tooltip:RED._("markdownEditor.unordered-list")},bq:{before:"> ",newline:!0,tooltip:RED._("markdownEditor.quote")},link:{before:"[",after:"]()",tooltip:RED._("markdownEditor.link")},hr:{before:"\n---\n\n",tooltip:RED._("markdownEditor.horizontal-rule")}},o=$('<div style="margin-bottom: 5px"><span class="button-group"><button type="button" class="red-ui-button" data-style="h1" style="font-size:1.1em; font-weight: bold">h1</button><button type="button" class="red-ui-button" data-style="h2" style="font-size:1.0em; font-weight: bold">h2</button><button type="button" class="red-ui-button" data-style="h3" style="font-size:0.9em; font-weight: bold">h3</button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="b"><i class="fa fa-bold"></i></button><button type="button" class="red-ui-button" data-style="i"><i class="fa fa-italic"></i></button><button type="button" class="red-ui-button" data-style="code"><i class="fa fa-code"></i></button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="ol"><i class="fa fa-list-ol"></i></button><button type="button" class="red-ui-button" data-style="ul"><i class="fa fa-list-ul"></i></button><button type="button" class="red-ui-button" data-style="bq"><i class="fa fa-quote-left"></i></button><button type="button" class="red-ui-button" data-style="hr"><i class="fa fa-minus"></i></button><button type="button" class="red-ui-button" data-style="link"><i class="fa fa-link"></i></button></span></div>').appendTo(e);return o.find("button[data-style]").each((function(e){var o=i[$(this).data("style")];$(this).on("click",(function(e){e.preventDefault();var i=t.getSelectedText(),n=t.selection.getRange();if(o.newline)for(var a=0,r=((o.before||"").match(/\n/g)||[]).length,s=((o.after||"").match(/\n/g)||[]).length,d=n.start.row;d<=n.end.row+a;d++)o.before&&(t.session.insert({row:d,column:0},o.before),a+=r,d+=r),o.after&&(t.session.insert({row:d,column:1/0},o.after),a+=s,d+=s);else t.session.replace(t.selection.getRange(),(o.before||"")+i+(o.after||"")),""===i&&t.gotoLine(n.start.row+1,n.start.column+(o.before||"").length,!1);t.focus()})),o.tooltip&&RED.popover.tooltip($(this),o.tooltip)})),o}};RED.editor.registerTypeEditor("_markdown",t)}(),function(){var e={show:function(e){var t,i=e.value,o=e.complete,n="_text";0===$("script[data-template-name='_text']").length&&$('<script type="text/x-red" data-template-name="_text"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-text"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING);var a={title:e.title,width:e.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){o(t.getValue(),t.getCursorPosition()),RED.tray.close()}}],resize:function(e){$("#dialog-form>div:not(.node-text-editor-row)"),$("#dialog-form>div.node-text-editor-row");var i=$("#dialog-form").height();$(".node-text-editor").css("height",i+"px"),t.resize()},open:function(o){o.find(".red-ui-tray-body"),RED.editor.buildEditForm(o.find(".red-ui-tray-body"),"dialog-form",n,"editor");(t=RED.editor.createEditor({id:"node-input-text",value:"",mode:"ace/mode/"+(e.mode||"text")})).getSession().setValue(i||"",-1),e.cursor&&t.gotoLine(e.cursor.row+1,e.cursor.column,!1)},close:function(){t.destroy(),e.onclose&&e.onclose()},show:function(){}};RED.tray.show(a)}};RED.editor.registerTypeEditor("_text",e)}(),RED.eventLog=function(){var e,t=[],i=!1;return{init:function(){$('<script type="text/x-red" data-template-name="_eventLog"><div class="form-row node-text-editor-row"><div style="height: 100%;min-height: 150px;" class="node-text-editor" id="red-ui-event-log-editor"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.actions.add("core:show-event-log",RED.eventLog.show)},show:function(){if(!i){i=!0;var o={title:RED._("eventLog.title"),width:1/0,buttons:[{id:"node-dialog-close",text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(t){for(var i=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<i.size();n++)o-=$(i[n]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),e.resize()},open:function(i){i.find(".red-ui-tray-body");var o=RED.editor.buildEditForm(i.find(".red-ui-tray-body"),"dialog-form","_eventLog","editor");e=RED.editor.createEditor({id:"red-ui-event-log-editor",value:t.join("\n"),lineNumbers:!1,readOnly:!0,options:{showPrintMargin:!1}}),setTimeout((function(){e.scrollToLine(e.getSession().getLength())}),200),o.i18n()},close:function(){e.destroy(),e=null,i=!1},show:function(){}};RED.tray.show(o)}},log:function(i,o){var n=new Date(o.ts).toISOString()+" ";if(o.type&&(n+="["+o.type+"] "),o.data){var a=o.data;a.endsWith("\n")&&(a=a.substring(0,a.length-1)),a.split(/\n/).forEach((function(i){!function(i){t.push(i),t.length>500&&(t=t.slice(-500)),e&&(e.getSession().insert({row:e.getSession().getLength(),column:0},"\n"+i),e.scrollToLine(e.getSession().getLength()))}(n+i)}))}},startEvent:function(e){t.push(""),t.push("-----------------------------------------------------------"),t.push((new Date).toISOString()+" "+e),t.push("")}}}(),RED.tray=function(){var e,t=[],i=!1,o=!1;function n(o){var n=$('<div class="red-ui-tray"></div>'),r=$('<div class="red-ui-tray-header editor-tray-header"></div>').appendTo(n),s=$('<div class="red-ui-tray-body-wrapper"></div>').appendTo(n),d=$('<div class="red-ui-tray-body editor-tray-body"></div>').appendTo(s),l=$('<div class="red-ui-tray-footer"></div>').appendTo(n),c=$('<div class="red-ui-tray-resize-handle"></div>').appendTo(n);if(o.title){var p=t.map((function(e){return e.options.title}));p.push(o.title);var u='<ul class="red-ui-tray-breadcrumbs"><li>'+p.join("</li><li>")+"</li></ul>";$('<div class="red-ui-tray-titlebar">'+u+"</div>").appendTo(r)}o.width===1/0&&(o.maximized=!0,c.addClass("red-ui-tray-resize-maximised"));var f,h=$('<div class="red-ui-tray-toolbar"></div>').appendTo(r);if(o.buttons)for(var g=0;g<o.buttons.length;g++){var v=o.buttons[g],b=$("<button>").button().appendTo(h);v.id&&b.attr("id",v.id),v.text&&b.text(v.text),v.click&&b.on("click",function(e){return function(t){$(this).hasClass("disabled")||e(t)}}(v.click)),v.class&&(b.addClass(v.class),"primary"===v.class&&(f=v))}n.appendTo(e);var m={tray:n,header:r,body:d,footer:l,options:o,primaryButton:f};function y(){$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),m.preferredWidth=Math.max(n.width(),600),o.maximized||d.css({minWidth:m.preferredWidth-40}),o.width?(o.width>$("#red-ui-editor-stack").position().left-8&&(o.width=$("#red-ui-editor-stack").position().left-8),n.width(o.width)):n.width(m.preferredWidth),m.width=n.width(),m.width>$("#red-ui-editor-stack").position().left-8&&(m.width=Math.max(0,$("#red-ui-editor-stack").position().left-8),n.width(m.width)),$("#red-ui-main-container").scrollLeft(0),n.css({right:-(n.width()+10)+"px",transition:"right 0.25s ease"}),a(),i=!0,setTimeout((function(){setTimeout((function(){o.width||n.width(Math.min(m.preferredWidth,$("#red-ui-editor-stack").position().left-8)),o.resize&&o.resize({width:n.width()}),o.show&&o.show(),setTimeout((function(){i=!1}),200),d.find(":focusable:first").trigger("focus")}),150),n.css({right:0})}),0)}t.push(m),o.maximized||n.draggable({handle:c,axis:"x",start:function(e,t){n.width("auto")},drag:function(t,i){var o=e.position().left+i.position.left;o<7?i.position.left+=7-o:i.position.left>-m.preferredWidth-1&&(i.position.left=-Math.min(e.position().left-7,m.preferredWidth-1)),m.options.resize&&setTimeout((function(){m.options.resize({width:-i.position.left})}),0),m.width=-i.position.left},stop:function(e,t){n.width(-t.position.left),n.css({left:""}),m.options.resize&&m.options.resize({width:-t.position.left}),m.width=-t.position.left}}),o.open?1===o.open.length?(o.open(n),y()):o.open(n,y):y()}function a(){if(t.length>0){var e=t[t.length-1];e.options.maximized||e.width>$("#red-ui-editor-stack").position().left-8?(e.width=$("#red-ui-editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#red-ui-editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width));var i=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight();e.body.height(i),e.options.resize&&e.options.resize({width:e.width,height:i})}}return{init:function(){e=$("#red-ui-editor-stack"),$(window).on("resize",a),RED.events.on("sidebar:resize",a),$("#red-ui-editor-shade").on("click",(function(){if(!i){var e=t[t.length-1];e&&e.primaryButton&&e.primaryButton.click()}}))},show:function(e){if(e){if(o)throw new Error("Cannot add to stack whilst hidden");if(t.length>0&&!e.overlay){var i=t[t.length-1];"inherit"===e.width&&(e.width=i.tray.width()),i.tray.css({right:-(i.tray.width()+10)+"px"}),setTimeout((function(){i.tray.detach(),n(e)}),250)}else RED.events.emit("editor:open"),n(e)}else{if(t.length>0)t[t.length-1].tray.css({right:0}),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),o=!1}},hide:function(){if(t.length>0){var e=t[t.length-1];e.tray.css({right:-(e.tray.width()+10)+"px"}),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),o=!0}},resize:a,close:function(e){if(t.length>0){var i=t.pop();i.tray.css({right:-(i.tray.width()+10)+"px"}),setTimeout((function(){if(i.options.close&&i.options.close(),i.tray.remove(),t.length>0){var o=t[t.length-1];o.options.overlay?(a(),o.options.show&&o.options.show()):(o.tray.appendTo("#red-ui-editor-stack"),setTimeout((function(){a(),o.tray.css({right:0}),o.options.show&&o.options.show()}),0))}e&&e(),0===t.length&&($("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())}),250)}}}}(),RED.clipboard=function(){var e,t,i,o,n,a,r,s,d,l,c,p,u=!1;function f(){c&&clearTimeout(c),c=setTimeout((function(){var e=$("#red-ui-clipboard-dialog-tab-library-name"),t=e.val().trim();t.length>0&&!/[\/\\]/.test(t)?(e.removeClass("input-error"),$("#red-ui-clipboard-dialog-export").button("enable")):(e.addClass("input-error"),$("#red-ui-clipboard-dialog-export").button("disable"))}),100)}function h(){if("red-ui-clipboard-dialog-import-tab-clipboard"===r)p&&clearTimeout(p),p=setTimeout((function(){var e=$("#red-ui-clipboard-dialog-import-text"),t=e.val().trim();if(""===t)return n.close(!0),a=null,e.removeClass("input-error"),void $("#red-ui-clipboard-dialog-ok").button("disable");try{if(!/^\[[\s\S]*\]$/m.test(t))throw new Error(RED._("clipboard.import.errors.notArray"));for(var i=JSON.parse(t),o=0;o<i.length;o++){if("object"!=typeof i[o])throw new Error(RED._("clipboard.import.errors.itemNotObject",{index:o}));if(!i[o].hasOwnProperty("id"))throw new Error(RED._("clipboard.import.errors.missingId",{index:o}));if(!i[o].hasOwnProperty("type"))throw new Error(RED._("clipboard.import.errors.missingType",{index:o}))}a=null,n.close(!0),e.removeClass("input-error"),e.val(t),$("#red-ui-clipboard-dialog-ok").button("enable")}catch(i){if(""!==t){e.addClass("input-error");var r=i.toString();if(r!==a){var s,d=$('<div class="red-ui-clipboard-import-error"></div>').text(r),l=/at position (\d+)/i.exec(r);if(l)s=parseInt(l[1]);else if(l=/at line (\d+) column (\d+)/i.exec(r)){var c=parseInt(l[1])-1,p=parseInt(l[2])-1,u=t.split("\n");s=0;for(o=0;o<c;o++)s+=u[o].length+1;s+=p}if(void 0!==s){t=t.replace(/\n/g,"↵");parseInt(l[1]);var f=$("<div>").appendTo(d),h=$("<pre>").appendTo(f);$("<span>").text(t.substring(s-12,s)).appendTo(h),$('<span class="error">').text(t.charAt(s)).appendTo(h),$("<span>").text(t.substring(s+1,s+12)).appendTo(h)}n.close(!0).setContent(d).open(),a=r}}else a=null;$("#red-ui-clipboard-dialog-ok").button("disable")}}),100);else{var e=s.getSelected();e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")}}function g(i){if(!u){i=i||"clipboard",t.empty(),t.append($(o));var l=RED.tabs.create({id:"red-ui-clipboard-dialog-import-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-import-tabs-content").children().hide(),$("#"+e.id).show(),r=e.id,n&&(n.close(!0),a=null),"red-ui-clipboard-dialog-import-tab-clipboard"===e.id?$("#red-ui-clipboard-dialog-import-text").trigger("focus"):s.focus(),h()}});l.addTab({id:"red-ui-clipboard-dialog-import-tab-clipboard",label:RED._("clipboard.clipboard")}),l.addTab({id:"red-ui-clipboard-dialog-import-tab-library",label:RED._("library.library")}),l.addTab({id:"red-ui-clipboard-dialog-import-tab-examples",label:RED._("library.types.examples")}),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",f),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",(function(){setTimeout(f,10)})),$("#red-ui-clipboard-dialog-export").button("enable"),b(s=RED.library.createBrowser({container:$("#red-ui-clipboard-dialog-import-tab-library"),onselect:function(e){e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")},onconfirm:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-ok").trigger("click")}}),"local",RED._("library.types.local")),b(d=RED.library.createBrowser({container:$("#red-ui-clipboard-dialog-import-tab-examples"),onselect:function(e){e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")},onconfirm:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-ok").trigger("click")}}),"_examples_",RED._("library.types.examples")),t.i18n(),$("#red-ui-clipboard-dialog-ok").show(),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-import-conflict").hide(),$("#red-ui-clipboard-dialog-ok").button("disable"),$("#red-ui-clipboard-dialog-import-text").on("keyup",h),$("#red-ui-clipboard-dialog-import-text").on("paste",(function(){setTimeout(h,10)})),$("#red-ui-clipboard-dialog-import-opt > a").on("click",(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))})),$("#red-ui-clipboard-dialog-import-file-upload").on("change",(function(){var e=new FileReader;e.onload=function(){$("#red-ui-clipboard-dialog-import-text").val(e.result),h()},e.readAsText($(this).prop("files")[0])})),$("#red-ui-clipboard-dialog-import-file-upload-btn").on("click",(function(e){e.preventDefault(),$("#red-ui-clipboard-dialog-import-file-upload").trigger("click")})),l.activateTab("red-ui-clipboard-dialog-import-tab-"+i),"clipboard"===i&&setTimeout((function(){$("#red-ui-clipboard-dialog-import-text").trigger("focus")}),100);var c=400,p=$(window).height();p<600&&(c=400-(600-p)),$(".red-ui-clipboard-dialog-box").height(c),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("option","width",700).dialog("open"),n=RED.popover.create({target:$("#red-ui-clipboard-dialog-import-text"),trigger:"manual",direction:"bottom",content:""})}}function v(o){if(!u){o=o||"clipboard",t.empty(),t.append($(i));var n=RED.tabs.create({id:"red-ui-clipboard-dialog-export-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-export-tabs-content").children().hide(),$("#"+e.id).show(),r=e.id,"red-ui-clipboard-dialog-export-tab-clipboard"===e.id?($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.copy")),$("#red-ui-clipboard-dialog-download").show()):($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.export")),$("#red-ui-clipboard-dialog-download").hide(),s.focus())}});n.addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard",label:RED._("clipboard.clipboard")}),n.addTab({id:"red-ui-clipboard-dialog-export-tab-library",label:RED._("library.library")}),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",f),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",(function(){setTimeout(f,10)})),$("#red-ui-clipboard-dialog-export").button("enable"),b(s=RED.library.createBrowser({container:$("#red-ui-clipboard-dialog-export-tab-library-browser"),folderTools:!0,onselect:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-tab-library-name").val(e.label)}}),"local",RED._("library.types.local")),$("#red-ui-clipboard-dialog-tab-library-name").val("flows.json").select(),t.i18n();var a=RED.settings.flowFilePretty?"red-ui-clipboard-dialog-export-fmt-full":"red-ui-clipboard-dialog-export-fmt-mini";$("#red-ui-clipboard-dialog-export-fmt-group > a").on("click",(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#red-ui-clipboard-dialog-export-text").trigger("focus");else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#red-ui-clipboard-dialog-export-text").val();if(t.length>0){var i=JSON.parse(t);t="red-ui-clipboard-dialog-export-fmt-full"===(a=$(this).attr("id"))?JSON.stringify(i,null,4):JSON.stringify(i),$("#red-ui-clipboard-dialog-export-text").val(t),setTimeout((function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0)}),50),$("#red-ui-clipboard-dialog-export-text").trigger("focus")}}})),$("#red-ui-clipboard-dialog-export-rng-group > a").on("click",(function(e){if(e.preventDefault(),!$(this).hasClass("disabled")&&!$(this).hasClass("selected")){$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),i="",o=null;if("red-ui-clipboard-dialog-export-rng-selected"===t){var n=RED.workspaces.selection();n.length>0?(o=[],n.forEach((function(e){o.push(e),o=(o=o.concat(RED.nodes.groups(e.id))).concat(RED.nodes.filterNodes({z:e.id}))}))):o=RED.view.selection().nodes||[],o=RED.nodes.createExportableNodeSet(o.filter((function(e){return"subflow"!==e.type})))}else if("red-ui-clipboard-dialog-export-rng-flow"===t){var r=RED.workspaces.active();o=(o=RED.nodes.groups(r)).concat(RED.nodes.filterNodes({z:r}));var s=RED.nodes.workspace(r)||RED.nodes.subflow(r);o.unshift(s),o=RED.nodes.createExportableNodeSet(o)}else"red-ui-clipboard-dialog-export-rng-full"===t&&(o=RED.nodes.createCompleteNodeSet(!1));null!==o&&(i="red-ui-clipboard-dialog-export-fmt-full"===a?JSON.stringify(o,null,4):JSON.stringify(o)),i.length>0?$("#red-ui-clipboard-dialog-export").removeClass("disabled"):$("#red-ui-clipboard-dialog-export").addClass("disabled"),$("#red-ui-clipboard-dialog-export-text").val(i),setTimeout((function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0)}),50),$("#red-ui-clipboard-dialog-export-text").trigger("focus")}})),$("#red-ui-clipboard-dialog-ok").hide(),$("#red-ui-clipboard-dialog-cancel").hide(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-import-conflict").hide();var d=RED.workspaces.selection();d.length>0||(d=RED.view.selection()).nodes?$("#red-ui-clipboard-dialog-export-rng-selected").trigger("click"):($("#red-ui-clipboard-dialog-export-rng-selected").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-flow").trigger("click")),"red-ui-clipboard-dialog-export-fmt-full"===a?$("#red-ui-clipboard-dialog-export-fmt-full").trigger("click"):$("#red-ui-clipboard-dialog-export-fmt-mini").trigger("click"),n.activateTab("red-ui-clipboard-dialog-export-tab-"+o);var l=400,c=$(window).height();c<600&&(l=400-(600-c)),$(".red-ui-clipboard-dialog-box").height(l),e.dialog("option","title",RED._("clipboard.exportNodes")).dialog("option","width",700).dialog("open"),$("#red-ui-clipboard-dialog-export-text").trigger("focus"),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").show(),$("#red-ui-clipboard-dialog-download").show(),$("#red-ui-clipboard-dialog-import-conflict").hide()}}function b(e,t,i){e.data([{library:t,type:"flows",icon:"fa fa-hdd-o",label:i,path:"",expanded:!0,children:function(e,i){RED.library.loadLibraryFolder(t,"flows","",(function(t){i.children=t,e(t)}))}}],!0)}function m(){$("#red-ui-drop-target").hide(),RED.keyboard.remove("escape")}function y(i,o){var n=i;if("string"==typeof i)try{if(0===(i=i.trim()).length)return;n=JSON.parse(i)}catch(e){var a=new Error(RED._("clipboard.invalidFlow",{message:e.message}));throw a.code="NODE_RED",a}var r={generateIds:!1,addFlow:o};try{RED.view.importNodes(n,r)}catch(i){!function(i,o,n){var a=RED.notify("<p>"+RED._("clipboard.import.conflictNotification1")+"</p>",{type:"info",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.close()}},{text:RED._("clipboard.import.viewNodes"),click:function(){a.close(),function(i,o,n){var a,r;l={importConfig:i,importNodes:o,importOptions:n};var s,d=[],c=!1;for(a in i.subflows)if(i.subflows.hasOwnProperty(a)){c||(d.push({gutter:$('<span data-i18n="menu.label.subflows"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0);var p=w(r=i.subflows[a],u=i.conflicted[r.id],f=!u);s={id:r.id,gutter:p.gutter.element,element:p.element,class:f?"":"disabled",deferBuild:!0,children:[]},d.push(s),i.zMap[a]&&i.zMap[a].forEach((function(e){var t=w(e,i.conflicted[e.id],f,p.gutter.cb);s.children.push({id:e.id,gutter:t.gutter.element,element:t.element,class:f?"":"disabled"})}))}for(a in c=!1,i.tabs)if(i.tabs.hasOwnProperty(a)){c||(d.push({gutter:$('<span data-i18n="menu.label.flows"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0);var u,f;p=w(r=i.tabs[a],u=i.conflicted[r.id],f=!0);s={id:r.id,gutter:p.gutter.element,element:p.element,icon:"red-ui-icons red-ui-icons-flow",deferBuild:!0,class:f?"":"disabled",children:[]},d.push(s),i.zMap[a]&&i.zMap[a].forEach((function(e){var t=w(e,i.conflicted[e.id],f,p.gutter.cb);s.children.push({id:e.id,gutter:t.gutter.element,element:t.element,class:f?"":"disabled"})}))}c=!1;var h=[];i.all.forEach((function(e){if("tab"!==e.type&&"subflow"!==e.type&&!i.tabs[e.z]&&!i.subflows[e.z]){var t=i.conflicted[e.id],o=!t||!i.configs[e.id],n=w(e,t,o),a={id:e.id,gutter:n.gutter.element,element:n.element,class:o?"":"disabled"};i.configs[e.id]?h.push(a):(c||(d.push({gutter:$('<span data-i18n="menu.label.nodes"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0),d.push(a))}})),h.length>0&&(d.push({gutter:$('<span data-i18n="menu.label.displayConfig"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),c=!0,d=d.concat(h));t.empty(),t.append($(importConflictsDialog));$("#red-ui-clipboard-dialog-import-conflicts-list").css({position:"absolute",top:0,right:0,bottom:0,left:0}).treeList({data:d});t.i18n();var g=400,v=$(window).height();v<600&&(g=400-(600-v));$(".red-ui-clipboard-dialog-box").height(g),$("#red-ui-clipboard-dialog-ok").hide(),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-import-conflict").show(),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("option","width",500).dialog("open")}(i,o,n)}},{text:RED._("clipboard.import.importCopy"),click:function(){a.close(),n.generateIds=!0,RED.view.importNodes(o,n)}}]})}(i.importConfig,n,r)}}function w(e,t,i,o){var n;n="tab"===e.type?function(e){e=JSON.parse(JSON.stringify(e)),e._def=RED.nodes.getType(e.type)||{},e._def&&(e._=e._def._);var t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"}),i=$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t),o="string"==typeof e?e:e.label,n=o.indexOf("\\n");n>-1&&(o=o.substring(0,n)+"...");return i.text(o),t}(e):function(e,t){e=JSON.parse(JSON.stringify(e)),e._def=RED.nodes.getType(e.type)||{},e._def&&(e._=e._def._);var i=$("<div>",{class:"red-ui-info-outline-item"});RED.utils.createNodeIcon(e).appendTo(i);var o=$("<div>",{class:"red-ui-search-result-description"}).appendTo(i),n=function(e){var t=e.name||e.type+": "+e.id;if(e._def.label)try{t=("function"==typeof e._def.label?e._def.label.call(e):e._def.label)||""}catch(t){console.log("Definition error: "+e.type+".label",t)}var i=t.indexOf("\\n");i>-1&&(t=t.substring(0,i)+"...");return t}(e),a=$("<div>",{class:"red-ui-search-result-node-label red-ui-info-outline-item-label"}).appendTo(o);n?a.text(n):a.html(e.type);return i}(e,0);var a=$("<div>",{class:"red-ui-clipboard-dialog-import-conflicts-controls"}).appendTo(n);if(a.on("click",(function(e){e.stopPropagation()})),t&&!o){var r=$("<label><input "+(i?"":"disabled ")+'type="checkbox" data-node-id="'+e.id+'"> <span data-i18n="clipboard.import.replace"></span></label>').appendTo(a);("tab"===e.type||"subflow"!==e.type&&e.hasOwnProperty("x")&&e.hasOwnProperty("y"))&&r.hide()}return{element:n,gutter:E(e,i,o)}}function E(e,t,i){var o=$("<label>",{class:"red-ui-clipboard-dialog-import-conflicts-gutter"}),n=$('<input data-node-id="'+e.id+'" type="checkbox" '+(t?"checked":"")+">").appendTo(o);i&&(n.attr("disabled",!0),i.addChild(n)),o.on("click",(function(e){e.stopPropagation()})),n.on("change",(function(e){var t=this.checked;o.parent().toggleClass("disabled",!t),o.parent().find('.red-ui-clipboard-dialog-import-conflicts-controls  input[type="checkbox"]').attr("disabled",!t),a.forEach((function(e){e.attr("checked",t),e.trigger("change")}))}));var a=[];return{cb:{addChild:function(e){a.push(e)}},element:o}}return{init:function(){e=$('<div id="red-ui-clipboard-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:700,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{id:"red-ui-clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-clipboard-dialog-download",class:"primary",text:RED._("clipboard.download"),click:function(){var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent($("#red-ui-clipboard-dialog-export-text").val())),e.setAttribute("download","flows.json"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),$(this).dialog("close")}},{id:"red-ui-clipboard-dialog-export",class:"primary",text:RED._("clipboard.export.copy"),click:function(){if("red-ui-clipboard-dialog-export-tab-clipboard"===r)$("#red-ui-clipboard-dialog-export-text").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported"),{id:"clipboard"}),$(this).dialog("close");else{var t=$("#red-ui-clipboard-dialog-export-text").val(),i=s.getSelected();i.children||(i=i.parent);var o=$("#red-ui-clipboard-dialog-tab-library-name").val().trim(),n=function(){$.ajax({url:"library/"+i.library+"/"+i.type+"/"+i.path+o,type:"POST",data:t,contentType:"application/json; charset=utf-8"}).done((function(){$(e).dialog("close"),RED.notify(RED._("library.exportedToLibrary"),"success")})).fail((function(e,t,i){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}))};if(i.children){var a=!1;if(i.children.forEach((function(e){e.label===o&&(a=!0)})),a){e.dialog("close");var d=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(o)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){d.hideNotification(),e.dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){d.hideNotification(),n()}}]})}else n()}else n()}}},{id:"red-ui-clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){var e,t="red-ui-clipboard-dialog-import-opt-new"===$("#red-ui-clipboard-dialog-import-opt > a.selected").attr("id");"red-ui-clipboard-dialog-import-tab-clipboard"===r?y($("#red-ui-clipboard-dialog-import-text").val(),t):(e="red-ui-clipboard-dialog-import-tab-library"===r?s.getSelected():d.getSelected()).path&&$.get("library/"+e.library+"/"+e.type+"/"+e.path,(function(e){y(e,t)})),$(this).dialog("close")}},{id:"red-ui-clipboard-dialog-import-conflict",class:"primary",text:RED._("clipboard.import.importSelected"),click:function(){var e={};$('#red-ui-clipboard-dialog-import-conflicts-list input[type="checkbox"]').each((function(){e[$(this).attr("data-node-id")]=this.checked?"import":"skip"})),$('.red-ui-clipboard-dialog-import-conflicts-controls input[type="checkbox"]').each((function(){$(this).attr("disabled")||(e[$(this).attr("data-node-id")]=this.checked?"replace":"copy")})),l.importOptions.importMap=e;var t=l.importNodes.filter((function(t){return e[t.id]&&!e[t.z]||(e[t.id]=e[t.z]),"skip"!==e[t.id]}));RED.view.importNodes(t,l.importOptions),$(this).dialog("close")}}],open:function(e,t){RED.keyboard.disable()},close:function(e){RED.keyboard.enable(),n&&(n.close(!0),a=null)}}),t=e.children(".dialog-form"),i='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="common.label.export"></label><span id="red-ui-clipboard-dialog-export-rng-group" class="button-group"><a id="red-ui-clipboard-dialog-export-rng-selected" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="red-ui-clipboard-dialog-export-rng-flow" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-export-rng-full" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="red-ui-clipboard-dialog-box"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-export-tabs"></ul></div><div id="red-ui-clipboard-dialog-export-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-export-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div class="form-row" style="height:calc(100% - 30px)"><textarea readonly id="red-ui-clipboard-dialog-export-text"></textarea></div><div class="form-row" style="text-align: right;"><span id="red-ui-clipboard-dialog-export-fmt-group" class="button-group"><a id="red-ui-clipboard-dialog-export-fmt-mini" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="red-ui-clipboard-dialog-export-fmt-full" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div></div><div id="red-ui-clipboard-dialog-export-tab-library" class="red-ui-clipboard-dialog-tab-library"><div id="red-ui-clipboard-dialog-export-tab-library-browser"></div><div class="form-row"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-clipboard-dialog-tab-library-name" type="text"></div></div></div></div>',o='<div class="red-ui-clipboard-dialog-box" style="margin-bottom: 12px"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-import-tabs"></ul></div><div id="red-ui-clipboard-dialog-import-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-import-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div class="form-row"><span data-i18n="clipboard.pasteNodes"></span> <a class="red-ui-button" id="red-ui-clipboard-dialog-import-file-upload-btn"><i class="fa fa-upload"></i> <span data-i18n="clipboard.selectFile"></span></a><input type="file" id="red-ui-clipboard-dialog-import-file-upload" accept=".json" style="display:none"></div><div class="form-row" style="height:calc(100% - 47px)"><textarea id="red-ui-clipboard-dialog-import-text"></textarea></div></div><div id="red-ui-clipboard-dialog-import-tab-library" class="red-ui-clipboard-dialog-tab-library"></div><div id="red-ui-clipboard-dialog-import-tab-examples" class="red-ui-clipboard-dialog-tab-library"></div></div></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="red-ui-clipboard-dialog-import-opt" class="button-group"><a id="red-ui-clipboard-dialog-import-opt-current" class="red-ui-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-import-opt-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',importConflictsDialog='<div class="form-row"><div class="form-row"><p data-i18n="clipboard.import.conflictNotification1"></p><p data-i18n="clipboard.import.conflictNotification2"></p></div><div class="red-ui-clipboard-dialog-import-conflicts-list-container"><div id="red-ui-clipboard-dialog-import-conflicts-list"></div></div></div>',$('<input type="text" id="red-ui-clipboard-hidden" tabIndex="-1">').appendTo("#red-ui-editor"),RED.actions.add("core:show-export-dialog",v),RED.actions.add("core:show-import-dialog",g),RED.actions.add("core:show-library-export-dialog",(function(){v("library")})),RED.actions.add("core:show-library-import-dialog",(function(){g("library")})),RED.actions.add("core:show-examples-import-dialog",(function(){g("examples")})),RED.events.on("editor:open",(function(){u=!0})),RED.events.on("editor:close",(function(){u=!1})),RED.events.on("search:open",(function(){u=!0})),RED.events.on("search:close",(function(){u=!1})),RED.events.on("actionList:open",(function(){u=!0})),RED.events.on("actionList:close",(function(){u=!1})),RED.events.on("type-search:open",(function(){u=!0})),RED.events.on("type-search:close",(function(){u=!1})),$('<div id="red-ui-drop-target"><div data-i18n="[append]workspace.dropFlowHere"><i class="fa fa-download"></i><br></div></div>').appendTo("#red-ui-editor"),$("#red-ui-workspace-chart").on("dragenter",(function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#red-ui-drop-target").css({display:"table"}),RED.keyboard.add("*","escape",m))})),$("#red-ui-drop-target").on("dragover",(function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()})).on("dragleave",(function(e){m()})).on("drop",(function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");y(t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1))}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var i=e.originalEvent.dataTransfer.files;if(1===i.length){var o=i[0],n=new FileReader;n.onload=function(e){y(e.target.result)},n.readAsText(o)}}m(),e.preventDefault()}))},import:g,export:v,copyText:function(e,t,i){var o=!1;"string"!=typeof e&&(e=JSON.stringify(e,(function(e,t){if(null!==t&&"object"==typeof t&&t.__enc__){if(t.hasOwnProperty("data")&&t.hasOwnProperty("length"))return o=t.data.length!==t.length,t.data;if("function"===t.type||"internal"===t.type)return;if("number"===t.type)return null;if("bigint"===t.type)return t.data.toString();if("undefined"===t.type)return}return t}))),o&&(i+="_truncated"),$("#red-ui-clipboard-hidden").val(e).select();var n=document.execCommand("copy");if(n&&t){var a=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(i)});setTimeout((function(){a.close()}),1e3),a.open()}return n}}}(),RED.library=function(){var e,t,i,o,n;function a(e,t,i,o){$.getJSON("library/"+e+"/"+t+"/"+i,(function(n){var r=n.map((function(o){return"string"==typeof o?{library:e,type:t,icon:"fa fa-folder",label:o,path:i+o+"/",children:function(n,r){a(e,t,i+o+"/",(function(e){r.children=e,n(e)}))}}:{library:e,type:t,icon:"fa fa-file-o",label:o.fn,path:i+o.fn,props:o}}));r.sort((function(e,t){return e.children&&!t.children?-1:!e.children&&t.children?1:e.label.localeCompare(t.label)})),o(r)}))}function r(e){n&&clearTimeout(n),n=setTimeout((function(){var t=e.val().trim();t.length>0&&!/[\/\\]/.test(t)?(e.removeClass("input-error"),$("#red-ui-library-dialog-save-button").button("enable")):(e.addClass("input-error"),$("#red-ui-library-dialog-save-button").button("disable"))}),100)}return{init:function(){$('<div id="red-ui-library-dialog-save" class="hide"><form class="form-horizontal"><div class="red-ui-library-dialog-box" style="height: 400px; position:relative; "><div id="red-ui-library-dialog-save-browser"></div><div class="form-row"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-library-dialog-save-filename" type="text"></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$('<div id="red-ui-library-dialog-load" class="hide"><form class="form-horizontal"><div class="red-ui-library-dialog-box" style="height: 400px; position:relative; "><div id="red-ui-library-dialog-load-panes"><div class="red-ui-panel" id="red-ui-library-dialog-load-browser"></div><div class="red-ui-panel"><div id="red-ui-library-dialog-load-preview"><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-text"></div><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-details"><table id="red-ui-library-dialog-load-preview-details-table" class="red-ui-info-table"></table></div></div></div></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$("#red-ui-library-dialog-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:800,resizable:!1,open:function(e,t){RED.keyboard.disable()},close:function(e,t){RED.keyboard.enable()},classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-library-dialog-save-button",text:RED._("common.label.save"),class:"primary",click:function(){!function(){var e=o.elementPrefix||"node-input-",i=$("#"+e+"name").val().trim();""===i&&(i=RED._("library.unnamedType",{type:o.type}));var n=$("#red-ui-library-dialog-save-filename").val().trim(),a=t.getSelected();a.children||(a=a.parent);for(var r={},s=0;s<o.fields.length;s++){var d=o.fields[s];"name"===d?r.name=i:"object"==typeof d?r[d.name]=d.get():r[d]=$("#"+e+d).val()}r.text=o.editor.getValue();var l=function(){$.ajax({url:"library/"+a.library+"/"+a.type+"/"+a.path+n,type:"POST",data:JSON.stringify(r),contentType:"application/json; charset=utf-8"}).done((function(e,t,i){RED.notify(RED._("library.savedType",{type:o.type}),"success")})).fail((function(e,t,i){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}))};if(a.children){var c=!1;if(a.children.forEach((function(e){e.label===n&&(c=!0)})),c){$("#red-ui-library-dialog-save").dialog("close");var p=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(n)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){p.hideNotification(),$("#red-ui-library-dialog-save").dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){p.hideNotification(),l()}}]})}else l()}else l()}(),$(this).dialog("close")}}]}),t=RED.library.createBrowser({container:$("#red-ui-library-dialog-save-browser"),folderTools:!0,onselect:function(e){e.label&&(e.children||($("#red-ui-library-dialog-save-filename").val(e.label),e=e.parent),!1===e.writable?$("#red-ui-library-dialog-save-button").button("disable"):$("#red-ui-library-dialog-save-button").button("enable"))}}),$("#red-ui-library-dialog-save-filename").on("keyup",(function(){r($(this))})),$("#red-ui-library-dialog-save-filename").on("paste",(function(){var e=$(this);setTimeout((function(){r(e)}),10)})),$("#red-ui-library-dialog-load").dialog({modal:!0,autoOpen:!1,width:800,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(selectedLibraryItem){for(var e=o.elementPrefix||"node-input-",t=0;t<o.fields.length;t++){var n=o.fields[t];if("object"==typeof n){var a=selectedLibraryItem[n.name];n.set(a)}else $("#"+e+n).val(selectedLibraryItem[n])}o.editor.setValue(i.getValue(),-1)}$(this).dialog("close")}}],open:function(e){RED.keyboard.disable(),$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){RED.keyboard.enable(),i&&(i.destroy(),i=null)}}),e=RED.library.createBrowser({container:$("#red-ui-library-dialog-load-browser"),onselect:function(e){var t=$("#red-ui-library-dialog-load-preview-details-table").empty();selectedLibraryItem=e.props,e&&e.label&&!e.children?$.get("library/"+e.library+"/"+e.type+"/"+e.path,(function(n){var a=$('<tr class="red-ui-help-info-row"><td>Type</td><td></td></tr>').appendTo(t);for(var r in $(a.children()[1]).text(o.type),e.props.hasOwnProperty("name")&&(a=$('<tr class="red-ui-help-info-row"><td>Name</td><td>'+e.props.name+"</td></tr>").appendTo(t),$(a.children()[1]).text(e.props.name)),e.props)e.props.hasOwnProperty(r)&&"name"!==r&&"fn"!==r&&(a=$('<tr class="red-ui-help-info-row"><td></td><td></td></tr>').appendTo(t),$(a.children()[0]).text(r),RED.utils.createObjectElement(e.props[r]).appendTo(a.children()[1]));i.setValue(n,-1)})):i.setValue("",-1)}}),RED.panels.create({container:$("#red-ui-library-dialog-load-panes"),dir:"horizontal",resize:function(){i.resize()}}),RED.panels.create({container:$("#red-ui-library-dialog-load-preview"),dir:"vertical",resize:function(){i.resize()}})},create:function(n){var r=n.elementPrefix||"node-input-";n.editor.setText&&(n.editor.setValue=function(e,t){n.editor.setText.call(n.editor,e)}),n.editor.getText&&(n.editor.getValue=n.editor.getText),$("#"+r+"name").css("width","calc(100% - 52px)").after('<div style="margin-left:5px; display: inline-block;position: relative;"><a id="node-input-'+n.type+'-lookup" class="red-ui-button"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a></div>'),RED.menu.init({id:"node-input-"+n.type+"-lookup",options:[{id:"node-input-"+n.type+"-menu-open-library",label:RED._("library.openLibrary"),onselect:function(){o=n,a("local",n.url,"",(function(t){var i=[{library:"local",type:n.url,icon:"fa fa-hdd-o",label:RED._("library.types.local"),path:"",expanded:!0,writable:!1,children:[{library:"local",type:n.url,icon:"fa fa-cube",label:n.type,path:"",expanded:!0,children:t}]}];e.data(i),setTimeout((function(){e.select(i[0].children[0])}),200)})),(i=ace.edit("red-ui-library-dialog-load-preview-text",{useWorker:!1})).setTheme("ace/theme/tomorrow"),n.mode&&i.getSession().setMode(n.mode),i.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),i.renderer.$cursorLayer.element.style.opacity=0,i.$blockScrolling=1/0;var t=400,r=$(window).height();r<570&&(t=400-(570-r)),$("#red-ui-library-dialog-load .red-ui-library-dialog-box").height(t),$("#red-ui-library-dialog-load").dialog("option","title",RED._("library.typeLibrary",{type:n.type})).dialog("open")}},{id:"node-input-"+n.type+"-menu-save-library",label:RED._("library.saveToLibrary"),onselect:function(){o=n;var e=$("#"+r+"name").val().replace(/(^\s*)|(\s*$)/g,"").replace(/[^\w-]/g,"-");""===e&&(e="unnamed-"+n.type),$("#red-ui-library-dialog-save-filename").attr("value",e+"."+(n.ext||"txt")),a("local",n.url,"",(function(e){var i=[{library:"local",type:n.url,icon:"fa fa-hdd-o",label:RED._("library.types.local"),path:"",expanded:!0,writable:!1,children:[{library:"local",type:n.url,icon:"fa fa-cube",label:n.type,path:"",expanded:!0,children:e}]}];t.data(i),setTimeout((function(){t.select(i[0].children[0])}),200)}));var i=400,s=$(window).height();s<570&&(i=400-(570-s)),$("#red-ui-library-dialog-save .red-ui-library-dialog-box").height(i),$("#red-ui-library-dialog-save").dialog("open")}}]})},createBrowser:function(e){var t=$('<div class="red-ui-library-browser"></div>').appendTo(e.container),i=$("<div>").css({width:"100%",height:"100%"}).appendTo(t).treeList({}).on("treelistselect",(function(t,i){e.onselect&&e.onselect(i)})).on("treelistconfirm",(function(t,i){e.onconfirm&&e.onconfirm(i)})),o=$("<div>").css({position:"absolute",bottom:"6px",right:"8px"}),n=$('<button class="red-ui-button red-ui-button-small" type="button"><i class="fa fa-ellipsis-h"></i></button>').on("click",(function(e){e.preventDefault(),e.stopPropagation();var t=n.offset(),o=RED.menu.init({id:"red-ui-library-browser-menu",options:[{id:"red-ui-library-browser-menu-addFolder",label:RED._("library.newFolder"),onselect:function(){var e="new-folder",t={},o=i.treeList("selected");o.children||(o=o.parent);o.treeList.expand((function(){o.children.forEach((function(e){/^new-folder/.test(e.label)&&(t[e.label]=!0)}));for(var i=2;t[e];)e="new-folder-"+i++;o.treeList.expand();var n=$('<input type="text" class="red-ui-treeList-input">').val(e),a={icon:"fa fa-folder-o",children:[],path:o.path,element:n},r=function(){var e=n.val().trim();if(""!==e){for(var t=0;t<o.children.length;t++)if(o.children[t].label===e)return void s();a.treeList.remove();var i={library:o.library,type:o.type,icon:"fa fa-folder",children:[],label:e,path:a.path+e+"/"};o.treeList.addChild(i,!0)}else s()},s=function(){a.treeList.remove()};n.on("keydown",(function(e){e.stopPropagation(),13===e.keyCode?r():27===e.keyCode&&s()})),n.on("blur",(function(){r()})),o.treeList.addChild(a),setTimeout((function(){n.trigger("focus"),n.select()}),400)}))}}]}).on("mouseleave",(function(){$(this).remove(),i.focus()})).on("mouseup",(function(){var e=$(this);e.hide(),i.focus(),setTimeout((function(){e.remove()}),100)})).appendTo("body");o.css({position:"absolute",top:t.top+"px",left:t.left-o.width()+20+"px"}).show()})).appendTo(o);return e.folderTools&&i.on("treelistselect",(function(e,t){!1!==t.writable&&t.treeList&&o.appendTo(t.treeList.label)})),{select:function(e){i.treeList("select",e)},getSelected:function(){return i.treeList("selected")},focus:function(){i.focus()},data:function(e,t){i.treeList("data",e),t&&setTimeout((function(){i.treeList("select",e[0])}),100)}}},export:function(){console.warn("Deprecated call to RED.library.export")},loadLibraryFolder:a}}(),RED.notifications=function(){var e,t={},i=[],o=0;function n(n,a,r,s){var d={};if(null!==a&&"object"==typeof a&&(r=(d=a).fixed,s=d.timeout,a=d.type),d.id&&t.hasOwnProperty(d.id))return t[d.id].update(n,d),t[d.id];if(d.modal&&$("#red-ui-full-shade").show(),i.length>4)for(var l=i.length,c=0;l>4&&c<i.length;c+=1){var p=i[c];p.fixed||(window.clearTimeout(p.timeoutid),p.close(),l-=1)}var u=document.createElement("div");if(u.id="red-ui-notification-"+o,u.className="red-ui-notification",u.fixed=r,a&&(u.className="red-ui-notification red-ui-notification-"+a),d.width){var f=$("#red-ui-notifications").width();if(d.width>f){var h=-(d.width-f)/2;$(u).css({width:d.width+"px",marginLeft:h+"px"})}}if(u.style.display="none","string"==typeof n?(/<p>/i.test(n)||(n="<p>"+n+"</p>"),u.innerHTML=n):$(u).append(n),d.buttons){var g=$('<div class="ui-dialog-buttonset"></div>').appendTo(u);d.buttons.forEach((function(e){var t=$("<button>").html(e.text).on("click",e.click).appendTo(g);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)}))}return $("#red-ui-notifications").append(u),RED.notifications.hide||$(u).slideDown(300),u.close=function(){var o=u;return function(){o.closed||(o.closed=!0,i.splice(i.indexOf(o),1),d.id&&(delete t[d.id],0===Object.keys(t).length&&e.hide()),RED.notifications.hide?o.parentNode.removeChild(o):$(o).slideUp(300,(function(){o.parentNode.removeChild(o)})),d.modal&&$("#red-ui-full-shade").hide())}}(),u.hideNotification=function(){var e=u;return function(){e.closed||(e.hidden=!0,RED.notifications.hide||$(e).slideUp(300))}}(),u.showNotification=function(){var e=u;return function(){!e.closed&&e.hidden&&(e.hidden=!1,RED.notifications.hide||$(e).slideDown(300))}}(),u.update=function(){var e=u;return function(t,i){var o;if("string"==typeof t?(/<p>/i.test(t)||(t="<p>"+t+"</p>"),e.innerHTML=t):$(e).empty().append(t),"number"==typeof i)o=i;else if(void 0!==i&&(i.fixed||(o=i.timeout||5e3),i.buttons)){var n=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(e);i.buttons.forEach((function(e){var t=$("<button>").text(e.text).on("click",e.click).appendTo(n);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)}))}void 0!==o&&o>0?(window.clearTimeout(e.timeoutid),e.timeoutid=window.setTimeout(e.close,o)):window.clearTimeout(e.timeoutid),e.hidden?e.showNotification():i&&i.silent||($(e).addClass("red-ui-notification-shake-horizontal"),setTimeout((function(){$(e).removeClass("red-ui-notification-shake-horizontal")}),300))}}(),r||($(u).on("click",function(){var e=u;return function(){e.close(),window.clearTimeout(e.timeoutid)}}()),u.timeoutid=window.setTimeout(u.close,s||5e3)),i.push(u),d.id&&(t[d.id]=u,d.fixed&&e.show()),o+=1,u}return RED.notify=n,{init:function(){$('<div id="red-ui-notifications"></div>').appendTo("#red-ui-editor"),e=$("<li></li>").prependTo(".red-ui-header-toolbar").hide(),$('<a class="button" href="#"><i class="fa fa-warning"></i></a>').appendTo(e).on("click",(function(){!function(){for(var e in t)t.hasOwnProperty(e)&&t[e].showNotification()}()}))},notify:n}}(),RED.search=function(){var e,t,o,n=!1,a=null,r=-1,s=!1,d={},l=[];function c(e,t,i){if("string"==typeof i||"number"==typeof i)i=(""+i).toLowerCase(),d[i]=d[i]||{},d[i][e.id]={node:e,label:t};else if(Array.isArray(i))i.forEach((function(i){c(e,t,i)}));else if("object"==typeof i)for(var o in i)i.hasOwnProperty(o)&&c(e,t,i[o])}function p(e,t,i){var o=new RegExp("(?:^| )is:"+t+"(?: |$)");return o.exec(e)&&(e=e.replace(o," ").trim(),i[t]=!0),e}function u(e){var t,i=[],o=[],n=/(?:^| )type:([^ ]+)/.exec(e);n&&(e=e.replace(/(?:^| )type:[^ ]+/,""),t=n[1]);var a={};e=p(e,"invalid",a),e=p(e,"unused",a),e=p(e,"config",a),e=function(e,t,i){for(var o,n=new RegExp("(?:^| )"+t+":([^ ]+)(?: |$)");o=n.exec(e);)e=e.replace(n," ").trim(),i[t]=i[t]||[],i[t].push(o[1]);return e}(e=p(e,"subflow",a),"uses",a);var r=Object.keys(a).length>0;if((e=e.trim()).length>0||t||r){var s,l;e=e.toLowerCase();var c=[],u={};for(o=a.uses?a.uses:Object.keys(d),s=0;s<o.length;s++){var f=o[s],h=o[s].indexOf(e);if(h>-1){var g=Object.keys(d[f]);for(l=0;l<g.length;l++){var v=d[f][g[l]],b="config"===v.node._def.category&&"group"!==v.node.type;if(!a.uses||f!==v.node.id){if(a.hasOwnProperty("invalid")){var m=!v.node.hasOwnProperty("valid")||v.node.valid;if(a.invalid===m)continue}if(!(a.hasOwnProperty("config")&&a.config!==b||a.hasOwnProperty("subflow")&&a.subflow!==("subflow"===v.node.type))){if(a.hasOwnProperty("unused")){var y="subflow"===v.node.type&&0===v.node.instances.length||b&&0===v.node.users.length;if(a.unused!==y)continue}t&&v.node.type!==t||(u[v.node.id]=u[v.node.id]={node:v.node,label:v.label},u[v.node.id].index=Math.min(u[v.node.id].index||1/0,h))}}}}}for((c=Object.keys(u)).sort((function(e,t){return u[e].index-u[t].index})),s=0;s<c.length;s++)i.push(u[c[s]])}return i}function f(){var e=t.find("li.selected");if(1===e.length){var i=t.parent(),o=i.height(),n=(i.scrollTop(),e.position().top),a=e.height();n+a>o?i.animate({scrollTop:"-="+(o-(n+a)-10)},50):n<0&&i.animate({scrollTop:"+="+(n-10)},50)}}function h(e){v(),RED.view.reveal(e.id)}function g(d){n||(s||(o=document.activeElement,RED.keyboard.add("*","escape",(function(){v()})),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),null===a&&function(){a=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#red-ui-main-container");var o=$("<div>",{class:"red-ui-search-container"}).appendTo(a);e=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(o).searchBox({delay:200,change:function(){if(t.editableList("empty"),r=-1,(l=u($(this).val())).length>0){for(i=0;i<Math.min(l.length,25);i++)t.editableList("addItem",l[i]);l.length>25&&t.editableList("addItem",{more:{results:l,start:25}})}else t.editableList("addItem",{})}}),$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-caret-right"></button>').appendTo(o).on("click",(function(t){t.preventDefault(),RED.sidebar.info.outliner.search(e.val()),v()})),e.on("keydown",(function(e){var o;if(l.length>0)if(40===e.keyCode)o=t.children(),r<o.length-1&&(r>-1&&$(o[r]).removeClass("selected"),r++),$(o[r]).addClass("selected"),f(),e.preventDefault();else if(38===e.keyCode)o=t.children(),r>0&&(r<o.length&&$(o[r]).removeClass("selected"),r--),$(o[r]).addClass("selected"),f(),e.preventDefault();else if(13===e.keyCode)if(o=t.children(),$(o[r]).hasClass("red-ui-search-more")){var n=$(o[r]).find(".red-ui-editableList-item-content").data("data");if(n){for(t.editableList("removeItem",n),i=n.more.start;i<Math.min(l.length,n.more.start+25);i++)t.editableList("addItem",l[i]);l.length>n.more.start+25&&t.editableList("addItem",{more:{results:l,start:n.more.start+25}})}}else l.length>0&&h(l[Math.max(0,r)].node)})),e.i18n();var n=$("<div>",{class:"red-ui-search-results-container"}).appendTo(a);t=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(n).editableList({addButton:!1,addItem:function(e,i,o){var n,a=o.node;if(o.more)e.parent().addClass("red-ui-search-more"),(n=$("<a>",{href:"#",class:"red-ui-search-result red-ui-search-empty"}).appendTo(e)).text(RED._("palette.editor.more",{count:o.more.results.length-o.more.start})),n.on("click",(function(e){for(e.preventDefault(),t.editableList("removeItem",o),i=o.more.start;i<Math.min(l.length,o.more.start+25);i++)t.editableList("addItem",l[i]);l.length>o.more.start+25&&t.editableList("addItem",{more:{results:l,start:o.more.start+25}})}));else if(void 0===a)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{a._def,n=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),RED.utils.createNodeIcon(a).appendTo(n);var r=$("<div>",{class:"red-ui-search-result-node-description"}).appendTo(n);if(a.z){var s=RED.nodes.workspace(a.z);s=s?"flow:"+s.label:"subflow:"+(s=RED.nodes.subflow(a.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).text(s).appendTo(r)}$("<div>",{class:"red-ui-search-result-node-label"}).text(o.label||a.id).appendTo(r),$("<div>",{class:"red-ui-search-result-node-type"}).text(a.type).appendTo(r),$("<div>",{class:"red-ui-search-result-node-id"}).text(a.id).appendTo(r),n.on("click",(function(e){e.preventDefault(),h(a)}))}},scrollOnAdd:!1})}(),a.slideDown(300),e.searchBox("value",d),RED.events.emit("search:open"),s=!0),e.trigger("focus"))}function v(){s&&(RED.keyboard.remove("escape"),s=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==a&&a.slideUp(200,(function(){e.searchBox("value","")})),RED.events.emit("search:close"),o&&($(o).trigger("focus"),o=null))}function b(){d={}}function m(e){!function(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),d[t]=d[t]||{},d[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var i=["id","type","name","label","info"];e._def&&e._def.defaults&&(i=i.concat(Object.keys(e._def.defaults)));for(var o=0;o<i.length;o++)if(e.hasOwnProperty(i[o])){if("group"===e.type&&"nodes"===i[o])continue;c(e,t,e[i[o]])}}(e)}function y(e){for(var t=Object.keys(d),i=0,o=t.length;i<o;i++)delete d[t[i]][e.id],0===Object.keys(d[t[i]]).length&&delete d[t[i]]}function w(e){y(e),m(e)}return{init:function(){RED.actions.add("core:search",g),RED.events.on("editor:open",(function(){n=!0})),RED.events.on("editor:close",(function(){n=!1})),RED.events.on("type-search:open",(function(){n=!0})),RED.events.on("type-search:close",(function(){n=!1})),RED.events.on("actionList:open",(function(){n=!0})),RED.events.on("actionList:close",(function(){n=!1})),$("#red-ui-header-shade").on("mousedown",v),$("#red-ui-editor-shade").on("mousedown",v),$("#red-ui-palette-shade").on("mousedown",v),$("#red-ui-sidebar-shade").on("mousedown",v),RED.events.on("workspace:clear",b),RED.events.on("flows:add",m),RED.events.on("flows:remove",y),RED.events.on("flows:change",w),RED.events.on("subflows:add",m),RED.events.on("subflows:remove",y),RED.events.on("subflows:change",w),RED.events.on("nodes:add",m),RED.events.on("nodes:remove",y),RED.events.on("nodes:change",w),RED.events.on("groups:add",m),RED.events.on("groups:remove",y),RED.events.on("groups:change",w)},show:g,hide:v,search:u}}(),RED.actionList=function(){var e,t,i,o=!1,n=null,a=!1,r="",s=[];function d(){var e=t.find("li.selected");if(1===e.length){var i=t.parent(),o=i.height(),n=(i.scrollTop(),e.position().top),a=e.height();n+a>o?i.animate({scrollTop:"-="+(o-(n+a)-10)},50):n<0&&i.animate({scrollTop:"+="+(n-10)},50)}}function l(e){p(),e&&RED.actions.invoke(e.id)}function c(c){if(!o){if(!a){i=document.activeElement,RED.keyboard.add("*","escape",(function(){p()})),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),null===n&&function(){n=$("<div>",{id:"red-ui-actionList",class:"red-ui-search"}).appendTo("#red-ui-main-container");var i=$("<div>",{class:"red-ui-search-container"}).appendTo(n);(e=$('<input type="text" data-i18n="[placeholder]keyboard.filterActions">').appendTo(i).searchBox({change:function(){r=$(this).val().trim(),s=r.split(" "),t.editableList("filter"),t.find("li.selected").removeClass("selected");var e=t.children(":visible");e.length&&$(e[0]).addClass("selected")}})).on("keydown",(function(e){var i;if(40===e.keyCode){if((i=t.find("li.selected")).length)(n=i.nextAll(":visible").first()).length&&(i.removeClass("selected"),n.addClass("selected"));else{var o=t.children(":visible");o.length&&$(o[0]).addClass("selected")}d(),e.preventDefault()}else if(38===e.keyCode){var n;(n=(i=t.find("li.selected")).prevAll(":visible").first()).length&&(i.removeClass("selected"),n.addClass("selected")),d(),e.preventDefault()}else 13===e.keyCode&&(i=t.find("li.selected"),l(t.editableList("getItem",i)))})),e.i18n();var o=$("<div>",{class:"red-ui-search-results-container"}).appendTo(n);t=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(o).editableList({addButton:!1,addItem:function(e,t,i){if(void 0===i.id)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{var o=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),n=$("<div>",{class:"red-ui-search-result-action"}).appendTo(o);$("<div>").text(i.label).appendTo(n),i.key&&$("<div>",{class:"red-ui-search-result-action-key"}).html(RED.keyboard.formatKey(i.key)).appendTo(n),o.on("click",(function(e){e.preventDefault(),l(i)}))}},scrollOnAdd:!1,filter:function(e){if(""!==r){for(var t=0,i=0;i<s.length;i++){var o=e._label.indexOf(s[i],t);if(!(o>-1))return!1;t=o}return!0}return!0}})}(),n.slideDown(300),e.searchBox("value",c),t.editableList("empty"),results=[];var u=RED.actions.list();u.sort((function(e,t){return e.id.localeCompare(t.id)})),u.forEach((function(e){e.label=e.id.replace(/:/,": ").replace(/-/g," ").replace(/(^| )./g,(function(){return arguments[0].toUpperCase()})),e._label=e.label.toLowerCase(),t.editableList("addItem",e)})),RED.events.emit("actionList:open"),a=!0}e.trigger("focus");var f=t.children(":visible");f.length&&$(f[0]).addClass("selected")}}function p(){a&&(RED.keyboard.remove("escape"),a=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==n&&n.slideUp(200,(function(){e.searchBox("value","")})),RED.events.emit("actionList:close"),i&&($(i).trigger("focus"),i=null))}return{init:function(){RED.actions.add("core:show-action-list",c),RED.events.on("editor:open",(function(){o=!0})),RED.events.on("editor:close",(function(){o=!1})),RED.events.on("search:open",(function(){o=!0})),RED.events.on("search:close",(function(){o=!1})),RED.events.on("type-search:open",(function(){o=!0})),RED.events.on("type-search:close",(function(){o=!1})),$("#red-ui-header-shade").on("mousedown",p),$("#red-ui-editor-shade").on("mousedown",p),$("#red-ui-palette-shade").on("mousedown",p),$("#red-ui-sidebar-shade").on("mousedown",p)},show:c,hide:p}}(),RED.typeSearch=function(){var e,t,i,o,n,a,r=null,s=-1,d=!1,l="",c={};function p(){var e=t.find("li.selected");if(1===e.length){var i=t.parent(),o=i.height(),n=(i.scrollTop(),e.position().top),a=e.height();n+a>o?i.animate({scrollTop:"-="+(o-(n+a)-10)},50):n<0&&i.animate({scrollTop:"+="+(n-10)},50)}}function u(e,t){var i=r.position();i.top=i.top+t+"px",i.left=i.left+e+"px",r.css(i),a(e,t)}function f(){r=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#red-ui-main-container");var n=$("<div>",{class:"red-ui-search-container"}).appendTo(r);(e=$('<input type="text" id="red-ui-type-search-input">').attr("placeholder",RED._("search.addNode")).appendTo(n).searchBox({delay:50,change:function(){var e;e=$(this).val(),l=e.toLowerCase(),t.editableList("filter"),t.editableList("sort"),setTimeout((function(){s=0,t.children().removeClass("selected"),t.children(":visible:first").addClass("selected")}),100)}})).on("keydown",(function(e){var i=t.children(":visible");if(40===e.keyCode&&e.shiftKey)e.preventDefault(),u(0,10);else if(38===e.keyCode&&e.shiftKey)e.preventDefault(),u(0,-10);else if(39===e.keyCode&&e.shiftKey)e.preventDefault(),u(10,0);else if(37===e.keyCode&&e.shiftKey)e.preventDefault(),u(-10,0);else if(i.length>0){if(40===e.keyCode)s<i.length-1&&(s>-1&&$(i[s]).removeClass("selected"),s++),$(i[s]).addClass("selected"),p(),e.preventDefault();else if(38===e.keyCode)s>0&&(s<i.length&&$(i[s]).removeClass("selected"),s--),$(i[s]).addClass("selected"),p(),e.preventDefault();else if((e.metaKey||e.ctrlKey)&&13===e.keyCode){if(e.preventDefault(),(a=Math.max(0,s))<i.length){var n=$(i[a]).find(".red-ui-editableList-item-content").data("data");c[n.type]=Date.now(),0===n.def.outputs?h(n):o(n.type,!0),$("#red-ui-type-search-input").val("").trigger("keyup"),setTimeout((function(){$("#red-ui-type-search-input").focus()}),100)}}else if(13===e.keyCode){var a;e.preventDefault(),(a=Math.max(0,s))<i.length&&h($(i[a]).find(".red-ui-editableList-item-content").data("data"))}}else 13===e.keyCode&&(e.stopPropagation(),e.preventDefault())})),i=$("<div>",{class:"red-ui-search-results-container"}).appendTo(r),t=$("<ol>",{style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(i).editableList({addButton:!1,filter:function(e){return""===l||!e.recent&&!e.common&&(""===l||e.index.indexOf(l)>-1)},sort:function(e,t){if(""===l)return e.i-t.i;var i=e.index.indexOf(l),o=t.index.indexOf(l);return-1===i?1:-1===o?-1:i===o?m(e,t):i-o},addItem:function(e,t,i){var o=i.def;i.index=i.type.toLowerCase(),i.separator&&e.addClass("red-ui-search-result-separator");var n=$("<div>",{class:"red-ui-search-result"}).appendTo(e),a=$("<div>",{class:"red-ui-search-result-node"}).appendTo(n),r=RED.utils.getNodeColor(i.type,o),s=RED.utils.getNodeIcon(o);a.css("backgroundColor",r);var d=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(a);RED.utils.createIconElement(s,d,!1),o.inputs>0&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(a),o.outputs>0&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(a);var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(n),c=i.label;i.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).text(c).appendTo(l),n.on("click",(function(e){e.preventDefault(),h(i)}))},scrollOnAdd:!1})}function h(e){v(),c[e.type]=Date.now(),o(e.type)}function g(e){if(d){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}v(!0),n&&n()}}function v(t){d&&(RED.keyboard.remove("escape"),d=!1,null!==r&&i.slideUp(t?50:200,(function(){r.hide(),e.searchBox("value","")})),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"),$(document).off("touchstart.red-ui-type-search"))}function b(e,t){var i=e;if(void 0!==t.paletteLabel)try{i=("function"==typeof t.paletteLabel?t.paletteLabel.call(t):t.paletteLabel)||"",i+=" ("+e+")"}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}return i}function m(e,t){var i=e.label.toLowerCase(),o=t.label.toLowerCase();return i<o?-1:i===o?0:1}function y(e,t,i){return!e||(!e.type||t===e.type)&&(!e.input||i.inputs>0)&&(!e.output||i.outputs>0)}function w(i){var o;t.editableList("empty"),e.searchBox("value","").focus(),s=-1;var n=["inject","debug","function","change","switch"].filter((function(e){return y(i.filter,e,RED.nodes.getType(e))})),a=Object.keys(c);a.sort((function(e,t){return c[t]-c[e]})),a=a.filter((function(e){return y(i.filter,e,RED.nodes.getType(e))&&-1===n.indexOf(e)}));var r=[];RED.nodes.registry.getNodeTypes().forEach((function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&r.push({type:e,def:t,label:b(e,t)})})),r.sort(m);var d,l=0;for(o=0;o<n.length;o++){var p=RED.nodes.getType(n[o]);p&&((d={type:n[o],common:!0,def:p,i:l++}).label=b(d.type,d.def),o===n.length-1&&(d.separator=!0),t.editableList("addItem",d))}for(o=0;o<Math.min(5,a.length);o++)(d={type:a[o],def:RED.nodes.getType(a[o]),recent:!0,i:l++}).label=b(d.type,d.def),o===a.length-1&&(d.separator=!0),t.editableList("addItem",d);for(o=0;o<r.length;o++)y(i.filter,r[o].type,r[o].def)&&(r[o].i=l++,t.editableList("addItem",r[o]));setTimeout((function(){s=0,t.children(":first").addClass("selected")}),100)}return{show:function(t){d?(r.hide(),i.hide()):(RED.keyboard.add("*","escape",(function(){v(),n&&n()})),null===r&&f(),d=!0),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"),$(document).off("touchstart.red-ui-type-search"),$(document).off("mousedown.red-ui-type-search"),setTimeout((function(){$(document).on("mousedown.red-ui-type-search",g),$(document).on("mouseup.red-ui-type-search",g),$(document).on("click.red-ui-type-search",g),$(document).on("touchstart.red-ui-type-search",g)}),200),w(t),o=t.add,n=t.cancel,a=t.move,RED.events.emit("type-search:open"),$("#red-ui-main-container").height()-t.y-150<0&&(t.y=t.y-235),r.css({left:t.x+"px",top:t.y+"px"}).show(),i.slideDown(300),setTimeout((function(){i.find(".red-ui-editableList-container").scrollTop(0),t.disableFocus||e.trigger("focus")}),100)},refresh:w,hide:v}}(),RED.subflow=function(){var e="en-US";function t(e,t){var i={x:50,y:30};t||(i.x+=110);var o=[].concat(e.out).concat(e.in);e.status&&o.push(e.status),o.sort((function(e,t){return e.x-t.x}));for(var n=0;n<o.length;n++){var a=o[n];a.x==i.x&&a.y==i.y&&(i.x+=55)}return i}function o(){var e=RED.nodes.subflow(RED.workspaces.active());if(0!==e.in.length){var t=e.in[0],i=[];return RED.nodes.eachLink((function(o){("subflow"==o.source.type&&o.source.z==e.id&&o.source.i==t.i||o.target.type=="subflow:"+e.id)&&i.push(o)})),i.forEach((function(e){RED.nodes.removeLink(e)})),e.in=[],$("#red-ui-subflow-input-add").removeClass("active"),$("#red-ui-subflow-input-remove").addClass("active"),e.changed=!0,RED.events.emit("subflows:change",e),{subflowInputs:[t],links:i}}}function n(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var o=[];for(e.sort((function(e,t){return t.i-e.i})),i=0;i<e.length;i++){var n=e[i];t.out.splice(n.i,1);var a=[],r=[];RED.nodes.eachLink((function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==n.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==n.i?a.push(e):e.sourcePort>n.i&&r.push(e))})),a.forEach((function(e){RED.nodes.removeLink(e)})),r.forEach((function(e){e.sourcePort--})),o=o.concat(a);for(var s=n.i;s<t.out.length;s++)t.out[s].i--,t.out[s].dirty=!0}return t.changed=!0,RED.events.emit("subflows:change",t),{subflowOutputs:e,links:o}}}function a(){var e=RED.nodes.subflow(RED.workspaces.active());if(e.status){var t=[];return RED.nodes.eachLink((function(i){"subflow"==i.target.type&&i.target.z==e.id&&"status"==i.target.direction&&t.push(i)})),t.forEach((function(e){RED.nodes.removeLink(e)})),delete e.status,$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status),{links:t}}}function r(e){var t=RED.nodes.subflow(RED.workspaces.active());s(t);var i=[];if(t)return RED.nodes.filterNodes({type:"subflow:"+t.id}).forEach((function(o){i.push({id:o.id,changed:o.changed}),e&&(o.changed=!0),o.inputs=t.in.length,o.outputs=t.out.length,o.resize=!0,o.dirty=!0,RED.editor.updateNodeProperties(o)})),RED.editor.validateNode(t),{instances:i}}function s(e){e&&($("#red-ui-subflow-input-add").toggleClass("active",0!==e.in.length),$("#red-ui-subflow-input-remove").toggleClass("active",0===e.in.length),$("#red-ui-subflow-output .spinner-value").text(e.out.length),$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status))}function d(e){var i=$("#red-ui-workspace-toolbar");i.empty(),$('<a class="button" id="red-ui-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(i),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="red-ui-subflow-input-remove" class="button active" href="#">0</a><a id="red-ui-subflow-input-add" class="button" href="#">1</a></div>').appendTo(i),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="red-ui-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="red-ui-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="red-ui-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(i),$('<span class="button-group"><span class="button" style="padding:0"><label for="red-ui-subflow-status"><input id="red-ui-subflow-status" type="checkbox"> <span data-i18n="subflow.status"></span></label></span></span>').appendTo(i),$('<a class="button" id="red-ui-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(i),i.i18n(),$("#red-ui-subflow-output-remove").on("click",(function(t){t.preventDefault();var i=RED.nodes.dirty(),o=e.changed,a=n();if(a){var s=r(!0);RED.history.push({t:"delete",links:a.links,subflowOutputs:a.subflowOutputs,changed:o,dirty:i,subflow:{instances:s.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}})),$("#red-ui-subflow-output-add").on("click",(function(e){e.preventDefault(),function(e){var i=RED.nodes.subflow(RED.workspaces.active()),o=t(i,!1),n={type:"subflow",direction:"out",z:i.id,i:i.out.length,x:o.x,y:o.y,id:RED.nodes.id()},a=i.out.length;i.out.push(n),i.dirty=!0;var s=RED.nodes.dirty(),d=i.changed;i.changed=!0;var l={t:"edit",node:i,dirty:s,changed:d,subflow:{outputCount:a,instances:r(!0).instances}};RED.history.push(l),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-output .spinner-value").text(i.out.length),RED.events.emit("subflows:change",i)}()})),$("#red-ui-subflow-input-add").on("click",(function(e){e.preventDefault(),function(){var e=RED.nodes.subflow(RED.workspaces.active());if(1!==e.in.length){var i=t(e,!0),o={type:"subflow",direction:"in",z:e.id,i:e.in.length,x:i.x,y:i.y,id:RED.nodes.id()},n=e.in.length;e.in.push(o),e.dirty=!0;var a=RED.nodes.dirty(),s=e.changed;e.changed=!0;var d={t:"edit",node:e,dirty:a,changed:s,subflow:{inputCount:n,instances:r(!0).instances}};RED.history.push(d),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-input-add").addClass("active"),$("#red-ui-subflow-input-remove").removeClass("active"),RED.events.emit("subflows:change",e)}}()})),$("#red-ui-subflow-input-remove").on("click",(function(t){t.preventDefault();var i=RED.nodes.dirty(),n=e.changed;e.changed=!0;var a=o();if(a){var s=r(!0);RED.history.push({t:"delete",links:a.links,changed:n,subflowInputs:a.subflowInputs,dirty:i,subflow:{instances:s.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}})),$("#red-ui-subflow-status").on("change",(function(i){if(this.checked)!function(){var e=RED.nodes.subflow(RED.workspaces.active());if(!e.status){var i=t(e,!1),o={type:"subflow",direction:"status",z:e.id,x:i.x,y:i.y,id:RED.nodes.id()};e.status=o,e.dirty=!0;var n=RED.nodes.dirty(),a=e.changed;e.changed=!0,r(!0);var s={t:"edit",node:e,dirty:n,changed:a,subflow:{status:!0}};RED.history.push(s),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),RED.events.emit("subflows:change",e),$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status)}}();else{var o=e.status,n=e.changed,s=a();if(s){e.changed=!0;var d=RED.nodes.dirty();RED.history.push({t:"delete",links:s.links,changed:n,dirty:d,subflow:{id:e.id,status:o}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw()}}})),$("#red-ui-subflow-edit").on("click",(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()})),$("#red-ui-subflow-delete").on("click",(function(e){e.preventDefault();var t=RED.nodes.dirty(),i=l(RED.workspaces.active());i.t="delete",i.dirty=t,RED.history.push(i)})),s(e),$("#red-ui-workspace-chart").css({"margin-top":"40px"}),$("#red-ui-workspace-toolbar").show()}function l(e,t){var i=[],o=[],n=[],a=RED.nodes.subflow(e);RED.nodes.eachNode((function(o){t||o.type!="subflow:"+e||i.push(o),o.z==e&&i.push(o)})),RED.nodes.eachConfig((function(t){t.z==e&&i.push(t)})),RED.nodes.groups(e).forEach((function(e){n.push(e)}));for(var r=[],s=0;s<i.length;s++){var d=RED.nodes.remove(i[s].id);o=o.concat(d.links),r=r.concat(d.nodes)}for(i=i.concat(r),n=RED.nodes.groups(e).filter((function(e){return!e.g})),s=0;s<n.length;s++)n[s].nodes.forEach((function(e){"group"===e.type&&n.push(e)}));for(s=n.length-1;s>=0;s--)RED.nodes.removeGroup(n[s]);return RED.nodes.removeSubflow(a),RED.workspaces.remove(a),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:i,links:o,groups:n,subflows:[a]}}function c(){var e=0;RED.nodes.eachSubflow((function(t){var i=new RegExp("^Subflow (\\d+)$").exec(t.name);i&&(e=Math.max(e,i[1]))}));var t="Subflow "+(e+1),i=RED.nodes.id(),o={type:"subflow",id:i,name:t,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(i),RED.nodes.dirty(!0)}function p(e){return RED.settings.get("editor").view["view-snap-grid"]&&(e=Math.round(e/RED.view.gridSize())*RED.view.gridSize()),e}function u(){var e=RED.view.selection();if(e.nodes){for(var t,i,o=new Set,n=e.nodes.slice(),a=new Set;n.length>0;)"group"===(i=n.shift()).type&&(a.add(i.id),n=n.concat(i.nodes)),o.add(i);var r=(o=Array.from(o))[0].g,s=[];for(t=0;t<o.length;t++)if(o[t].g&&!a.has(o[t].g)&&r!==o[t].g)return void RED.notify("Cannot create subflow across multiple groups","error");r&&(r=RED.nodes.group(r));var d={},l=[],c=[],u=[],f=[],h={},g=[o[0].x,o[0].y,o[0].x,o[0].y];for(t=0;t<o.length;t++)i=o[t],d[i.id]={n:i,outputs:{}},g=[Math.min(g[0],i.x),Math.min(g[1],i.y),Math.max(g[2],i.x),Math.max(g[3],i.y)];var v=p(g[0]-200),b=p(g[1]-80),m=[p((g[2]+g[0])/2),p((g[3]+g[1])/2)];RED.nodes.eachLink((function(e){d[e.source.id]&&d[e.target.id],d[e.source.id]&&!d[e.target.id]&&(f.push(e),c.push(e)),!d[e.source.id]&&d[e.target.id]&&(u.push(e),h[e.target.id]=e.target,c.push(e))}));var y={};if((f=f.filter((function(e){return y[e.source.id+":"+e.sourcePort]?(y[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),y[e.source.id+":"+e.sourcePort]=e,!0)}))).sort((function(e,t){return e.source.y-t.source.y})),Object.keys(h).length>1)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var w=0;RED.nodes.eachSubflow((function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(w=Math.max(w,t[1]))}));var E="Subflow "+(w+1),D=RED.nodes.id(),R={type:"subflow",id:D,name:E,info:"",in:Object.keys(h).map((function(e,t){var i=t;return{type:"subflow",direction:"in",x:p(h[e].x-h[e].w/2-80-v),y:p(h[e].y-b),z:D,i:i,id:RED.nodes.id(),wires:[{id:h[e].id}]}})),out:f.map((function(e,t){var i=t;return{type:"subflow",direction:"out",x:p(e.source.x+e.source.w/2+80-v),y:p(e.source.y-b),z:D,i:i,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}}))};RED.nodes.addSubflow(R);var $={id:RED.nodes.id(),type:"subflow:"+R.id,x:m[0],y:m[1],z:RED.workspaces.active(),inputs:R.in.length,outputs:R.out.length,h:Math.max(30,15*(R.out.length||0)),changed:!0};for($._def=RED.nodes.getType($.type),RED.editor.validateNode($),RED.nodes.add($),r&&(RED.group.addToGroup(r,$),o.forEach((function(e){if(e.g===r.id){delete e.g;var t=r.nodes.indexOf(e);r.nodes.splice(t,1),s.push(e)}})),r.dirty=!0),u.forEach((function(e){var t={source:e.source,sourcePort:e.sourcePort,target:$};l.push(t),RED.nodes.addLink(t)})),f.forEach((function(e,t){e.targets.forEach((function(e){var i={source:$,sourcePort:t,target:e};l.push(i),RED.nodes.addLink(i)}))})),R.in.forEach((function(e){e.wires.forEach((function(t){var i={source:e,sourcePort:0,target:RED.nodes.node(t.id)};l.push(i),RED.nodes.addLink(i)}))})),R.out.forEach((function(e,t){e.wires.forEach((function(t){var i={source:RED.nodes.node(t.id),sourcePort:t.port,target:e};l.push(i),RED.nodes.addLink(i)}))})),t=0;t<c.length;t++)RED.nodes.removeLink(c[t]);for(t=0;t<o.length;t++)i=o[t],/^link /.test(i.type)&&(i.links=i.links.filter((function(e){var t=d.hasOwnProperty(e);if(!t){var o=RED.nodes.node(e);if(o&&o.links){var n=o.links.indexOf(i.id);n>-1&&o.links.splice(n,1)}}return t}))),i.x-=v,i.y-=b,RED.nodes.moveNodeToTab(i,R.id);var x={t:"createSubflow",nodes:[$.id],links:l,subflow:{subflow:R,offsetX:v,offsetY:b},activeWorkspace:RED.workspaces.active(),removedLinks:c,dirty:RED.nodes.dirty()};r&&((x={t:"multi",events:[x]}).events.push({t:"addToGroup",group:r,nodes:[$]}),x.events.push({t:"removeFromGroup",group:r,nodes:s,reparent:!1})),RED.history.push(x),RED.editor.validateNode(R),RED.nodes.dirty(!0),RED.view.updateActive(),RED.view.select(null)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}var f=["str","num","bool","json","bin","env"],h=["str","num","bool","json","bin","env","cred"];function g(t,i){var o="subflow"===i.type;o&&function(t,i){var o=RED.tabs.create({id:"subflow-env-tabs",onchange:function(e){"subflow-env-tab-preview"===e.id&&b($("#subflow-input-ui"),m(t.editableList("items"),!0),i),$("#subflow-env-tabs-content").children().hide(),$("#"+e.id).show()}});o.addTab({id:"subflow-env-tab-edit",label:RED._("editor-tab.envProperties")}),o.addTab({id:"subflow-env-tab-preview",label:RED._("editor-tab.preview")});var n=RED.settings.theme("languages").map((function(e){return{text:RED._("languages."+e)||e,val:e}})).sort((function(e,t){return e.text.localeCompare(t.text)}));RED.popover.tooltip($(".node-input-env-locales-row i"),RED._("editor.locale"));var a=$("#subflow-input-env-locale");n.forEach((function(e){var t={value:e.val};"en-US"===e.val&&(t.selected=""),$("<option/>",t).text(e.text).appendTo(a)}));var r=RED.i18n.lang();a.val(r),a.on("change",(function(){e=$(this).val(),$("#node-input-env-container").editableList("items").each((function(t,i){var o=$(this).data("data"),n=o.ui.labelField;n.val(E(o.ui.label,"",e)),n.timeout&&(clearTimeout(n.timeout),delete n.timeout),n.addClass("input-updated"),n.timeout=setTimeout((function(){delete n.timeout,n.removeClass("input-updated")}),3e3)}))}))}(t,i),t.css({"min-height":"150px","min-width":"450px"}).editableList({header:o?$('<div><div><div></div><div data-i18n="common.label.name"></div><div data-i18n="editor-tab.defaultValue"></div><div></div></div></div>'):void 0,addItem:function(n,a,r){o&&n.addClass("red-ui-editor-subflow-env-editable");var s=$("<div/>").appendTo(n),d=null,l=null;d=$("<input/>",{class:"node-input-env-name",type:"text",placeholder:RED._("common.label.name")}).attr("autocomplete","disable").appendTo(s).val(r.name),(l=$("<input/>",{style:"width:100%",class:"node-input-env-value",type:"text"}).attr("autocomplete","disable").appendTo(s)).typedInput({default:"str",types:o?f:h}),l.typedInput("type",r.type),"cred"===r.type?r.value?l.typedInput("value",r.value):i.credentials&&i.credentials[r.name]?l.typedInput("value",i.credentials[r.name]):i.credentials&&i.credentials["has_"+r.name]?l.typedInput("value","__PWRD__"):l.typedInput("value",""):l.typedInput("value",r.value),r.nameField=d,r.valueField=l;var c=$("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(s);$("<i/>",{class:"fa "+(r.parent?"fa-reply":"fa-remove")}).appendTo(c);var p=RED.popover.tooltip(c,RED._("subflow.env.remove"));if(c.on("click",(function(e){e.preventDefault(),p.close(),n.parent().addClass("red-ui-editableList-item-deleting"),n.fadeOut(300,(function(){t.editableList("removeItem",r)}))})),o){"cred"===r.type?r.ui=r.ui||{icon:"",type:"cred"}:r.ui=r.ui||{icon:"",type:"input",opts:{types:f}},r.ui.label=r.ui.label||{},r.ui.type=r.ui.type||"input";var u=$("<div/>").appendTo(n).hide();$('<a href="#"><i class="fa fa-angle-right"></a>').prependTo(s).on("click",(function(e){e.preventDefault(),$(this).hasClass("expanded")?(u.slideUp(),$(this).removeClass("expanded")):(u.slideDown(),$(this).addClass("expanded"))})),function(t,i,o,n){t.addClass("red-ui-editor-subflow-env-ui-row");var a=$("<div></div>").appendTo(t);$("<div></div>").appendTo(a),$("<div>").text(RED._("editor.icon")).appendTo(a),$("<div>").text(RED._("editor.label")).appendTo(a),$("<div>").text(RED._("editor.inputType")).appendTo(a);var r=$("<div></div>").appendTo(t);$('<div><i class="red-ui-editableList-item-handle fa fa-bars"></i></div>').appendTo(r);var s={input:{types:f},select:{opts:[]},spinner:{},cred:{}};i.opts?s[i.type]=i.opts:i.opts=s[i.type];var d=$("<div></div>").appendTo(r),l=$('<a href="#"></a>').appendTo(d);if(l.on("click",(function(e){e.preventDefault();var t=i.icon||"",o=t?RED.utils.separateIconPath(t):{};RED.editor.showIconPicker(l,null,o,!0,(function(e){l.empty();var t=e||"",o=RED.utils.separateIconPath(t);o&&$('<i class="fa"></i>').addClass(o.file).appendTo(l),i.icon=t}))})),i.icon){var c=RED.utils.separateIconPath(i.icon);$('<i class="fa '+c.file+'"></i>').appendTo(l)}var p=$("<div></div>").appendTo(r),u=i.label&&i.label[e]||"",h=$('<input type="text">').val(u).appendTo(p);i.labelField=h,h.on("change",(function(t){i.label=i.label||{};var o=$(this).val().trim();""===o?delete i.label[e]:i.label[e]=o}));var g=$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(p);RED.popover.tooltip(g,(function(){var t=Object.keys(i.label),o=$("<div>");return-1===t.indexOf(e)&&(t.push(e),t.sort()),t.forEach((function(t){var n=$("<div>").appendTo(o);$("<span>").css({display:"inline-block",width:"120px"}).text(RED._("languages."+t)+(t===e?"*":"")).appendTo(n),$("<span>").text(i.label[t]||"").appendTo(n)})),o})),o.on("change",(function(e){h.attr("placeholder",$(this).val())}));var v,b,m=$("<div></div>").appendTo(r),y=$('<input type="text">').css("width","100%").appendTo(m);"input"===i.type&&y.val(i.opts.types.join(","));y.typedInput({types:[{value:"input",label:RED._("editor.inputs.input"),icon:"fa fa-i-cursor",showLabel:!1,multiple:!0,options:[{value:"str",label:RED._("editor.types.str"),icon:"red/images/typedInput/az.svg"},{value:"num",label:RED._("editor.types.num"),icon:"red/images/typedInput/09.svg"},{value:"bool",label:RED._("editor.types.bool"),icon:"red/images/typedInput/bool.svg"},{value:"json",label:RED._("editor.types.json"),icon:"red/images/typedInput/json.svg"},{value:"bin",label:RED._("editor.types.bin"),icon:"red/images/typedInput/bin.svg"},{value:"env",label:RED._("editor.types.env"),icon:"red/images/typedInput/env.svg"},{value:"cred",label:RED._("editor.types.cred"),icon:"fa fa-lock"}],default:f,valueLabel:function(e,t){e.css("padding",0);var i=$('<div class="red-ui-editor-subflow-env-input-type"></div>').appendTo(e),o=$('<div class="placeholder-input">').appendTo(i);$('<span><i class="fa fa-i-cursor"></i></span>').appendTo(o),t.length?t.forEach((function(e){if(/^fa /.test(e.icon)){var t=$("<span>",{style:"max-width:14px; padding: 0 3px; margin-top:-4px; margin-left: 1px"}).appendTo(o);$("<i>",{class:e.icon}).appendTo(t)}else $("<img>",{src:e.icon,style:"max-width:14px; padding: 0 3px; margin-top:-4px; margin-left: 1px"}).appendTo(o)})):$('<span class="red-ui-editor-subflow-env-input-type-placeholder"></span>').text(RED._("editor.selectType")).appendTo(o)}},{value:"cred",label:RED._("typedInput.type.cred"),icon:"fa fa-lock",showLabel:!1,valueLabel:function(e,t){e.css("padding",0);var i=$('<div class="red-ui-editor-subflow-env-input-type">').css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"}).appendTo(e);$('<div class="placeholder-input">').html("&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;").appendTo(i)}},{value:"select",label:RED._("editor.inputs.select"),icon:"fa fa-tasks",showLabel:!1,valueLabel:function(t,o){t.css("padding","0"),b=$("<select></select>").appendTo(t),i.opts&&Array.isArray(i.opts.opts)&&i.opts.opts.forEach((function(t){var i=E(t.l,t.l["en-US"]||t.v,e);$("<option>").val(t.v).text(i).appendTo(b)})),b.on("change",(function(e){var t=b.val();n.typedInput("value",t)})),b.val(n.typedInput("value"))},expand:{icon:"fa-caret-down",minWidth:400,content:function(t){var o=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(t),n=$("<ol>").appendTo(o).editableList({header:$("<div><div>"+RED._("editor.select.label")+"</div><div>"+RED._("editor.select.value")+"</div></div>"),addItem:function(t,i,o){var a=$("<div>").appendTo(t),r=E(o.l,"",e);o.label=$('<input type="text">').val(r).appendTo(a),o.label.on("keydown",(function(e){13===e.keyCode&&(o.input.focus(),e.preventDefault())}));var s=$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(a);RED.popover.tooltip(s,(function(){return e})),o.input=$('<input type="text">').val(o.v).appendTo(t),o.input.on("keydown",(function(e){if(13===e.keyCode){var t=n.editableList("indexOf",o);if(t+1===n.editableList("length")){var i={};n.editableList("addItem",i),setTimeout((function(){i.label&&i.label.focus()}),100)}else{var a=n.editableList("getItemAt",t+1);a.label&&a.label.focus()}e.preventDefault()}}))},sortable:!0,removable:!0,height:160});return i.opts.opts.length>0?i.opts.opts.forEach((function(e){n.editableList("addItem",$.extend(!0,{},e))})):n.editableList("addItem",{}),{onclose:function(){var t=n.editableList("items"),o=[];t.each((function(t,i){var n=i.data("data"),a=n.label.val().trim(),r=n.input.val();if(a.length>0&&(n.l=n.l||{},n.l[e]=a),n.v=r,a.length>0||r.length>0){var s={l:n.l,v:n.v};o.push(s)}})),i.opts.opts=o,y.typedInput("value",Date.now())}}}}},{value:"checkbox",label:RED._("editor.inputs.checkbox"),icon:"fa fa-check-square-o",showLabel:!1,valueLabel:function(e,t){e.css("padding",0),(v=$('<input type="checkbox">').appendTo(e)).on("change",(function(e){n.typedInput("value",$(this).prop("checked")?"true":"false")})),v.prop("checked","true"===n.typedInput("value"))}},{value:"spinner",label:RED._("editor.inputs.spinner"),icon:"fa fa-sort-numeric-asc",showLabel:!1,valueLabel:function(e,t){e.css("padding",0);var o=$('<div class="red-ui-editor-subflow-env-input-type"></div>').appendTo(e),n=$('<div class="placeholder-input">').appendTo(o);$('<span><i class="fa fa-sort-numeric-asc"></i></span>').appendTo(n);var a=i.opts&&i.opts.min,r=i.opts&&i.opts.max,s="";void 0!==a&&void 0!==r?s=Math.min(a,r)+" - "+Math.max(a,r):void 0!==a?s="> "+a:void 0!==r&&(s="< "+r),$("<span>").css("margin-left","15px").text(s).appendTo(n)},expand:{icon:"fa-caret-down",content:function(e){var t=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(e);t.css("padding","8px 5px");var o=i.opts.min,n=i.opts.max,a=$('<input type="number" style="margin-bottom:0; width:60px">');a.val(o);var r=$('<input type="number" style="margin-bottom:0; width:60px">');return r.val(n),$('<div class="form-row" style="margin-bottom:3px"><label>'+RED._("editor.spinner.min")+"</label></div>").append(a).appendTo(t),$('<div class="form-row" style="margin-bottom:0"><label>'+RED._("editor.spinner.max")+"</label></div>").append(r).appendTo(t),{onclose:function(){var e=a.val().trim(),t=r.val().trim();""!==e?i.opts.min=parseInt(e):delete i.opts.min,""!==t?i.opts.max=parseInt(t):delete i.opts.max,y.typedInput("value",Date.now())}}}}},{value:"none",label:RED._("editor.inputs.none"),icon:"fa fa-times",hasValue:!1},{value:"hide",label:RED._("editor.inputs.hidden"),icon:"fa fa-ban",hasValue:!1}],default:"none"}).on("typedinputtypechange",(function(e,t){switch(i.type=$(this).typedInput("type"),i.opts=s[i.type],"input"===i.type?y.typedInput("value",i.opts.types.join(",")):y.typedInput("value",Date.now()),i.type){case"input":n.typedInput("types",i.opts.types);break;case"select":n.typedInput("types",["str"]);break;case"checkbox":n.typedInput("types",["bool"]);break;case"spinner":n.typedInput("types",["num"]);break;case"cred":n.typedInput("types",["cred"]);break;default:n.typedInput("types",f)}"checkbox"===i.type?n.typedInput("type","bool"):"spinner"===i.type&&n.typedInput("type","num"),"checkbox"!==i.type&&(v=null)})).on("change",(function(e,t){if("input"===i.type){var o=y.typedInput("value");i.opts.types=""===o?["str"]:o.split(","),n.typedInput("types",i.opts.types)}})),n.on("change",(function(e){v&&v.prop("checked","true"===$(this).typedInput("value"))})),y.typedInput("type",i.type)}(u,r.ui,d,l),d.trigger("change")}},sortable:".red-ui-editableList-item-handle",removable:!1});var n={},a=[];if(/^subflow:/.test(i.type)){var r=RED.nodes.subflow(i.type.substring(8));r.env&&r.env.forEach((function(e){var t={name:e.name,parent:{type:e.type,value:e.value,ui:e.ui}};a.push(t),n[e.name]=t}))}if(i.env)for(var s=0;s<i.env.length;s++){var d=i.env[s];n.hasOwnProperty(d.name)?(n[d.name].type=d.type,n[d.name].value=d.value):a.push({name:d.name,type:d.type,value:d.value,ui:d.ui})}a.forEach((function(e){e.parent&&e.parent.ui&&"hide"===e.parent.ui.type||!o&&e.parent||t.editableList("addItem",JSON.parse(JSON.stringify(e)))}))}function v(e,t,i,o){i.label=i.label||{},("cred"===t.type||t.parent&&"cred"===t.parent.type)&&!i.type?(i.type="cred",i.opts={}):i.type?i.opts||(i.opts="select"===i.type?{opts:[]}:{}):(i.type="input",i.opts={types:f});var n,a=i.label||{},r=RED.i18n.lang(),s=E(a,a["en-US"]||t.name,r),d=$("<label>").appendTo(e),l=$("<span></span>").appendTo(d);if(i.icon){var c=RED.utils.separateIconPath(i.icon);c&&$("<i class='fa "+c.file+"'/>").appendTo(l)}if("checkbox"!==i.type){var p=i.icon?{"padding-left":"5px"}:{};$("<span>").css(p).text(s).appendTo(d),"none"===i.type&&d.width("100%")}var u={value:"",type:"str"};switch(t.parent&&(u.value=t.parent.value,u.type=t.parent.type),t.hasOwnProperty("value")&&(u.value=t.value),t.hasOwnProperty("type")&&(u.type=t.type),i.type){case"input":if(n=$('<input type="text">').css("width","70%").appendTo(e),i.opts.types&&i.opts.types.length>0){var h=u.type;-1===i.opts.types.indexOf(h)&&(h=i.opts.types[0]),n.typedInput({types:i.opts.types,default:h}),n.typedInput("value",u.value)}else n.val(u.value);break;case"select":n=$("<select>").css("width","70%").appendTo(e),i.opts.opts&&i.opts.opts.forEach((function(e){$("<option>").val(e.v).text(E(e.l,e.l["en-US"]||e.v,r)).appendTo(n)})),n.val(u.value);break;case"checkbox":d.css("cursor","default");var g=$("<label>").css("width","70%").appendTo(e);n=$('<input type="checkbox">').css({marginTop:0,width:"auto",height:"34px"}).appendTo(g),l.css({"padding-left":"5px"}).appendTo(g),$("<span>").css({"padding-left":"5px"}).text(s).appendTo(g);var v=!1;v="bool"===u.type?"true"===u.value:"num"===u.type?"0"!==u.value:""!==u.value,n.prop("checked",v);break;case"spinner":n=$("<input>").css("width","70%").appendTo(e);var b={};i.opts.hasOwnProperty("min")&&(b.min=i.opts.min),i.opts.hasOwnProperty("max")&&(b.max=i.opts.max),n.spinner(b).parent().width("70%"),n.val(u.value);break;case"cred":n=$('<input type="password">').css("width","70%").appendTo(e),o.credentials?o.credentials[t.name]?n.val(o.credentials[t.name]):o.credentials["has_"+t.name]?n.val("__PWRD__"):n.val(""):n.val(""),n.typedInput({types:["cred"],default:"cred"})}n&&n.attr("id",w(t.name))}function b(e,t,i){e.empty();for(var o=0;o<t.length;o++){var n=t[o];if(!n.ui||"hide"!==n.ui.type)v($("<div/>",{class:"form-row"}).appendTo(e),n,n.ui||{},i)}}function m(e,t){if(e){var i=[];return e.each((function(e){var o=$(this).data("data"),n=(o.parent?o.name:o.nameField.val()).trim();if(""!==n||o.ui&&"none"===o.ui.type){var a=o.valueField,r=a.typedInput("value"),s=a.typedInput("type");if(t||!o.parent||o.parent.value!==r||o.parent.type!==s){var d={name:n,type:s,value:r};if(o.ui){var l={icon:o.ui.icon,label:$.extend(!0,{},o.ui.label),type:o.ui.type,opts:$.extend(!0,{},o.ui.opts)};switch(l.icon||delete l.icon,$.isEmptyObject(l.label)&&delete l.label,l.type){case"input":JSON.stringify(l.opts)===JSON.stringify({types:f})&&(delete l.type,delete l.opts);break;case"cred":"cred"===d.type&&delete l.type,delete l.opts;break;case"select":l.opts&&$.isEmptyObject(l.opts.opts)&&delete l.opts;break;case"spinner":$.isEmptyObject(l.opts)&&delete l.opts;break;default:delete l.opts}$.isEmptyObject(l)||(d.ui=l)}i.push(d)}}})),i}return null}function y(e){var t={},i=[];if(/^subflow:/.test(e.type)){var o=RED.nodes.subflow(e.type.substring(8));o.env&&o.env.forEach((function(e){var o={name:e.name,parent:{type:e.type,value:e.value},ui:$.extend(!0,{},e.ui)};i.push(o),t[e.name]=o}))}if(e.env)for(var n=0;n<e.env.length;n++){var a=e.env[n];t.hasOwnProperty(a.name)&&(t[a.name].type=a.type,t[a.name].value=a.value)}return i}function w(e){return"node-input-subflow-env-"+e.replace(/[^a-z0-9-_]/gi,"_")}function E(e,t,i){if(e){if(e[i])return e[i];if(i){var o=i.substring(0,2);if(e[o])return e[o]}}return t}return{init:function(){RED.events.on("workspace:change",(function(e){var t=RED.nodes.subflow(e.workspace);t?d(t):($("#red-ui-workspace-toolbar").hide().empty(),$("#red-ui-workspace-chart").css({"margin-top":"0"}))})),RED.events.on("view:selection-changed",(function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)})),RED.actions.add("core:create-subflow",c),RED.actions.add("core:convert-to-subflow",u),$('<script type="text/x-red" data-template-name="subflow"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div><div id="subflow-input-ui"></div><\/script>').appendTo("#red-ui-editor-node-configs"),$('<script type="text/x-red" data-template-name="subflow-template"><div class="form-row"><label for="subflow-input-name" data-i18n="[append]common.label.name"><i class="fa fa-tag"></i>  </label><input type="text" id="subflow-input-name" data-i18n="[placeholder]common.label.name"></div><div class="form-row"><ul style="margin-bottom: 20px;" id="subflow-env-tabs"></ul></div><div id="subflow-env-tabs-content"><div id="subflow-env-tab-edit"><div class="form-row node-input-env-container-row" id="subflow-input-edit-ui"><ol class="red-ui-editor-subflow-env-list" id="node-input-env-container"></ol><div class="node-input-env-locales-row"><i class="fa fa-language"></i> <select id="subflow-input-env-locale"></select></div></div></div><div id="subflow-env-tab-preview"><div id="subflow-input-ui"/></div></div><\/script>').appendTo("#red-ui-editor-node-configs")},createSubflow:c,convertToSubflow:u,removeSubflow:l,refresh:r,removeInput:o,removeOutput:n,removeStatus:a,buildEditForm:function(e,t){"subflow-template"===e?g($("#node-input-env-container"),t):"subflow"===e&&b($("#subflow-input-ui"),y(t),t)},buildPropertiesForm:function(e){var t=$("#editor-subflow-envProperties-content"),i=$('<form class="dialog-form form-horizontal"></form>').appendTo(t),o=$('<div class="form-row node-input-env-container-row"></div>').appendTo(i);g($('<ol id="red-ui-editor-subflow-env-list" class="red-ui-editor-subflow-env-list"></ol>').appendTo(o),e)},exportSubflowTemplateEnv:m,exportSubflowInstanceEnv:function(e){var t=[];return y(e).forEach((function(e){var i,o=e.ui||{};o.type?o.opts=o.opts||{}:e.parent&&"cred"===e.parent.type?o.type="cred":(o.type="input",o.opts={types:f});var n=$("#"+w(e.name));if(n.length||"cred"===o.type){switch(i={name:e.name},o.type){case"input":o.opts.types&&o.opts.types.length>0?(i.value=n.typedInput("value"),i.type=n.typedInput("type")):(i.value=n.val(),i.type="str");break;case"cred":i.value=n.val(),i.type="cred";break;case"spinner":i.value=n.val(),i.type="num";break;case"select":i.value=n.val(),i.type="str";break;case"checkbox":i.type="bool",i.value=""+n.prop("checked")}"cred"!==o.type&&i.type===e.parent.type&&i.value===e.parent.value||t.push(i)}})),$("#red-ui-editor-subflow-env-list").editableList("items").each((function(e,i){var o,n=i.data("data");n.nameField&&n.valueField&&""!==(o={name:n.nameField.val(),value:n.valueField.typedInput("value"),type:n.valueField.typedInput("type")}).name.trim()&&t.push(o)})),t}}}(),RED.group=function(){for(var e=["#ff0000","#ffC000","#ffff00","#92d04f","#0070c0","#001f60","#6f2fa0","#000000","#777777"],t=e.length,i=0,o=3*e.length;i<o;i++){var n=i%t,a=Math.floor(i/t)+1,r=e[n],s=parseInt(r.substring(1,3),16),d=parseInt(r.substring(3,5),16),l=parseInt(r.substring(5,7),16),c=(255-s)/(3+(n===t-1?0:1)),p=(255-d)/(3+(n===t-1?0:1)),u=(255-l)/(3+(n===t-1?0:1)),f=(((s=Math.min(255,Math.floor(s+a*c)))<<16)+((d=Math.min(255,Math.floor(d+a*p)))<<8)+(l=Math.min(255,Math.floor(l+a*u)))).toString(16);e.push("#"+"000000".slice(0,6-f.length)+f)}var h,g={label:!0,"label-position":"nw"};function v(e){var t=/^rgb\((\d+), (\d+), (\d+)\)$/.exec(e);if(t){var i=((parseInt(t[1])<<16)+(parseInt(t[2])<<8)+parseInt(t[3])).toString(16);return"#"+"000000".slice(0,6-i.length)+i}return e}function b(e){var t=[],i=RED.nodes.group(e.g);return e.nodes.forEach((function(e){t.push(e),i?(e.g=i.id,i.nodes.push(e),i.dirty=!0,e.dirty=!0):delete e.g,"group"===e.type?RED.events.emit("groups:change",e):RED.events.emit("nodes:change",e)})),RED.nodes.removeGroup(e),t}function m(e){if(0!==e.length){if(!(e.filter((function(e){return"subflow"===e.type})).length>0)){var t={id:RED.nodes.id(),type:"group",nodes:[],style:JSON.parse(JSON.stringify(g)),x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,w:0,h:0,_def:RED.group.def};t.z=e[0].z,RED.nodes.addGroup(t);try{y(t,e)}catch(e){return void RED.notify(e,"error")}return t}RED.notify(RED._("group.errors.cannotAddSubflowPorts"),"error")}}function y(e,t){var i,o,n,a;for(Array.isArray(t)||(t=[t]),i=0;i<t.length;i++){if(!(o=t[i]).z)throw new Error("Cannot add node without a z property to a group");if(n){if(n!==o.z)throw new Error("Cannot add nooes with different z properties")}else n=o.z;if(o.g&&!a){if(0!==i)throw new Error(RED._("group.errors.cannotCreateDiffGroups"));a=o.g}if(a!==o.g)throw new Error(RED._("group.errors.cannotCreateDiffGroups"))}for(a&&((a=RED.nodes.group(a)).nodes.push(e),a.dirty=!0,e.g=a.id),i=0;i<t.length;i++)if("subflow"!==(o=t[i]).type){if(a&&o.g===a.id){var r=a.nodes.indexOf(o);r>-1&&a.nodes.splice(r,1)}o.g=e.id,o.dirty=!0,e.nodes.push(o),e.x=Math.min(e.x,o.x-o.w/2-25-(o._def.button&&"right"!==o._def.align?20:0)),e.y=Math.min(e.y,o.y-o.h/2-25),e.w=Math.max(e.w,o.x+o.w/2+25+(o._def.button&&"right"==o._def.align?20:0)-e.x),e.h=Math.max(e.h,o.y+o.h/2+25-e.y),"group"===o.type?RED.events.emit("groups:change",o):RED.events.emit("nodes:change",o)}a&&RED.events.emit("groups:change",e),E(e)}function w(e,t,i){var o;Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++)if(t[n].g!==e.id)return;var a=RED.nodes.group(e.g);for(n=0;n<t.length;n++){(o=t[n]).dirty=!0;var r=e.nodes.indexOf(o);e.nodes.splice(r,1),i&&e.g?(o.g=e.g,a.nodes.push(o)):delete o.g,"group"===o.type?RED.events.emit("groups:change",o):RED.events.emit("nodes:change",o)}E(e)}function E(e){for(e.dirty=!0;e;)e.dirty=!0,e=RED.nodes.group(e.g)}return{def:{defaults:{name:{value:""},style:{value:{label:!0}},nodes:{value:[]}},category:"config",oneditprepare:function(){var i=this.style||{};RED.colorPicker.create({id:"node-input-style-stroke",value:i.stroke||g.stroke||"#a4a4a4",palette:e,cellPerRow:t,cellWidth:16,cellHeight:16,cellMargin:3,none:!0,opacity:i.hasOwnProperty("stroke-opacity")?i["stroke-opacity"]:g.hasOwnProperty("stroke-opacity")?g["stroke-opacity"]:1}).appendTo("#node-input-row-style-stroke"),RED.colorPicker.create({id:"node-input-style-fill",value:i.fill||g.fill||"none",palette:e,cellPerRow:t,cellWidth:16,cellHeight:16,cellMargin:3,none:!0,opacity:i.hasOwnProperty("fill-opacity")?i["fill-opacity"]:g.hasOwnProperty("fill-opacity")?g["fill-opacity"]:1}).appendTo("#node-input-row-style-fill"),function(e){var t=$("<div>",{style:"display:inline-block"}),i=$("<input/>",{id:e.id,type:"hidden",value:e.value}).appendTo(t),o=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(t);$('<i class="fa fa-caret-down"></i>').appendTo(o);var n=$("<div>",{class:"red-ui-search-result-node"}).appendTo(o),a=$("<div>",{class:"red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"}).appendTo(n),r=function(){var e=i.val();a.removeClass().addClass("red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"+e)};return o.on("click",(function(e){var t,n=$("<div/>",{class:"red-ui-group-layout-picker"}).css({width:"126px"}),a=null;a=$("<div/>").appendTo(n);for(var s=0;s<2;s++){var d="ns"[s];a=$("<div/>").appendTo(n);for(var l=0;l<3;l++){var c=d+["w","","e"][l],p=$("<button/>",{class:"red-ui-search-result-node red-ui-button","data-pos":c}).appendTo(a);p.on("click",(function(e){e.preventDefault(),i.val($(this).data("pos")),u.hide(),r()})),$("<div>",{class:"red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"+c}).appendTo(p),c===i.val()&&(t=p)}}r();var u=RED.popover.panel(n);u.show({target:o,onclose:function(){o.focus()}}),t&&t.focus()})),r(),t}({id:"node-input-style-label-position",value:i["label-position"]||"nw"}).appendTo("#node-input-row-style-label-position"),RED.colorPicker.create({id:"node-input-style-color",value:i.color||g.color||"#a4a4a4",palette:e,cellPerRow:t,cellWidth:16,cellHeight:16,cellMargin:3}).appendTo("#node-input-row-style-label-color"),$("#node-input-style-label").toggleButton({enabledLabel:RED._("editor.show"),disabledLabel:RED._("editor.show")}),$("#node-input-style-label").on("change",(function(e){$("#node-input-row-style-label-options").toggle($(this).prop("checked"))})),$("#node-input-style-label").prop("checked",this.style.label),$("#node-input-style-label").trigger("change")},oneditresize:function(e){},oneditsave:function(){this.style.stroke=$("#node-input-style-stroke").val(),this.style.fill=$("#node-input-style-fill").val(),this.style["stroke-opacity"]=$("#node-input-style-stroke-opacity").val(),this.style["fill-opacity"]=$("#node-input-style-fill-opacity").val(),this.style.label=$("#node-input-style-label").prop("checked"),this.style.label?(this.style["label-position"]=$("#node-input-style-label-position").val(),this.style.color=$("#node-input-style-color").val()):(delete this.style["label-position"],delete this.style.color);var e=this;["stroke","fill","stroke-opacity","fill-opacity","color","label-position"].forEach((function(t){e.style[t]===g[t]&&delete e.style[t]})),this.resize=!0},set:{module:"node-red"}},init:function(){RED.events.on("view:selection-changed",(function(e){var t=!!e.nodes,i=!1,o=!1,n=!1;t&&(e.nodes.forEach((function(e){"group"===e.type&&(i=!0),e.g&&(n=!0)})),i&&(o=e.nodes.length>1)),RED.menu.setDisabled("menu-item-group-group",!t),RED.menu.setDisabled("menu-item-group-ungroup",!i),RED.menu.setDisabled("menu-item-group-merge",!o),RED.menu.setDisabled("menu-item-group-remove",!n)})),RED.actions.add("core:group-selection",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){var t=m(e.nodes);if(t){var i={t:"createGroup",groups:[t],dirty:RED.nodes.dirty()};RED.history.push(i),RED.view.select({nodes:[t]}),RED.nodes.dirty(!0)}}}()})),RED.actions.add("core:ungroup-selection",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){var t=[];groups=e.nodes.filter((function(e){return"group"===e.type}));var i={t:"ungroup",groups:[],dirty:RED.nodes.dirty()};RED.history.push(i),groups.forEach((function(e){t=t.concat(b(e)),i.groups.push(e)})),RED.history.push(i),RED.view.select({nodes:t}),RED.nodes.dirty(!0)}}()})),RED.actions.add("core:merge-selection-to-group",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){for(var t,i,o,n=[],a={t:"multi",events:[]},r={t:"ungroup",groups:[]},s=0;s<e.nodes.length;s++)if(t=e.nodes[s],0===s)i=t.g;else if(t.g!==i)return void RED.notify(RED._("group.errors.cannotCreateDiffGroups"),"error");for(s=0;s<e.nodes.length;s++)"group"===(t=e.nodes[s]).type?(o||(o=t),r.groups.push(t),n=n.concat(b(t))):n.push(t),t.dirty=!0;r.groups.length>0&&a.events.push(r);var d=m(n);d&&(o&&(d.style=o.style,d.name=o.name),RED.view.select({nodes:[d]})),a.events.push({t:"createGroup",groups:[d],dirty:RED.nodes.dirty()}),RED.history.push(a),RED.nodes.dirty(!0)}}()})),RED.actions.add("core:remove-selection-from-group",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();if(e.nodes){var t=RED.nodes.group(e.nodes[0].g);if(t)try{w(t,e.nodes,!0);var i={t:"removeFromGroup",dirty:RED.nodes.dirty(),group:t,nodes:e.nodes};RED.history.push(i),RED.nodes.dirty(!0)}catch(e){return void RED.notify(e,"error")}RED.view.select({nodes:e.nodes})}}()})),RED.actions.add("core:copy-group-style",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;var e=RED.view.selection();e.nodes&&1===e.nodes.length&&"group"===e.nodes[0].type&&(h=JSON.parse(JSON.stringify(e.nodes[0].style)),RED.notify(RED._("clipboard.groupStyleCopied"),{id:"clipboard"}))}()})),RED.actions.add("core:paste-group-style",(function(){!function(){if(RED.view.state()!==RED.state.DEFAULT)return;if(h){var e=RED.view.selection();if(e.nodes){var t={t:"multi",events:[],dirty:RED.nodes.dirty()};e.nodes.forEach((function(e){"group"===e.type&&(t.events.push({t:"edit",node:e,changes:{style:JSON.parse(JSON.stringify(e.style))},dirty:RED.nodes.dirty()}),e.style=JSON.parse(JSON.stringify(h)),e.dirty=!0)})),t.events.length>0&&(RED.history.push(t),RED.nodes.dirty(!0),RED.view.redraw())}}}()})),$('<script type="text/x-red" data-template-name="group"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div><div class="form-row" id="node-input-row-style-stroke"><label data-i18n="editor:common.label.style"></label><label style="width: 70px;margin-right:10px" for="node-input-style-stroke" data-i18n="editor:common.label.line"></label></div><div class="form-row" style="padding-left: 100px;" id="node-input-row-style-fill"><label style="width: 70px;margin-right: 10px "  for="node-input-style-fill" data-i18n="editor:common.label.fill"></label></div><div class="form-row"><label for="node-input-style-label" data-i18n="editor:common.label.label"></label><input type="checkbox" id="node-input-style-label"/></div><div class="form-row" id="node-input-row-style-label-options"><div style="margin-left: 100px; display: inline-block"><div class="form-row"><span style="display: inline-block; min-width: 140px"  id="node-input-row-style-label-color"><label style="width: 70px;margin-right: 10px" for="node-input-style-fill" data-i18n="editor:common.label.color"></label></span></div><div class="form-row"><span style="display: inline-block; min-width: 140px;" id="node-input-row-style-label-position"><label style="width: 70px;margin-right: 10px " for="node-input-style-label-position" data-i18n="editor:common.label.position"></label></span></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs");var e=$("<div>",{class:"red-ui-flow-group-body",style:"position: absolute; top: -1000px;"}).appendTo(document.body),t=getComputedStyle(e[0]);g={stroke:v(t.stroke),"stroke-opacity":t.strokeOpacity,fill:v(t.fill),"fill-opacity":t.fillOpacity,label:!0,"label-position":"nw"},e.remove(),e=$("<div>",{class:"red-ui-flow-group-label",style:"position: absolute; top: -1000px;"}).appendTo(document.body),t=getComputedStyle(e[0]),g.color=v(t.fill),e.remove()},createGroup:m,ungroup:b,addToGroup:y,removeFromGroup:w,getNodes:function e(t,i){var o=[];return t.nodes.forEach((function(t){o.push(t),i&&"group"===t.type&&(o=o.concat(e(t,i)))})),o},contains:function e(t,i){if(i.g===t.id)return!0;for(var o=0;o<t.nodes.length;o++)if("group"===t.nodes[o].type&&e(t.nodes[o],i))return!0;return!1},markDirty:E}}(),RED.userSettings=function(){var e=700,t=!1,i=[];function o(e){i.push(e)}function n(o){if(!t)if(RED.user.hasPermission("settings.write")){t=!0;var n={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(t){e=t.width},open:function(e){var t=e.find(".red-ui-tray-body"),n=$("<div></div>").appendTo(t),a=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(n);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(a);var r=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout((function(){s.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()}),50)}}),s=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(n);i.forEach((function(e){r.addTab({id:"red-ui-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(s)})),n.i18n(),r.activateTab("red-ui-settings-tab-"+(o||"view")),$("#red-ui-sidebar-shade").show()},close:function(){t=!1,i.forEach((function(e){e.close&&e.close()})),$("#red-ui-sidebar-shade").hide()},show:function(){}};null!==e&&(n.width=e),RED.tray.show(n)}else RED.notify(RED._("user.errors.settings"),"error")}function a(e){var t=RED._("languages."+e);return{text:t||e,val:e}}function r(e,t){return e.text.localeCompare(t.text)}var s=[{options:[{setting:"editor-language",local:!0,label:"menu.label.view.language",options:function(e){e([{val:"",text:RED._("menu.label.view.browserDefault")}].concat(RED.settings.theme("languages").map(a).sort(r)))}}]},{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",default:!0,toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",default:!0,toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"},{setting:"view-node-show-label",label:"menu.label.showNodeLabelDefault",default:!0,toggle:!0}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],d={};function l(){var e=$('<div id="red-ui-settings-tab-view" class="red-ui-help"></div>'),t=RED.settings.get("editor")||{};return t.view=t.view||{},s.forEach((function(i){i.title&&$("<h3></h3>").text(RED._(i.title)).appendTo(e),i.options.forEach((function(i){var o;o=i.local?localStorage.getItem(i.setting):t.view[i.setting];var n=$('<div class="red-ui-settings-row"></div>').appendTo(e);if(i.toggle)$('<label for="user-settings-'+i.setting+'"><input id="user-settings-'+i.setting+'" type="checkbox"> '+RED._(i.label)+"</label>").appendTo(n).find("input").prop("checked",o);else if(i.options){$('<label for="user-settings-'+i.setting+'">'+RED._(i.label)+"</label>").appendTo(n);var a=$('<select id="user-settings-'+i.setting+'"></select>').appendTo(n);"function"==typeof i.options&&(i.options((function(e){e.forEach((function(e){var t=e,i=e;"string"!=typeof e&&(t=e.val,i=e.text),$("<option>").val(t).text(i).appendTo(a)}))})),a.val(o))}else $('<label for="user-settings-'+i.setting+'">'+RED._(i.label)+"</label>").appendTo(n),$('<input id="user-settings-'+i.setting+'" type="'+(i.type||"text")+'">').appendTo(n).val(o)}))})),e}function c(e,t){var i=d[e];if(i.local)localStorage.setItem(i.setting,t);else{var o=RED.settings.get("editor")||{};o.view=o.view||{},o.view[i.setting]=t,RED.settings.set("editor",o);var n=i.onchange;"string"==typeof n&&(n=RED.actions.get(n)),n&&n.call(i,t)}}return{init:function(){RED.actions.add("core:show-user-settings",n),RED.actions.add("core:show-help",(function(){n("keyboard")})),o({id:"view",title:RED._("menu.label.view.view"),get:l,close:function(){s.forEach((function(e){e.options.forEach((function(e){var t=$("#user-settings-"+e.setting);e.toggle?c(e.setting,t.prop("checked")):c(e.setting,t.val())}))}))}});var e=RED.settings.get("editor")||{};e.view=e.view||{};var t=!1;s.forEach((function(i){i.options.forEach((function(i){if(i.local)d[i.setting]=i;else{if(i.oldSetting){var o=RED.settings.get(i.oldSetting);null!=o&&(e.view[i.setting]=o,t=!0,RED.settings.remove(i.oldSetting))}d[i.setting]=i;var n=e.view[i.setting];if(null==n&&i.hasOwnProperty("default")&&(n=i.default,e.view[i.setting]=n,t=!0),i.onchange){var a=i.onchange;"string"==typeof a&&(a=RED.actions.get(a)),a&&a.call(i,n)}}}))})),t&&RED.settings.set("editor",e)},toggle:function(e){var t=d[e],i=RED.settings.get("editor")||{};i.view=i.view||{},c(e,!i.view[t.setting])},show:n,add:o}}(),RED.projects=function(){var e,t,i;function o(e){var t;"git_missing_user"===e.code?t=RED.notify("<p>"+RED._("projects.errors.no-username-email")+"</p>",{fixed:!0,type:"error",buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("projects.config-git"),click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),t=RED.notify("<p>"+RED._("projects.errors.unexpected")+":</p><p>"+e.message+"</p><small>"+RED._("projects.errors.code")+": "+e.code+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:RED._("common.label.close"),click:function(){t.close()}}]}))}var n={};function a(){var t=$('<div class="red-ui-projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(t),$("<hr>").appendTo(t);var a,s,l,c,p,u,f,h={};n={welcome:{content:function(e){var i=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(i);var o=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(i);$("<p>").text(RED._("projects.welcome.hello")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc0")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc1")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc2")).appendTo(o);var n=$('<div style="text-align: center"></div>').appendTo(o),a=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.welcome.create")+"</button>").appendTo(n),s=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.welcome.clone")+"</button>").appendTo(n);return a.on("click",(function(e){e.preventDefault(),h={action:"create"},r("git-config")})),s.on("click",(function(e){e.preventDefault(),h={action:"clone"},r("git-config")})),i},buttons:[{text:RED._("projects.welcome.openExistingProject"),class:"secondary",click:function(){h={action:"open"},r("git-config")}},{text:RED._("projects.welcome.not-right-now"),click:function(){h={},$(this).dialog("close")}}]},"git-config":{content:function(e){var i=!1,o=RED.settings.get("git");o&&o.user?o=o.user:RED.settings.git&&RED.settings.git.globalUser&&(i=!0,o=RED.settings.git.globalUser);var n=function(){var e=u.val().trim(),t=f.val().trim(),i=e.length>0&&t.length>0;$("#red-ui-projects-dialog-git-config").prop("disabled",!i).toggleClass("disabled ui-button-disabled ui-state-disabled",!i)},a=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(a);var r=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(a);$("<p>").text(RED._("projects.git-config.setup")).appendTo(r),$("<p>").text(RED._("projects.git-config.desc0")).appendTo(r),$("<p>").text(RED._("projects.git-config.desc1")).appendTo(r),i&&$("<p>").text(RED._("projects.git-config.desc2")).appendTo(r),$("<p>").text(RED._("projects.git-config.desc3")).appendTo(r);var s=$('<div class="form-row"></div>').appendTo(r);return $('<label for="">'+RED._("projects.git-config.username")+"</label>").appendTo(s),(u=$('<input type="text">').val(o&&o.name||"").appendTo(s)).on("change keyup paste",n),s=$('<div class="form-row"></div>').appendTo(r),$('<label for="">'+RED._("projects.git-config.email")+"</label>").appendTo(s),(f=$('<input type="text">').val(o&&o.email||"").appendTo(s)).on("change keyup paste",n),setTimeout((function(){u.trigger("focus"),n()}),50),a},buttons:[{text:RED._("common.label.back"),click:function(){r("welcome")}},{id:"red-ui-projects-dialog-git-config",text:RED._("common.label.next"),class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=u.val(),e.user.email=f.val(),RED.settings.set("git",e),"create"===h.action?r("project-details"):"clone"===h.action?r("clone-project"):"open"===h.action&&r("create",{screen:"open"})}}]},"project-details":{content:function(e){var i=null,o=!1;$.getJSON("projects",(function(e){i={},e.projects.forEach((function(e){i[e]=!0,o&&(o=!1,r())}))}));var n=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(n);var a=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text(RED._("projects.project-details.create")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc0")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc1")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc2")).appendTo(a);var r=function(){var e=c.val(),t=!0;if(g){if(null===i)return void(o=!0);f.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||i[e]?(c.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(f),l=!1,t=!1,i[e]?projectNameSublabel.text(RED._("projects.project-details.already-exists")):projectNameSublabel.text(RED._("projects.project-details.must-contain"))):(c.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(f),projectNameSublabel.text(RED._("projects.project-details.must-contain")),l=!0),v=e}t=l,$("#red-ui-projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},s=$('<div class="form-row"></div>').appendTo(a);$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.project-details.project-name")+"</label>").appendTo(s);var d=$('<div style="position:relative;"></div>').appendTo(s);c=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').val(h.name||"").appendTo(d);var l,u,f=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(d),g=!1,v="";return c.on("change keyup paste",(function(){if(g=c.val()!==v,u)clearTimeout(u);else if(g&&(f.empty(),$('<img src="red/images/spin.svg"/>').appendTo(f),""===c.val()))return void r();u=setTimeout((function(){r(),u=null}),300)})),projectNameSublabel=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.must-contain")+"</small></label>").appendTo(s).find("small"),s=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(a),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.project-details.desc")+"</label>").appendTo(s),p=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').val(h.summary||"").appendTo(s),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.opt")+"</small></label>").appendTo(s),setTimeout((function(){c.trigger("focus"),c.trigger("change")}),50),n},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){r("git-config")}},{id:"red-ui-projects-dialog-create-name",disabled:!0,text:RED._("common.label.next"),class:"primary disabled",click:function(){h.name=c.val(),h.summary=p.val(),r("default-files",e)}}]}},"clone-project":function(){var i,n,a,s,l,c,p,u;return{content:function(o){var r=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(r);var d=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(r);$("<p>").text(RED._("projects.clone-project.clone")).appendTo(d),$("<p>").text(RED._("projects.clone-project.desc0")).appendTo(d);var f=null,h=!1;$.getJSON("projects",(function(e){f={},e.projects.forEach((function(e){f[e]=!0,h&&(h=!1,v())}))}));var g,v=function(){var e=i.val(),t=!0;if(E){if(null===f)return void(h=!0);w.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||f[e]?(i.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(w),m=!1,t=!1,f[e]?c.text(RED._("projects.clone-project.already-exists")):c.text(RED._("projects.clone-project.must-contain"))):(i.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(w),c.text(RED._("projects.clone-project.must-contain")),m=!0),D=e}t=m;var o=a.val(),n=o.length>0&&!/\s/.test(o);/^https?:\/\/[^/]+@/i.test(o)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.no-info-in-url")),n=!1),n?a.removeClass("input-error"):(x&&a.addClass("input-error"),t=!1),/^https?:\/\//.test(o)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(o)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()),$("#red-ui-projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(d),$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.clone-project.project-name")+"</label>").appendTo(g);var b=$('<div style="position:relative;"></div>').appendTo(g);i=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(b);var m,y,w=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(b),E=!1,D="",R="";i.on("change keyup paste",(function(){if(E=i.val()!==D,y)clearTimeout(y);else if(E&&(w.empty(),$('<img src="red/images/spin.svg"/>').appendTo(w),""===i.val()))return void v();y=setTimeout((function(){v(),y=null}),300)})),c=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.must-contain")+"</small></label>").appendTo(g).find("small"),g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(d),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.clone-project.git-url")+"</label>").appendTo(g),a=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(g),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.protocols")+"</small></label>").appendTo(g);var x=!1,_="";a.on("change keyup paste",(function(){x=!0;var e=$(this).val();_!==e&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),_=e;var t=/\/([^/]+?)(?:\.git)?$/.exec(e);if(t){var o=i.val();""!==o&&o!==R||(R=t[1],i.val(R),i.trigger("change"))}v()}));var k=$('<div class="red-ui-projects-dialog-screen-create-row"></div>').appendTo(d);g=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(k),$('<div><i class="fa fa-warning"></i> '+RED._("projects.clone-project.auth-failed")+"</div>").appendTo(g),g=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(k);b=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(g);$('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.clone-project.username")+"</label>").appendTo(b),s=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(b),b=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(g),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.clone-project.passwd")+"</label>").appendTo(b),(l=$('<input style="width:100%" id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(b)).typedInput({type:"cred"}),g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(k),b=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(g),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.ssh-key")+"</label>").appendTo(b),p=$("<select>",{style:"width: 100%"}).appendTo(b),$.getJSON("settings/user/keys",(function(e){var t=0;e.keys.forEach((function(e){p.append($("<option></option>").val(e.name).text(e.name)),t++})),0===t?(p.addClass("input-error"),p.attr("disabled",!0),T.show()):(p.removeClass("input-error"),p.attr("disabled",!1),T.hide())})),b=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(g),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.passphrase")+"</label>").appendTo(b),(u=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(b)).typedInput({type:"cred"}),b=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(k);var T=$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(b);return $('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.clone-project.ssh-key-desc")+"</div>").appendTo(T),b=$('<div style="text-align: center">').appendTo(T),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("projects.clone-project.ssh-key-add")+"</button>").appendTo(b).on("click",(function(t){t.preventDefault(),e.dialog("close"),RED.userSettings.show("gitconfig"),setTimeout((function(){$("#user-settings-gitconfig-add-key").trigger("click")}),500)})),g=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(d),$("<label>"+RED._("projects.clone-project.credential-key")+"</label>").appendTo(g),(n=$('<input style="width: 100%" type="password"></input>').appendTo(g)).typedInput({type:"cred"}),r},buttons:function(t){return[{text:RED._("common.label.back"),click:function(){r("git-config")}},{id:"red-ui-projects-dialog-clone-project",disabled:!0,text:RED._("common.label.clone"),class:"primary disabled",click:function(){$(".red-ui-projects-dialog-screen-create-type.selected").data("type");var t={name:i.val()};t.credentialSecret=n.val();var r=a.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(r)){var c=p.val();if(!c)return void console.log(RED._("projects.clone-project.cant-get-ssh-key"));t.git={remotes:{origin:{url:r,keyFile:c,passphrase:u.val()}}}}else t.git={remotes:{origin:{url:r,username:s.val(),password:l.val()}}};$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),s.removeClass("input-error"),l.removeClass("input-error"),p.removeClass("input-error"),u.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t.name),d({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(t){e.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.clone-project.already-exists2"))},git_error:function(e){console.log(RED._("projects.clone-project.git-error"),e)},git_connection_failed:function(e){a.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.connection-failed"))},git_not_a_repository:function(e){a.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.not-git-repo"))},git_repository_not_found:function(e){a.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.repo-not-found"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),s.addClass("input-error"),l.addClass("input-error"),p.addClass("input-error"),u.addClass("input-error")},missing_flow_file:function(t){e.dialog("close")},missing_package_file:function(t){e.dialog("close")},project_empty:function(t){e.dialog("close")},credentials_load_failed:function(t){e.dialog("close")},"*":function(t){o(t),$(e).dialog("close")}}}},t).then((function(){RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1),RED.events.emit("project:change",{name:name})})).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]}}}(),"default-files":{content:function(e){var i=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(i);var o=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(i);$("<p>").text(RED._("projects.default-files.create")).appendTo(o),$("<p>").text(RED._("projects.default-files.desc0")).appendTo(o),$("<p>").text(RED._("projects.default-files.desc1")).appendTo(o),!e.existingProject&&RED.settings.files&&$("<p>").text(RED._("projects.default-files.desc2")).appendTo(o);var n=function(){var e=!0,t=s.val();""!==t&&/\.json$/.test(t)?(s.hasClass("input-error")&&(s.removeClass("input-error"),s.next().empty()),l.hasClass("input-error")&&(l.removeClass("input-error"),l.next().empty()),l.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,s.hasClass("input-error")||(s.addClass("input-error"),s.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),l.text(""),l.hasClass("input-error")||(l.addClass("input-error"),l.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#red-ui-projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},a=$('<div class="form-row"></div>').appendTo(o);$('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.default-files.flow-file")+"</label>").appendTo(a);var r=$('<div style="position:relative;"></div>').appendTo(a),d=h.files&&h.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";s=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val(d).on("change keyup paste",n).appendTo(r),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(r),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(a);var c=h.files&&h.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return a=$('<div class="form-row"></div>').appendTo(o),$('<label for="red-ui-projects-dialog-screen-create-project-credfile">'+RED._("projects.default-files.credentials-file")+"</label>").appendTo(a),r=$('<div style="position:relative;"></div>').appendTo(a),l=$('<div style="width: 100%" class="uneditable-input" id="red-ui-projects-dialog-screen-create-project-credentials">').text(c).appendTo(r),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(r),setTimeout((function(){s.trigger("focus"),n()}),50),i},buttons:function(e){return[{text:RED._(e.existingProject?"common.label.cancel":"common.label.back"),click:function(){e.existingProject?$(this).dialog("close"):r("project-details",e)}},{id:"red-ui-projects-dialog-create-default-files",text:RED._("common.label.next"),class:"primary",click:function(){h.files={flow:s.val(),credentials:l.text()},e.existingProject||(h.migrateFiles=!0),r("encryption-config",e)}}]}},"encryption-config":{content:function(e){var i=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(i);var o=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(i);$("<p>").text(RED._("projects.encryption-config.setup")).appendTo(o),e.existingProject?($("<p>").text(RED._("projects.encryption-config.desc0")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc1")).appendTo(o)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text(RED._("projects.encryption-config.desc2")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc3")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc4")).appendTo(o)):("user"===RED.settings.flowEncryptionType?$("<p>").text(RED._("projects.encryption-config.desc5")).appendTo(o):"system"===RED.settings.flowEncryptionType&&$("<p>").text(RED._("projects.encryption-config.desc6")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc7")).appendTo(o));var n=function(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==a.val()),$("#red-ui-projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},r=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(o);$("<label>"+RED._("projects.encryption-config.credentials")+"</label>").appendTo(r);var s=$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(r),d=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(s),l=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(s),c=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(l);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(c);var p=$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled"></div>').appendTo(l);return $('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(p),l.find("input[name=projects-encryption-type]").on("click",(function(e){var t,i;"enabled"===$(this).val()?(t=c,i=p,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&a.trigger("focus")):(i=c,t=p,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),i.addClass("disabled"),n()})),r=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="red-ui-projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?RED._("projects.encryption-config.disabled"):"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.copy")+"</span></label>").appendTo(r),r=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="red-ui-projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.use-custom")+"</span></label>").appendTo(r),r=$('<div class="projects-encryption-enabled-row"></div>').appendTo(d),(a=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(r)).typedInput({type:"cred"}),a.on("change keyup paste",n),r=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(d),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.encryption-config.desc8")+"</div>").appendTo(r),d.find("input[name=projects-encryption-key]").on("click",(function(){var e=$(this).val();a.attr("disabled","default"===e),"custom"===e&&a.trigger("focus"),n()})),setTimeout((function(){l.find("input[name=projects-encryption-type][value=enabled]").trigger("click"),"user"!==RED.settings.flowEncryptionType?d.find("input[name=projects-encryption-key][value=custom]").trigger("click"):d.find("input[name=projects-encryption-key][value=default]").trigger("click"),n()}),100),i},buttons:function(t){return[{text:RED._("common.label.back"),click:function(){r("default-files",t)}},{id:"red-ui-projects-dialog-create-encryption",text:RED._(t.existingProject?"projects.encryption-config.create-project-files":"projects.encryption-config.create-project"),class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(h.credentialSecret=a.val()):h.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(h.name);var n="POST",s="projects";t.existingProject&&(h.initialise=!0,n="PUT",s="projects/"+i.name);var l=this;d({url:s,type:n,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){h={},t.existingProject?$(l).dialog("close"):(r("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log(RED._("projects.encryption-config.already-exists"))},git_error:function(e){console.log(RED._("projects.encryption-config.git-error"),e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log(RED._("projects.encryption-config.git-auth-error"),e)},"*":function(t){o(t),$(e).dialog("close")}}}},h).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]}},"create-success":{content:function(e){var i=$('<div class="red-ui-projects-dialog-screen-start"></div>');t.appendTo(i);var o=$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(i);return $("<p>").text(RED._("projects.create-success.success")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc0")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc1")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc2")).appendTo(o),i},buttons:[{text:RED._("common.label.done"),click:function(){$(this).dialog("close")}}]},create:function(){var t,n,a,r,s,l,c,p,u,f,h,g,v;return{title:RED._("projects.create.projects"),content:function(e){var o=null;v=null;var s=!1;$.getJSON("projects",(function(e){o={},e.projects.forEach((function(e){o[e]=!0,s&&(s=!1,y())}))}));var b,m=$('<div class="red-ui-projects-dialog-screen-create"></div>'),y=function(){var e=t.val(),i=!0;if(T){if(null===o)return void(s=!0);k.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||o[e]?(t.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(k),x=!1,i=!1,o[e]?f.text(RED._("projects.create.already-exists")):f.text(RED._("projects.create.must-contain"))):(t.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(k),f.text(RED._("projects.create.must-contain")),x=!0),C=e}i=x;var n=$(".red-ui-projects-dialog-screen-create-type.selected").data("type");if("copy"===n)i=!1;else if("clone"===n){var r=l.val(),d=r.length>0&&!/\s/.test(r);/^https?:\/\/[^/]+@/i.test(r)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-info-in-url")),d=!1),d?l.removeClass("input-error"):(N&&l.addClass("input-error"),i=!1),/^https?:\/\//.test(r)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(r)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===n){var p=a.val();if(""!==p&&/\.json$/.test(p)?a.hasClass("input-error")&&(a.removeClass("input-error"),a.next().empty()):(i=!1,a.hasClass("input-error")||(a.addClass("input-error"),a.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val())"custom"===$("input[name=projects-encryption-key]:checked").val()&&(i=i&&""!==c.val())}else"open"===n&&(i=!!v);$("#red-ui-projects-dialog-create").prop("disabled",!i).toggleClass("disabled ui-button-disabled ui-state-disabled",!i)};b=$('<div class="form-row button-group"></div>').appendTo(m);var w=$('<button data-type="open" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>'+RED._("projects.create.open")+"</button>").appendTo(b),E=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.create.create")+"</button>").appendTo(b),D=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.create.clone")+"</button>").appendTo(b);b.find(".red-ui-projects-dialog-screen-create-type").on("click",(function(e){switch(e.preventDefault(),m.find(".red-ui-projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),m.find(".red-ui-projects-dialog-screen-create-row").hide(),m.find(".red-ui-projects-dialog-screen-create-row-"+$(this).data("type")).show(),y(),t.trigger("focus"),$(this).data("type")){case"open":$("#red-ui-projects-dialog-create").text(RED._("projects.create.open"));break;case"empty":$("#red-ui-projects-dialog-create").text(RED._("projects.create.create"));break;case"clone":$("#red-ui-projects-dialog-create").text(RED._("projects.create.clone"))}})),b=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-open"></div>').hide().appendTo(m),function(e){e=e||{};e.height;var t,o=$("<div></div>",{class:"red-ui-projects-dialog-project-list-container"}),n="",a=$("<div>",{class:"red-ui-search-container"}).appendTo(o),r=$('<input id="red-ui-projects-dialog-project-list-search" type="text" placeholder="'+RED._("projects.create-project-list.search")+'">').appendTo(a).searchBox({delay:200,change:function(){n=$(this).val().toLowerCase(),c.editableList("filter"),t&&!t.is(":visible")?(t.children().children().removeClass("selected"),(t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))):((t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))),s()}});r.on("keydown",(function(i){if(40===i.keyCode){i.preventDefault();var o=t;if(t){do{o=o.next()}while(0!==o.length&&!o.is(":visible"));if(0===o.length)return;t.children().children().removeClass("selected")}else o=c.children(":visible").first();(t=o).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),s()}else if(38===i.keyCode){i.preventDefault();var n=t;if(t){do{n=n.prev()}while(0!==n.length&&!n.is(":visible"));if(0===n.length)return;t.children().children().removeClass("selected")}else n=c.children(":visible").first();(t=n).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),s()}else 13===i.keyCode&&(i.preventDefault(),t&&e.dblclick&&e.dblclick(t.children().data("data")))})),r.i18n();var s=function(){var e=c.find(".red-ui-projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=l,i=t.height(),o=(t.scrollTop(),e.position().top),n=e.height();o+n>i?t.animate({scrollTop:"-="+(i-o-n)},50):o<0&&t.animate({scrollTop:"+="+o},50)}},l=$("<div></div>",{class:"red-ui-projects-dialog-project-list-inner-container"}).appendTo(o),c=$("<ol>",{class:"red-ui-projects-dialog-project-list"}).appendTo(l).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(o,n,a){var l=$("<div></div>",{class:"red-ui-projects-dialog-project-list-entry"}).appendTo(o);if($('<span class="red-ui-projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(l),$('<span class="red-ui-projects-dialog-project-list-entry-name" style=""></span>').text(a.name).appendTo(l),!i||i.name!==a.name||(l.addClass("projects-list-entry-current"),$('<span class="red-ui-projects-dialog-project-list-entry-current">'+RED._("projects.create-project-list.current")+"</span>").appendTo(l),!1!==e.canSelectActive)){l.addClass("selectable");var p=$('<div class="red-ui-projects-dialog-project-list-entry-tools"></div>').appendTo(l);$('<button class="red-ui-button red-ui-projects-dialog-button red-ui-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(p).on("click",(function(t){t.stopPropagation(),t.preventDefault(),function(e,t,i){var o=$('<div class="red-ui-projects-dialog-project-list-entry-delete-confirm"></div>').on("click",(function(e){e.stopPropagation()})).appendTo(e);$("<span>").text(RED._("projects.delete.confirm")).appendTo(o),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("common.label.cancel")+"</button>").appendTo(o).on("click",(function(e){e.stopPropagation(),o.remove(),i(!0)})),$('<button class="red-ui-button red-ui-projects-dialog-button primary">'+RED._("common.label.delete")+"</button>").appendTo(o).on("click",(function(e){e.stopPropagation(),o.remove(),d({url:"projects/"+t,type:"DELETE",responses:{200:function(e){i(!1)},400:{unexpected_error:function(e){o.remove(),i(!0)}}}})})),setTimeout((function(){o.css("left",0)}),50)}(o,a.name,(function(t){t||o.fadeOut(300,(function(){c.editableList("removeItem",a),e.delete&&e.delete(a)}))}))})),o.on("click",(function(i){$(".red-ui-projects-dialog-project-list-entry").removeClass("selected"),l.addClass("selected"),t=o.parent(),e.select&&e.select(a),s(),r.trigger("focus")})),e.dblclick&&o.on("dblclick",(function(t){t.preventDefault(),e.dblclick(a)}))}},filter:function(e){return""===n||-1!==e.name.toLowerCase().indexOf(n)}});return $.getJSON("projects",(function(e){e.projects.forEach((function(e){c.editableList("addItem",{name:e})}))})),o}({canSelectActive:!1,dblclick:function(e){v=e,$("#red-ui-projects-dialog-create").trigger("click")},select:function(e){v=e,y()},delete:function(e){o&&delete o[e.name],v=null,y()}}).appendTo(b),b=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(m),$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.create.project-name")+"</label>").appendTo(b);var R=$('<div style="position:relative;"></div>').appendTo(b);t=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(R);var x,_,k=$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(R),T=!1,C="",j="";t.on("change keyup paste",(function(){if(T=t.val()!==C,_)clearTimeout(_);else if(T&&(k.empty(),$('<img src="red/images/spin.svg"/>').appendTo(k),""===t.val()))return void y();_=setTimeout((function(){y(),_=null}),300)})),f=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.must-contain")+"</small></label>").appendTo(b).find("small"),b=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(m),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.create.desc")+"</label>").appendTo(b),n=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').appendTo(b),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.opt")+"</small></label>").appendTo(b),b=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(m),$('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.create.flow-file")+"</label>").appendTo(b),R=$('<div style="position:relative;"></div>').appendTo(b),a=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",y).appendTo(R),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(R),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(b),b=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(m),$("<label>"+RED._("projects.create.credentials")+"</label>").appendTo(b);var L=$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(b),O=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(L),S=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(L),I=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(S);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(I);var P=$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled disabled"></div>').appendTo(S);$('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(P),S.find("input[name=projects-encryption-type]").on("click",(function(e){var t,i;"enabled"===$(this).val()?(t=I,i=P,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&c.trigger("focus")):(i=I,t=P,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),i.addClass("disabled"),y()})),b=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(O),$('<label class="red-ui-projects-edit-form-inline-label">'+RED._("projects.create.encryption-key")+"</label>").appendTo(b),(c=$('<input type="password"></input>').appendTo(b)).typedInput({type:"cred"}),c.on("change keyup paste",y),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.desc0")+"</small></label>").appendTo(b),b=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(O),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.create.desc1")+"</div>").appendTo(b),O.find("input[name=projects-encryption-key]").on("click",(function(){var e=$(this).val();c.attr("disabled","default"===e),"custom"===e&&c.trigger("focus"),y()})),b=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(m),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.create.git-url")+"</label>").appendTo(b),l=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(b),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.protocols")+"</small></label>").appendTo(b);var N=!1,A="";l.on("change keyup paste",(function(){N=!0;var e=$(this).val();A!==e&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),A=e;var i=/\/([^/]+?)(?:\.git)?$/.exec(e);if(i){var o=t.val();""!==o&&o!==j||(j=i[1],t.val(j),t.trigger("change"))}y()}));var z=$('<div class="hide red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').hide().appendTo(m);b=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(z),$('<div><i class="fa fa-warning"></i> '+RED._("projects.create.auth-failed")+"</div>").appendTo(b),b=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(z);R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(b);$('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.create.username")+"</label>").appendTo(R),p=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(R),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(b),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.create.password")+"</label>").appendTo(R),(u=$('<input style="width:100%" id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(R)).typedInput({type:"cred"}),b=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(z),R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(b),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.ssh-key")+"</label>").appendTo(R),h=$("<select>",{style:"width: 100%"}).appendTo(R),$.getJSON("settings/user/keys",(function(e){var t=0;e.keys.forEach((function(e){h.append($("<option></option>").val(e.name).text(e.name)),t++})),0===t?(h.addClass("input-error"),h.attr("disabled",!0),M.show()):(h.removeClass("input-error"),h.attr("disabled",!1),M.hide())})),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(b),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.passphrase")+"</label>").appendTo(R),(g=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(R)).typedInput({type:"cred"}),R=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(z);var M=$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(R);switch($('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.create.desc2")+"</div>").appendTo(M),R=$('<div style="text-align: center">').appendTo(M),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("projects.create.add-ssh-key")+"</button>").appendTo(R).on("click",(function(e){e.preventDefault(),$("#red-ui-projects-dialog-cancel").trigger("click"),RED.userSettings.show("gitconfig"),setTimeout((function(){$("#user-settings-gitconfig-add-key").trigger("click")}),500)})),b=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(m),$("<label>"+RED._("projects.create.credentials-encryption-key")+"</label>").appendTo(b),(r=$('<input style="width:100%" type="password"></input>').appendTo(b)).typedInput({type:"cred"}),e.screen||"empty"){case"empty":E.trigger("click");break;case"open":w.trigger("click");break;case"clone":D.trigger("click")}return setTimeout((function(){"open"!==(e.screen||"empty")?t.trigger("focus"):$("#red-ui-projects-dialog-project-list-search").trigger("focus")}),50),m},buttons:function(i){var f;switch(i.screen||"empty"){case"open":f=RED._("projects.create.open");break;case"empty":f=RED._("projects.create.create");break;case"clone":f=RED._("projects.create.clone")}return[{id:"red-ui-projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-projects-dialog-create",text:f,class:"primary disabled",disabled:!0,click:function(){var i=$(".red-ui-projects-dialog-screen-create-type.selected").data("type"),f={name:t.val()};if("empty"===i){f.summary=n.val(),f.files={flow:a.val()};var b=$("input[name=projects-encryption-type]:checked").val();f.credentialSecret="enabled"===b&&c.val()}else if("copy"===i)f.copy=s.name;else if("clone"===i){f.credentialSecret=r.val();var m=l.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(m)){var y=h.val();if(!y)return void console.log(RED._("projects.create.cant-get-ssh-key-path"));f.git={remotes:{origin:{url:m,keyFile:y,passphrase:g.val()}}}}else f.git={remotes:{origin:{url:m,username:p.val(),password:u.val()}}}}else if("open"===i)return function(t,i){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t),d({url:"projects/"+t,type:"PUT",responses:{200:function(e){i(null,e)},400:{"*":i}}},{active:!0}).then((function(){e.dialog("close"),RED.events.emit("project:change",{name:t})})).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}(v.name,(function(e,t){e&&"credentials_load_failed"!==e.code&&console.log(RED._("projects.create.unexpected_error"),e)}));$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),p.removeClass("input-error"),u.removeClass("input-error"),h.removeClass("input-error"),g.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(f.name),d({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(t){e.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.create.already-exists-2"))},git_error:function(e){console.log(RED._("projects.create.git-error"),e)},git_connection_failed:function(e){l.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.con-failed"))},git_not_a_repository:function(e){l.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.not-git"))},git_repository_not_found:function(e){l.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-resource"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),p.addClass("input-error"),u.addClass("input-error"),h.addClass("input-error"),g.addClass("input-error")},missing_flow_file:function(t){e.dialog("close")},missing_package_file:function(t){e.dialog("close")},project_empty:function(t){e.dialog("close")},credentials_load_failed:function(t){e.dialog("close")},"*":function(t){o(t),$(e).dialog("close")}}}},f).then((function(){RED.events.emit("project:change",{name:name})})).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]}}}()}}function r(i,o){e||RED.projects.init();var a=n[i],r=a.content(o||{});t.empty();var s=a.buttons;"function"==typeof s&&(s=s(o||{})),e.dialog("option","buttons",s),t.append(r);var d=590,l=$(window).height();l<750&&(d=590-(750-l)),$(".red-ui-projects-dialog-box").height(d),$(".red-ui-projects-dialog-project-list-inner-container").height(Math.max(500,d)-180),e.dialog("option","title",a.title||""),e.dialog("open")}function s(e){if(RED.nodes.dirty())var t=RED._("projects.require-clean.confirm"),i=RED.notify(t,{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close(),e(!0)}},{text:RED._("common.label.cont"),click:function(){i.close(),e(!1)}}]})}function d(e,t){var o,n;if(e.requireCleanWorkspace&&RED.nodes.dirty())return s((function(i){i?e.cancel&&(e.cancel(),n&&n()):(delete e.requireCleanWorkspace,d(e,t).then((function(){o&&o()})).always((function(){n&&n()})))})),{then:function(e){return o=e,{always:function(e){n=e}}},always:function(e){n=e}};var a,r,l=Date.now();return $(".red-ui-component-spinner").show(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),t&&(e.data=JSON.stringify(t),e.contentType="application/json; charset=utf-8"),$.ajax(e).done((function(t,i,o){e.responses&&e.responses[200]&&(a=e.responses[200],r=t)})).fail((function(o,n,s){var l;if(e.responses&&e.responses[o.status]){if("function"==typeof(l=e.responses[o.status]))return a=l,void(r={error:l.statusText});if(!1===e.handleAuthFail||"git_auth_failed"!==o.responseJSON.code&&"git_host_key_verification_failed"!==o.responseJSON.code){if(l[o.responseJSON.code])return a=l[o.responseJSON.code],void(r=o.responseJSON);if(l["*"])return a=l["*"],void(r=o.responseJSON)}else{if("git_auth_failed"===o.responseJSON.code){var c=i.git.remotes[o.responseJSON.remote||e.remote||"origin"].fetch,p=$('<div><div class="form-row">'+RED._("projects.send-req.auth-req")+':</div><div class="form-row"><div style="margin-left: 20px;">'+c+"</div></div></div>"),u=!1;if(/^https?:\/\//.test(c))$('<div class="form-row"><label for="projects-user-auth-username">'+RED._("projects.send-req.username")+'</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for="projects-user-auth-password">'+RED._("projects.send-req.password")+'</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(p),p.find("#projects-user-auth-password").typedInput({type:"cred"});else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(c)){u=!0;var f=$('<div class="form-row"></div>').appendTo(p);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(f);var h=$('<select id="projects-user-auth-key">').width("70%").appendTo(f);$.getJSON("settings/user/keys",(function(e){e.keys.forEach((function(e){h.append($("<option></option>").val(e.name).text(e.name))}))})),f=$('<div class="form-row"></div>').appendTo(p),$('<label for="projects-user-auth-passphrase">'+RED._("projects.send-req.passphrase")+"</label>").appendTo(f),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(f).typedInput({type:"cred"})}var g=RED.notify(p,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){g.close()}},{text:'<span><i class="fa fa-refresh"></i> '+RED._("projects.send-req.retry")+"</span>",click:function(){t=t||{};var n={};u?(n.keyFile=$("#projects-user-auth-key").val(),n.passphrase=$("#projects-user-auth-passphrase").val()):(n.username=$("#projects-user-auth-username").val(),n.password=$("#projects-user-auth-password").val());var a=function(i){i?(console.log(RED._("projects.send-req.update-failed")),console.log(i)):(d(e,t),g.close())};d({url:"projects/"+i.name+"/remotes/"+(o.responseJSON.remote||e.remote||"origin"),type:"PUT",responses:{0:function(e){a(e)},200:function(e){a(null)},400:{unexpected_error:function(e){a(e)}}}},{auth:n})}}]});return}if("git_host_key_verification_failed"===o.responseJSON.code){p=$('<div><div class="form-row">'+RED._("projects.send-req.host-key-verify-failed")+"</div></div>"),g=RED.notify(p,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.close"),click:function(){g.close()}}]});return}}}console.log(l),console.log(RED._("projects.send-req.unhandled")+":"),console.log(o),console.log(n),console.log(s)})).always((function(){var e=Date.now()-l;e=Math.max(0,500-e),setTimeout((function(){$(".red-ui-component-spinner").hide(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),a&&a(r)}),e)}))}function l(e){var t,i="",n=new Set,a=[],r="",s=$('<div class="red-ui-projects-branch-list">').appendTo(e.container),l=$('<input type="text">').attr("placeholder",e.placeholder).appendTo(s).searchBox({delay:200,change:function(){i=$(this).val();var e=!1,o=!1,n=/^([^/]+)\/[^/.~*?\[]/.exec(i);n&&a.indexOf(n[1])>-1&&(e=!0,o=!0),!e&&/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(i)?(t.hasClass("input-error")||(t.addClass("input-error"),t.find("i").addClass("fa-warning").removeClass("fa-code-fork")),t.find("span").text(RED._("projects.create-branch-list.invalid")+": "+(o?"":r)+i)):(t.hasClass("input-error")&&(t.removeClass("input-error"),t.find("i").removeClass("fa-warning").addClass("fa-code-fork")),t.find("span").text(RED._("projects.create-branch-list.create")+":"),t.find(".red-ui-sidebar-vc-branch-list-entry-create-name").text((o?"":r)+i)),p.editableList("filter")}}),p=$("<ol>",{style:"height: 130px;"}).appendTo(s);return p.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(i,o,n){var r=$('<div class="red-ui-sidebar-vc-branch-list-entry">').appendTo(i);n.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(r),$("<span>").text(n.name).appendTo(r),n.current&&(r.addClass("selected"),$('<span class="current"></span>').text(e.currentLabel||RED._("projects.create-branch-list.current")).appendTo(r))):(t=r,$('<i class="fa fa-code-fork"></i>').appendTo(r),$("<span>").text(RED._("projects.create-branch-list.create")+":").appendTo(r),$('<div class="red-ui-sidebar-vc-branch-list-entry-create-name" style="margin-left: 10px;">').text(n.name).appendTo(r)),r.on("click",(function(t){if(t.preventDefault(),!$(this).hasClass("input-error")){var i={};if(n.hasOwnProperty("commit"))$(this).hasClass("selected")&&(i.current=!0),i.name=n.name;else if(i.name=l.val(),i.create=!0,e.remotes){var o=/^([^/]+)\/[^/.~*?\[]/.exec(i.name);o&&-1!==a.indexOf(o[1])||(i.name=a[0]+"/"+i.name)}e.onselect&&e.onselect(i)}}))},filter:function(e){var t=!e.hasOwnProperty("commit"),o=i;if(a.length>0){var r=/^([^/]+)\/[^/.~*?\[]/.exec(o);""===o||r&&-1!=a.indexOf(r[1])||(o=a[0]+"/"+o)}return t&&""!==o&&!n.has(o)||!t&&-1!==e.name.indexOf(i)}}),{refresh:function(t){l.searchBox("value",""),p.editableList("empty");var i=Date.now(),u=c(s).addClass("red-ui-component-spinner-contain");e.remotes?(a=e.remotes(),r=a[0]+"/"):(r="",a=[]),n=new Set,d({url:t,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){e.branches,e.branches.forEach((function(e){p.editableList("addItem",e),n.add(e.name)})),p.editableList("addItem",{}),setTimeout((function(){u.remove()}),Math.max(300-(Date.now()-i),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){o(e)}}}})},filter:function(){p.editableList("filter")},focus:function(){l.trigger("focus")}}}function c(e){return $('<div class="red-ui-component-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function p(){createProjectOptions={},i?r("create",{screen:"empty"}):r("welcome")}return{init:function(){e=$('<div id="red-ui-projects-dialog" class="hide red-ui-projects-edit-form"><div class="red-ui-projects-dialog-box"><form class="form-horizontal"></form><div class="red-ui-component-spinner hide"><img src="red/images/spin.svg"/></div></div></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){RED.keyboard.disable()},close:function(e){RED.keyboard.enable()},classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"}}),t=e.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var i={sendRequest:d,createBranchList:l,addSpinnerOverlay:c,reportUnexpectedError:o};RED.projects.settings.init(i),RED.projects.userSettings.init(i),RED.sidebar.versionControl.init(i),a()},showStartup:function(){RED.user.hasPermission("projects.write")?r("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?s((function(e){e||p()})):void p();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?s((function(e){e||r("create",{screen:"open"})})):void r("create",{screen:"open"});RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?(RED.projects.settings.show("settings"),setTimeout((function(){$("#project-settings-tab-settings-file-edit").trigger("click")}),200)):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!i)throw new Error(RED._("projects.create-default-file-set.no-active"));if(!i.empty)throw new Error(RED._("projects.create-default-file-set.no-empty"));RED.user.hasPermission("projects.write")?(createProjectOptions={},r("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(i.name),d({url:"projects/"+i.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log(RED._("projects.create-default-file-set.git-error"),e)},missing_flow_file:function(t){$(e).dialog("close")},"*":function(t){o(t),$(e).dialog("close")}}}},{initialise:!0}).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))},refresh:function(e){$.getJSON("projects",(function(t){t.active?$.getJSON("projects/"+t.active,(function(t){i=t,RED.events.emit("projects:load",i),RED.sidebar.versionControl.refresh(!0),e&&e(i)})):e&&e(null)}))},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return i}}}(),RED.projects.settings=function(){var e,t,i=700,o=!1,n=[];function a(e){n.push(e)}function r(e,i){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:e.description,complete:function(o){i.empty();var n=t.addSpinnerOverlay(i),a=function(t,n){if(t)return r(e,i);e.description=o,s(e,i)};t.sendRequest({url:"projects/"+e.name,type:"PUT",responses:{0:function(e){a(e)},200:function(e){a(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){t.reportUnexpectedError(e),a(e)}}}},{description:o}).always((function(){n.remove()}))}})}function s(e,t){var i,o;t.empty(),i=e.description?RED.utils.renderMarkdown(e.description):'<span class="red-ui-help-info-none">'+RED._("sidebar.project.noDescriptionAvailable")+"</span>",(o=$('<span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(i)+'">'+i+"</span>"),$(o).find("a").each((function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")})),o).appendTo(t).find(".red-ui-text-bidi-aware").contents().filter((function(){return 3===this.nodeType&&""!==this.textContent.trim()})).wrap("<span></span>")}function d(e,i,o,n,a){var r=o.prev();r.hide(),o.empty(),a.empty();var s=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(o),p=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(i||"").appendTo(o),u=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(n||"").appendTo(a);$('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(s).on("click",(function(t){t.preventDefault(),l(e.summary,o),c(e.version,a),r.show()})),$('<button class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(s).on("click",(function(s){s.preventDefault();var f=p.val(),h=u.val();l(f,o),c(h,a);var g=t.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),v=function(t,s){if(t)return g.remove(),d(e,i,o,n,a);e.summary=f,e.version=h,g.remove(),l(e.summary,o),c(e.version,a),r.show()};t.sendRequest({url:"projects/"+e.name,type:"PUT",responses:{0:function(e){v(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),v(null)},400:{"*":function(e){t.reportUnexpectedError(e),v(e)}}}},{summary:f,version:h})}))}function l(e,t){t.empty(),e?t.text(e).removeClass("red-ui-help-info-none"):t.text(RED._("sidebar.project.noSummaryAvailable")).addClass("red-ui-help-info-none")}function c(e,t){t.empty(),e&&t.text(e)}function p(e){var t=$('<div id="red-ui-project-settings-tab-main" class="red-ui-project-settings-tab-pane red-ui-help"></div>');$("<h1>").text(e.name).appendTo(t);var i=$('<div style="position: relative">').appendTo(t),o=$("<div></div>").appendTo(i),n=$("<div></div>").addClass("red-ui-help-info-none").appendTo(i);l(e.summary,o),c(e.version,n),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editDescription")+"</button>").prependTo(i).on("click",(function(t){t.preventDefault(),d(e,e.summary,o,e.version,n)})),$("<hr>").appendTo(t);var a=$('<div class="red-ui-help" style="position: relative"></div>').appendTo(t),p=$("<div>",{style:"min-height: 200px"}).appendTo(a);return s(e,p),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editReadme")+"</button>").prependTo(a).on("click",(function(t){t.preventDefault(),r(e,p)})),t}function u(e,t){t.editableList("empty");var i=0;for(var o in E)E.hasOwnProperty(o)&&(t.editableList("addItem",{id:E[o].module,version:E[o].version,count:E[o].count,known:e.dependencies.hasOwnProperty(o),installed:!0}),i++,0===E[o].count&&0,e.dependencies.hasOwnProperty(o)||0);if(e.dependencies)for(var o in e.dependencies)if(e.dependencies.hasOwnProperty(o)&&!E.hasOwnProperty(o)){var n=!!RED.nodes.registry.getModule(o);t.editableList("addItem",{id:o,version:e.dependencies[o],count:0,known:!0,installed:n}),i++,n?0:0}0===i&&t.editableList("addItem",{index:0,label:RED._("sidebar.project.projectSettings.none")})}function f(e,i,o,n){var a=RED.projects.getActiveProject(),r=t.addSpinnerOverlay(i).addClass("red-ui-component-spinner-contain"),s=function(e,t){if(r.remove(),e)return n(e);a.dependencies=o,RED.sidebar.versionControl.refresh(!0),n()};t.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){s(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),s(null)},400:{"*":function(e){s(e)}}}},{dependencies:o})}function h(e,t,i,o){var n=t||JSON.stringify(e.dependencies||{},"",4);"{}"===n&&(n="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:n,requireValid:!0,complete:function(t){try{var n=JSON.parse(t);f(0,i,n,(function(a){if(a)return h(e,t,i,o);e.dependencies=n,u(e,o)}))}catch(n){h(e,t,i,o)}}})}function g(e){var t=$('<div id="red-ui-project-settings-tab-deps" class="red-ui-project-settings-tab-pane red-ui-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="margin-top:10px;float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(t).on("click",(function(o){o.preventDefault(),h(e,null,t,i)}));var i=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return i.editableList({addButton:!1,addItem:function(t,o,n){var a=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(t);if(n.label)0===n.index?a.addClass("red-ui-search-empty"):t.parent().addClass("red-ui-palette-module-section"),a.text(n.label);else{a.addClass("red-ui-palette-module-header"),n.installed?0===n.count?a.addClass("red-ui-palette-module-unused"):n.known||a.addClass("red-ui-palette-module-unknown"):a.addClass("red-ui-palette-module-not-installed"),n.element=a;var r=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"></div>').appendTo(a),s="fa-cube";n.installed||(s="fa-warning");var d=$('<i class="fa '+s+'"></i>').appendTo(r);n.icon=d,$("<span>").text(n.id).appendTo(r);var l=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(a);$("<span>").text(n.version).appendTo(l);l=$('<div class="red-ui-palette-module-meta"></div>').appendTo(a);var c=$('<div class="red-ui-palette-module-button-group"></div>').appendTo(l);RED.user.hasPermission("projects.write")&&(n.installed||!1===RED.settings.theme("palette.editable")?n.known&&0===n.count?$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.removeFromProject")+"</a>").appendTo(c).on("click",(function(o){o.preventDefault();var a=$.extend(!0,{},e.dependencies);delete a[n.id],f(0,t,a,(function(e){e?console.log(e):t.fadeOut(200,(function(){i.editableList("removeItem",n)}))}))})):n.known||$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.addToProject")+"</a>").appendTo(c).on("click",(function(i){i.preventDefault();var o=$.extend(!0,{},e.dependencies);o[n.id]=E[n.id].version,f(0,t,o,(function(e){e?console.log(e):(c.remove(),a.removeClass("red-ui-palette-module-unknown"))}))})):$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.install")+"</a>").appendTo(c).on("click",(function(e){e.preventDefault(),RED.palette.editor.install(n,t,(function(e){if(!e){n.installed=!0;RED.utils.addSpinnerOverlay(t,!0);setTimeout((function(){i.editableList("removeItem",n),E={},RED.nodes.eachNode(w),RED.nodes.eachConfig(w),E.hasOwnProperty(n.id)?n.count=E[n.id].count:n.count=0,i.editableList("addItem",n)}),500)}}))})))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),u(e,i),t}function v(e,i,o,n,a){var r=$('<div class="red-ui-projects-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),s=t.addSpinnerOverlay(r);return $.getJSON("projects/"+i.name+"/files",(function(e){var t=Object.keys(e);t=t.filter((function(t){return!e[t].status||!/D/.test(e[t].status)}));var i={};t.sort(),t.forEach((function(e){e.split("/").reduce((function(e,t,i,o){if(t)return i<o.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]}),i)}));var d=function(e,t,i){var o={name:e||"/",path:i+(i?"/":"")+e};return!0===t?(o.type="f",o):(o.type="d",o.children=[],o.path=o.path,Object.keys(t).forEach((function(e){o.children.push(d(e,t[e],o.path))})),o.children.sort((function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)})),o)};i=d("",i,"");b(r,i.children,o,n,a,"height: 175px"),s.remove()})),r}function b(e,t,i,o,n,a){a=a||"";var r=$("<ol>",{class:"red-ui-projects-dialog-file-list",style:a}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,a){var r=$("<div></div>",{class:"red-ui-projects-dialog-file-list-entry"}).appendTo(e);if(a.children){if($('<span class="red-ui-projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(r),a.children.length>0){var s=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(e);0===i.indexOf(a.path+"/")?r.addClass("expanded"):s.hide(),b(s,a.children,i,o,n),r.addClass("selectable"),r.on("click",(function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),s.slideUp(200)):($(this).addClass("expanded"),s.slideDown(200))}))}}else{var d="fa-file-o";/\.json$/i.test(a.name)?d="fa-file-code-o":/\.md$/i.test(a.name)?d="fa-book":/^\.git/i.test(a.name)&&(d="fa-code-fork",r.addClass("red-ui-projects-dialog-file-list-entry-file-type-git")),$('<span class="red-ui-projects-dialog-file-list-entry-file"> <i class="fa '+d+'"></i></span>').appendTo(r),o(a)?(r.addClass("selectable"),a.path===i&&r.addClass("selected"),r.on("click",(function(e){$(".red-ui-projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),n(a.path,!0)})),r.on("dblclick",(function(e){e.preventDefault(),n(a.path,!0)}))):r.addClass("unselectable")}$('<span class="red-ui-projects-dialog-file-list-entry-name" style=""></span>').text(a.name).appendTo(r)}});a||r.parent().css("overflow-y",""),t.forEach((function(e){r.editableList("addItem",e)}))}function m(e,i){$("<h3></h3>").text(RED._("sidebar.project.projectSettings.versionControl")).appendTo(i),function(e,i){var o=$('<div class="red-ui-settings-section"></div>').appendTo(i);$("<h4></h4>").text(RED._("sidebar.project.projectSettings.branches")).appendTo(o);var n=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(o),a=$("<ol>").appendTo(n).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(i,o,n){var r=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(i);if(n.empty)return r.addClass("red-ui-search-empty"),void r.text(RED._("sidebar.project.projectSettings.noBranches"));n.current&&r.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(r);var s=$("<span>").appendTo(r),d=$("<div>").appendTo(s);if($('<span class="entry-name">').text(n.name).appendTo(d),n.commit&&$('<span class="entry-detail">').text(n.commit.sha).appendTo(d),n.remote){var l=$("<div>").appendTo(s);$('<span class="entry-detail entry-remote-name">').text(n.remote||"").appendTo(l),n.status.ahead+n.status.behind>0&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+n.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+n.status.behind+"</span></span>").appendTo(l)}if(!n.current){var c=$('<span class="entry-tools">').appendTo(r);$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(c).on("click",(function(o){o.preventDefault();var r=t.addSpinnerOverlay(i).addClass("red-ui-component-spinner-contain"),s=RED.notify(RED._("sidebar.project.projectSettings.deleteConfirm",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){r.remove(),s.close()}},{text:"Delete branch",click:function(){s.close();var o={url:"projects/"+e.name+"/branches/"+n.name,type:"DELETE",responses:{200:function(e){i.fadeOut(200,(function(){a.editableList("removeItem",n),r.remove()}))},400:{git_delete_branch_unmerged:function(e){s=RED.notify(RED._("sidebar.project.projectSettings.unmergedConfirm",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){r.remove(),s.close()}},{text:RED._("sidebar.project.projectSettings.deleteUnmergedBranch"),click:function(){o.url+="?force=true",s.close(),t.sendRequest(o)}}]})},"*":function(e){t.reportUnexpectedError(e),r.remove()}}}};t.sendRequest(o)}}]})}))}}});$.getJSON("projects/"+e.name+"/branches",(function(e){e.branches&&(e.branches.length>0?(e.branches.sort((function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)})),e.branches.forEach((function(e){a.editableList("addItem",e)}))):a.editableList("addItem",{empty:!0}))}))}(e,i);var o=$('<div class="red-ui-settings-section"></div>').appendTo(i),n=$("<h4></h4>").text(RED._("sidebar.project.projectSettings.gitRemotes")).appendTo(o),a=$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("sidebar.project.projectSettings.addRemote")+"</button>").appendTo(n).on("click",(function(e){a.attr("disabled",!0),l.slideDown(200,(function(){l[0].scrollIntoView(),s?(g.val("origin"),v.trigger("focus")):g.trigger("focus"),u()}))})),r={empty:!0},s=!0,d=$('<div class="red-ui-settings-row"></div>').appendTo(o),l=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(d);d=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(o);var c=$("<ol>").appendTo(d);c.editableList({addButton:!1,height:"auto",addItem:function(i,o,n){var a=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(i);if(n.empty)return a.addClass("red-ui-search-empty"),void a.text(RED._("sidebar.project.projectSettings.noRemotes"));$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(a);var d=$("<span>").appendTo(a);$('<div class="entry-name">').text(n.name).appendTo(d),n.urls.fetch===n.urls.push?$('<div class="entry-detail">').text(n.urls.fetch).appendTo(d):($('<div class="entry-detail">').text("fetch: "+n.urls.fetch).appendTo(d),$('<div class="entry-detail">').text("push: "+n.urls.push).appendTo(d));var l=$('<span class="entry-tools">').appendTo(a);$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(l).on("click",(function(o){o.preventDefault();var a=t.addSpinnerOverlay(i).addClass("red-ui-component-spinner-contain"),d=RED.notify(RED._("sidebar.project.projectSettings.deleteRemoteConfrim",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.remove(),d.close()}},{text:RED._("sidebar.project.projectSettings.deleteRemote"),click:function(){d.close(),e.git.branches.remote&&0===e.git.branches.remote.indexOf(n.name+"/")&&delete e.git.branches.remote,e.git.branches.remoteAlt&&0===e.git.branches.remoteAlt.indexOf(n.name+"/")&&delete e.git.branches.remoteAlt;var o={url:"projects/"+e.name+"/remotes/"+n.name,type:"DELETE",responses:{200:function(t){i.fadeOut(200,(function(){c.editableList("removeItem",n),setTimeout(a.remove,100),0===t.remotes.length?(delete e.git.remotes,s=!0,c.editableList("addItem",r)):(e.git.remotes={},t.remotes.forEach((function(t){var i=t.name;delete t.name,e.git.remotes[i]=t}))),delete e.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()}))},400:{"*":function(e){t.reportUnexpectedError(e),a.remove()}}}};t.sendRequest(o)}}]})}))}});var p,u=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(g.val()),t=v.val(),i=t.length>0&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(b.text(RED._("sidebar.project.projectSettings.urlRule2")),i=!1):b.text(RED._("sidebar.project.projectSettings.urlRule")),w.attr("disabled",!e||!i),g.toggleClass("input-error",f&&!e),v.toggleClass("input-error",h&&!i),p&&(p.close(),p=null)},f=!1,h=!1;$('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("sidebar.project.projectSettings.addRemote2")).appendTo(l),d=$('<div class="red-ui-settings-row"></div>').appendTo(l),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.remoteName")).appendTo(d);var g=$('<input type="text">').appendTo(d).on("change keyup paste",(function(){f=!0,u()}));$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.nameRule")+"</small></label>").appendTo(d).find("small"),d=$('<div class="red-ui-settings-row"></div>').appendTo(l),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.url")).appendTo(d);var v=$('<input type="text">').appendTo(d).on("change keyup paste",(function(){h=!0,u()})),b=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.urlRule")+"</small></label>").appendTo(d).find("small"),m=function(){a.attr("disabled",!1),l.hide(),g.val(""),v.val(""),p&&(p.close(),p=null)},y=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(y).on("click",(function(e){e.preventDefault(),m()}));var w=$('<button class="red-ui-button">'+RED._("sidebar.project.projectSettings.addRemote2")+"</button>").appendTo(y).on("click",(function(i){i.preventDefault();var o=t.addSpinnerOverlay(l).addClass("red-ui-component-spinner-contain"),n={name:g.val(),url:v.val()},a=function(e){o.remove(),e||m()};RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+e.name+"/remotes",type:"POST",responses:{0:function(e){a(e)},200:function(t){e.git.remotes={},t.remotes.forEach((function(t){var i=t.name;delete t.name,e.git.remotes[i]=t})),E(),RED.sidebar.versionControl.refresh(),a()},400:{git_remote_already_exists:function(e){p=RED.popover.create({target:g,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),g.addClass("input-error"),a(e)},"*":function(e){t.reportUnexpectedError(e),a(e)}}}},n)})),E=function(){c.editableList("empty");var t=0;if(e.git.hasOwnProperty("remotes"))for(var i in e.git.remotes)e.git.remotes.hasOwnProperty(i)&&(t++,c.editableList("addItem",{name:i,urls:e.git.remotes[i]}));(s=0===t)&&c.editableList("addItem",r)};E()}function y(i){var o=$('<div id="red-ui-project-settings-tab-settings" class="red-ui-project-settings-tab-pane red-ui-help"></div>');return function(i,o){var n,a=$("<h3></h3>").text(RED._("sidebar.project.projectSettings.files")).appendTo(o),r=$('<div class="red-ui-settings-section"></div>').appendTo(o);if(RED.user.hasPermission("projects.write"))var s=$('<button type="button" id="red-ui-project-settings-tab-settings-file-edit" class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(a).on("click",(function(e){e.preventDefault(),J.show(),s.hide(),i.files.package||(u.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.packageCreate")),u.show()),p.show(),y.hide(),E.show(),D.show(),w(),j.addClass("uneditable-input"),$(".red-ui-settings-row-credentials").show(),j.css("height","auto"),I.hide(),L.show()}));n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.package")).appendTo(n);var d=$('<div class="uneditable-input" style="padding:0">').appendTo(n),l=$('<span style="display:inline-block;  padding: 6px">').text(i.files.package||"package.json").appendTo(d),c=$('<input type="hidden">').val(i.files.package||"package.json").appendTo(d),p=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(d).on("click",(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),d.find(".red-ui-projects-file-listing-container").slideUp(200,(function(){$(this).remove(),d.css("height","")})),d.css("color","");else{$(this).addClass("selected"),d.css("color","inherit");var t=v(d,i,c.val(),(function(e){return e.children||/package\.json$/.test(e.path)}),(function(e,t){if(e){c.val(e),l.text(e);var i=e.substring(0,e.length-12);b.text(i),_.text(i),w(),u.hide()}t&&$(p).trigger("click"),C()}));d.css("height","auto"),setTimeout((function(){t.slideDown(200)}),50)}}));RED.popover.tooltip(p,RED._("sidebar.project.projectSettings.selectFile"));var u=$('<label style="margin-left: 110px" class="red-ui-projects-edit-form-sublabel"><small><span class="form-warning"><i class="fa fa-warning"></i> <span class="red-ui-projects-edit-form-sublabel-text"></span></small></label>').appendTo(n).hide();i.files.package||(u.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),u.show());var f=i.files.package||"package.json",h=f.substring(0,f.length-12);n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.flow")).appendTo(n);var g=$('<div class="uneditable-input" style="padding:0">').appendTo(n),b=$('<span style="display:inline-block; padding: 6px 0 6px 6px">').text(h).appendTo(g),m="flows.json";i.files.flow&&(m=0===i.files.flow.indexOf(h)?i.files.flow.substring(h.length):i.files.flow);var y=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(m).appendTo(g),w=function(){E.css({width:"calc(100% - "+(D.width()+b.width())+"px)"})},E=$('<input type="text" style="padding-left:1px; margin-top: -2px; margin-bottom: 0;border: none;">').val(m).hide().appendTo(g),D=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(g).on("click",(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),g.find(".red-ui-projects-file-listing-container").slideUp(200,(function(){$(this).remove(),g.css("height","")})),g.css("color","");else{$(this).addClass("selected"),g.css("color","inherit");var t=c.val(),o=t.substring(0,t.length-12),n=new RegExp("^"+o+".*.json$"),a=v(g,i,E.val(),(function(e){return!/package.json$/.test(e.path)&&n.test(e.path)&&!/_cred\.json$/.test(e.path)}),(function(e,t){e&&E.val(e.substring(o.length)),t&&$(D).trigger("click"),C()}));g.css("height","auto"),setTimeout((function(){a.slideDown(200)}),50)}}));RED.popover.tooltip(D,RED._("sidebar.project.projectSettings.selectFile")),n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.credentials")).appendTo(n);var R="flows_cred.json";i.files.credentials&&(R=0===i.files.flow.indexOf(h)?i.files.credentials.substring(h.length):i.files.credentials);var x=$('<div class="uneditable-input" style="padding:0">').appendTo(n),_=$('<span style="display:inline-block;padding: 6px 0 6px 6px">').text(h).appendTo(x),k=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(R).appendTo(x),T=$('<input type="hidden">').val(R).insertAfter(x),C=function(){var e,t=E.val(),i=/^(.+?)(\.[^.]*)?$/.exec(t);i?k.text(i[1]+"_cred"+(i[2]||".json")):""===t&&k.text(""),T.val(k.text());var o=""===t||/\.\./.test(t)||/\/$/.test(t);e=o||""===k.text(),M.is(":visible")&&(M.toggleClass("input-error",""===M.val()),e=e||""===M.val()),G.is(":visible")&&(G.toggleClass("input-error",""===G.val()),e=e||""===G.val()),E.toggleClass("input-error",o),q.toggleClass("disabled",e),q.prop("disabled",e)};E.on("change keyup paste",C),n=$('<div class="red-ui-settings-row"></div>').appendTo(r),$("<label></label>").appendTo(n);var j=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(n),L=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(n);j.css("color","#666"),L.css("vertical-align","top");var O=$('<button type="button" class="red-ui-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(L).on("click",(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),I.hide()):(G.val(""),z.hide(),B.show(),$(this).addClass("selected"),S.removeClass("selected"),A.show(),U.show(),P.hide(),N.hide(),I.show()),C()}));RED.popover.tooltip(O,RED._("sidebar.project.projectSettings.resetTheEncryptionKey"));var S=$('<button type="button" class="red-ui-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(L).on("click",(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),I.hide()):(M.val(""),G.val(""),i.settings.credentialSecretInvalid||!i.settings.credentialsEncrypted?(P.show(),N.hide(),z.hide()):(z.show(),P.hide(),N.show()),B.show(),S.addClass("selected"),O.removeClass("selected"),A.hide(),U.hide(),I.show()),C()}));RED.popover.tooltip(S,RED._("sidebar.project.projectSettings.changeTheEncryptionKey")),n=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').hide().appendTo(r);var I=$("<div>",{style:"margin-top:10px"}).hide().appendTo(j),P=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.setTheEncryptionKey")+"</div>").hide().appendTo(I),N=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.changeTheEncryptionKey")+"</div>").hide().appendTo(I),A=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.resetTheEncryptionKey")+"</div>").hide().appendTo(I),z=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(I);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.currentKey")).appendTo(z);var M=$('<input type="text">').appendTo(z).typedInput({type:"cred"}).on("change keyup paste",(function(){e&&(e.close(),e=null),C()})),B=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(I);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.newKey")).appendTo(B);var G=$('<input type="text">').appendTo(B).typedInput({type:"cred"}).on("change keyup paste",C),U=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i>'+RED._("sidebar.project.projectSettings.credentialsAlert")+"</div>").hide().appendTo(I),F=function(){s.show(),J.hide(),p.hide(),y.show(),E.hide(),D.hide(),j.removeClass("uneditable-input"),j.css("height",""),D.removeClass("selected"),g.find(".red-ui-projects-file-listing-container").remove(),g.css("height",""),g.css("color",""),$(".red-ui-settings-row-credentials").hide(),I.hide(),L.hide(),O.removeClass("selected"),S.removeClass("selected")},J=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(r);$('<button type="button" class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(J).on("click",(function(e){e.preventDefault();var t=i.files.package||"package.json",o=t.substring(0,t.length-12);b.text(o),_.text(o),l.text(i.files.package||"package.json"),i.files.package?u.hide():(u.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),u.show()),E.val(y.text()),k.text(R),F()}));var q=$('<button type="button" class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(J).on("click",(function(o){o.preventDefault();var n=t.addSpinnerOverlay(r),a=function(e){n.remove(),e?t.reportUnexpectedError(e):(y.text(E.val()),k.text(T.val()),u.hide(),F())},s=c.val();s=s.substring(0,s.length-12);var d={files:{package:c.val(),flow:s+E.val(),credentials:s+T.val()}};O.hasClass("selected")&&(d.resetCredentialSecret=!0),(O.hasClass("selected")||S.hasClass("selected"))&&(d.credentialSecret=G.val(),M.is(":visible")&&(d.currentCredentialSecret=M.val())),RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+i.name,type:"PUT",responses:{0:function(e){a(e)},200:function(e){i=e,RED.sidebar.versionControl.refresh(!0),V(),a()},400:{credentials_load_failed:function(e){a(e)},missing_current_credential_key:function(t){M.addClass("input-error"),e=RED.popover.create({target:M,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),a(t)},"*":function(e){a(e)}}}},d).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))})),V=function(){i.settings.credentialSecretInvalid?(j.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),j.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.invalidEncryptionKey"))):i.settings.credentialsEncrypted?(j.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),j.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionEnabled"))):(j.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),j.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionDisabled"))),O.toggleClass("disabled",!i.settings.credentialSecretInvalid&&!i.settings.credentialsEncrypted),O.prop("disabled",!i.settings.credentialSecretInvalid&&!i.settings.credentialsEncrypted)};C(),V()}(i,o),m(i,o),o}function w(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(E.hasOwnProperty(t)||(E[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),E[t].count++)}}var E={};return{init:function(i){t=i,a({id:"main",title:RED._("sidebar.project.name"),get:p,close:function(){}}),a({id:"deps",title:RED._("sidebar.project.dependencies"),get:g,close:function(){}}),a({id:"settings",title:RED._("sidebar.project.settings"),get:y,close:function(){e&&(e.close(),e=null)}}),RED.events.on("nodes:add",w),RED.events.on("nodes:remove",(function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&E.hasOwnProperty(t)&&(E[t].count--,0===E[t].count&&(E[t].known||delete E[t]))}}))},show:function(e){if(!o)if(RED.user.hasPermission("projects.write")){o=!0;var t={title:RED._("sidebar.project.projectSettings.title"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){i=e.width},open:function(t){var i=RED.projects.getActiveProject(),o=t.find(".red-ui-tray-body"),a=$("<div></div>").appendTo(o),r=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(a);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(r);var s=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout((function(){d.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()}),50)}}),d=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(a);n.forEach((function(e){s.addTab({id:"red-ui-project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(i).hide().appendTo(d)})),a.i18n(),s.activateTab("red-ui-project-settings-tab-"+(e||"main")),$("#red-ui-sidebar-shade").show()},close:function(){o=!1,n.forEach((function(e){e.close&&e.close()})),$("#red-ui-sidebar-shade").hide()},show:function(){}};null!==i&&(t.width=i),RED.tray.show(t)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){E={}}}}(),RED.projects.userSettings=function(){var e,t,i;function o(o){var n=$('<div id="red-ui-settings-tab-gitconfig" class="project-settings-tab-pane red-ui-help"></div>');return function(i){var o=RED.settings.get("git")||{};o.user=o.user||{},$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.committerDetail")).appendTo(i);var n=$('<div class="red-ui-settings-section"></div>').appendTo(i);$('<div class="red-ui-settings-section-description"></div>').appendTo(n).text(RED._("editor:sidebar.project.userSettings.committerTip"));var a=$('<div class="red-ui-settings-row"></div>').appendTo(n);$('<label for="user-settings-gitconfig-username"></label>').text(RED._("editor:sidebar.project.userSettings.userName")).appendTo(a),(e=$('<input type="text" id="user-settings-gitconfig-username">').appendTo(a)).val(o.user.name||""),a=$('<div class="red-ui-settings-row"></div>').appendTo(n),$('<label for="user-settings-gitconfig-email"></label>').text(RED._("editor:sidebar.project.userSettings.email")).appendTo(a),(t=$('<input type="text" id="user-settings-gitconfig-email">').appendTo(a)).val(o.user.email||"")}(n),function(e){var t=RED.settings.get("git")||{};t.workflow=t.workflow||{},t.workflow.mode=t.workflow.mode||"manual",$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.workflow")).appendTo(e);var i=$('<div class="red-ui-settings-section"></div>').appendTo(e);$('<div class="red-ui-settings-section-description"></div>').appendTo(i).text(RED._("editor:sidebar.project.userSettings.workfowTip"));var o=$('<div class="red-ui-settings-row"></div>').appendTo(i);$('<label><input type="radio" name="user-setting-gitworkflow" value="manual"> <div style="margin-left: 3px; display: inline-block"><div data-i18n="editor:sidebar.project.userSettings.workflowManual"></div><div style="color:#aaa;" data-i18n="editor:sidebar.project.userSettings.workflowManualTip"></div></div></label>').appendTo(o),o=$('<div class="red-ui-settings-row"></div>').appendTo(i),$('<label><input type="radio" name="user-setting-gitworkflow" value="auto"> <div style="margin-left: 3px; display: inline-block"><div data-i18n="editor:sidebar.project.userSettings.workflowAuto"></div><div style="color:#aaa;" data-i18n="editor:sidebar.project.userSettings.workflowAutoTip"></div></div></label>').appendTo(o),i.find('[name="user-setting-gitworkflow"][type="radio"][value="'+t.workflow.mode+'"]').prop("checked",!0)}(n),function(e){$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.sshKeys")).appendTo(e);var o,n=$('<div class="red-ui-settings-section"></div>').appendTo(e),a=$('<div class="red-ui-settings-section-description"></div>').appendTo(n).text(RED._("editor:sidebar.project.userSettings.sshKeysTip")),r=$('<button id="user-settings-gitconfig-add-key" class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("editor:sidebar.project.userSettings.add")+"</button>").appendTo(a).on("click",(function(e){r.attr("disabled",!0),m.attr("disabled",!0),l.slideDown(200),u.trigger("focus")})),s=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(u.val());u.toggleClass("input-error",p&&!e);var t=h.val(),i=0===t.length||t.length>=8;h.toggleClass("input-error",!i),i?0===t.length?g.text(RED._("editor:sidebar.project.userSettings.optional")):g.text(""):g.text(RED._("editor:sidebar.project.userSettings.passphraseShort")),e=e&&i,m.attr("disabled",!e),o&&(o.close(),o=null)},d=$('<div class="red-ui-settings-row"></div>').appendTo(n),l=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(d);$('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("editor:sidebar.project.userSettings.addSshKey")).appendTo(l);var c=$("<div>").appendTo(l);d=$('<div class="red-ui-settings-row"></div>').appendTo(c),$('<div class="red-ui-settings-section-description"></div>').appendTo(d).text(RED._("editor:sidebar.project.userSettings.addSshKeyTip")),d=$('<div class="red-ui-settings-row"></div>').appendTo(c),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.name")).appendTo(d);var p=!1,u=$('<input type="text">').appendTo(d).on("change keyup paste",(function(){p=!0,s()}));$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.nameRule")+"</small></label>").appendTo(d).find("small");var f=$("<div>").appendTo(c);d=$('<div class="red-ui-settings-row"></div>').appendTo(f),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.passphrase")).appendTo(d);var h=$('<input type="password">').appendTo(d).on("change keyup paste",s),g=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.optional")+"</small></label>").appendTo(d).find("small"),v=function(){r.attr("disabled",!1),l.hide(),u.val(""),p=!1,h.val(""),o&&(o.close(),o=null)},b=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.cancel")+"</button>").appendTo(b).on("click",(function(e){e.preventDefault(),v()}));var m=$('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.generate")+"</button>").appendTo(b).on("click",(function(e){e.preventDefault();var o=i.addSpinnerOverlay(l).addClass("red-ui-component-spinner-contain"),n={name:u.val(),type:"generate"};n.comment=t.val(),n.password=h.val(),n.size=4096;var a=function(e){o.remove(),e||v()};RED.deploy.setDeployInflight(!0),i.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){a(e)},200:function(e){D(n.name),a()},400:{unexpected_error:function(e){console.log(e),a(e)}}}},n)}));d=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(n);var y={empty:!0},w=function(e,t){var o=$('<div class="red-ui-projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),n=$("<pre>",{style:"min-height: 80px"}).appendTo(o),a=i.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),r={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){n.text(e.publickey),a.remove()},400:{unexpected_error:function(e){console.log(e),a.remove()}}}};i.sendRequest(r);var s=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(o);return $('<button class="red-ui-button red-ui-button-small">'+RED._("editor:sidebar.project.userSettings.copyPublicKey")+"</button>").appendTo(s).on("click",(function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(n[0]),document.execCommand("copy"),document.getSelection().empty()}catch(e){}})),o},E=$('<ol class="red-ui-projects-dialog-ssh-key-list">').appendTo(d).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){var n=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(e);if(o.empty)return n.addClass("red-ui-search-empty"),void n.text(RED._("editor:sidebar.project.userSettings.noSshKeys"));var a=$('<div class="red-ui-projects-dialog-ssh-key-header">').appendTo(n);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(a),$('<span class="entry-name">').text(o.name).appendTo(a);var r,s=$('<span class="button-row entry-tools">').appendTo(a);a.on("click",(function(e){r?r.slideUp(200,(function(){r.remove(),r=null})):r=w(n,o)})),o.system||$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(s).on("click",(function(t){t.stopPropagation();var n=i.addSpinnerOverlay(e).addClass("red-ui-component-spinner-contain"),a=RED.notify(RED._("editor:sidebar.project.userSettings.deleteConfirm",{name:o.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.remove(),a.close()}},{text:RED._("editor:sidebar.project.userSettings.delete"),click:function(){a.close();var t={url:"settings/user/keys/"+o.name,type:"DELETE",responses:{200:function(t){e.fadeOut(200,(function(){E.editableList("removeItem",o),setTimeout(n.remove,100),0===E.editableList("length")&&E.editableList("addItem",y)}))},400:{unexpected_error:function(e){console.log(e),n.remove()}}}};i.sendRequest(t)}}]})})),o.expand&&(r=w(n,o))}}),D=function(e){$.getJSON("settings/user/keys",(function(t){t.keys&&(t.keys.sort((function(e,t){return e.name.localeCompare(t.name)})),E.editableList("empty"),t.keys.forEach((function(t){t.name===e&&(t.expand=!0),E.editableList("addItem",t)})),0===E.editableList("length")&&E.editableList("addItem",y))}))};D()}(n),n}return{init:function(n){i=n,RED.userSettings.add({id:"gitconfig",title:RED._("editor:sidebar.project.userSettings.gitConfig"),get:o,close:function(){var i=RED.settings.get("git")||{};i.user=i.user||{},i.user.name=e.val(),i.user.email=t.val(),i.workflow=i.workflow||{},i.workflow.mode=$('[name="user-setting-gitworkflow"][type="radio"]:checked').val(),RED.settings.set("git",i)}})}}}(),RED.sidebar.versionControl=function(){var e,t,i,o,n,a,r,s,d,l,c,p,u,f,h,g,v,b={};function m(e,t,i,o){e.addClass("red-ui-sidebar-vc-change-entry");var n=$("<div>").appendTo(e);if(t.label){if(e.addClass("red-ui-help-info-none"),n.text(t.label),t.button){n.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var a=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(n);$('<button class="red-ui-button red-ui-button-small"></button>').text(t.button.label).appendTo(a).on("click",t.button.click)}}else{var r,s,d=$('<i class=""></i>').appendTo(n),l=$('<a href="#">').appendTo(n).on("click",(function(e){e.preventDefault(),function(e,t){var i=RED.projects.getActiveProject(),o="staged"===t?"index":"tree";h.sendRequest({url:"projects/"+i.name+"/diff/"+o+"/"+encodeURIComponent(e.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(o){var n;n="unstaged"===t?RED._("sidebar.project.versionControl.unstagedChanges")+" : "+e.file:"staged"===t?RED._("sidebar.project.versionControl.stagedChanges")+" : "+e.file:RED._("sidebar.project.versionControl.resolveConflicts")+" : "+e.file;var a={diff:o.diff,title:n,unmerged:"unmerged"===t,project:i};"unstaged"==t?(a.oldRevTitle=" "===e.indexStatus?RED._("sidebar.project.versionControl.head"):RED._("sidebar.project.versionControl.staged"),a.newRevTitle=RED._("sidebar.project.versionControl.unstaged"),a.oldRev=" "===e.indexStatus?"@":":0",a.newRev="_"):"staged"===t?(a.oldRevTitle=RED._("sidebar.project.versionControl.head"),a.newRevTitle=RED._("sidebar.project.versionControl.staged"),a.oldRev="@",a.newRev=":0"):(a.oldRevTitle=RED._("sidebar.project.versionControl.local"),a.newRevTitle=RED._("sidebar.project.versionControl.remote"),a.commonRev=":1",a.oldRev=":2",a.newRev=":3",a.onresolve=function(t){h.sendRequest({url:"projects/"+i.name+"/resolve/"+encodeURIComponent(e.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:t.resolutions[e.file]})}),RED.diff.showUnifiedDiff(a)},400:{unexpected_error:function(e){console.log(e)}}}})}(t,o)})),c=$("<span>").appendTo(l),p=$('<div class="red-ui-sidebar-vc-change-entry-tools">').appendTo(e);if("unstaged"===o&&(r=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(p),s=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(r).on("click",(function(e){e.preventDefault();var i=h.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),o=RED.notify(RED._("sidebar.project.versionControl.revert",{file:t.file}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.remove(),o.close()}},{text:RED._("sidebar.project.versionControl.revertChanges"),click:function(){o.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+t.file,type:"DELETE",responses:{200:function(e){i.remove()},400:{unexpected_error:function(e){i.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),h.sendRequest(e).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}]})})),RED.popover.tooltip(s,RED._("sidebar.project.versionControl.revertChanges"))),r=$('<span class="button-group"></span>').appendTo(p),"unmerged"!==o){var u=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-'+("unstaged"===o?"plus":"minus")+'"></i></button>').appendTo(r).on("click",(function(i){i.preventDefault();var n=RED.projects.getActiveProject();t.spinner=h.addSpinnerOverlay(e).addClass("projects-version-control-spinner-sidebar"),h.sendRequest({url:"projects/"+n.name+"/stage/"+encodeURIComponent(t.file),type:"unstaged"===o?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})}));RED.popover.tooltip(u,RED._("sidebar.project.versionControl."+("unstaged"===o?"stage":"unstage")+"Change"))}t["update"+("unstaged"===o?"Unstaged":"Staged")]=function(e,t){n.removeClass();var i="";"A"===t?(n.addClass("red-ui-diff-state-added"),i="fa-plus-square"):"?"===t?(n.addClass("red-ui-diff-state-unchanged"),i="fa-question-circle-o"):"D"===t?(n.addClass("red-ui-diff-state-deleted"),i="fa-minus-square"):"M"===t?(n.addClass("red-ui-diff-state-changed"),i="fa-square"):"R"===t?(n.addClass("red-ui-diff-state-changed"),i="fa-toggle-right"):"U"===t?(n.addClass("red-ui-diff-state-conflicted"),i="fa-exclamation-triangle"):i="fa-exclamation-triangle",c.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(c),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(c),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(c)),d.removeClass(),d.addClass("fa "+i),e.spinner&&(e.spinner.remove(),delete e.spinner),s&&s.toggle("?"!==t),l.toggleClass("disabled","D"===t||"?"===t)},t["update"+("unstaged"===o?"Unstaged":"Staged")](t,i)}}function y(e){var t=Date.now()/1e3-e,i=Math.floor(t/86400);if(i>30)return new Date(1e3*e).toLocaleDateString();if(i>0)return RED._("sidebar.project.versionControl.daysAgo",{count:i});var o=Math.floor(t/3600);if(o>0)return RED._("sidebar.project.versionControl.hoursAgo",{count:o});var n=Math.floor(t/60);return n>0?RED._("sidebar.project.versionControl.minsAgo",{count:n}):RED._("sidebar.project.versionControl.secondsAgo")}function w(e,t){var o=RED.projects.getActiveProject();(r=t?h.addSpinnerOverlay(i.parent()):h.addSpinnerOverlay(n.parent())).addClass("red-ui-component-spinner-sidebar");var a=t?{files:e}:void 0;h.sendRequest({url:"projects/"+o.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},a)}var E=!1;function D(e,t,i,o,n){var a=h.addSpinnerOverlay(i),r=e+"?limit="+(o||20);n&&(r+="&before="+n),h.sendRequest({url:r,type:"GET",responses:{0:function(e){console.log(e)},200:function(i){var n;i.commits.forEach((function(e){t.editableList("addItem",e),n=e.sha})),t.loadMoreItem&&(t.editableList("removeItem",t.loadMoreItem),delete t.loadMoreItem);var r=t.editableList("length");r<i.total&&(t.loadMoreItem={totalKnown:r,total:i.total,url:e,before:n+"~1",limit:o},t.editableList("addItem",t.loadMoreItem)),a.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function R(t){var c=t.files;r&&(r.remove(),r=null),(f=!!t.merging)?(e.addClass("red-ui-sidebar-vc-merging"),s.show()):(e.removeClass("red-ui-sidebar-vc-merging"),s.hide()),i.editableList("removeItem",g),n.editableList("removeItem",g),d.editableList("removeItem",v);var p=Object.keys(c).filter((function(e){return"f"===c[e].type}));p.sort();var u=Date.now()+Math.floor(100*Math.random());p.forEach((function(e){var t=c[e],o=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),b[e]?(b[e].unmerged&&!t.unmerged?(d.editableList("removeItem",b[e]),o=!0):!b[e].unmerged&&t.unmerged&&(i.editableList("removeItem",b[e]),n.editableList("removeItem",b[e])),b[e].status!==t.status&&(" "!==b[e].treeStatus?" "===t.treeStatus?i.editableList("removeItem",b[e]):t.treeStatus!==b[e].treeStatus&&b[e].updateUnstaged(t,t.treeStatus):o=!0," "!==b[e].indexStatus&&"?"!==b[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?n.editableList("removeItem",b[e]):t.indexStatus!==b[e].indexStatus&&b[e].updateStaged(t,t.indexStatus):o=!0),b[e].status=t.status,b[e].indexStatus=t.indexStatus,b[e].treeStatus=t.treeStatus,b[e].oldName=t.oldName,b[e].unmerged=t.unmerged):(o=!0,b[e]=t),b[e].updateIndex=u,o&&(t.unmerged?d.editableList("addItem",b[e]):(" "!==t.treeStatus&&i.editableList("addItem",b[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&n.editableList("addItem",b[e]))))})),Object.keys(b).forEach((function(e){b[e].updateIndex!==u&&(i.editableList("removeItem",b[e]),n.editableList("removeItem",b[e]),delete b[e])}));var h=n.editableList("length"),m=i.editableList("length"),y=d.editableList("length");l.prop("disabled",f&&y>0||!f&&0===h),o.prop("disabled",0===m),a.prop("disabled",0===h),0===h&&n.editableList("addItem",g),0===m&&i.editableList("addItem",g),0===y&&d.editableList("addItem",v)}function x(e,t){if(!E&&(e&&(b={},i.editableList("empty"),n.editableList("empty"),d.editableList("empty")),RED.user.hasPermission("projects.write"))){E=!0,function(){p.editableList("empty");var e=RED.projects.getActiveProject();e&&D("projects/"+e.name+"/commits",p,p.parent())}();var o=RED.projects.getActiveProject();if(o){var a="projects/"+o.name+"/status";t&&(a+="?remote=true"),$.getJSON(a,(function(e){R(e),$("#red-ui-sidebar-vc-local-branch").text(e.branches.local),$("#red-ui-sidebar-vc-remote-branch").text(e.branches.remote||RED._("sidebar.project.versionControl.none"));var t=e.commits.ahead||0,i=e.commits.behind||0;o.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#red-ui-sidebar-vc-repo-status-auth-issue").show(),$("#red-ui-sidebar-vc-repo-status-stats").hide(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-toolbar-message").hide(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").show()):($("#red-ui-sidebar-vc-repo-toolbar-message").show(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").hide(),$("#red-ui-sidebar-vc-repo-status-auth-issue").hide(),$("#red-ui-sidebar-vc-repo-status-stats").show(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-status-button").show(),e.branches.hasOwnProperty("remote")?_(t,i):($("#red-ui-sidebar-vc-commits-ahead").text(""),$("#red-ui-sidebar-vc-commits-behind").text(""),$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.notTracking")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))):$("#red-ui-sidebar-vc-repo-status-button").hide(),E=!1,$(".red-ui-sidebar-vc-shade").hide()})).fail((function(){E=!1}))}else $(".red-ui-sidebar-vc-shade").show(),i.editableList("empty"),n.editableList("empty"),d.editableList("empty")}}function _(e,t){$("#red-ui-sidebar-vc-commits-ahead").text(e),$("#red-ui-sidebar-vc-commits-behind").text(t),f?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.statusUnmergedChanged")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):e>0&&0===t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAhead",{count:e})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1)):0===e&&t>0?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsBehind",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):e>0&&t>0?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAheadAndBehind1",{count:t})+RED._("sidebar.project.versionControl.commitsAheadAndBehind2",{count:e})+RED._("sidebar.project.versionControl.commitsAheadAndBehind3",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0===e&&0===t&&($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.repositoryUpToDate")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))}function k(){x(),RED.sidebar.show("version-control")}return{init:function(r){h=r,RED.actions.add("core:show-version-control-tab",k),RED.events.on("deploy",(function(){var e=RED.projects.getActiveProject();e&&("auto"===(((RED.settings.get("git")||{}).workflow||{}).mode||"manual")?x(!0):(b={},i.editableList("empty"),n.editableList("empty"),d.editableList("empty"),$.getJSON("projects/"+e.name+"/status",(function(e){R(e)}))))})),RED.events.on("login",(function(){x(!0)})),e=$("<div>",{class:"red-ui-sidebar-vc"});var f=$("<div>",{class:"red-ui-sidebar-vc-stack"}).appendTo(e);t=RED.stack.create({container:f,fill:!0,singleExpanded:!0}),(c=t.add({title:RED._("sidebar.project.versionControl.localChanges"),collapsible:!0})).expand(),c.content.css({height:"100%"});var E=$('<div style="float: right"></div>').appendTo(c.header),T=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),x(!0)}));RED.popover.tooltip(T,RED._("sidebar.project.versionControl.refreshChanges")),g={label:RED._("sidebar.project.versionControl.none")},v={label:RED._("sidebar.project.versionControl.conflictResolve")};var C=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(c.content),j=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.localFiles")+"</div>").appendTo(C);o=$('<button class="red-ui-button red-ui-button-small" style="position: absolute; right: 5px; top: 5px;"><i class="fa fa-plus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(j).on("click",(function(e){e.preventDefault(),e.stopPropagation(),w(Object.keys(b).filter((function(e){return" "!==b[e].treeStatus})),!0)})),RED.popover.tooltip(o,RED._("sidebar.project.versionControl.stageAllChange")),(i=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(C)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){m(e,i,i.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),s=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(c.content),j=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.unmergedChanges")+"</div>").appendTo(s),E=$('<div style="position: absolute; right: 5px; top: 5px;"></div>').appendTo(j);var L=$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.abortMerge")+"</button>").appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation();var t=h.addSpinnerOverlay(s),i=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+i.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),x(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}));(d=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(s)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){i===v&&(i.button={label:RED._("sidebar.project.versionControl.commit"),click:function(e){e.preventDefault(),e.stopPropagation(),S()}}),m(e,i,i.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var O=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(c.content);j=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.changeToCommit")+"</div>").appendTo(O),E=$('<div style="position: absolute; right: 5px; top: 5px;"></div>').appendTo(j);var S=function(){I.val(""),A.prop("disabled",!0),C.css("height","30px"),s.is(":visible")?(s.css("height","30px"),O.css("height","calc(100% - 60px - 175px)")):O.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout((function(){commitBox.css("height","175px")}),10),o.prop("disabled",!0),a.prop("disabled",!0),l.prop("disabled",!0),L.prop("disabled",!0),I.trigger("focus")};l=$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.commit")+"</button>").appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),S()})),RED.popover.tooltip(l,RED._("sidebar.project.versionControl.commitChanges")),a=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-minus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),w(Object.keys(b).filter((function(e){return" "!==b[e].indexStatus&&"?"!==b[e].indexStatus})),!1)})),RED.popover.tooltip(a,RED._("sidebar.project.versionControl.unstageAllChange")),(n=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(O)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){m(e,i,i.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-bottom"></div>').hide().appendTo(c.content);var I=$("<textarea></textarea>").attr("placeholder",RED._("sidebar.project.versionControl.commitPlaceholder")).appendTo(commitBox).on("change keyup paste",(function(){A.prop("disabled",""===$(this).val().trim())})),P=$('<div class="red-ui-sidebar-vc-slide-box-toolbar button-group">').appendTo(commitBox),N=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.cancelCapital")+"</button>").appendTo(P).on("click",(function(e){e.preventDefault(),I.val(""),C.css("height",""),s.css("height",""),O.css("height",""),commitBox.css("height",0),setTimeout((function(){commitBox.hide()}),200),o.prop("disabled",!1),a.prop("disabled",!1),l.prop("disabled",!1),L.prop("disabled",!1)})),A=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.commitCapital")+"</button>").appendTo(P).on("click",(function(e){e.preventDefault();var t=h.addSpinnerOverlay(A).addClass("red-ui-component-spinner-sidebar"),i=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+i.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),N.trigger("click"),x(!0)},400:{"*":function(e){h.reportUnexpectedError(e)}}}},{message:I.val()}).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))})),z=t.add({title:RED._("sidebar.project.versionControl.commitHistory"),collapsible:!0});E=$('<div style="float: right"></div>').appendTo(z.header),T=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(E).on("click",(function(e){e.preventDefault(),e.stopPropagation(),x(!0,!0)})),RED.popover.tooltip(T,RED._("sidebar.project.versionControl.refreshCommitHistory"));var M=$('<div class="red-ui-sidebar-vc-change-header" style="text-align: right;"></div>').appendTo(z.content),B=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.branch")+' <span id="red-ui-sidebar-vc-local-branch"></span></button>').appendTo(M).on("click",(function(e){if(e.preventDefault(),$(this).hasClass("selected"))U();else{V(),u.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();J.refresh("projects/"+t.name+"/branches"),F.show(),setTimeout((function(){F.css("height","215px"),J.focus()}),100)}}));RED.popover.tooltip(B,RED._("sidebar.project.versionControl.changeLocalBranch"));var G=$('<button class="red-ui-button red-ui-button-small" style="margin-left: 10px;" id="red-ui-sidebar-vc-repo-status-button"><span id="red-ui-sidebar-vc-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="red-ui-sidebar-vc-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="red-ui-sidebar-vc-commits-behind"></span></span><span id="red-ui-sidebar-vc-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(M).on("click",(function(e){if(e.preventDefault(),$(this).hasClass("selected"))V();else{U(),u.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),q.show(),setTimeout((function(){q.css("height","265px")}),100)}}));RED.popover.tooltip(G,RED._("sidebar.project.versionControl.manageRemoteBranch")),p=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(z.content),u=$('<div class="red-ui-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(z.content),p.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){if(e.addClass("red-ui-sidebar-vc-commit-entry"),i.url)e.addClass("red-ui-sidebar-vc-commit-more"),e.text("+ "+(i.total-i.totalKnown)+RED._("sidebar.project.versionControl.moreCommits")),e.on("click",(function(t){t.preventDefault(),D(i.url,p,e,i.limit,i.before)}));else{e.on("click",(function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+i.sha,(function(e){e.project=t,e.parents=i.parents,e.oldRev=i.sha+"~1",e.newRev=i.sha,e.oldRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+i.sha.substring(0,7)+"~1",e.newRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+i.sha.substring(0,7),e.date=y(parseInt(i.date)),RED.diff.showCommitDiff(e)}))}));var o=$("<div>").appendTo(e);if($('<div class="red-ui-sidebar-vc-commit-subject">').text(i.subject).appendTo(o),i.refs){var n=$('<div class="red-ui-sidebar-vc-commit-refs">').appendTo(o);i.refs.forEach((function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="red-ui-sidebar-vc-commit-ref">').text(t).appendTo(n)})),e.addClass("red-ui-sidebar-vc-commit-head")}$('<div class="red-ui-sidebar-vc-commit-sha">').text(i.sha.substring(0,7)).appendTo(o),$('<div class="red-ui-sidebar-vc-commit-date">').text(y(parseInt(i.date))).appendTo(o)}}});var U=function(e){B.removeClass("selected"),F.css("height","0"),u.hide(),setTimeout((function(){F.hide(),e&&e()}),200)},F=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px;"></div>').hide().appendTo(z.content);$('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.changeLocalBranch")).appendTo(F);var J=h.createBranchList({placeholder:RED._("sidebar.project.versionControl.createBranchPlaceholder"),container:F,onselect:function(e){if(e.current)return U();var t=h.addSpinnerOverlay(F),i=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+i.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){U((function(){t.remove()}))},400:{git_local_overwrite:function(e){t.remove(),RED.notify(RED._("sidebar.project.versionControl.localOverwrite"),{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always((function(){setTimeout((function(){RED.deploy.setDeployInflight(!1)}),500)}))}}),q=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px"></div>').hide().appendTo(z.content),V=function(){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),G.removeClass("selected"),q.css("height","0"),u.hide(),setTimeout((function(){q.hide(),W()}),200)},W=function(e){H.hasClass("selected")&&(H.removeClass("selected"),X.height(0),q.css("height","265px"),setTimeout((function(){X.hide(),e&&e()}),200))};$('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.manageRemoteBranch")).appendTo(q);var K=$('<div style="margin-bottom: 5px;"></div>').appendTo(q),H=$('<button id="red-ui-sidebar-vc-repo-branch" class="red-ui-sidebar-vc-repo-action red-ui-button"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.remote")+': <span id="red-ui-sidebar-vc-remote-branch"></span></button>').appendTo(K).on("click",(function(e){if(e.preventDefault(),$(this).hasClass("selected"))W();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();Z.refresh("projects/"+t.name+"/branches/remote"),X.show(),setTimeout((function(){X.height(180),q.css("height","445px"),Z.focus()}),100)}}));$('<div id="red-ui-sidebar-vc-repo-toolbar-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').appendTo(q);var Y=$('<div id="red-ui-sidebar-vc-repo-toolbar-error-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(q);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> '+RED._("sidebar.project.versionControl.unableToAccess")+"</div>").appendTo(Y);var Q=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(Y);$('<button class="red-ui-button" style="width: 80%;"><i class="fa fa-refresh"></i> '+RED._("sidebar.project.versionControl.retry")+"</button>").appendTo(Q).on("click",(function(e){e.preventDefault();var t=RED.projects.getActiveProject(),i=h.addSpinnerOverlay(q).addClass("red-ui-component-spinner-contain");h.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always((function(){i.remove()}))})),$('<div class="red-ui-sidebar-vc-slide-box-header" style="height: 20px;"><label id="red-ui-sidebar-vc-repo-toolbar-set-upstream-row" for="red-ui-sidebar-vc-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="red-ui-sidebar-vc-repo-toolbar-set-upstream"> '+RED._("sidebar.project.versionControl.setUpstreamBranch")+"</label></div>").appendTo(q);var X=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(K),Z=h.createBranchList({placeholder:RED._("sidebar.project.versionControl.createRemoteBranchPlaceholder"),currentLabel:RED._("sidebar.project.versionControl.upstream"),remotes:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)},container:X,onselect:function(e){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!1),$("#red-ui-sidebar-vc-remote-branch").text(e.name+(e.create?" *":""));var t=RED.projects.getActiveProject();t.git.branches.remote===e.name?delete t.git.branches.remoteAlt:t.git.branches.remoteAlt=e.name,$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),W((function(){if(e.create)t.git.branches.remote?$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.selectUpstreamBranch")):($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.trackedUpstreamBranch")),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!0),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!0)),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1);else{var i=Date.now(),o=h.addSpinnerOverlay($("#red-ui-sidebar-vc-repo-toolbar-message")).addClass("red-ui-component-spinner-contain");$.getJSON("projects/"+t.name+"/branches/remote/"+e.name+"/status",(function(e){setTimeout((function(){_(e.commits.ahead,e.commits.behind),o.remove()}),Math.max(400-(Date.now()-i),0))}))}}))}}),ee=$('<div style="margin-bottom: 5px;"></div>').appendTo(q);$('<button id="red-ui-sidebar-vc-repo-push" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-up"></i> <span data-i18n="sidebar.project.versionControl.push"></span></button>').appendTo(ee).on("click",(function(e){e.preventDefault();var t=h.addSpinnerOverlay(q).addClass("red-ui-component-spinner-contain"),i=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(t);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(i).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}));var o=RED.projects.getActiveProject();RED.eventLog.startEvent("Push changes"+(o.git.branches.remoteAlt?" : "+o.git.branches.remoteAlt:""));var n="projects/"+o.name+"/push";o.git.branches.remoteAlt&&(n+="/"+o.git.branches.remoteAlt);var a=$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked");a&&(n+="?u=true"),h.sendRequest({url:n,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){a&&o.git.branches.remoteAlt&&(o.git.branches.remote=o.git.branches.remoteAlt,delete o.git.branches.remoteAlt),x(!0),V()},400:{git_push_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.pushFailed"),"error")},unexpected_error:function(e){console.log(e)}}}},{}).always((function(){t.remove()}))}));var te=function(e){e=e||{};var t=h.addSpinnerOverlay(q).addClass("red-ui-component-spinner-contain"),i=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(t);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(i).on("click",(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}));var o=RED.projects.getActiveProject();RED.eventLog.startEvent("Pull changes"+(o.git.branches.remoteAlt?" : "+o.git.branches.remoteAlt:""));var n="projects/"+o.name+"/pull";o.git.branches.remoteAlt&&(n+="/"+o.git.branches.remoteAlt),(e.setUpstream||e.allowUnrelatedHistories)&&(n+="?"),e.setUpstream&&(n+="setUpstream=true",e.allowUnrelatedHistories&&(n+="&")),e.allowUnrelatedHistories&&(n+="allowUnrelatedHistories=true"),h.sendRequest({url:n,type:"POST",responses:{0:function(e){console.log(e)},200:function(t){e.setUpstream&&o.git.branches.remoteAlt&&(o.git.branches.remote=o.git.branches.remoteAlt,delete o.git.branches.remoteAlt),x(!0),V()},400:{git_local_overwrite:function(e){RED.notify(RED._("sidebar.project.versionControl.unablePull")+'<p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">'+RED._("sidebar.project.versionControl.showUnstagedChanges")+"</a></p>","error",!1,1e7)},git_pull_merge_conflict:function(e){x(!0),V()},git_connection_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.connectionFailed")+e.toString(),"warning")},git_pull_unrelated_history:function(t){var i=RED.notify(RED._("sidebar.project.versionControl.pullUnrelatedHistory"),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close()}},{text:RED._("sidebar.project.versionControl.pullChanges"),click:function(){i.close(),e.allowUnrelatedHistories=!0,te(e)}}]})},"*":function(e){h.reportUnexpectedError(e)}}}},{}).always((function(){t.remove()}))};$('<button id="red-ui-sidebar-vc-repo-pull" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-down"></i> <span data-i18n="sidebar.project.versionControl.pull"></span></button>').appendTo(ee).on("click",(function(e){e.preventDefault(),te({setUpstream:$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked")})})),$('<div class="red-ui-shade red-ui-sidebar-vc-shade">').appendTo(e),RED.sidebar.addTab({id:"version-control",label:RED._("sidebar.project.versionControl.history"),name:RED._("sidebar.project.versionControl.projectHistory"),content:e,enableOnEdit:!1,pinned:!0,iconClass:"fa fa-code-fork",action:"core:show-version-control-tab",onchange:function(){setTimeout((function(){t.resize()}),10)}})},show:k,refresh:x,showLocalChanges:function(){RED.sidebar.show("version-control"),c.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var e=null,t=!1,i=!1,o=null;return{show:function(n,a,r){t=!0;try{for(var s=(e=d3.select("body").append("div").classed("red-ui-editor-radial-menu",!0).on("touchstart",(function(){v(),d3.event.preventDefault()}))).append("div").style({top:a[1]-80+"px",left:a[0]-80+"px"}),d=[],l=function(e,t,i){i.el=s.append("div").classed("red-ui-editor-radial-menu-opt",!0).style({top:t+80-25+"px",left:e+80-25+"px"}).classed("red-ui-editor-radial-menu-opt-disabled",!!i.disabled),i.el.html(i.name),i.x=e,i.y=t,d.push(i),i.el.on("touchstart",(function(){i.el.classed("red-ui-editor-radial-menu-opt-active",!0),d3.event.preventDefault(),d3.event.stopPropagation()})),i.el.on("touchend",(function(){v(),i.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()}))},c=r.length,p=Math.max(Math.PI/(c-1),Math.PI/4),u=Math.PI,f=0;f<c;f++){var h=Math.floor(80*Math.cos(u)),g=Math.floor(80*Math.sin(u));r[f].name&&l(h,g,r[f]),u+=p}var v=function(){t=!1,o=null,e.remove(),e=null};n.on("touchend.radial",(function(){if(n.on("touchend.radial",null),n.on("touchmenu.radial",null),o){try{o.onselect()}catch(e){RED._debug(e)}v()}else i&&v()})),n.on("touchmove.radial",(function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-a[0],e.pageY-a[1]],n=0;n<d.length;n++){var r=d[n];r.disabled||(t[0]>r.x-30&&t[0]<r.x+30&&t[1]>r.y-30&&t[1]<r.y+30?r!==o&&(r.el.classed("selected",!0),o=r):(r===o&&(o=null),r.el.classed("selected",!1)))}if(!o){var s=Math.abs(t[0]*t[0]+t[1]*t[1]);i=s>6400}}catch(e){RED._debug(e)}}))}catch(e){RED._debug(e)}},active:function(){return t}}}();
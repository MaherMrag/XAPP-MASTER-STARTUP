<script type="text/html" data-template-name="ui.template">
    <style>
        span.nr-db-color-pick-container {
            max-width: 50px;
            border-radius: 3px;
            margin-left: 15px;
        }

        input.nr-db-field-themeColor::-webkit-color-swatch {
            border: none;
        }


            .nr-db-text-align {
                position:relative;
                display: inline-block;
                width: 24px;
                height: 24px;
                
                border:1px solid #bbb;
                cursor:pointer;
                color: #666;
                
                
            }
            .nr-db-text-align.selected, .nr-db-text-align:hover {
                border-color: #333;
                color: #333;
            }

        
            .nr-db-text-align-checkbox {
                display: none;
                width: 10px;
                height: 10px;
                border-radius: 10px;
                border: 1px solid #bbb;
                position: absolute;
                right: -5px;
                top: -5px;
                background: #fff;
            }
            .nr-db-text-align.selected .nr-db-text-align-checkbox {
                display:inline-block;
                box-shadow: inset 0px 0px 0px 2px #fff;
                background: #333;
                border-color: #333;
            }

    </style>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>

    <!-- Element: Tag -->
    <div class="form-row">
        <label for="node-input-tag"><i class="fa fa-tag"></i> Tag </label>
        <div class="menu-container" style="display: inline-block;">
            <div id='tag_btncontainer' class="red-ui-typedInput-container"
                style="width: 268px; margin-right: 0px; margin-left: 0px;">
                <button id='tag_menuBtn' class="red-ui-typedInput-type-select red-ui-typedInput-full-width" tabindex="0">
                    <i class="red-ui-typedInput-icon fa fa-caret-down"></i>
                    <span class="red-ui-typedInput-type-label"></span>
                </button>
            </div>
            <div id="tag-menu-content" class="ztree-menucontent" style="display:none;width: 268px;">
                <ul id="tag-menu-item" class="ztree"></ul>
            </div>
            <input type="hidden" id="node-input-tag" style="width: 268px;" autocomplete="off" dir=""
                class="red-ui-typedInput" value="">
        </div>
    </div>

    <hr> 


    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> <span data-i18n="template.label.template"></span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            <span data-i18n="template.label.format"></span>:
            <select id="node-input-format" style=" font-size: 10px !important;  height: 20px; padding:0;">
                <option value="handlebars">mustache</option>
                <option value="html">HTML</option>
                <option value="json">JSON</option>
                <option value="javascript">Javascript</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
                <option value="python">Python</option>
                <option value="sql">SQL</option>
                <option value="yaml">YAML</option>
                <option value="text" data-i18n="template.label.none"></option>
            </select>
            <button id="node-template-expand-editor" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button>
        </div>
    </div>



    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>




</script>

<script type="text/javascript">
    // convert to i18 text
    function c_(x) {
        return RED._("node-red-dashboard/ui_base:ui_base." + x);
    }

    function colourPickerChangeHandler(id, value) {
        $("#" + id).css("background-color", value);
        $("#" + id + "-reset").css({ opacity: 1 });
        /*                     globalDashboardNode.theme.themeState[id].edited = true;
                            globalDashboardNode.theme.themeState[id].value = value;
                            if (editor) {
                                editor.setValue(JSON.stringify({theme:globalDashboardNode.theme.themeState, site:globalDashboardNode.site}),1);
                            }
                            RED.nodes.dirty(true); */
    }

    RED.nodes.registerType('ui.template', {
        color: "rgb(243, 181, 103)",
        category: 'function',
        autoedit: true,
        defaults: {
            name: { value: "_Template" },
            parentid: { },
            datapoints: { value: {} },
            tag: { value: '' },
            width: { value: 5 },
            height: { value: 5 },
            z: {},
            x: { value: 0},
            y: { value: 0 },
            class: { value: "icon-file" },
            field: { value: "payload", validate: RED.validators.typedInput("fieldType") },
            fieldType: { value: "msg" },
            formatt: { value: "handlebars" },
            syntax: { value: "mustache" },
            template: { value: "This is the payload: {{payload}} !" },
            output: { value: "str" },
        },
        inputs: 1,
        outputs: 1,
        icon: "template.svg",
        label: function () {
            return this.name || this._("template.template");;
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var that = this;

            if (!this.fieldType) {
                this.fieldType = 'msg';
            }
            if (!this.field) {
                this.field = 'payload';
                $("#node-input-field").val("payload");
            }
            if (!this.syntax) {
                this.syntax = 'mustache';
                $("#node-input-syntax").val(this.syntax);
            }

            $("#node-input-field").typedInput({
                default: 'msg',
                types: ['msg', 'flow', 'global'],
                typeField: $("#node-input-fieldType")
            });

            this.editor = RED.editor.createEditor({
                id: 'node-input-template-editor',
                mode: 'ace/mode/html',
                value: $("#node-input-template").val()
            });
            RED.library.create({
                url: "templates", // where to get the data from
                type: "template", // the type of object the library is for
                editor: that.editor, // the field name the main text body goes to
                fields: ['name', 'format', 'output', 'syntax'],
                ext: "txt"
            });
            this.editor.focus();

            $("#node-input-format").on("change", function () {
                var mod = "ace/mode/" + $("#node-input-format").val();
                /*                 that.editor.getSession().setMode({
                                    path: mod,
                                    v: Date.now()
                                }); */
            });
            RED.popover.tooltip($("#node-template-expand-editor"), RED._("node-red:common.label.expand"));
            $("#node-template-expand-editor").on("click", function (e) {
                e.preventDefault();
                var value = that.editor.getValue();
                RED.editor.editText({
                    mode: $("#node-input-format").val(),
                    value: value,
                    width: "Infinity",
                    cursor: that.editor.getCursorPosition(),
                    complete: function (v, cursor) {
                        that.editor.setValue(v, -1);
                        that.editor.gotoLine(cursor.row + 1, cursor.column, false);
                        setTimeout(function () {
                            that.editor.focus();
                        }, 300);
                    }
                })
            })

            //Tag
            var tag_settings = {
                view: {
                    dblClickExpand: false
                },
                data: {
                    simpleData: {
                        enable: true
                    }
                },
                callback: {
                    beforeClick: (treeId, treeNode) => {
                        var check = (treeNode && !treeNode.isParent);
                        if (!check) alert("Please select a...");
                        return check;
                    },
                    onClick: (e, treeId, treeNode) => {
                        var zTree = XAPP.trees.tree.getZTreeObj('tag-menu-item');
                        var node = zTree.getSelectedNodes()[0];
                        $("#node-input-tag").val(node.id);
                        $('#tag_menuBtn span').html(node.name);
                    }
                }
            };

            function tag_bodydown(event) {
                if (!(event.target.id == "tag_menuBtn" || event.target.id == "tag-menu-content" || $(event.target).parents("#tag-menu-content").length > 0)) {
                    tag_hideMenu();
                }
            }

            function tag_hideMenu() {
                $("#tag-menu-content").fadeOut("fast");
                $("body").unbind("mousedown", tag_bodydown);
            }

            function tag_showMenu() {
                $("#tag-menu-content").css({ 'display': 'Block' }).slideDown("fast");
                XAPP.trees.init($(`#tag-menu-item`), tag_settings, XAPP.treelist.tree().getNodesByParam('name', 'Configuration'));
                var Treemenu = XAPP.trees.tree.getZTreeObj('tag-menu-item');
                var nn = Treemenu.getNodesByParam('id', $("#node-input-tag").val())
                Treemenu.selectNode(nn[0])
                $("body").bind("mousedown", tag_bodydown);
            }
            $(`#tag_menuBtn`).on('click', tag_showMenu);

            var node_tag = RED.nodes.node(that.tag);
            if (node_tag) {
                $('#tag_menuBtn span').html(node_tag.name);
            } else {
                $('#tag_menuBtn span').html('');
            }



        },
        oneditsave: function () {

            $("#node-input-template").val(this.editor.getValue());
            this.template = $("#node-input-template").val();
            this.editor.destroy();
            delete this.editor;
            this._def.oncomponentload.call(this);
        },
        oneditcancel: function () {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function (size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height", height + "px");
            this.editor.resize();
        },
        oncomponentload() {
            var nn = this;


            var item_id = nn.id.replace(".", "-");

            var tag_id = nn.tag.replace(".", "-");
            var template = nn.template;
            var name = nn.name;
            var tagNode = RED.nodes.node(nn.tag);
            maxvalue = 0;
            if (tagNode) maxvalue = tagNode.maxvalue;

            var component_content = $(`#${item_id}-item-content`);
            component_content.empty();




            function show_spinner() {
                component_content.empty();
                var spinner = $(`<div id ='${item_id}-spinner'  class='tp-spinner'>
                                            <span class='tb-spinner tb-spinner-is-centered'> </span>
                                        </div>`).appendTo(component_content)
            }

            function load_data() {
                if (nn.tag && nn.template) {

                    var data = { template: template, id: tag_id, maxvalue: maxvalue, name: name }
                    show_spinner();
                    $.ajax({
                        method: 'POST',
                        contentType: 'application/json',
                        url: "template/" + nn.id,
                        data: JSON.stringify(data),
                        success: function (data) {
                            init_component(data)
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log("Unexpected error saving user settings:", jqXHR.status, textStatus);
                        }
                    });
                }

            }

            function init_component(data) {
                component_content.empty();
                var template = $(`${data}`).on("dblclick", function () {
                    RED.editor.edit(nn);
                    var n = XAPP.treelist.tree().getNodesByParam('id', nn.id)
                    XAPP.treelist.tree().selectNode(n[0])
                }).appendTo(component_content)

            }
            load_data();



        }
    });
</script>